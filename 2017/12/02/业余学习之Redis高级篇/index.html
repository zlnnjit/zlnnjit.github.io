<!DOCTYPE html>
<html>
<head hexo-theme='https://volantis.js.org/#2020'>
  <meta charset="utf-8">
  <!-- SEO相关 -->
  
    
  
  <!-- 渲染优化 -->
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <!-- 页面元数据 -->
  
    <title>业余学习之Redis高级篇 - zln&#39;s blog</title>
  
    <meta name="keywords" content="Redis,集群">
  
  
    <meta name="description" content="
引言

本系列主要是业余知识拓展（java相关方面的知识）的学习笔记，便于以后查看和复习。">
  

  <!-- feed -->
  

  <!-- import meta -->
  

  <!-- link -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css">
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">

  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css">

  

  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.css">
  

  <!-- import link -->
  

  
    
<link rel="stylesheet" href="/css/style.css">

  

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>

  
  
</head>

<body>
  
  <div class="cover-wrapper">
    
      <cover class='cover post half'>
        <div class='cover-body'>
  <div class='a'>
    
    
      <p class="title">bcoder.top</p>
    
    
      <p class="subtitle">不忘初心，无畏前行</p>
    
  </div>
  <div class='b'>
    
      <div class="m_search">
        <form name="searchform" class="form u-search-form">
          <input type="text" class="input u-search-input" placeholder="" />
          <i class="icon fas fa-search fa-fw"></i>
        </form>
      </div>
    
    <div class='menu navigation'>
      <ul class='h-list'>
        
          
            <li>
              <a class="nav home"
                href="/"
                
                
                id="home">
                <i class='fas fa-rss fa-fw'></i>&nbsp;博客
              </a>
            </li>
          
            <li>
              <a class="nav home"
                href="/categories/"
                
                
                id="categories">
                <i class='fas fa-folder-open fa-fw'></i>&nbsp;分类
              </a>
            </li>
          
            <li>
              <a class="nav home"
                href="/tags/"
                
                
                id="tags">
                <i class='fas fa-tags fa-fw'></i>&nbsp;标签
              </a>
            </li>
          
            <li>
              <a class="nav home"
                href="/archives/"
                
                
                id="archives">
                <i class='fas fa-archive fa-fw'></i>&nbsp;归档
              </a>
            </li>
          
            <li>
              <a class="nav home"
                href="https://github.com/zlnnjit"
                
                
                  target="_blank"
                
                id="https:githubcomzlnnjit">
                <i class='fas fa-link fa-fw'></i>&nbsp;github
              </a>
            </li>
          
            <li>
              <a class="nav home"
                href="/about/"
                
                
                id="about">
                <i class='fas fa-info-circle fa-fw'></i>&nbsp;关于
              </a>
            </li>
          
        
      </ul>
    </div>
  </div>
</div>

      </cover>
    
    <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>
<header class="l_header shadow blur">

  <div class='wrapper'>
    <div class='nav-sub container--flex'>
      <a class="logo flat-box"></a>
      <ul class='switcher h-list'>
        <li><a class="s-comment flat-btn fas fa-comments fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
          <li><a class="s-toc flat-btn fas fa-list fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
      </ul>
    </div>
		<div class="nav-main container container--flex">
      
        
        <a class="logo flat-box" target="_self" href='/'>
          
          
          
          
            周陆宁 <b><sup style='color:#3AA757'>2020</sup></b>
          
        </a>
      

			<div class='menu navigation'>
				<ul class='h-list'>
          
          
          
            
            
              <li>
                <a class="flat-box" href=/
                  
                  
                  
                    id="home"
                  >
                  
                    <i class='fas fa-rss fa-fw'></i>
                  
                  博客
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=/categories/
                  
                  
                  
                    id="categories"
                  >
                  
                    <i class='fas fa-folder-open fa-fw'></i>
                  
                  分类
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=/tags/
                  
                  
                  
                    id="tags"
                  >
                  
                    <i class='fas fa-tags fa-fw'></i>
                  
                  标签
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=/archives/
                  
                  
                  
                    id="archives"
                  >
                  
                    <i class='fas fa-archive fa-fw'></i>
                  
                  归档
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=https://github.com/zlnnjit
                  
                  
                    target="_blank"
                  
                  
                    id="https:githubcomzlnnjit"
                  >
                  
                    <i class='fas fa-link fa-fw'></i>
                  
                  github
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=/about/
                  
                  
                  
                    id="about"
                  >
                  
                    <i class='fas fa-info-circle fa-fw'></i>
                  
                  关于
                </a>
                
              </li>
            
          
          
				</ul>
			</div>

      
        <div class="m_search">
          <form name="searchform" class="form u-search-form">
            <i class="icon fas fa-search fa-fw"></i>
            <input type="text" class="input u-search-input" placeholder="搜索" />
          </form>
        </div>
      

			<ul class='switcher h-list'>
				
					<li><a class="s-search flat-btn fas fa-search fa-fw" target="_self" href='javascript:void(0)'></a></li>
				
				<li><a class="s-menu flat-btn fas fa-bars fa-fw" target="_self" href='javascript:void(0)'></a></li>
			</ul>
		</div>
	</div>
</header>
<ul class="menu-phone navigation white-box">
  
  
    <li>
      <a class="flat-box" href=/
        
        
        
          id="home"
        >
        
          <i class='fas fa-rss fa-fw'></i>
        
        博客
      </a>
    </li>
  
    <li>
      <a class="flat-box" href=/categories/
        
        
        
          id="categories"
        >
        
          <i class='fas fa-folder-open fa-fw'></i>
        
        分类
      </a>
    </li>
  
    <li>
      <a class="flat-box" href=/tags/
        
        
        
          id="tags"
        >
        
          <i class='fas fa-tags fa-fw'></i>
        
        标签
      </a>
    </li>
  
    <li>
      <a class="flat-box" href=/archives/
        
        
        
          id="archives"
        >
        
          <i class='fas fa-archive fa-fw'></i>
        
        归档
      </a>
    </li>
  
    <li>
      <a class="flat-box" href=/friends/
        
        
        
          id="friends"
        >
        
          <i class='fas fa-link fa-fw'></i>
        
        友链
      </a>
    </li>
  
    <li>
      <a class="flat-box" href=/about/
        
        
        
          id="about"
        >
        
          <i class='fas fa-info-circle fa-fw'></i>
        
        关于
      </a>
    </li>
  
</ul>
<script>setLoadingBarProgress(40);</script>

  </div>


  <div class="l_body">
    <div class='body-wrapper'>
      

<div class='l_main'>
  

  
    <article id="post" class="post white-box shadow article-type-post" itemscope itemprop="blogPost">
      


  <section class='meta'>
    
    
    <div class="meta" id="header-meta">
      
        
  
    <h1 class="title">
      <a href="/2017/12/02/%E4%B8%9A%E4%BD%99%E5%AD%A6%E4%B9%A0%E4%B9%8BRedis%E9%AB%98%E7%BA%A7%E7%AF%87/">
        业余学习之Redis高级篇
      </a>
    </h1>
  


      
      <div class='new-meta-box'>
        
          
        
          
            
<div class='new-meta-item author'>
  <a href="" rel="nofollow">
    <img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/avatar/avatar.png">
    <p>周陆宁</p>
  </a>
</div>

          
        
          
            
  
  <div class='new-meta-item category'>
    <a href='/categories/deep/' rel="nofollow">
      <i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>
      <p>deep</p>
    </a>
  </div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i>
    <p>发布于：2017-12-02 13:21:02</p>
  </a>
</div>

          
        
          
            
  <div class="new-meta-item wordcount">
    <a class='notlink'>
      <i class="fas fa-keyboard fa-fw" aria-hidden="true"></i>
      <p>字数：9.2k</p>
    </a>
  </div>
  <div class="new-meta-item readtime">
    <a class='notlink'>
      <i class="fas fa-hourglass-half fa-fw" aria-hidden="true"></i>
      <p>时长：40 分钟</p>
    </a>
  </div>


          
        
          
            

          
        
      </div>
      
        <hr>
      
    </div>
  </section>


      <section class="article typo">
        <div class="article-entry" itemprop="articleBody">
          
          <blockquote>
<p>引言</p>
</blockquote>
<p>本系列主要是业余知识拓展（java相关方面的知识）的学习笔记，便于以后查看和复习。</p>
<a id="more"></a>

<h2 id="Redis集群"><a href="#Redis集群" class="headerlink" title="Redis集群"></a>Redis集群</h2><h3 id="Redis集群简介"><a href="#Redis集群简介" class="headerlink" title="Redis集群简介"></a>Redis集群简介</h3><p>Redis 集群是一个提供在多个Redis间节点间共享数据的程序集。</p>
<p>Redis集群并不支持处理多个keys的命令,因为这需要在不同的节点间移动数据,从而达不到像Redis那样的性能,在高负载的情况下可能会导致不可预料的错误.</p>
<p>Redis 集群通过分区来提供一定程度的可用性,在实际环境中当某个节点宕机或者不可达的情况下继续处理命令. Redis 集群的优势:</p>
<ul>
<li>自动分割数据到不同的节点上。</li>
<li>整个集群的部分节点失败或者不可达的情况下能够继续处理命令。</li>
</ul>
<p>Redis支持集群最小的单位为6个实例，3个主节点，3个从节点</p>
<p>由于节点比较多，本人电脑资源有限，所以采取在一台虚拟机（虚拟机系统为centos）上部署6个Redis节点，从而实现Redis集群，具体拓扑如下图所示：</p>
<p><img src="http://img.bcoder.top/2017.12.02/1.png" alt="业余学习之Redis高级篇"></p>
<h3 id="Redis集群搭建"><a href="#Redis集群搭建" class="headerlink" title="Redis集群搭建"></a>Redis集群搭建</h3><p>第一步：在local下创建redis-cluster,然后在其下分别创建6个文件夹：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@zln111 local]# mkdir -p &#x2F;usr&#x2F;local&#x2F;redis-cluster</span><br><span class="line">[root@zln111 local]# cd &#x2F;usr&#x2F;local&#x2F;redis-cluster</span><br><span class="line">[root@zln111 redis-cluster]# mkdir 1001</span><br><span class="line">[root@zln111 redis-cluster]# mkdir 1002</span><br><span class="line">[root@zln111 redis-cluster]# mkdir 1003</span><br><span class="line">[root@zln111 redis-cluster]# mkdir 1004</span><br><span class="line">[root@zln111 redis-cluster]# mkdir 1005</span><br><span class="line">[root@zln111 redis-cluster]# mkdir 1006</span><br></pre></td></tr></table></figure>

<p>第二步：把之前的redis.conf配置分别copy到100<em>下，进行修改各个文件内容，也就是对100</em>下的每一个copy的redis.conf文件进行修改，如下：</p>
<p>1．daemonize yes   使用后台服务启动<br>2．port 100* (分别对每个机器的端口号进行设置，如果是不同的机器则可以不用修改端口)<br>3．bind 192.168.1.111(必须要绑定当前机器的IP，本机地址为192.168.1.111)<br>4．dir /usr/local/redis-cluster/100<em>/ (指定数据文件存放位置，必须要指定不同的目录，不然文件会丢失)<br>5．cluster-enabled yes  (表示启动集群模式)<br>6．cluster-config-file nodes-100</em>conf(这一步主要是为了让各个节点知道其他节点的存在)<br>7．cluster-node-timeout 5000 (设置访问超时时间5s)<br>8．appendonly yes  (启用AOP持久化机制)</p>
<p>上面的操作又用到了redis.conf,下面，我们来详细解释一下这个配置文件的各个部分：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Redis 配置文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 当配置中需要配置内存大小时，可以使用 1k, 5GB, 4M 等类似的格式，其转换方式如下(不区分大小写)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 1k =&gt;1000 bytes</span></span><br><span class="line"><span class="comment"># 1kb =&gt; 1024 bytes</span></span><br><span class="line"><span class="comment"># 1m =&gt; 1000000 bytes</span></span><br><span class="line"><span class="comment"># 1mb =&gt;1024*1024 bytes</span></span><br><span class="line"><span class="comment"># 1g =&gt; 1000000000 bytes</span></span><br><span class="line"><span class="comment"># 1gb =&gt; 1024*1024*1024bytes</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 内存配置大小写是一样的.比如 1gb 1Gb 1GB 1gB</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># daemonize no 默认情况下，redis不是在后台运行的，如果需要在后台运行，把该项的值更改为yes</span></span><br><span class="line">daemonize yes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 当redis在后台运行的时候，Redis默认会把pid文件放在/var/run/redis.pid，你可以配置到其他地址。</span></span><br><span class="line"><span class="comment"># 当运行多个redis服务时，需要指定不同的pid文件和端口</span></span><br><span class="line">pidfile /var/run/redis.pid</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定redis运行的端口，默认是6379</span></span><br><span class="line">port 6379</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定redis只接收来自于该IP地址的请求，如果不进行设置，那么将处理所有请求，</span></span><br><span class="line"><span class="comment"># 在生产环境中最好设置该项</span></span><br><span class="line"><span class="comment"># bind 127.0.0.1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Specify the path for the unix socket that will be used to listen for</span></span><br><span class="line"><span class="comment"># incoming connections. There is no default, so Redis will not listen</span></span><br><span class="line"><span class="comment"># on a unix socket when not specified.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># unixsocket /tmp/redis.sock</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">unixsocketperm 755</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置客户端连接时的超时时间，单位为秒。当客户端在这段时间内没有发出任何指令，那么关闭该连接</span></span><br><span class="line"><span class="comment"># 0是关闭此设置</span></span><br><span class="line">timeout 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定日志记录级别</span></span><br><span class="line"><span class="comment"># Redis总共支持四个级别：debug、verbose、notice、warning，默认为verbose</span></span><br><span class="line"><span class="comment"># debug  记录很多信息，用于开发和测试</span></span><br><span class="line"><span class="comment"># varbose 有用的信息，不像debug会记录那么多</span></span><br><span class="line"><span class="comment"># notice 普通的verbose，常用于生产环境</span></span><br><span class="line"><span class="comment"># warning 只有非常重要或者严重的信息会记录到日志</span></span><br><span class="line">loglevel debug</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置log文件地址</span></span><br><span class="line"><span class="comment"># 默认值为stdout，标准输出，若后台模式会输出到/dev/null</span></span><br><span class="line"><span class="comment"># logfile stdout</span></span><br><span class="line">logfile /var/<span class="built_in">log</span>/redis/redis.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># To enable logging to the system logger, just set 'syslog-enabled' toyes,</span></span><br><span class="line"><span class="comment"># and optionally update the other syslog parameters to suit your needs.</span></span><br><span class="line"><span class="comment"># syslog-enabled no</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Specify the syslog identity.</span></span><br><span class="line"><span class="comment"># syslog-ident redis</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Specify the syslog facility.  Must be USER or between LOCAL0-LOCAL7.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">syslog-facility local0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可用数据库数</span></span><br><span class="line"><span class="comment"># 默认值为16，默认数据库为0，数据库范围在0-（database-1）之间 </span></span><br><span class="line"></span><br><span class="line">databases 16</span><br><span class="line"></span><br><span class="line"><span class="comment">################################ 快照  #################################</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 保存数据到磁盘，格式如下:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   save &lt;seconds&gt; &lt;changes&gt;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   指出在多长时间内，有多少次更新操作，就将数据同步到数据文件rdb。</span></span><br><span class="line"><span class="comment">#   相当于条件触发抓取快照，这个可以多个条件配合</span></span><br><span class="line"><span class="comment">#   </span></span><br><span class="line"><span class="comment">#   比如默认配置文件中的设置，就设置了三个条件</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   save 900 1  900秒内至少有1个key被改变</span></span><br><span class="line"><span class="comment">#   save 300 10  300秒内至少有300个key被改变</span></span><br><span class="line"><span class="comment">#   save 60 10000  60秒内至少有10000个key被改变</span></span><br><span class="line"></span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 存储至本地数据库时（持久化到rdb文件）是否压缩数据，默认为yes</span></span><br><span class="line">rdbcompression yes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 本地持久化数据库文件名，默认值为dump.rdb</span></span><br><span class="line">dbfilename dump.rdb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 工作目录</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 数据库镜像备份的文件放置的路径。</span></span><br><span class="line"><span class="comment"># 这里的路径跟文件名要分开配置是因为redis在进行备份时，先会将当前数据库的状态写入到一个临时文件中，等备份完成时，</span></span><br><span class="line"><span class="comment"># 再把该该临时文件替换为上面所指定的文件，而这里的临时文件和上面所配置的备份文件都会放在这个指定的路径当中。</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># AOF文件也会存放在这个目录下面</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 注意这里必须制定一个目录而不是文件</span></span><br><span class="line">dir ./</span><br><span class="line"></span><br><span class="line"><span class="comment">################################# 复制 #################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 主从复制. 设置该数据库为其他数据库的从数据库.</span></span><br><span class="line"><span class="comment"># 设置当本机为slav服务时，设置master服务的IP地址及端口，在Redis启动时，它会自动从master进行数据同步</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># slaveof &lt;masterip&gt; &lt;masterport&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 当master服务设置了密码保护时(用requirepass制定的密码)</span></span><br><span class="line"><span class="comment"># slav服务连接master的密码</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># masterauth &lt;master-password&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 当从库同主机失去连接或者复制正在进行，从机库有两种运行方式：</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 1)如果slave-serve-stale-data设置为yes(默认设置)，从库会继续相应客户端的请求</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 2)如果slave-serve-stale-data是指为no，出去INFO和SLAVOF命令之外的任何请求都会返回一个</span></span><br><span class="line"><span class="comment">#    错误"SYNC with master in progress"</span></span><br><span class="line"><span class="comment"># slave-serve-stale-data yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从库会按照一个时间间隔向主库发送PINGs.可以通过repl-ping-slave-period设置这个时间间隔，默认是10秒</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># repl-ping-slave-period 10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># repl-timeout 设置主库批量数据传输时间或者ping回复时间间隔，默认值是60秒</span></span><br><span class="line"><span class="comment"># 一定要确保repl-timeout大于repl-ping-slave-period</span></span><br><span class="line"><span class="comment"># repl-timeout 60</span></span><br><span class="line"></span><br><span class="line"><span class="comment">################################## 安全 ###################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置客户端连接后进行任何其他指定前需要使用的密码。</span></span><br><span class="line"><span class="comment"># 警告：因为redis速度相当快，所以在一台比较好的服务器下，一个外部的用户可以在一秒钟进行</span></span><br><span class="line"><span class="comment"># 150K次的密码尝试，这意味着你需要指定非常非常强大的密码来防止暴力破解</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># requirepass foobared</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 命令重命名.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 在一个共享环境下可以重命名相对危险的命令。比如把CONFIG重名为一个不容易猜测的字符。</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 举例:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># rename-command CONFIG b840fc02d524045429941cc15f59e41cb7be6c52</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#如果想删除一个命令，直接把它重命名为一个空字符""即可，如下：</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># rename-command CONFIG ""</span></span><br><span class="line"></span><br><span class="line"><span class="comment">################################### 约束 ####################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置同一时间最大客户端连接数，默认无限制，Redis可以同时打开的客户端连接数为Redis进程可以打开的最大文件描述符数，</span></span><br><span class="line"><span class="comment"># 如果设置maxclients 0，表示不作限制。</span></span><br><span class="line"><span class="comment"># 当客户端连接数到达限制时，Redis会关闭新的连接并向客户端返回max number of clients reached错误信息</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># maxclients 128</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定Redis最大内存限制，Redis在启动时会把数据加载到内存中，达到最大内存后，Redis会先尝试清除已到期或即将到期的Key</span></span><br><span class="line"><span class="comment"># Redis同时也会移除空的list对象</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 当此方法处理后，仍然到达最大内存设置，将无法再进行写入操作，但仍然可以进行读取操作</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 注意：Redis新的vm机制，会把Key存放内存，Value会存放在swap区</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># maxmemory的设置比较适合于把redis当作于类似memcached的缓存来使用，而不适合当做一个真实的DB。</span></span><br><span class="line"><span class="comment"># 当把Redis当做一个真实的数据库使用的时候，内存使用将是一个很大的开销</span></span><br><span class="line"><span class="comment"># maxmemory &lt;bytes&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 当内存达到最大值的时候Redis会选择删除哪些数据？有五种方式可供选择</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># volatile-lru -&gt;利用LRU算法移除设置过过期时间的key (LRU:最近使用 Least Recently Used )</span></span><br><span class="line"><span class="comment"># allkeys-lru -&gt;利用LRU算法移除任何key</span></span><br><span class="line"><span class="comment"># volatile-random -&gt; 移除设置过过期时间的随机key</span></span><br><span class="line"><span class="comment"># allkeys-&gt;random -&gt; remove a random key, any key</span></span><br><span class="line"><span class="comment"># volatile-ttl -&gt; 移除即将过期的key(minor TTL)</span></span><br><span class="line"><span class="comment"># noeviction -&gt; 不移除任何可以，只是返回一个写错误</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 注意：对于上面的策略，如果没有合适的key可以移除，当写的时候Redis会返回一个错误</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#       写命令包括: set setnx  setex append</span></span><br><span class="line"><span class="comment">#       incr decr rpush lpush rpushx lpushx linsert lset rpoplpush sadd</span></span><br><span class="line"><span class="comment">#       sinter sinterstore sunion sunionstore sdiff sdiffstore zadd zincrby</span></span><br><span class="line"><span class="comment">#       zunionstore zinterstore hset hsetnx hmset hincrby incrby decrby</span></span><br><span class="line"><span class="comment">#       getset mset msetnx exec sort</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 默认是:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># maxmemory-policy volatile-lru</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># LRU 和 minimal TTL 算法都不是精准的算法，但是相对精确的算法(为了节省内存)，随意你可以选择样本大小进行检测。</span></span><br><span class="line"><span class="comment"># Redis默认的灰选择3个样本进行检测，你可以通过maxmemory-samples进行设置</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># maxmemory-samples 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">############################## AOF ###############################</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认情况下，redis会在后台异步的把数据库镜像备份到磁盘，但是该备份是非常耗时的，</span></span><br><span class="line"><span class="comment"># 而且备份也不能很频繁，如果发生诸如拉闸限电、拔插头等状况，那么将造成比较大范围的数据丢失。</span></span><br><span class="line"><span class="comment"># 所以redis提供了另外一种更加高效的数据库备份及灾难恢复方式。</span></span><br><span class="line"><span class="comment"># 开启append only模式之后，redis会把所接收到的每一次写操作请求都追加到appendonly.aof文件中，</span></span><br><span class="line"><span class="comment"># 当redis重新启动时，会从该文件恢复出之前的状态。</span></span><br><span class="line"><span class="comment"># 但是这样会造成appendonly.aof文件过大，所以redis还支持了BGREWRITEAOF指令，对appendonly.aof 进行重新整理。</span></span><br><span class="line"><span class="comment"># 你可以同时开启asynchronous dumps 和 AOF</span></span><br><span class="line"></span><br><span class="line">appendonly no</span><br><span class="line"></span><br><span class="line"><span class="comment"># AOF文件名称 (默认: "appendonly.aof")</span></span><br><span class="line"><span class="comment"># appendfilename appendonly.aof</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Redis支持三种同步AOF文件的策略:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># no: 不进行同步，系统去操作 . Faster.</span></span><br><span class="line"><span class="comment"># always:</span></span><br><span class="line">always表示每次有写操作都进行同步. Slow, Safest.</span><br><span class="line"><span class="comment"># everysec: 表示对写操作进行累积，每秒同步一次.</span></span><br><span class="line">Compromise.</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 默认是"everysec"，按照速度和安全折中这是最好的。</span></span><br><span class="line"><span class="comment"># 如果想让Redis能更高效的运行，你也可以设置为"no"，让操作系统决定什么时候去执行</span></span><br><span class="line"><span class="comment"># 或者相反想让数据更安全你也可以设置为"always"</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 如果不确定就用 "everysec".</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># appendfsync always</span></span><br><span class="line">appendfsync everysec</span><br><span class="line"><span class="comment"># appendfsync no</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># AOF策略设置为always或者everysec时，后台处理进程(后台保存或者AOF日志重写)会执行大量的I/O操作</span></span><br><span class="line"><span class="comment"># 在某些Linux配置中会阻止过长的fsync()请求。注意现在没有任何修复，即使fsync在另外一个线程进行处理</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 为了减缓这个问题，可以设置下面这个参数no-appendfsync-on-rewrite</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This means that while another child is saving the durability of Redis is</span></span><br><span class="line"><span class="comment"># the same as "appendfsync none", that in pratical terms means that it is</span></span><br><span class="line"><span class="comment"># possible to lost up to 30 seconds of log in the worst scenario (with the</span></span><br><span class="line"><span class="comment"># default Linux settings).</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># If you have latency problems turn this to "yes". Otherwise eave it as</span></span><br><span class="line"><span class="comment"># "no" that is the safest pick from the point of view of urability.</span></span><br><span class="line">no-appendfsync-on-rewrite no</span><br><span class="line"></span><br><span class="line"><span class="comment"># Automatic rewrite of the append only file.</span></span><br><span class="line"><span class="comment"># AOF 自动重写</span></span><br><span class="line"><span class="comment"># 当AOF文件增长到一定大小的时候Redis能够调用 BGREWRITEAOF 对日志文件进行重写</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 它是这样工作的：Redis会记住上次进行些日志后文件的大小(如果从开机以来还没进行过重写，那日子大小在开机的时候确定)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 基础大小会同现在的大小进行比较。如果现在的大小比基础大小大制定的百分比，重写功能将启动</span></span><br><span class="line"><span class="comment"># 同时需要指定一个最小大小用于AOF重写，这个用于阻止即使文件很小但是增长幅度很大也去重写AOF文件的情况</span></span><br><span class="line"><span class="comment"># 设置 percentage 为0就关闭这个特性</span></span><br><span class="line"></span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line"></span><br><span class="line"><span class="comment">################################## SLOW LOG ###################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Redis Slow Log 记录超过特定执行时间的命令。执行时间不包括I/O计算比如连接客户端，返回结果等，只是命令执行时间</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 可以通过两个参数设置slow log：一个是告诉Redis执行超过多少时间被记录的参数slowlog-log-slower-than(微妙)，</span></span><br><span class="line"><span class="comment"># 另一个是slow log 的长度。当一个新命令被记录的时候最早的命令将被从队列中移除</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下面的时间以微妙微单位，因此1000000代表一分钟。</span></span><br><span class="line"><span class="comment"># 注意制定一个负数将关闭慢日志，而设置为0将强制每个命令都会记录</span></span><br><span class="line">slowlog-log-slower-than 10000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对日志长度没有限制，只是要注意它会消耗内存</span></span><br><span class="line"><span class="comment"># 可以通过 SLOWLOG RESET 回收被慢日志消耗的内存</span></span><br><span class="line">slowlog-max-len 1024</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">############################### ADVANCED CONFIG ###############################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 当hash中包含超过指定元素个数并且最大的元素没有超过临界时，</span></span><br><span class="line"><span class="comment"># hash将以一种特殊的编码方式（大大减少内存使用）来存储，这里可以设置这两个临界值</span></span><br><span class="line"><span class="comment"># Redis Hash对应Value内部实际就是一个HashMap，实际这里会有2种不同实现，</span></span><br><span class="line"><span class="comment"># 这个Hash的成员比较少时Redis为了节省内存会采用类似一维数组的方式来紧凑存储，而不会采用真正的HashMap结构，</span></span><br><span class="line"><span class="comment"># 对应的value redisObject的encoding为zipmap,</span></span><br><span class="line"><span class="comment"># 当成员数量增大时会自动转成真正的HashMap,此时encoding为ht。</span></span><br><span class="line"><span class="built_in">hash</span>-max-zipmap-entries 512</span><br><span class="line"><span class="built_in">hash</span>-max-zipmap-value 64</span><br><span class="line"></span><br><span class="line"><span class="comment"># list数据类型多少节点以下会采用去指针的紧凑存储格式。</span></span><br><span class="line"><span class="comment"># list数据类型节点值大小小于多少字节会采用紧凑存储格式。</span></span><br><span class="line">list-max-ziplist-entries 512</span><br><span class="line">list-max-ziplist-value 64</span><br><span class="line"></span><br><span class="line"><span class="comment"># set数据类型内部数据如果全部是数值型，且包含多少节点以下会采用紧凑格式存储。</span></span><br><span class="line"><span class="built_in">set</span>-max-intset-entries 512</span><br><span class="line"></span><br><span class="line"><span class="comment"># zsort数据类型多少节点以下会采用去指针的紧凑存储格式。</span></span><br><span class="line"><span class="comment"># zsort数据类型节点值大小小于多少字节会采用紧凑存储格式。</span></span><br><span class="line">zset-max-ziplist-entries 128</span><br><span class="line">zset-max-ziplist-value 64</span><br><span class="line"></span><br><span class="line"><span class="comment"># Redis将在每100毫秒时使用1毫秒的CPU时间来对redis的hash表进行重新hash，可以降低内存的使用</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 当你的使用场景中，有非常严格的实时性需要，不能够接受Redis时不时的对请求有2毫秒的延迟的话，把这项配置为no。</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 如果没有这么严格的实时性要求，可以设置为yes，以便能够尽可能快的释放内存</span></span><br><span class="line">activerehashing yes</span><br><span class="line"></span><br><span class="line"><span class="comment">################################## INCLUDES ###################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定包含其它的配置文件，可以在同一主机上多个Redis实例之间使用同一份配置文件，</span></span><br><span class="line"><span class="comment"># 而同时各个实例又拥有自己的特定配置文件</span></span><br><span class="line"><span class="comment"># include /path/to/local.conf</span></span><br><span class="line"><span class="comment"># include /path/to/other.conf</span></span><br></pre></td></tr></table></figure>


<p>操作如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@zln111 etc]# cp redis.conf &#x2F;usr&#x2F;local&#x2F;redis-cluster&#x2F;1001</span><br><span class="line">[root@zln111 etc]# vim &#x2F;usr&#x2F;local&#x2F;redis-cluster&#x2F;1001&#x2F;redis.conf</span><br></pre></td></tr></table></figure>
<p>编辑后的内容为：<br>然后把1001的redis.conf分别拷贝其他对应1002到1006文件夹下，并修改port 和 dir 和Cluster-config-file nodes-100*.conf</p>
<p>然后修改其他文件的内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@zln111 etc]# cd &#x2F;usr&#x2F;local&#x2F;redis-cluster&#x2F;1001</span><br><span class="line">[root@zln111 1001]# ls</span><br><span class="line">redis.conf</span><br><span class="line">[root@zln111 1001]# cp redis.conf &#x2F;usr&#x2F;local&#x2F;redis-cluster&#x2F;1002</span><br><span class="line">[root@zln111 1001]# cp redis.conf &#x2F;usr&#x2F;local&#x2F;redis-cluster&#x2F;1003</span><br><span class="line">[root@zln111 1001]# cp redis.conf &#x2F;usr&#x2F;local&#x2F;redis-cluster&#x2F;1004</span><br><span class="line">[root@zln111 1001]# cp redis.conf &#x2F;usr&#x2F;local&#x2F;redis-cluster&#x2F;1005</span><br><span class="line">[root@zln111 1001]# cp redis.conf &#x2F;usr&#x2F;local&#x2F;redis-cluster&#x2F;1006</span><br><span class="line">[root@zln111 1001]# cd ..</span><br><span class="line">[root@zln111 redis-cluster]# cd 1002</span><br><span class="line">[root@zln111 1002]# vim redis.conf</span><br></pre></td></tr></table></figure>

<p>第三步(这部本人做的比较艰难，搞坏了一台虚拟机)：<br>由于redis集群需要使用ruby命令，所以需要安装ruby，安装步骤如下：<br>1．    yum install ruby<br>2．    yum install rubygems<br>3．    gem install redis(安装redis和ruby的接口)</p>
<p>到gem install redis这一步会抛出异常,大致如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gem install redis</span><br><span class="line">ERROR:  Error installing redis:</span><br><span class="line">        redis requires Ruby version &gt;&#x3D; 2.2.2.</span><br></pre></td></tr></table></figure>

<p>然后看了一下：yum install ruby 所装的版本发现为：1.8.7（原因应给是centos的系统的软件源更新不及时）</p>
<p>最后使用RVM更新新的RUBY版本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gpg2 --keyserver hkp:&#x2F;&#x2F;keys.gnupg.net --recv-keys D39DC0E3</span><br><span class="line">curl -L get.rvm.io | bash -s stable</span><br><span class="line">find &#x2F; -name rvm -print</span><br><span class="line">source &#x2F;usr&#x2F;local&#x2F;rvm&#x2F;scripts&#x2F;rvm</span><br><span class="line">rvm list known</span><br><span class="line">rvm install 2.3.3</span><br></pre></td></tr></table></figure>

<p>然后重新运行gem install redis，结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@zln111 ]# gem install redis</span><br><span class="line">Successfully installed redis-3.2.2</span><br><span class="line">Parsing documentation for redis-3.2.2</span><br><span class="line">Installing ri documentation for redis-3.2.2</span><br><span class="line">Done installing documentation for redis after 1 seconds</span><br><span class="line">1 gem installed</span><br></pre></td></tr></table></figure>

<p>操作成功，下面我们来启动一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@zln111 local]# &#x2F;usr&#x2F;local&#x2F;&#x2F;redis&#x2F;bin&#x2F;redis-server  &#x2F;usr&#x2F;local&#x2F;redis-cluster&#x2F;1001&#x2F;redis.conf</span><br><span class="line">[root@zln111 local]# &#x2F;usr&#x2F;local&#x2F;&#x2F;redis&#x2F;bin&#x2F;redis-server  &#x2F;usr&#x2F;local&#x2F;redis-cluster&#x2F;1002&#x2F;redis.conf</span><br><span class="line">[root@zln111 local]# &#x2F;usr&#x2F;local&#x2F;&#x2F;redis&#x2F;bin&#x2F;redis-server  &#x2F;usr&#x2F;local&#x2F;redis-cluster&#x2F;1003&#x2F;redis.conf</span><br><span class="line">[root@zln111 local]# &#x2F;usr&#x2F;local&#x2F;&#x2F;redis&#x2F;bin&#x2F;redis-server  &#x2F;usr&#x2F;local&#x2F;redis-cluster&#x2F;1004&#x2F;redis.conf</span><br><span class="line">[root@zln111 local]# &#x2F;usr&#x2F;local&#x2F;&#x2F;redis&#x2F;bin&#x2F;redis-server  &#x2F;usr&#x2F;local&#x2F;redis-cluster&#x2F;1005&#x2F;redis.conf</span><br><span class="line">[root@zln111 local]# &#x2F;usr&#x2F;local&#x2F;&#x2F;redis&#x2F;bin&#x2F;redis-server  &#x2F;usr&#x2F;local&#x2F;redis-cluster&#x2F;1006&#x2F;redis.conf</span><br></pre></td></tr></table></figure>

<p>参看是否是否启动：<strong>ps -el | grep redis</strong>和<strong>netstat -tunpl |grep redis</strong>:</p>
<p><img src="http://img.bcoder.top/2017.12.02/2.png" alt="业余学习之Redis高级篇"></p>
<p>第五步：首先到redis3.0的安装目录下，然后执行redis-trib.rb命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;usr&#x2F;local&#x2F;redis3.0&#x2F;src</span><br><span class="line">.&#x2F;redis-trib.rb create --replicas 1 192.168.1.111:1001 192.168.1.111:1002 192.168.1.111:1003 192.168.1.111:1004 192.168.1.111:1005 192.168.1.111:1006</span><br></pre></td></tr></table></figure>

<p>这里的1表示主从分配的比例，1表示集群的实例数是按照1:1的比例分配（主/从），当前是6个实例，那么结果是三主三从。如果这里设置为2，那么最小需要增加3个实例（主节点最少为三个，比例为2的最少组合是3主6从)。</p>
<p>如图集群就算是搭建成功了：</p>
<p><img src="http://img.bcoder.top/2017.12.02/3.png" alt="业余学习之Redis高级篇"></p>
<p><img src="http://img.bcoder.top/2017.12.02/4.png" alt="业余学习之Redis高级篇"></p>
<p>如上图所示，redis集群脚本已经帮我们自动划分好集群了，最下方是询问我们是否同意这种分配方式，如果同意的我们选yes</p>
<p>我们可以看到master节点的节点信息都有一个slots,这个我们可以形象的理解为槽位，用于存取数据，而slave却没有，这也能进一步说明，主节点具有读写特性，从节点只有读特性。（具体的原理后期会进行探讨）</p>
<p>搭建集群的时候可能遇到下面的问题，解决如下：<br>在搭建多机多点集群的时候，遇到以下问题：</p>
<p>1、一直在等待…</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; Nodes configuration updated</span><br><span class="line">&gt;&gt;&gt; Assign a different config epoch to each node</span><br><span class="line">&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster</span><br><span class="line">Waiting for the cluster to join.......................</span><br></pre></td></tr></table></figure>
<p>解决办法：确认端口是否开放。如果没有开发，可以修改/etc/sysconfig/iptables文件，开放端口（复制一行前面开放端口的来修改），然后service iptables restart重启防火墙。</p>
<p>极端的可以service iptables stop来关闭防火墙</p>
<p>2、槽被利用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;rvm&#x2F;gems&#x2F;ruby-2.3.3&#x2F;gems&#x2F;redis-4.0.0&#x2F;lib&#x2F;redis&#x2F;client.rb:119:in &#96;call&#39;: ERR Slot 5461 is already busy (Redis::CommandError)</span><br><span class="line">from &#x2F;usr&#x2F;local&#x2F;rvm&#x2F;gems&#x2F;ruby-2.3.3&#x2F;gems&#x2F;redis-4.0.0&#x2F;lib&#x2F;redis.rb:2742:in &#96;block in method_missing&#39;</span><br><span class="line">from &#x2F;usr&#x2F;local&#x2F;rvm&#x2F;gems&#x2F;ruby-2.3.3&#x2F;gems&#x2F;redis-4.0.0&#x2F;lib&#x2F;redis.rb:45:in &#96;block in synchronize&#39;</span><br><span class="line">from &#x2F;usr&#x2F;local&#x2F;rvm&#x2F;rubies&#x2F;ruby-2.3.3&#x2F;lib&#x2F;ruby&#x2F;2.3.0&#x2F;monitor.rb:214:in &#96;mon_synchronize&#39;</span><br><span class="line">from &#x2F;usr&#x2F;local&#x2F;rvm&#x2F;gems&#x2F;ruby-2.3.3&#x2F;gems&#x2F;redis-4.0.0&#x2F;lib&#x2F;redis.rb:45:in &#96;synchronize&#39;</span><br><span class="line">from &#x2F;usr&#x2F;local&#x2F;rvm&#x2F;gems&#x2F;ruby-2.3.3&#x2F;gems&#x2F;redis-4.0.0&#x2F;lib&#x2F;redis.rb:2741:in &#96;method_missing&#39;</span><br><span class="line">from &#x2F;usr&#x2F;local&#x2F;bin&#x2F;redis-trib.rb:212:in &#96;flush_node_config&#39;</span><br><span class="line">from &#x2F;usr&#x2F;local&#x2F;bin&#x2F;redis-trib.rb:776:in &#96;block in flush_nodes_config&#39;</span><br><span class="line">from &#x2F;usr&#x2F;local&#x2F;bin&#x2F;redis-trib.rb:775:in &#96;each&#39;</span><br><span class="line">from &#x2F;usr&#x2F;local&#x2F;bin&#x2F;redis-trib.rb:775:in &#96;flush_nodes_config&#39;</span><br><span class="line">from &#x2F;usr&#x2F;local&#x2F;bin&#x2F;redis-trib.rb:1296:in &#96;create_cluster_cmd&#39;</span><br><span class="line">from &#x2F;usr&#x2F;local&#x2F;bin&#x2F;redis-trib.rb:1100:in &#96;&lt;main&gt;&#39;</span><br></pre></td></tr></table></figure>
<p>解决办法：删除掉在redis.conf的dir目录下的几个文件redis.conf文件除外。</p>
<p>如果还是有相同的问题，可以考虑对所有节点执行下面两个命令。</p>
<p>redis-cli -p 端口号-h 主机物理地址 FLUSHALL</p>
<p>redis-cli -p 端口号-h 主机物理地址 CLUSTER RESET SOFT</p>
<h3 id="集群测试"><a href="#集群测试" class="headerlink" title="集群测试"></a>集群测试</h3><p>我们先来查看一下集群信息：</p>
<p>cluster info(查看集群消息)、cluster nodes（查看节点列表）</p>
<p><img src="http://img.bcoder.top/2017.12.02/8.png" alt="业余学习之Redis高级篇"></p>
<p>下面我们克隆6个会话，分别连接6个节点：</p>
<p><img src="http://img.bcoder.top/2017.12.02/5.png" alt="业余学习之Redis高级篇"></p>
<p>我们来看看我们的连接参数：</p>
<p>redis-cli</p>
<p>redis-cli默认情况下连接的是本地的6379端口的redis服务器。</p>
<p>现在有六个端口，所以需要指定参数。</p>
<p><strong>redis-cli -h xxx -p xxx -a xxx</strong><br>我们来解释一下上面的命令：<br>-h：指定服务器<br>-p：指定端口号<br>-a：指定密码<br>-c：开启集群模式</p>
<p>下面我们来看测试结果：</p>
<p><img src="http://img.bcoder.top/2017.12.02/6.png" alt="业余学习之Redis高级篇"></p>
<p><img src="http://img.bcoder.top/2017.12.02/7.png" alt="业余学习之Redis高级篇"></p>
<p>从测试结果看，我们只需要去存放数据，无需考虑我们要把数据存放在哪一个节点，Redis集群会主动帮我们做负载均衡。</p>
<h2 id="java操作Redis集群-Jedis"><a href="#java操作Redis集群-Jedis" class="headerlink" title="java操作Redis集群(Jedis)"></a>java操作Redis集群(Jedis)</h2><p>这个之前我们已经上过代码了(我们需要导入Jedis相关的Jar包)，下面根据当前配置环境，我们再来看一下代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestClusterRedis</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Set&lt;HostAndPort&gt; jedisClusterNode = <span class="keyword">new</span> HashSet&lt;HostAndPort&gt;();</span><br><span class="line">        jedisClusterNode.add(<span class="keyword">new</span> HostAndPort(<span class="string">"192.168.1.111"</span>, <span class="number">1001</span>));</span><br><span class="line">        jedisClusterNode.add(<span class="keyword">new</span> HostAndPort(<span class="string">"192.168.1.111"</span>, <span class="number">1002</span>));</span><br><span class="line">        jedisClusterNode.add(<span class="keyword">new</span> HostAndPort(<span class="string">"192.168.1.111"</span>, <span class="number">1003</span>));</span><br><span class="line">        jedisClusterNode.add(<span class="keyword">new</span> HostAndPort(<span class="string">"192.168.1.111"</span>, <span class="number">1004</span>));</span><br><span class="line">        jedisClusterNode.add(<span class="keyword">new</span> HostAndPort(<span class="string">"192.168.1.111"</span>, <span class="number">1005</span>));</span><br><span class="line">        jedisClusterNode.add(<span class="keyword">new</span> HostAndPort(<span class="string">"192.168.1.111"</span>, <span class="number">71006</span>));</span><br><span class="line">        <span class="comment">//GenericObjectPoolConfig goConfig = new GenericObjectPoolConfig();</span></span><br><span class="line">        <span class="comment">//JedisCluster jc = new JedisCluster(jedisClusterNode,2000,100, goConfig);</span></span><br><span class="line">        JedisPoolConfig cfg = <span class="keyword">new</span> JedisPoolConfig();</span><br><span class="line">        cfg.setMaxTotal(<span class="number">100</span>);</span><br><span class="line">        cfg.setMaxIdle(<span class="number">20</span>);</span><br><span class="line">        cfg.setMaxWaitMillis(-<span class="number">1</span>);</span><br><span class="line">        cfg.setTestOnBorrow(<span class="keyword">true</span>);</span><br><span class="line">        JedisCluster jc = <span class="keyword">new</span> JedisCluster(jedisClusterNode, <span class="number">6000</span>, <span class="number">1000</span>, cfg);</span><br><span class="line"></span><br><span class="line">        System.out.println(jc.set(<span class="string">"add"</span>, <span class="string">"nanjing"</span>));</span><br><span class="line">        System.out.println(jc.set(<span class="string">"sex"</span>, <span class="string">"男"</span>));</span><br><span class="line">        System.out.println(jc.get(<span class="string">"name"</span>));</span><br><span class="line">        System.out.println(jc.get(<span class="string">"name"</span>));</span><br><span class="line">        System.out.println(jc.get(<span class="string">"name"</span>));</span><br><span class="line">        System.out.println(jc.get(<span class="string">"name"</span>));</span><br><span class="line">        System.out.println(jc.get(<span class="string">"name"</span>));</span><br><span class="line">        System.out.println(jc.get(<span class="string">"name"</span>));</span><br><span class="line">        System.out.println(jc.get(<span class="string">"name"</span>));</span><br><span class="line">        System.out.println(jc.get(<span class="string">"name"</span>));</span><br><span class="line">        System.out.println(jc.get(<span class="string">"age"</span>));</span><br><span class="line">        System.out.println(jc.get(<span class="string">"sex"</span>));</span><br><span class="line">        jc.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们来看操作结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">OK</span><br><span class="line">OK</span><br><span class="line">zln</span><br><span class="line">zln</span><br><span class="line">zln</span><br><span class="line">zln</span><br><span class="line">zln</span><br><span class="line">zln</span><br><span class="line">zln</span><br><span class="line">zln</span><br><span class="line">100</span><br><span class="line">男</span><br></pre></td></tr></table></figure>

<p>各位看客可以进行运行一下，运行很快，说明Redis集群的性能不错。</p>
<h3 id="集群常用命令"><a href="#集群常用命令" class="headerlink" title="集群常用命令"></a>集群常用命令</h3><p><strong>集群</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cluster info ：打印集群的信息</span><br><span class="line">cluster nodes ：列出集群当前已知的所有节点（ node），以及这些节点的相关信息。</span><br></pre></td></tr></table></figure>

<p><strong>节点</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cluster meet &lt;ip&gt; &lt;port&gt; ：将 ip 和 port 所指定的节点添加到集群当中，让它成为集群的一份子。</span><br><span class="line">cluster forget &lt;node_id&gt; ：从集群中移除 node_id 指定的节点。</span><br><span class="line">cluster replicate &lt;node_id&gt; ：将当前节点设置为 node_id 指定的节点的从节点。</span><br><span class="line">cluster saveconfig ：将节点的配置文件保存到硬盘里面。</span><br></pre></td></tr></table></figure>
<p><strong>槽(slot)</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cluster addslots &lt;slot&gt; [slot ...] ：将一个或多个槽（ slot）指派（ assign）给当前节点。</span><br><span class="line">cluster delslots &lt;slot&gt; [slot ...] ：移除一个或多个槽对当前节点的指派。</span><br><span class="line">cluster flushslots ：移除指派给当前节点的所有槽，让当前节点变成一个没有指派任何槽的节点。</span><br><span class="line">cluster setslot &lt;slot&gt; node &lt;node_id&gt; ：将槽 slot 指派给 node_id 指定的节点，如果槽已经指派给</span><br><span class="line">另一个节点，那么先让另一个节点删除该槽&gt;，然后再进行指派。</span><br><span class="line">cluster setslot &lt;slot&gt; migrating &lt;node_id&gt; ：将本节点的槽 slot 迁移到 node_id 指定的节点中。</span><br><span class="line">cluster setslot &lt;slot&gt; importing &lt;node_id&gt; ：从 node_id 指定的节点中导入槽 slot 到本节点。</span><br><span class="line">cluster setslot &lt;slot&gt; stable ：取消对槽 slot 的导入（ import）或者迁移（ migrate）。</span><br></pre></td></tr></table></figure>

<p><strong>键</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cluster keyslot &lt;key&gt; ：计算键 key 应该被放置在哪个槽上。</span><br><span class="line">cluster countkeysinslot &lt;slot&gt; ：返回槽 slot 目前包含的键值对数量。</span><br><span class="line">cluster getkeysinslot &lt;slot&gt; &lt;count&gt; ：返回 count 个 slot 槽中的键</span><br></pre></td></tr></table></figure>

<h3 id="集群操作"><a href="#集群操作" class="headerlink" title="集群操作"></a>集群操作</h3><h4 id="新加节点"><a href="#新加节点" class="headerlink" title="新加节点"></a>新加节点</h4><p>按照之前搭建的集群方式新增2个节点：（一主一从 master、slave）<br>     Master：1007                Slave：1008</p>
<p>步骤一：创建1007/1008文件夹。拷贝redis.conf文件到对于的1007,1008目录下 要             进行修改配置文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@zln111 redis-cluster]# mkdir 1007</span><br><span class="line">[root@zln111 redis-cluster]# mkdir 1008</span><br><span class="line">[root@zln111 redis-cluster]# cd 1001</span><br><span class="line">[root@zln111 1001]# cp redis.conf &#x2F;usr&#x2F;local&#x2F;redis-cluster&#x2F;1007&#x2F;</span><br><span class="line">[root@zln111 1001]# cp redis.conf &#x2F;usr&#x2F;local&#x2F;redis-cluster&#x2F;1008&#x2F;</span><br><span class="line">[root@zln111 1001]# vim &#x2F;usr&#x2F;local&#x2F;redis-cluster&#x2F;1007&#x2F;redis.conf</span><br><span class="line">[root@zln111 1001]# vim &#x2F;usr&#x2F;local&#x2F;redis-cluster&#x2F;1008&#x2F;redis.conf</span><br></pre></td></tr></table></figure>
<p>1007/redis.conf修改内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">port:1007</span><br><span class="line">dir &#x2F;usr&#x2F;local&#x2F;redis-cluster&#x2F;1007&#x2F;</span><br><span class="line">cluster-config-file nodes1007.conf</span><br></pre></td></tr></table></figure>

<p>1008/redis.conf修改内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">port:1008</span><br><span class="line">dir &#x2F;usr&#x2F;local&#x2F;redis-cluster&#x2F;1008&#x2F;</span><br><span class="line">cluster-config-file nodes1008.conf</span><br></pre></td></tr></table></figure>

<p>步骤二：启动1007和1008这2个服务并查看服务状态。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@zln111 1001]# &#x2F;usr&#x2F;local&#x2F;redis&#x2F;bin&#x2F;redis-server &#x2F;usr&#x2F;local&#x2F;redis-cluster&#x2F;1007&#x2F;redis.conf </span><br><span class="line">[root@zln111111 1001]# &#x2F;usr&#x2F;local&#x2F;redis&#x2F;bin&#x2F;redis-server &#x2F;usr&#x2F;local&#x2F;redis-cluster&#x2F;1008&#x2F;redis.conf</span><br></pre></td></tr></table></figure>

<p>查看：</p>
<p><img src="http://img.bcoder.top/2017.12.02/9.png" alt="业余学习之Redis高级篇"></p>
<p><img src="http://img.bcoder.top/2017.12.02/10.png" alt="业余学习之Redis高级篇"></p>
<p>我们发现虽然1007和1008节点启动了，但是并没有加入到集群中，要向加入到集群，就需要redis-trib的命令操作了</p>
<h4 id="redis-trib命令使用"><a href="#redis-trib命令使用" class="headerlink" title="redis-trib命令使用"></a>redis-trib命令使用</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@zln111 local]# cd &#x2F;usr&#x2F;local&#x2F;redis-3.0.0&#x2F;src</span><br><span class="line">[root@zln111 src]# .&#x2F;redis-trib.rb</span><br></pre></td></tr></table></figure>
<p>命令参数如下：</p>
<p><img src="http://img.bcoder.top/2017.12.02/11.png" alt="业余学习之Redis高级篇"></p>
<p>下面来稍微解释一下常用的命令：<br>1 create：创建一个集群环境host1:port1 … hostN:portN（集群中的主从节点比例）<br>2 call：可以执行redis命令<br>3 add-node：将一个节点添加到集群里，第一个参数为新节点的ip:port，第二个参数为集群中任意一个已经存在的节点的ip:port<br>4 del-node：移除一个节点<br>5 reshard：重新分片(分配槽位)<br>6 check：检查集群状态</p>
<h4 id="将Master节点加入到集群"><a href="#将Master节点加入到集群" class="headerlink" title="将Master节点加入到集群"></a>将Master节点加入到集群</h4><p>我们来新增一个主节点1007（master）：</p>
<p>步骤一：使用add-node命令：绿色为新增节点，红色为已知存在节点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@zln111 src]# </span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;redis-3.0.0&#x2F;src&#x2F;redis-trib.rb add-node 192.168.1.111:1007 192.168.1.111:1001</span><br></pre></td></tr></table></figure>
<p>192.168.1.111:1001表示集群中任意的一个节点<br>192.168.1.111:1007表示新加入的节点</p>
<p>操作结果如下：</p>
<p><img src="http://img.bcoder.top/2017.12.02/12.png" alt="业余学习之Redis高级篇"></p>
<p>步骤二：查看集群状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@zln111 src]# &#x2F;usr&#x2F;local&#x2F;redis&#x2F;bin&#x2F;redis-cli -c -h 192.168.1.111 -p 1001</span><br><span class="line">192.168.1.111:1001&gt; cluster  nodes</span><br></pre></td></tr></table></figure>
<p>注意：当添加节点成功以后，新增的节点不会有任何数据，因为它没有分配任何的slot（hash槽）。我们需要为新节点手工分配slot。</p>
<p><img src="http://img.bcoder.top/2017.12.02/13.png" alt="业余学习之Redis高级篇"></p>
<h4 id="为新加入的Master分配slot槽"><a href="#为新加入的Master分配slot槽" class="headerlink" title="为新加入的Master分配slot槽"></a>为新加入的Master分配slot槽</h4><p>步骤一：使用redis-trib命令，找到集群中的任意一个<strong>主节点</strong>，对其进行重新分片工作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@zln111 src]# &#x2F;usr&#x2F;local&#x2F;redis-3.0.0&#x2F;src&#x2F;redis-trib.rb reshard 192.168.1.111:1001</span><br></pre></td></tr></table></figure>
<p>输出如下:</p>
<p><img src="http://img.bcoder.top/2017.12.02/14.png" alt="业余学习之Redis高级篇"></p>
<p><img src="http://img.bcoder.top/2017.12.02/15.png" alt="业余学习之Redis高级篇"></p>
<p><img src="http://img.bcoder.top/2017.12.02/16.png" alt="业余学习之Redis高级篇"></p>
<p>我们对上面的①，②，③进行解释一下：</p>
<p>①：是希望你需要多少个槽移动到新的节点上，可以自己设置，比如500个槽。<br>②：是你需要把这500个slot槽移动到那个节点上去（需要指定节点id），并且下个提示是输入all为从所有主节点（1001 1002 1003）中分别抽取响应的槽数（一共为500个槽到指定的新节点中，并且会打印执行分片的计划。）</p>
<p>③：输入yes确认开始执行分片任务。在最后我们再次看一下集群状态：</p>
<p><img src="http://img.bcoder.top/2017.12.02/17.png" alt="业余学习之Redis高级篇"></p>
<p>如上图所示，现在我们的1007已经有slot槽了，也就是说可以在1007上进行读写数据啦！到此为止我们的1007已经加入到集群中啦，并且是主节点（Master）</p>
<p>我们下面看一下能否将数据放入1007中：</p>
<h4 id="将Slave节点加入到集群"><a href="#将Slave节点加入到集群" class="headerlink" title="将Slave节点加入到集群"></a>将Slave节点加入到集群</h4><p>添加从节点（1008）到集群中去，步骤如下：</p>
<p>步骤一：还是需要执行add-node命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@zln111 src]# </span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;redis-3.0.0&#x2F;src&#x2F;redis-trib.rb add-node 192.168.1.111:1008 192.168.1.111:1001</span><br></pre></td></tr></table></figure>
<p>结果如下:</p>
<p><img src="http://img.bcoder.top/2017.12.02/18.png" alt="业余学习之Redis高级篇"></p>
<p>提示添加成功后我们继续看一下集群的状态:</p>
<p><img src="http://img.bcoder.top/2017.12.02/19.png" alt="业余学习之Redis高级篇"></p>
<p>如图所示，还是一个master节点，没有被分配任何的slot槽。</p>
<p>步骤二：我们需要执行replicate命令来指定当前节点（从节点）的主节点id为哪个。<br>首先需要登录新加的1008节点的客户端，然后使用集群命令进行操作，把当前的1008（slave）节点指定到一个主节点下（这里使用之前创建的1007主节点,也就是下方的cadc74cba223ddae59b495be280a835882f48f65）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@zln111 src]# &#x2F;usr&#x2F;local&#x2F;redis&#x2F;bin&#x2F;redis-cli -c -h 192.168.1.111 -p 1008</span><br><span class="line">192.168.1.111:1008&gt; cluster replicate cadc74cba223ddae59b495be280a835882f48f65</span><br><span class="line">192.168.1.111:1008&gt; </span><br><span class="line">OK（提示OK则操作成功）</span><br></pre></td></tr></table></figure>
<p>我们继续看一下当前集群的状态，如下图：我们已经成功的把1008放到1007这个主节点下面了，到此为止我们已经成功的添加完一个从节点了。</p>
<p><img src="http://img.bcoder.top/2017.12.02/20.png" alt="业余学习之Redis高级篇"></p>
<h4 id="将新加入集群的slave节点移除"><a href="#将新加入集群的slave节点移除" class="headerlink" title="将新加入集群的slave节点移除"></a>将新加入集群的slave节点移除</h4><p>我们现在尝试删除一个节点（1008 slave）<br>步骤一：删除从节点1008，输入del-node命令，指定删除节点ip和端口，以及节点id（8211dbd5712e91b9104748c3f0a3acd31874f871）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@zln111 src]# &#x2F;usr&#x2F;local&#x2F;redis-3.0.0&#x2F;src&#x2F;redis-trib.rb del-node 192.168.1.111:1008 8211dbd5712e91b9104748c3f0a3acd31874f871</span><br></pre></td></tr></table></figure>
<p>操作如下：</p>
<p><img src="http://img.bcoder.top/2017.12.02/21.png" alt="业余学习之Redis高级篇"></p>
<p>步骤二：再次查看一下集群状态，如下图所示，我们已经成功的移除了1008 slave节点，另外我们发现移除一个节点以后，当前节点的服务进程也会随之销毁。可以使用ps命令查看当前的服务（ps -el | grep redis），发现少了一个运行的server，也就是刚移除的1008从节点。</p>
<p><img src="http://img.bcoder.top/2017.12.02/22.png" alt="业余学习之Redis高级篇"></p>
<h4 id="将新加入集群的master节点移除"><a href="#将新加入集群的master节点移除" class="headerlink" title="将新加入集群的master节点移除"></a>将新加入集群的master节点移除</h4><p>我们尝试删除之前加入的主节点1007，这个步骤会相对比较麻烦一些，因为主节点的里面是有分配了slot槽的，所以我们这里必须先把1007里的slot槽放入到其他的可用主节点中去，然后再进行移除节点操作才行，不然会出现数据丢失问题。</p>
<p>步骤一：删除1007（master）节点之前，我们需要先把其全部的数据（slot槽）移动到其他节点上去（redis3.0.0只能把master的数据迁移到一个节点上，暂时做不了平均分配功能）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@zln111 src]# &#x2F;usr&#x2F;local&#x2F;redis-3.0.0&#x2F;src&#x2F;redis-trib.rb reshard 192.168.1.111:1007</span><br></pre></td></tr></table></figure>

<p>操作如下：</p>
<p><img src="http://img.bcoder.top/2017.12.02/23.png" alt="业余学习之Redis高级篇"></p>
<p>①：这里不会是正好500个槽，一般来说少一个，也就是499</p>
<p>②：这里是需要把数据移动到哪？1001的主节点id</p>
<p>③：这里是需要数据源，也就是我们的1007节点id</p>
<p>④：这里直接输入done 开始生成迁移计划(不能使用all)</p>
<p>到此为止我们已经成功的把1007主节点的数据迁移到1001上去了，我们可以看一下现在的集群状态如下图，你会发现1007下面已经没有任何数据（slot）槽了，证明迁移成功！</p>
<p><img src="http://img.bcoder.top/2017.12.02/24.png" alt="业余学习之Redis高级篇"></p>
<p>步骤二：最后我们直接使用del-node命令删除1007主节点即可（cadc74cba223ddae59b495be280a835882f48f65）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@zln111 ~]# &#x2F;usr&#x2F;local&#x2F;redis-3.0.0&#x2F;src&#x2F;redis-trib.rb del-node 192.168.1.111:1007 cadc74cba223ddae59b495be280a835882f48f65</span><br></pre></td></tr></table></figure>

<p>操作结果如下：</p>
<p><img src="http://img.bcoder.top/2017.12.02/25.png" alt="业余学习之Redis高级篇"></p>
<p>最后：我们查看集群状态，一切还原为最初始状态(槽位略有变化)</p>
<p><img src="http://img.bcoder.top/2017.12.02/26.png" alt="业余学习之Redis高级篇"></p>
<h2 id="Spring整合Redis集群"><a href="#Spring整合Redis集群" class="headerlink" title="Spring整合Redis集群"></a>Spring整合Redis集群</h2><p>Spring整合Redis集群其实相对来说比较简单，首先一点是引入jedis的jar包，其次和上面Jedis代码差不多，只是，初始化代码变成在xml中配置完成，我们根据当前的环境配置如下：</p>
<p>applicationContext-cluster.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:p</span>=<span class="string">"http://www.springframework.org/schema/p"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xmlns:jee</span>=<span class="string">"http://www.springframework.org/schema/jee"</span> <span class="attr">xmlns:tx</span>=<span class="string">"http://www.springframework.org/schema/tx"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xsi:schemaLocation</span>=<span class="string">"  </span></span></span><br><span class="line"><span class="tag"><span class="string">            http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd  </span></span></span><br><span class="line"><span class="tag"><span class="string">            http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">"classpath:redis.properties"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.x.redis.dao"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jedisPoolConfig"</span> <span class="attr">class</span>=<span class="string">"redis.clients.jedis.JedisPoolConfig"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxIdle"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.maxIdle&#125;"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxTotal"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.maxActive&#125;"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxWaitMillis"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.maxWait&#125;"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"testOnBorrow"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.testOnBorrow&#125;"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"hostport1"</span> <span class="attr">class</span>=<span class="string">"redis.clients.jedis.HostAndPort"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">"host"</span> <span class="attr">value</span>=<span class="string">"192.168.1.111"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">"port"</span> <span class="attr">value</span>=<span class="string">"1006"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"hostport2"</span> <span class="attr">class</span>=<span class="string">"redis.clients.jedis.HostAndPort"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">"host"</span> <span class="attr">value</span>=<span class="string">"192.168.1.111"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">"port"</span> <span class="attr">value</span>=<span class="string">"1001"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"hostport3"</span> <span class="attr">class</span>=<span class="string">"redis.clients.jedis.HostAndPort"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">"host"</span> <span class="attr">value</span>=<span class="string">"192.168.1.111"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">"port"</span> <span class="attr">value</span>=<span class="string">"1002"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"hostport4"</span> <span class="attr">class</span>=<span class="string">"redis.clients.jedis.HostAndPort"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">"host"</span> <span class="attr">value</span>=<span class="string">"192.168.1.111"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">"port"</span> <span class="attr">value</span>=<span class="string">"1003"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"hostport5"</span> <span class="attr">class</span>=<span class="string">"redis.clients.jedis.HostAndPort"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">"host"</span> <span class="attr">value</span>=<span class="string">"192.168.1.111"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">"port"</span> <span class="attr">value</span>=<span class="string">"1004"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"hostport6"</span> <span class="attr">class</span>=<span class="string">"redis.clients.jedis.HostAndPort"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">"host"</span> <span class="attr">value</span>=<span class="string">"192.168.1.111"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">"port"</span> <span class="attr">value</span>=<span class="string">"1005"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"redisCluster"</span> <span class="attr">class</span>=<span class="string">"redis.clients.jedis.JedisCluster"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">"nodes"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"hostport1"</span> /&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"hostport2"</span> /&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"hostport3"</span> /&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"hostport4"</span> /&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"hostport5"</span> /&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"hostport6"</span> /&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">"timeout"</span> <span class="attr">value</span>=<span class="string">"6000"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">"poolConfig"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"jedisPoolConfig"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>配置文件比较简单，熟悉Spring的童鞋应该都能看懂。</p>
<h2 id="基于Redis的Session共享"><a href="#基于Redis的Session共享" class="headerlink" title="基于Redis的Session共享"></a>基于Redis的Session共享</h2><p>session基于redis共享有两种基本的方案 </p>
<p>1、基于容器自身的扩展，比如tomcat的session-manage，可以参考如下<br>地址进行配置<a href="https://github.com/jcoleman/tomcat-redis-session-manager" target="_blank" rel="noopener">https://github.com/jcoleman/tomcat-redis-session-manager</a> </p>
<p>这个方案只适用tomcat容器，而且容器需要配置，这里不具体展开，有需要的可以参考上面的地址进行配置。但是这个方案有一个好处，可以适用于struts2和springmvc的场景，而且对springmvc没有版本要求。</p>
<p>2、基于spring-session的方案，spring-session的好处不仅仅是session共享，它还可以应用于多终端session共享，websocket，restful api等场景。下面具体说明一下<br>配置。特别说明spring-session是基于springmvc4.0以后的版本的，所以版本不匹配的就不能使用。</p>
<p>mave配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.session&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-session-data-redis&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;version&gt;1.2.2.RELEASE&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;type&gt;pom&lt;&#x2F;type&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-web&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;version&gt;4.2.9.RELEASE&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<p>spring.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id&#x3D;&quot;redisHttpSessionConfiguration&quot;  class&#x3D;&quot;org.springframework.session.data.redis.config.annotation.web.http.RedisHttpSessionConfiguration&quot; &gt;</span><br><span class="line">    &lt;property name&#x3D;&quot;maxInactiveIntervalInSeconds&quot; value&#x3D;&quot;1800&quot; &#x2F;&gt;</span><br><span class="line">&lt;&#x2F;bean&gt;</span><br><span class="line"></span><br><span class="line">&lt;bean class&#x3D;&quot;org.springframework.data.redis.connection.jedis.JedisConnectionFactory&quot;&gt;</span><br><span class="line">    &lt;property name&#x3D;&quot;hostName&quot; value&#x3D;&quot;192.168.17.24&quot; &#x2F;&gt;</span><br><span class="line">    &lt;property name&#x3D;&quot;port&quot; value&#x3D;&quot;6379&quot; &#x2F;&gt;</span><br><span class="line">&lt;&#x2F;bean&gt;</span><br></pre></td></tr></table></figure>

<p>web.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 分布式Session共享Filter --&gt;</span><br><span class="line">&lt;filter&gt;</span><br><span class="line">    &lt;filter-name&gt;springSessionRepositoryFilter&lt;&#x2F;filter-name&gt;</span><br><span class="line">    &lt;filter-class&gt;org.springframework.web.filter.DelegatingFilterProxy&lt;&#x2F;filter-class&gt;</span><br><span class="line">&lt;&#x2F;filter&gt;</span><br><span class="line"></span><br><span class="line">&lt;filter-mapping&gt;</span><br><span class="line">    &lt;filter-name&gt;springSessionRepositoryFilter&lt;&#x2F;filter-name&gt;</span><br><span class="line">    &lt;url-pattern&gt;&#x2F;*&lt;&#x2F;url-pattern&gt;</span><br><span class="line">    &lt;dispatcher&gt;REQUEST&lt;&#x2F;dispatcher&gt;</span><br><span class="line">    &lt;dispatcher&gt;ERROR&lt;&#x2F;dispatcher&gt;</span><br><span class="line">&lt;&#x2F;filter-mapping&gt;</span><br></pre></td></tr></table></figure>






          
            <br>
            
  
    
    

<section class="widget copyright  desktop mobile">
  <div class='content'>
    
      <blockquote>
        
          
            <p>博客内容遵循 署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</p>

          
        
          
            <p>本文永久链接是：<a href=https://www.bcoder.top/2017/12/02/%E4%B8%9A%E4%BD%99%E5%AD%A6%E4%B9%A0%E4%B9%8BRedis%E9%AB%98%E7%BA%A7%E7%AF%87/>https://www.bcoder.top/2017/12/02/%E4%B8%9A%E4%BD%99%E5%AD%A6%E4%B9%A0%E4%B9%8BRedis%E9%AB%98%E7%BA%A7%E7%AF%87/</a></p>
          
        
      </blockquote>
    
  </div>
</section>

  

  
    
    

<section class="widget qrcode  desktop mobile">
  

  <div class='content article-entry'>
    
      
        <div class='fancybox'><img src='https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/qrcode/wiki_volantis.png'
        
          height='64px'
        ></div>
      
    
      
        <div class='fancybox'><img src='https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/qrcode/wiki_volantis.png'
        
          height='64px'
        ></div>
      
    
  </div>
</section>

  


          
        </div>
        
          


  <section class='meta' id="footer-meta">
    <div class='new-meta-box'>
      
        
          <div class="new-meta-item date" itemprop="dateUpdated" datetime="2020-01-21T18:44:04+08:00">
  <a class='notlink'>
    <i class="fas fa-edit fa-fw" aria-hidden="true"></i>
    <p>更新于：2020-01-21 18:44:04</p>
  </a>
</div>

        
      
        
          
  
  <div class="new-meta-item meta-tags"><a class="tag" href="/tags/Redis/" rel="nofollow"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i><p>Redis</p></a></div> <div class="new-meta-item meta-tags"><a class="tag" href="/tags/%E9%9B%86%E7%BE%A4/" rel="nofollow"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i><p>集群</p></a></div>


        
      
        
          

        
      
        
          
  <div class="new-meta-item share -mob-share-list">
  <div class="-mob-share-list share-body">
    
      
        <a class="-mob-share-qq" title="" rel="external nofollow noopener noreferrer"
          
          href="http://connect.qq.com/widget/shareqq/index.html?url=https://www.bcoder.top/2017/12/02/%E4%B8%9A%E4%BD%99%E5%AD%A6%E4%B9%A0%E4%B9%8BRedis%E9%AB%98%E7%BA%A7%E7%AF%87/&title=业余学习之Redis高级篇 - zln's blog&summary=
引言

本系列主要是业余知识拓展（java相关方面的知识）的学习笔记，便于以后查看和复习。"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/qq.png">
          
        </a>
      
    
      
        <a class="-mob-share-qzone" title="" rel="external nofollow noopener noreferrer"
          
          href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://www.bcoder.top/2017/12/02/%E4%B8%9A%E4%BD%99%E5%AD%A6%E4%B9%A0%E4%B9%8BRedis%E9%AB%98%E7%BA%A7%E7%AF%87/&title=业余学习之Redis高级篇 - zln's blog&summary=
引言

本系列主要是业余知识拓展（java相关方面的知识）的学习笔记，便于以后查看和复习。"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/qzone.png">
          
        </a>
      
    
      
        <a class="-mob-share-weibo" title="" rel="external nofollow noopener noreferrer"
          
          href="http://service.weibo.com/share/share.php?url=https://www.bcoder.top/2017/12/02/%E4%B8%9A%E4%BD%99%E5%AD%A6%E4%B9%A0%E4%B9%8BRedis%E9%AB%98%E7%BA%A7%E7%AF%87/&title=业余学习之Redis高级篇 - zln's blog&summary=
引言

本系列主要是业余知识拓展（java相关方面的知识）的学习笔记，便于以后查看和复习。"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/weibo.png">
          
        </a>
      
    
  </div>
</div>



        
      
    </div>
  </section>


        
        
          <div class="prev-next">
            
              <a class='prev' href='/2017/12/02/%E4%B8%9A%E4%BD%99%E5%AD%A6%E4%B9%A0%E4%B9%8BShell/'>
                <p class='title'><i class="fas fa-chevron-left" aria-hidden="true"></i>业余学习之Shell</p>
                <p class='content'>
引言

本系列主要是业余知识拓展（java相关方面的知识）的学习笔记，便于以后查看和复习。


Shell简介Shell本身是一个用C语言编写的程序，它是用户使用Unix/Linux的桥梁，用...</p>
              </a>
            
            
              <a class='next' href='/2017/11/28/%E4%B8%9A%E4%BD%99%E5%AD%A6%E4%B9%A0%E4%B9%8BRedis%E4%B8%AD%E7%BA%A7%E7%AF%87/'>
                <p class='title'>业余学习之Redis中级篇<i class="fas fa-chevron-right" aria-hidden="true"></i></p>
                <p class='content'>
引言

本系列主要是业余知识拓展（java相关方面的知识） 的学习笔记，便于以后查看和复习。


Redis高级命令1、测试是否连接到redis
1）ping，返回pong，说明连接成功；
2...</p>
              </a>
            
          </div>
        
      </section>
    </article>
  

  
    <!-- 显示推荐文章和评论 -->



  <article class="post white-box comments shadow">
    <section class="article typo">
      <p ct><i class='fas fa-comments'></i> 评论</p>
      
      
      
      
      
        <section id="comments">
          <div id="valine_container" class="valine_thread">
            <i class="fas fa-spinner fa-spin fa-fw"></i>
          </div>
        </section>
      
    </section>
  </article>


  




<!-- 根据页面mathjax变量决定是否加载MathJax数学公式js -->



  <script>
    window.subData = {
      title: '业余学习之Redis高级篇',
      tools: true
    }
  </script>


</div>
<aside class='l_side'>
  
  

  
    
    


  <section class="widget toc-wrapper shadow desktop mobile">
    
  <header>
    
      <i class="fas fa-list fa-fw" aria-hidden="true"></i><span class='name'>本文目录</span>
    
  </header>


    <div class='content'>
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis集群"><span class="toc-number">1.</span> <span class="toc-text">Redis集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis集群简介"><span class="toc-number">1.1.</span> <span class="toc-text">Redis集群简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis集群搭建"><span class="toc-number">1.2.</span> <span class="toc-text">Redis集群搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#集群测试"><span class="toc-number">1.3.</span> <span class="toc-text">集群测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#java操作Redis集群-Jedis"><span class="toc-number">2.</span> <span class="toc-text">java操作Redis集群(Jedis)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#集群常用命令"><span class="toc-number">2.1.</span> <span class="toc-text">集群常用命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#集群操作"><span class="toc-number">2.2.</span> <span class="toc-text">集群操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#新加节点"><span class="toc-number">2.2.1.</span> <span class="toc-text">新加节点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#redis-trib命令使用"><span class="toc-number">2.2.2.</span> <span class="toc-text">redis-trib命令使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#将Master节点加入到集群"><span class="toc-number">2.2.3.</span> <span class="toc-text">将Master节点加入到集群</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#为新加入的Master分配slot槽"><span class="toc-number">2.2.4.</span> <span class="toc-text">为新加入的Master分配slot槽</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#将Slave节点加入到集群"><span class="toc-number">2.2.5.</span> <span class="toc-text">将Slave节点加入到集群</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#将新加入集群的slave节点移除"><span class="toc-number">2.2.6.</span> <span class="toc-text">将新加入集群的slave节点移除</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#将新加入集群的master节点移除"><span class="toc-number">2.2.7.</span> <span class="toc-text">将新加入集群的master节点移除</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring整合Redis集群"><span class="toc-number">3.</span> <span class="toc-text">Spring整合Redis集群</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基于Redis的Session共享"><span class="toc-number">4.</span> <span class="toc-text">基于Redis的Session共享</span></a></li></ol>
    </div>
  </section>


  


</aside>


  
  <footer class="clearfix">
    <br><br>
    
      
        <br>
        <div class="social-wrapper">
          
            
              <a href="https://www.bcoder.top"
                class="social fas fa-rss flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
            
              <a href="mailto:me@xaoxuu.com"
                class="social fas fa-envelope flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
            
              <a href="https://github.com/zlnnjit"
                class="social fab fa-github flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
            
              <a href="https://music.163.com/#/user/home?id=430673592"
                class="social fas fa-headphones-alt flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
        </div>
      
    
      
        Use
        <a href="https://bcoder.top/" target="_blank" class="codename">周陆宁</a>
        as theme
        
          , 
          total visits
          <span id="busuanzi_value_site_pv"><i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span>
          times
        
      
    
      
        <div class='copyright'>
        <p><a href="https://bocder.top" target="_blank" rel="noopener">Copyright © 2016-2020 zlnnjit</a></p>

        </div>
      
    
  </footer>

<script>setLoadingBarProgress(80);</script>


      <script>setLoadingBarProgress(60);</script>
    </div>
    <a class="s-top fas fa-arrow-up fa-fw" href='javascript:void(0)'></a>
  </div>
  
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4/dist/jquery.min.js"></script>


  <script>
    
    var SEARCH_SERVICE = "hexo" || "hexo";
    var ROOT = "/" || "/";
    if (!ROOT.endsWith('/')) ROOT += '/';
  </script>


  <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2/js/instant_page.js" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>



  
<script src="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js"></script>

  <script type="text/javascript">
    $(function() {
      Waves.attach('.flat-btn', ['waves-button']);
      Waves.attach('.float-btn', ['waves-button', 'waves-float']);
      Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);
      Waves.attach('.flat-box', ['waves-block']);
      Waves.attach('.float-box', ['waves-block', 'waves-float']);
      Waves.attach('.waves-image');
      Waves.init();
    });
  </script>


  <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js"></script>



  
  
  
    
<script src="https://cdn.jsdelivr.net/npm/jquery-backstretch@2.1.18/jquery.backstretch.min.js"></script>

    <script type="text/javascript">
      $(function(){
        var imgs=["https://cdn.jsdelivr.net/gh/xaoxuu/cdn-wallpaper/abstract/41F215B9-261F-48B4-80B5-4E86E165259E.jpeg"];
        if ('true' == 'true') {
          function shuffle(arr){
            /*From countercurrent-time*/
            var n = arr.length;
            while(n--) {
              var index = Math.floor(Math.random() * n);
              var temp = arr[index];
              arr[index] = arr[n];
              arr[n] = temp;
            }
          }
          shuffle(imgs);
        }
        if ('.cover') {
          $('.cover').backstretch(
            imgs,
          {
            duration: "20000",
            fade: "1500"
          });
        } else {
          $.backstretch(
            imgs,
          {
            duration: "20000",
            fade: "1500"
          });
        }
      });
    </script>
  



  
    
<script src="https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.js" async></script>

  
    
<script src="https://cdn.jsdelivr.net/npm/meting@2.0/dist/Meting.min.js" async></script>

  








  
    
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2.2.0/js/valine.js"></script>

  
  <script>
  var GUEST_INFO = ['nick','mail','link'];
  var guest_info = 'nick,mail,link'.split(',').filter(function(item){
    return GUEST_INFO.indexOf(item) > -1
  });
  var notify = 'true' == true;
  var verify = 'true' == true;
  var valine = new Valine();
  valine.init({
    el: '#valine_container',
    notify: notify,
    verify: verify,
    guest_info: guest_info,
    
    appId: "M3YhrSNLSJTxyKwa8hGSGbH7-gzGzoHsz",
    appKey: "RwjMsAULtRweeA4GtaqJGPVu",
    placeholder: "快来评论吧~",
    pageSize:'10',
    avatar:'mp',
    lang:'zh-cn',
    visitor: 'false',
    highlight:'true'
  })
  </script>



  
<script src="/js/app.js"></script>



  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2.1/js/search.js"></script>



  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2/js/comment_typing.js"></script>



<!-- 复制 -->

  <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="fas fa-copy"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copyed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('fa-copy');
        $icon.addClass('fa-clipboard-check');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPYED';
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('fa-copy');
        $icon.addClass('fa-exclamation-triangle');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
      });
    }
    initCopyCode();
  }(window, document);
</script>




<!-- fancybox -->

  <script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script>
  let LAZY_LOAD_IMAGE = "";
  $(".article-entry").find("div.fancybox").find("img").each(function () {
      var element = document.createElement("a");
      $(element).attr("data-fancybox", "gallery");
      $(element).attr("href", $(this).attr("src"));
      /* 图片采用懒加载处理时,
       * 一般图片标签内会有个属性名来存放图片的真实地址，比如 data-original,
       * 那么此处将原本的属性名src替换为对应属性名data-original,
       * 修改如下
       */
       if (LAZY_LOAD_IMAGE) {
         $(element).attr("href", $(this).attr("data-original"));
       }
      $(this).wrap(element);
  });
</script>






  <script>setLoadingBarProgress(100);</script>
</body>
</html>

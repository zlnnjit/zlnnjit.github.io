<!DOCTYPE html>
<html>
<head hexo-theme='https://volantis.js.org/#2020'>
  <meta charset="utf-8">
  <!-- SEO相关 -->
  
    
  
  <!-- 渲染优化 -->
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <!-- 页面元数据 -->
  
    <title>业余学习之Zookeeper深入篇 - zln&#39;s blog</title>
  
    <meta name="keywords" content="分布式,Zookeeper,集群,zkClient,Curator框架,分布式锁">
  
  
    <meta name="description" content="
引言本系列主要是业余知识拓展（java相关方面的知识）的学习笔记，便于以后查看和复习。
">
  

  <!-- feed -->
  

  <!-- import meta -->
  

  <!-- link -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css">
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">

  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css">

  

  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.css">
  

  <!-- import link -->
  

  
    
<link rel="stylesheet" href="/css/style.css">

  

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>

  
  
</head>

<body>
  
  <div class="cover-wrapper">
    
      <cover class='cover post half'>
        <div class='cover-body'>
  <div class='a'>
    
    
      <p class="title">bcoder.top</p>
    
    
      <p class="subtitle">不忘初心，无畏前行</p>
    
  </div>
  <div class='b'>
    
      <div class="m_search">
        <form name="searchform" class="form u-search-form">
          <input type="text" class="input u-search-input" placeholder="" />
          <i class="icon fas fa-search fa-fw"></i>
        </form>
      </div>
    
    <div class='menu navigation'>
      <ul class='h-list'>
        
          
            <li>
              <a class="nav home"
                href="/"
                
                
                id="home">
                <i class='fas fa-rss fa-fw'></i>&nbsp;博客
              </a>
            </li>
          
            <li>
              <a class="nav home"
                href="/categories/"
                
                
                id="categories">
                <i class='fas fa-folder-open fa-fw'></i>&nbsp;分类
              </a>
            </li>
          
            <li>
              <a class="nav home"
                href="/tags/"
                
                
                id="tags">
                <i class='fas fa-tags fa-fw'></i>&nbsp;标签
              </a>
            </li>
          
            <li>
              <a class="nav home"
                href="/archives/"
                
                
                id="archives">
                <i class='fas fa-archive fa-fw'></i>&nbsp;归档
              </a>
            </li>
          
        
      </ul>
    </div>
  </div>
</div>

      </cover>
    
    <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>
<header class="l_header shadow blur">

  <div class='wrapper'>
    <div class='nav-sub container--flex'>
      <a class="logo flat-box"></a>
      <ul class='switcher h-list'>
        <li><a class="s-comment flat-btn fas fa-comments fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
          <li><a class="s-toc flat-btn fas fa-list fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
      </ul>
    </div>
		<div class="nav-main container container--flex">
      
        
        <a class="logo flat-box" target="_self" href='/'>
          
          
          
          
            周陆宁 <b><sup style='color:#3AA757'>2020</sup></b>
          
        </a>
      

			<div class='menu navigation'>
				<ul class='h-list'>
          
          
          
            
            
              <li>
                <a class="flat-box" href=/
                  
                  
                  
                    id="home"
                  >
                  
                    <i class='fas fa-rss fa-fw'></i>
                  
                  博客
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=/categories/
                  
                  
                  
                    id="categories"
                  >
                  
                    <i class='fas fa-folder-open fa-fw'></i>
                  
                  分类
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=/tags/
                  
                  
                  
                    id="tags"
                  >
                  
                    <i class='fas fa-tags fa-fw'></i>
                  
                  标签
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=/archives/
                  
                  
                  
                    id="archives"
                  >
                  
                    <i class='fas fa-archive fa-fw'></i>
                  
                  归档
                </a>
                
              </li>
            
          
          
				</ul>
			</div>

      
        <div class="m_search">
          <form name="searchform" class="form u-search-form">
            <i class="icon fas fa-search fa-fw"></i>
            <input type="text" class="input u-search-input" placeholder="搜索" />
          </form>
        </div>
      

			<ul class='switcher h-list'>
				
					<li><a class="s-search flat-btn fas fa-search fa-fw" target="_self" href='javascript:void(0)'></a></li>
				
				<li><a class="s-menu flat-btn fas fa-bars fa-fw" target="_self" href='javascript:void(0)'></a></li>
			</ul>
		</div>
	</div>
</header>
<ul class="menu-phone navigation white-box">
  
  
    <li>
      <a class="flat-box" href=/
        
        
        
          id="home"
        >
        
          <i class='fas fa-rss fa-fw'></i>
        
        博客
      </a>
    </li>
  
    <li>
      <a class="flat-box" href=/categories/
        
        
        
          id="categories"
        >
        
          <i class='fas fa-folder-open fa-fw'></i>
        
        分类
      </a>
    </li>
  
    <li>
      <a class="flat-box" href=/tags/
        
        
        
          id="tags"
        >
        
          <i class='fas fa-tags fa-fw'></i>
        
        标签
      </a>
    </li>
  
    <li>
      <a class="flat-box" href=/archives/
        
        
        
          id="archives"
        >
        
          <i class='fas fa-archive fa-fw'></i>
        
        归档
      </a>
    </li>
  
    <li>
      <a class="flat-box" href=/friends/
        
        
        
          id="friends"
        >
        
          <i class='fas fa-link fa-fw'></i>
        
        友链
      </a>
    </li>
  
    <li>
      <a class="flat-box" href=/about/
        
        
        
          id="about"
        >
        
          <i class='fas fa-info-circle fa-fw'></i>
        
        关于
      </a>
    </li>
  
</ul>
<script>setLoadingBarProgress(40);</script>

  </div>


  <div class="l_body">
    <div class='body-wrapper'>
      

<div class='l_main'>
  

  
    <article id="post" class="post white-box shadow article-type-post" itemscope itemprop="blogPost">
      


  <section class='meta'>
    
    
    <div class="meta" id="header-meta">
      
        
  
    <h1 class="title">
      <a href="/2018/01/27/%E4%B8%9A%E4%BD%99%E5%AD%A6%E4%B9%A0%E4%B9%8BZookeeper%E6%B7%B1%E5%85%A5%E7%AF%87/">
        业余学习之Zookeeper深入篇
      </a>
    </h1>
  


      
      <div class='new-meta-box'>
        
          
        
          
            
<div class='new-meta-item author'>
  <a href="" rel="nofollow">
    <img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/avatar/avatar.png">
    <p>周陆宁</p>
  </a>
</div>

          
        
          
            
  
  <div class='new-meta-item category'>
    <a href='/categories/deep/' rel="nofollow">
      <i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>
      <p>deep</p>
    </a>
  </div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i>
    <p>发布于：2018-01-27 22:44:18</p>
  </a>
</div>

          
        
          
            
  <div class="new-meta-item wordcount">
    <a class='notlink'>
      <i class="fas fa-keyboard fa-fw" aria-hidden="true"></i>
      <p>字数：15.5k</p>
    </a>
  </div>
  <div class="new-meta-item readtime">
    <a class='notlink'>
      <i class="fas fa-hourglass-half fa-fw" aria-hidden="true"></i>
      <p>时长：75 分钟</p>
    </a>
  </div>


          
        
          
            

          
        
      </div>
      
        <hr>
      
    </div>
  </section>


      <section class="article typo">
        <div class="article-entry" itemprop="articleBody">
          
          <blockquote>
<p>引言<br>本系列主要是业余知识拓展（java相关方面的知识）的学习笔记，便于以后查看和复习。</p>
</blockquote>
<a id="more"></a>

<h2 id="Zookeeper-watcher"><a href="#Zookeeper-watcher" class="headerlink" title="Zookeeper watcher"></a>Zookeeper watcher</h2><p>ookeeper有watch事件，是一次性触发的。当watch监视的数据发生变化时，通知在创建Zookeeper是设置了Watcher的客户端。</p>
<p>Watcher类监视的事件类型和状态类型如下所示：<br><strong>事件类型（znode节点相关）：</strong><br>①EventType.NodeCreated：节点创建<br>②EventType.NodeDataChanged：节点数据变更<br>③EventType.NodeChildrenChanged：子节点变更<br>④EventType.NodeDeleted：节点删除</p>
<p><strong>状态类型（客户端实例相关）：</strong><br>①KeeperState.Disconnected：未连接<br>②KeeperState.SyncConnected：已连接<br>③KeeperState.AuthFailed：认证失败<br>④KeeperState.Expired：会话失效</p>
<p><strong>Watcher的特性：一次性、客户端串行执行、轻量。</strong></p>
<p>一次性：对于Zookeeper的Watcher，只需要记住一点：Zookeeper的<code>watch事件</code>是一次性触发的。当watch监视的数据发生变化时，通知设置了该watch的客户端，即<code>watcher</code>。由于Zookeeper的监视都是一次性的，所以每次必须设置监控。</p>
<p>客户端串行执行：客户端Watcher回调的过程是一个串行同步的过程，这为我们保证了顺序，同时需要注意一点，千万不要因为一个Watcher的处理逻辑影响了这个客户端的Watcher回调。</p>
<p>轻量：WatchedEvent是Zookeeper整个Wacher通知机制的最小通知单元，整个数据结构只包含三部分：<strong>通知状态、事件类型和节点路径</strong>。也就是说Watcher通知非常的简单，只会告诉客户端发生了事件而不会告知其具体内容，需要客户端自己去获取，比如NodeDataChanged事件，Zookeeper只会通知客户端指定节点的数据发生了变更，而不会直接提供具体的数据内容。</p>
<p><strong>设置监听的方法有以下方法:</strong><br>1）监听节点的创建、修改、删除，对应的事件为<strong>：NodeDataChanged\NodeCreated\NodeDeleted</strong><br>Zookeeper.exists(path, true);<br>Zookeeper.getData(path, true, null);</p>
<p>2）监听子节点创建和删除，对应的事件：<strong>NodeChildrenChanged</strong><br>Zookeeper.getChildren(path, true);</p>
<p>下面通过例子来更加深入理解Watcher:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bcoder.top.Zookeeper.watcher;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.Zookeeper.CreateMode;</span><br><span class="line"><span class="keyword">import</span> org.apache.Zookeeper.WatchedEvent;</span><br><span class="line"><span class="keyword">import</span> org.apache.Zookeeper.Watcher;</span><br><span class="line"><span class="keyword">import</span> org.apache.Zookeeper.Watcher.Event.EventType;</span><br><span class="line"><span class="keyword">import</span> org.apache.Zookeeper.Watcher.Event.KeeperState;</span><br><span class="line"><span class="keyword">import</span> org.apache.Zookeeper.ZooDefs.Ids;</span><br><span class="line"><span class="keyword">import</span> org.apache.Zookeeper.Zookeeper;</span><br><span class="line"><span class="keyword">import</span> org.apache.Zookeeper.data.Stat;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *Zookeeper Wathcher </span></span><br><span class="line"><span class="comment"> * 本类就是一个Watcher类（实现了org.apache.Zookeeper.Watcher类）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>（alienware）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2015-6-14</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> classZookeeperWatcher implements Watcher &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 定义原子变量 */</span></span><br><span class="line">	AtomicInteger seq = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line">	<span class="comment">/** 定义session失效时间 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SESSION_TIMEOUT = <span class="number">10000</span>;</span><br><span class="line">	<span class="comment">/**Zookeeper服务器地址 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String CONNECTION_ADDR = <span class="string">"192.168.1.111:2181,192.168.1.112:2181,192.168.1.113:2181"</span>;</span><br><span class="line">	<span class="comment">/**Zookeeper父路径设置 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PARENT_PATH = <span class="string">"/testWatch"</span>;</span><br><span class="line">	<span class="comment">/**Zookeeper子路径设置 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String CHILDREN_PATH = <span class="string">"/testWatch/children"</span>;</span><br><span class="line">	<span class="comment">/** 进入标识 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOG_PREFIX_OF_MAIN = <span class="string">"【Main】"</span>;</span><br><span class="line">	<span class="comment">/**Zookeeper变量 */</span></span><br><span class="line">	privateZookeeperZookeeper = <span class="keyword">null</span>;</span><br><span class="line">	<span class="comment">/** 信号量设置，用于等待Zookeeper连接建立之后 通知阻塞程序继续向下执行 */</span></span><br><span class="line">	<span class="keyword">private</span> CountDownLatch connectedSemaphore = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;B&gt;方法名称：&lt;/B&gt;测试Zookeeper监控&lt;BR&gt;</span></span><br><span class="line"><span class="comment">     * &lt;B&gt;概要说明：&lt;/B&gt;主要测试watch功能&lt;BR&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//建立watcher</span></span><br><span class="line">       ZookeeperWatcherZookeeperWatch = newZookeeperWatcher();</span><br><span class="line">        <span class="comment">//创建连接</span></span><br><span class="line">       ZookeeperWatch.createConnection(CONNECTION_ADDR, SESSION_TIMEOUT);</span><br><span class="line">        <span class="comment">//System.out.println(ZookeeperWatch.Zookeeper.toString());</span></span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 清理节点</span></span><br><span class="line">       ZookeeperWatch.deleteAllTestPath(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ZookeeperWatch.createPath(PARENT_PATH, System.currentTimeMillis() + <span class="string">""</span>,<span class="keyword">true</span>)) &#123;<span class="comment">//进入process(Watcher-1和Watcher-2)</span></span><br><span class="line"></span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 读取数据</span></span><br><span class="line">            System.out.println(<span class="string">"---------------------- read parent ----------------------------"</span>);</span><br><span class="line">           ZookeeperWatch.readData(PARENT_PATH, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 读取子节点</span></span><br><span class="line">            System.out.println(<span class="string">"---------------------- read children path ----------------------------"</span>);</span><br><span class="line">           ZookeeperWatch.getChildren(PARENT_PATH, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 更新数据</span></span><br><span class="line">           ZookeeperWatch.writeData(PARENT_PATH, System.currentTimeMillis() + <span class="string">""</span>);<span class="comment">//进入process（Watcher-3）</span></span><br><span class="line"></span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建子节点(不能隔代监控孙子节点的变化)</span></span><br><span class="line">           ZookeeperWatch.createPath(CHILDREN_PATH, System.currentTimeMillis() + <span class="string">""</span>, <span class="keyword">true</span>);<span class="comment">//进入process（Watcher-4/Watcher-5）</span></span><br><span class="line"></span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            <span class="comment">//创建子节点的子节点</span></span><br><span class="line">           ZookeeperWatch.createPath(CHILDREN_PATH+<span class="string">"/c1"</span>, System.currentTimeMillis() + <span class="string">""</span>, <span class="keyword">true</span>);<span class="comment">//进入process（Watcher-6）</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 子节点修改数据</span></span><br><span class="line">           ZookeeperWatch.writeData(CHILDREN_PATH, System.currentTimeMillis() + <span class="string">""</span>);<span class="comment">//进入process（Watcher-7）</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">50000</span>);</span><br><span class="line">        <span class="comment">// 清理节点</span></span><br><span class="line">       ZookeeperWatch.deleteAllTestPath(<span class="keyword">false</span>);</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">       ZookeeperWatch.releaseConnection();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 创建Zookeeper连接</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> connectAddrZookeeper服务器地址列表</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> sessionTimeout Session超时时间</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createConnection</span><span class="params">(String connectAddr, <span class="keyword">int</span> sessionTimeout)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.releaseConnection();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">		    <span class="comment">//本类实现了Watcher接口，因此用this</span></span><br><span class="line">			Zookeeper = newZookeeper(connectAddr, sessionTimeout, <span class="keyword">this</span>);</span><br><span class="line">			System.out.println(LOG_PREFIX_OF_MAIN + <span class="string">"开始连接Zookeeper服务器"</span>);</span><br><span class="line">			connectedSemaphore.await();</span><br><span class="line">            System.out.println(LOG_PREFIX_OF_MAIN + <span class="string">"成功连接Zookeeper服务器"</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 关闭Zookeeper连接</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">releaseConnection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.Zookeeper != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="keyword">this</span>.Zookeeper.close();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 创建节点</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> path 节点路径</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> data 数据内容</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> needWatch 是否需要监控</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">createPath</span><span class="params">(String path, String data, <span class="keyword">boolean</span> needWatch)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">//设置监控(由于Zookeeper的监控都是一次性的所以 每次必须设置监控)</span></span><br><span class="line">			<span class="keyword">this</span>.Zookeeper.exists(path, needWatch);</span><br><span class="line">			System.out.println(LOG_PREFIX_OF_MAIN + <span class="string">"节点创建成功, Path: "</span> + </span><br><span class="line">							   <span class="keyword">this</span>.Zookeeper.create(	<span class="comment">/**路径*/</span> </span><br><span class="line">									   			path, </span><br><span class="line">									   			<span class="comment">/**数据*/</span></span><br><span class="line">									   			data.getBytes(), </span><br><span class="line">									   			<span class="comment">/**所有可见*/</span></span><br><span class="line">								   				Ids.OPEN_ACL_UNSAFE, </span><br><span class="line">								   				<span class="comment">/**永久存储*/</span></span><br><span class="line">								   				CreateMode.PERSISTENT ) + 	</span><br><span class="line">							   <span class="string">", content: "</span> + data);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 读取指定节点数据内容</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> path 节点路径</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">readData</span><span class="params">(String path, <span class="keyword">boolean</span> needWatch)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> String(<span class="keyword">this</span>.Zookeeper.getData(path, needWatch, <span class="keyword">null</span>));</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">			<span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 更新指定节点数据内容</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> path 节点路径</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> data 数据内容</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">writeData</span><span class="params">(String path, String data)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			System.out.println(LOG_PREFIX_OF_MAIN + <span class="string">"更新数据成功，path："</span> + path + <span class="string">", stat: "</span> +</span><br><span class="line">								<span class="keyword">this</span>.Zookeeper.setData(path, data.getBytes(), -<span class="number">1</span>));</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 删除指定节点</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> path</span></span><br><span class="line"><span class="comment">	 *            节点path</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteNode</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">this</span>.Zookeeper.delete(path, -<span class="number">1</span>);</span><br><span class="line">			System.out.println(LOG_PREFIX_OF_MAIN + <span class="string">"删除节点成功，path："</span> + path);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 判断指定节点是否存在</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> path 节点路径</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Stat <span class="title">exists</span><span class="params">(String path, <span class="keyword">boolean</span> needWatch)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">this</span>.Zookeeper.exists(path, needWatch);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 获取子节点</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> path 节点路径</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> List&lt;String&gt; <span class="title">getChildren</span><span class="params">(String path, <span class="keyword">boolean</span> needWatch)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">this</span>.Zookeeper.getChildren(path, needWatch);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 删除所有节点</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> needWatch</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteAllTestPath</span><span class="params">(<span class="keyword">boolean</span> needWatch)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">this</span>.exists(CHILDREN_PATH, needWatch) != <span class="keyword">null</span>)&#123;</span><br><span class="line">			<span class="keyword">this</span>.deleteNode(CHILDREN_PATH);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">this</span>.exists(PARENT_PATH, needWatch) != <span class="keyword">null</span>)&#123;</span><br><span class="line">			<span class="keyword">this</span>.deleteNode(PARENT_PATH);</span><br><span class="line">		&#125;		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 收到来自Server的Watcher通知后的处理。</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent event)</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">		System.out.println(<span class="string">"-----------------Watcher监听到变化，进入process方法------------------------------"</span>);</span><br><span class="line">        System.out.println(<span class="string">"事件event: "</span> + event);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">			Thread.sleep(<span class="number">200</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (event == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 连接状态</span></span><br><span class="line">		KeeperState keeperState = event.getState();</span><br><span class="line">		<span class="comment">// 事件类型</span></span><br><span class="line">		EventType eventType = event.getType();</span><br><span class="line">		<span class="comment">// 受影响的path</span></span><br><span class="line">		String path = event.getPath();</span><br><span class="line">		</span><br><span class="line">		String logPrefix = <span class="string">"【Watcher-"</span> + <span class="keyword">this</span>.seq.incrementAndGet() + <span class="string">"】"</span>;</span><br><span class="line"></span><br><span class="line">		System.out.println(logPrefix + <span class="string">"收到Watcher通知"</span>);</span><br><span class="line">		System.out.println(logPrefix + <span class="string">"连接状态:\t"</span> + keeperState.toString());</span><br><span class="line">		System.out.println(logPrefix + <span class="string">"事件类型:\t"</span> + eventType.toString());</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (KeeperState.SyncConnected == keeperState) &#123;</span><br><span class="line">			<span class="comment">// 成功连接上Zookeeper服务器</span></span><br><span class="line">			<span class="keyword">if</span> (EventType.None == eventType) &#123;</span><br><span class="line">				System.out.println(logPrefix + <span class="string">"成功连接上Zookeeper服务器"</span>);</span><br><span class="line">				connectedSemaphore.countDown();</span><br><span class="line">			&#125; </span><br><span class="line">			<span class="comment">//创建节点</span></span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (EventType.NodeCreated == eventType) &#123;</span><br><span class="line">				System.out.println(logPrefix + <span class="string">"节点创建"</span>);</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					Thread.sleep(<span class="number">100</span>);</span><br><span class="line">				&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">this</span>.exists(path, <span class="keyword">true</span>);</span><br><span class="line">			&#125; </span><br><span class="line">			<span class="comment">//更新节点</span></span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (EventType.NodeDataChanged == eventType) &#123;</span><br><span class="line">				System.out.println(logPrefix + <span class="string">"节点数据更新"</span>);</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					Thread.sleep(<span class="number">100</span>);</span><br><span class="line">				&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">				System.out.println(logPrefix + <span class="string">"数据内容: "</span> + <span class="keyword">this</span>.readData(PARENT_PATH, <span class="keyword">true</span>));</span><br><span class="line">			&#125; </span><br><span class="line">			<span class="comment">//更新子节点</span></span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (EventType.NodeChildrenChanged == eventType) &#123;</span><br><span class="line">				System.out.println(logPrefix + <span class="string">"子节点变更"</span>);</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">				&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">				System.out.println(logPrefix + <span class="string">"子节点列表："</span> + <span class="keyword">this</span>.getChildren(PARENT_PATH, <span class="keyword">true</span>));</span><br><span class="line">			&#125; </span><br><span class="line">			<span class="comment">//删除节点</span></span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (EventType.NodeDeleted == eventType) &#123;</span><br><span class="line">				System.out.println(logPrefix + <span class="string">"节点 "</span> + path + <span class="string">" 被删除"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> ;</span><br><span class="line">		&#125; </span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (KeeperState.Disconnected == keeperState) &#123;</span><br><span class="line">			System.out.println(logPrefix + <span class="string">"与Zookeeper服务器断开连接"</span>);</span><br><span class="line">		&#125; </span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (KeeperState.AuthFailed == keeperState) &#123;</span><br><span class="line">			System.out.println(logPrefix + <span class="string">"权限检查失败"</span>);</span><br><span class="line">		&#125; </span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (KeeperState.Expired == keeperState) &#123;</span><br><span class="line">			System.out.println(logPrefix + <span class="string">"会话失效"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">【Main】开始连接Zookeeper服务器</span><br><span class="line">-----------------Watcher监听到变化，进入process方法------------------------------</span><br><span class="line">事件event: WatchedEvent state:SyncConnected type:None path:null</span><br><span class="line">【Watcher-1】收到Watcher通知</span><br><span class="line">【Watcher-1】连接状态:	SyncConnected</span><br><span class="line">【Watcher-1】事件类型:	None</span><br><span class="line">【Watcher-1】成功连接上Zookeeper服务器</span><br><span class="line">【Main】成功连接Zookeeper服务器</span><br><span class="line">-----------------Watcher监听到变化，进入process方法------------------------------</span><br><span class="line">事件event: WatchedEvent state:SyncConnected type:NodeCreated path:&#x2F;testWatch</span><br><span class="line">【Main】节点创建成功, Path: &#x2F;testWatch, content: 1517024484731</span><br><span class="line">【Watcher-2】收到Watcher通知</span><br><span class="line">【Watcher-2】连接状态:	SyncConnected</span><br><span class="line">【Watcher-2】事件类型:	NodeCreated</span><br><span class="line">【Watcher-2】节点创建</span><br><span class="line">---------------------- read parent ----------------------------</span><br><span class="line">---------------------- read children path ----------------------------</span><br><span class="line">-----------------Watcher监听到变化，进入process方法------------------------------</span><br><span class="line">事件event: WatchedEvent state:SyncConnected type:NodeDataChanged path:&#x2F;testWatch</span><br><span class="line">【Main】更新数据成功，path：&#x2F;testWatch, stat: 25769803865,25769803866,1517024484845,1517024485898,1,0,0,0,13,0,25769803865</span><br><span class="line"></span><br><span class="line">【Watcher-3】收到Watcher通知</span><br><span class="line">【Watcher-3】连接状态:	SyncConnected</span><br><span class="line">【Watcher-3】事件类型:	NodeDataChanged</span><br><span class="line">【Watcher-3】节点数据更新</span><br><span class="line">【Watcher-3】数据内容: 1517024485795</span><br><span class="line">-----------------Watcher监听到变化，进入process方法------------------------------</span><br><span class="line">事件event: WatchedEvent state:SyncConnected type:NodeCreated path:&#x2F;testWatch&#x2F;children</span><br><span class="line">【Main】节点创建成功, Path: &#x2F;testWatch&#x2F;children, content: 1517024486800</span><br><span class="line">【Watcher-4】收到Watcher通知</span><br><span class="line">【Watcher-4】连接状态:	SyncConnected</span><br><span class="line">【Watcher-4】事件类型:	NodeCreated</span><br><span class="line">【Watcher-4】节点创建</span><br><span class="line">-----------------Watcher监听到变化，进入process方法------------------------------</span><br><span class="line">事件event: WatchedEvent state:SyncConnected type:NodeChildrenChanged path:&#x2F;testWatch</span><br><span class="line">【Watcher-5】收到Watcher通知</span><br><span class="line">【Watcher-5】连接状态:	SyncConnected</span><br><span class="line">【Watcher-5】事件类型:	NodeChildrenChanged</span><br><span class="line">【Watcher-5】子节点变更</span><br><span class="line">【Main】节点创建成功, Path: &#x2F;testWatch&#x2F;children&#x2F;c1, content: 1517024487810</span><br><span class="line">【Main】更新数据成功，path：&#x2F;testWatch&#x2F;children, stat: 25769803867,25769803869,1517024486906,1517024487919,1,1,0,0,13,1,25769803868</span><br><span class="line"></span><br><span class="line">【Watcher-5】子节点列表：[children]</span><br><span class="line">-----------------Watcher监听到变化，进入process方法------------------------------</span><br><span class="line">事件event: WatchedEvent state:SyncConnected type:NodeCreated path:&#x2F;testWatch&#x2F;children&#x2F;c1</span><br><span class="line">【Watcher-6】收到Watcher通知</span><br><span class="line">【Watcher-6】连接状态:	SyncConnected</span><br><span class="line">【Watcher-6】事件类型:	NodeCreated</span><br><span class="line">【Watcher-6】节点创建</span><br><span class="line">-----------------Watcher监听到变化，进入process方法------------------------------</span><br><span class="line">事件event: WatchedEvent state:SyncConnected type:NodeDataChanged path:&#x2F;testWatch&#x2F;children</span><br><span class="line">【Watcher-7】收到Watcher通知</span><br><span class="line">【Watcher-7】连接状态:	SyncConnected</span><br><span class="line">【Watcher-7】事件类型:	NodeDataChanged</span><br><span class="line">【Watcher-7】节点数据更新</span><br><span class="line">【Watcher-7】数据内容: 1517024485795</span><br></pre></td></tr></table></figure>

<h2 id="Zookeeper-ACL权限认证"><a href="#Zookeeper-ACL权限认证" class="headerlink" title="Zookeeper ACL权限认证"></a>Zookeeper ACL权限认证</h2><p>ACL（Access Control List），Zookeeper作为一个分布式协调框架，其内部存储的都是一些关乎分布式系统运行时状态的元数据，尤其是涉及到一些分布式锁、Master选举和协调等应用场景。我们需要有效的保障Zookeeper中的数据安全，Zookeeper提供了一套完善的ACL权限控制机制来保障数据的安全。</p>
<p>Zookeeper提供了三种模式，权限模式、授权对象、权限。</p>
<p>权限模式：Scheme，开发人员经常使用如下四种权限模式：<br><strong>①IP</strong>：ip模式通过ip地址粒度来进行权限控制，例如配置了：ip:192.168.1.107，即表示权限控制都是针对这个ip地址的，同时也支持按网段分配，比如：192.168.1.<em>。<br>*</em>②Digest<strong>：digest是最常用的权限控制模式，也更符合对权限的认知。其类似于“username:password”形式的权限控制标识进行权限配置。Zookeeper会对形成的权限标识先后进行两次编码处理，分别是SHA-1加密算法和BASE64编码。<br>**③World</strong>：World是一种最开放的权限控制模式。这种模式可以看做为特殊的digest，它仅仅是一个标识而已。<br><strong>④Super</strong>：超级用户模式。在超级用户模式下可以对Zookeeper进行任意操作。<br>权限对象：指的是权限赋予给用户或者一个指定的实体，例如IP地址或机器等。在不同的模式下，授权对象是不同的。这种模式和授权对象一一对应。</p>
<p>权限：权限就是指那些通过权限检测后可以被允许执行的操作，在Zookeeper中，对数据的操作权限分为以下五大类：CREATE、DELETE、READ、WRITE、ADMIN</p>
<p>下面来看具体的应用实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bcoder.top.Zookeeper.auth;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.Zookeeper.CreateMode;</span><br><span class="line"><span class="keyword">import</span> org.apache.Zookeeper.WatchedEvent;</span><br><span class="line"><span class="keyword">import</span> org.apache.Zookeeper.Watcher;</span><br><span class="line"><span class="keyword">import</span> org.apache.Zookeeper.Watcher.Event.EventType;</span><br><span class="line"><span class="keyword">import</span> org.apache.Zookeeper.Watcher.Event.KeeperState;</span><br><span class="line"><span class="keyword">import</span> org.apache.Zookeeper.ZooDefs.Ids;</span><br><span class="line"><span class="keyword">import</span> org.apache.Zookeeper.Zookeeper;</span><br><span class="line"><span class="keyword">import</span> org.apache.Zookeeper.data.ACL;</span><br><span class="line"><span class="keyword">import</span> org.apache.Zookeeper.data.Stat;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *Zookeeper 节点授权</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>（alienware）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2015-6-14</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> classZookeeperAuth implements Watcher &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 连接地址 */</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">static</span> String CONNECT_ADDR = <span class="string">"192.168.1.111:2181,192.168.1.112:2181,192.168.1.113:2181"</span>;</span><br><span class="line">	<span class="comment">/** 测试路径 */</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">static</span> String PATH = <span class="string">"/testAuth"</span>;</span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">static</span> String PATH_DEL = <span class="string">"/testAuth/delNode"</span>;</span><br><span class="line">	<span class="comment">/** 认证类型 */</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">static</span> String authentication_type = <span class="string">"digest"</span>;</span><br><span class="line">	<span class="comment">/** 认证正确方法 */</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">static</span> String correctAuthentication = <span class="string">"123456"</span>;</span><br><span class="line">	<span class="comment">/** 认证错误方法 */</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">static</span> String badAuthentication = <span class="string">"654321"</span>;</span><br><span class="line">	</span><br><span class="line">	staticZookeeperZookeeper = <span class="keyword">null</span>;</span><br><span class="line">	<span class="comment">/** 计时器 */</span></span><br><span class="line">	AtomicInteger seq = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line">	<span class="comment">/** 标识 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOG_PREFIX_OF_MAIN = <span class="string">"【Main】"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> CountDownLatch connectedSemaphore = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">       ZookeeperAuth testAuth = newZookeeperAuth();</span><br><span class="line">        testAuth.createConnection(CONNECT_ADDR,<span class="number">2000</span>);</span><br><span class="line">        List&lt;ACL&gt; acls = <span class="keyword">new</span> ArrayList&lt;ACL&gt;(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">for</span> (ACL ids_acl : Ids.CREATOR_ALL_ACL) &#123;</span><br><span class="line">            acls.add(ids_acl);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">           Zookeeper.create(PATH, <span class="string">"init content"</span>.getBytes(), acls, CreateMode.PERSISTENT);</span><br><span class="line">            System.out.println(<span class="string">"使用授权key："</span> + correctAuthentication + <span class="string">"创建节点："</span>+ PATH + <span class="string">", 初始内容是: init content"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">           Zookeeper.create(PATH_DEL, <span class="string">"will be deleted! "</span>.getBytes(), acls, CreateMode.PERSISTENT);</span><br><span class="line">            System.out.println(<span class="string">"使用授权key："</span> + correctAuthentication + <span class="string">"创建节点："</span>+ PATH_DEL + <span class="string">", 初始内容是: init content"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取数据</span></span><br><span class="line">        getDataByNoAuthentication();</span><br><span class="line">        getDataByBadAuthentication();</span><br><span class="line">        getDataByCorrectAuthentication();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 更新数据</span></span><br><span class="line">        updateDataByNoAuthentication();</span><br><span class="line">        updateDataByBadAuthentication();</span><br><span class="line">        updateDataByCorrectAuthentication();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 删除数据</span></span><br><span class="line">        deleteNodeByBadAuthentication();</span><br><span class="line">        deleteNodeByNoAuthentication();</span><br><span class="line">        deleteNodeByCorrectAuthentication();</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">        deleteParent();</span><br><span class="line">        <span class="comment">//释放连接</span></span><br><span class="line">        testAuth.releaseConnection();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent event)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Thread.sleep(<span class="number">200</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (event==<span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 连接状态</span></span><br><span class="line">		KeeperState keeperState = event.getState();</span><br><span class="line">		<span class="comment">// 事件类型</span></span><br><span class="line">		EventType eventType = event.getType();</span><br><span class="line">		<span class="comment">// 受影响的path</span></span><br><span class="line">		String path = event.getPath();</span><br><span class="line">		</span><br><span class="line">		String logPrefix = <span class="string">"【Watcher-"</span> + <span class="keyword">this</span>.seq.incrementAndGet() + <span class="string">"】"</span>;</span><br><span class="line"></span><br><span class="line">		System.out.println(logPrefix + <span class="string">"收到Watcher通知"</span>);</span><br><span class="line">		System.out.println(logPrefix + <span class="string">"连接状态:\t"</span> + keeperState.toString());</span><br><span class="line">		System.out.println(logPrefix + <span class="string">"事件类型:\t"</span> + eventType.toString());</span><br><span class="line">		<span class="keyword">if</span> (KeeperState.SyncConnected == keeperState) &#123;</span><br><span class="line">			<span class="comment">// 成功连接上Zookeeper服务器</span></span><br><span class="line">			<span class="keyword">if</span> (EventType.None == eventType) &#123;</span><br><span class="line">				System.out.println(logPrefix + <span class="string">"成功连接上Zookeeper服务器"</span>);</span><br><span class="line">				connectedSemaphore.countDown();</span><br><span class="line">			&#125; </span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (KeeperState.Disconnected == keeperState) &#123;</span><br><span class="line">			System.out.println(logPrefix + <span class="string">"与Zookeeper服务器断开连接"</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (KeeperState.AuthFailed == keeperState) &#123;</span><br><span class="line">			System.out.println(logPrefix + <span class="string">"权限检查失败"</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (KeeperState.Expired == keeperState) &#123;</span><br><span class="line">			System.out.println(logPrefix + <span class="string">"会话失效"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println(<span class="string">"--------------------------------------------"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 创建Zookeeper连接</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> connectString</span></span><br><span class="line"><span class="comment">	 *           Zookeeper服务器地址列表</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> sessionTimeout</span></span><br><span class="line"><span class="comment">	 *            Session超时时间</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createConnection</span><span class="params">(String connectString, <span class="keyword">int</span> sessionTimeout)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.releaseConnection();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Zookeeper = newZookeeper(connectString, sessionTimeout, <span class="keyword">this</span>);</span><br><span class="line">			<span class="comment">//添加节点授权</span></span><br><span class="line">			Zookeeper.addAuthInfo(authentication_type,correctAuthentication.getBytes());</span><br><span class="line">			System.out.println(LOG_PREFIX_OF_MAIN + <span class="string">"开始连接Zookeeper服务器"</span>);</span><br><span class="line">			<span class="comment">//倒数等待</span></span><br><span class="line">			connectedSemaphore.await();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 关闭Zookeeper连接</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">releaseConnection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.Zookeeper!=<span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="keyword">this</span>.Zookeeper.close();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 获取数据：采用错误的密码 */</span></span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getDataByBadAuthentication</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		String prefix = <span class="string">"[使用错误的授权信息]"</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Zookeeper badZookeeper = newZookeeper(CONNECT_ADDR, <span class="number">2000</span>, <span class="keyword">null</span>);</span><br><span class="line">			<span class="comment">//授权</span></span><br><span class="line">			badZookeeper.addAuthInfo(authentication_type,badAuthentication.getBytes());</span><br><span class="line">			Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">			System.out.println(prefix + <span class="string">"获取数据："</span> + PATH);</span><br><span class="line">			System.out.println(prefix + <span class="string">"成功获取数据："</span> + badZookeeper.getData(PATH, <span class="keyword">false</span>, <span class="keyword">null</span>));</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			System.err.println(prefix + <span class="string">"获取数据失败，原因："</span> + e.getMessage());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 获取数据：不采用密码 */</span></span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getDataByNoAuthentication</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		String prefix = <span class="string">"[不使用任何授权信息]"</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			System.out.println(prefix + <span class="string">"获取数据："</span> + PATH);</span><br><span class="line">			Zookeeper noZookeeper = newZookeeper(CONNECT_ADDR, <span class="number">2000</span>, <span class="keyword">null</span>);</span><br><span class="line">			Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">			System.out.println(prefix + <span class="string">"成功获取数据："</span> + noZookeeper.getData(PATH, <span class="keyword">false</span>, <span class="keyword">null</span>));</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			System.err.println(prefix + <span class="string">"获取数据失败，原因："</span> + e.getMessage());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 采用正确的密码 */</span></span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getDataByCorrectAuthentication</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		String prefix = <span class="string">"[使用正确的授权信息]"</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			System.out.println(prefix + <span class="string">"获取数据："</span> + PATH);</span><br><span class="line">			</span><br><span class="line">			System.out.println(prefix + <span class="string">"成功获取数据："</span> +Zookeeper.getData(PATH, <span class="keyword">false</span>, <span class="keyword">null</span>));</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			System.out.println(prefix + <span class="string">"获取数据失败，原因："</span> + e.getMessage());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 更新数据：不采用密码</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">updateDataByNoAuthentication</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		String prefix = <span class="string">"[不使用任何授权信息]"</span>;</span><br><span class="line"></span><br><span class="line">		System.out.println(prefix + <span class="string">"更新数据： "</span> + PATH);</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Zookeeper noZookeeper = newZookeeper(CONNECT_ADDR, <span class="number">2000</span>, <span class="keyword">null</span>);</span><br><span class="line">			Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">			Stat stat = noZookeeper.exists(PATH, <span class="keyword">false</span>);</span><br><span class="line">			<span class="keyword">if</span> (stat!=<span class="keyword">null</span>) &#123;</span><br><span class="line">				noZookeeper.setData(PATH, prefix.getBytes(), -<span class="number">1</span>);</span><br><span class="line">				System.out.println(prefix + <span class="string">"更新成功"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			System.err.println(prefix + <span class="string">"更新失败，原因是："</span> + e.getMessage());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 更新数据：采用错误的密码</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">updateDataByBadAuthentication</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		String prefix = <span class="string">"[使用错误的授权信息]"</span>;</span><br><span class="line"></span><br><span class="line">		System.out.println(prefix + <span class="string">"更新数据："</span> + PATH);</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Zookeeper badZookeeper = newZookeeper(CONNECT_ADDR, <span class="number">2000</span>, <span class="keyword">null</span>);</span><br><span class="line">			<span class="comment">//授权</span></span><br><span class="line">			badZookeeper.addAuthInfo(authentication_type,badAuthentication.getBytes());</span><br><span class="line">			Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">			Stat stat = badZookeeper.exists(PATH, <span class="keyword">false</span>);</span><br><span class="line">			<span class="keyword">if</span> (stat!=<span class="keyword">null</span>) &#123;</span><br><span class="line">				badZookeeper.setData(PATH, prefix.getBytes(), -<span class="number">1</span>);</span><br><span class="line">				System.out.println(prefix + <span class="string">"更新成功"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			System.err.println(prefix + <span class="string">"更新失败，原因是："</span> + e.getMessage());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 更新数据：采用正确的密码</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">updateDataByCorrectAuthentication</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		String prefix = <span class="string">"[使用正确的授权信息]"</span>;</span><br><span class="line"></span><br><span class="line">		System.out.println(prefix + <span class="string">"更新数据："</span> + PATH);</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Stat stat =Zookeeper.exists(PATH, <span class="keyword">false</span>);</span><br><span class="line">			<span class="keyword">if</span> (stat!=<span class="keyword">null</span>) &#123;</span><br><span class="line">				Zookeeper.setData(PATH, prefix.getBytes(), -<span class="number">1</span>);</span><br><span class="line">				System.out.println(prefix + <span class="string">"更新成功"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			System.err.println(prefix + <span class="string">"更新失败，原因是："</span> + e.getMessage());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 不使用密码 删除节点</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">deleteNodeByNoAuthentication</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">		String prefix = <span class="string">"[不使用任何授权信息]"</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			System.out.println(prefix + <span class="string">"删除节点："</span> + PATH_DEL);</span><br><span class="line">			Zookeeper noZookeeper = newZookeeper(CONNECT_ADDR, <span class="number">2000</span>, <span class="keyword">null</span>);</span><br><span class="line">			Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">			Stat stat = noZookeeper.exists(PATH_DEL, <span class="keyword">false</span>);</span><br><span class="line">			<span class="keyword">if</span> (stat!=<span class="keyword">null</span>) &#123;</span><br><span class="line">				noZookeeper.delete(PATH_DEL,-<span class="number">1</span>);</span><br><span class="line">				System.out.println(prefix + <span class="string">"删除成功"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			System.err.println(prefix + <span class="string">"删除失败，原因是："</span> + e.getMessage());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 采用错误的密码删除节点</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">deleteNodeByBadAuthentication</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">		String prefix = <span class="string">"[使用错误的授权信息]"</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			System.out.println(prefix + <span class="string">"删除节点："</span> + PATH_DEL);</span><br><span class="line">			Zookeeper badZookeeper = newZookeeper(CONNECT_ADDR, <span class="number">2000</span>, <span class="keyword">null</span>);</span><br><span class="line">			<span class="comment">//授权</span></span><br><span class="line">			badZookeeper.addAuthInfo(authentication_type,badAuthentication.getBytes());</span><br><span class="line">			Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">			Stat stat = badZookeeper.exists(PATH_DEL, <span class="keyword">false</span>);</span><br><span class="line">			<span class="keyword">if</span> (stat!=<span class="keyword">null</span>) &#123;</span><br><span class="line">				badZookeeper.delete(PATH_DEL, -<span class="number">1</span>);</span><br><span class="line">				System.out.println(prefix + <span class="string">"删除成功"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			System.err.println(prefix + <span class="string">"删除失败，原因是："</span> + e.getMessage());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 使用正确的密码删除节点</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">deleteNodeByCorrectAuthentication</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">		String prefix = <span class="string">"[使用正确的授权信息]"</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			System.out.println(prefix + <span class="string">"删除节点："</span> + PATH_DEL);</span><br><span class="line">			Stat stat =Zookeeper.exists(PATH_DEL, <span class="keyword">false</span>);</span><br><span class="line">			<span class="keyword">if</span> (stat!=<span class="keyword">null</span>) &#123;</span><br><span class="line">				Zookeeper.delete(PATH_DEL, -<span class="number">1</span>);</span><br><span class="line">				System.out.println(prefix + <span class="string">"删除成功"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			System.out.println(prefix + <span class="string">"删除失败，原因是："</span> + e.getMessage());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 使用正确的密码删除节点</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">deleteParent</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Stat stat =Zookeeper.exists(PATH_DEL, <span class="keyword">false</span>);</span><br><span class="line">			<span class="keyword">if</span> (stat == <span class="keyword">null</span>) &#123;</span><br><span class="line">				Zookeeper.delete(PATH, -<span class="number">1</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">【Main】开始连接Zookeeper服务器</span><br><span class="line">【Watcher-1】收到Watcher通知</span><br><span class="line">【Watcher-1】连接状态:	SyncConnected</span><br><span class="line">【Watcher-1】事件类型:	None</span><br><span class="line">【Watcher-1】成功连接上Zookeeper服务器</span><br><span class="line">--------------------------------------------</span><br><span class="line">使用授权key：123456创建节点：&#x2F;testAuth, 初始内容是: init content</span><br><span class="line">使用授权key：123456创建节点：&#x2F;testAuth&#x2F;delNode, 初始内容是: init content</span><br><span class="line">[不使用任何授权信息]获取数据：&#x2F;testAuth</span><br><span class="line">[不使用任何授权信息]获取数据失败，原因：KeeperErrorCode &#x3D; NoAuth for &#x2F;testAuth</span><br><span class="line">[使用错误的授权信息]获取数据：&#x2F;testAuth</span><br><span class="line">[使用正确的授权信息]获取数据：&#x2F;testAuth</span><br><span class="line">[使用错误的授权信息]获取数据失败，原因：KeeperErrorCode &#x3D; NoAuth for &#x2F;testAuth</span><br><span class="line">[使用正确的授权信息]成功获取数据：[B@2530c12</span><br><span class="line">[不使用任何授权信息]更新数据： &#x2F;testAuth</span><br><span class="line">[不使用任何授权信息]更新失败，原因是：KeeperErrorCode &#x3D; NoAuth for &#x2F;testAuth</span><br><span class="line">[使用错误的授权信息]更新数据：&#x2F;testAuth</span><br><span class="line">[使用正确的授权信息]更新数据：&#x2F;testAuth</span><br><span class="line">[使用正确的授权信息]更新成功</span><br><span class="line">[使用错误的授权信息]删除节点：&#x2F;testAuth&#x2F;delNode</span><br><span class="line">[使用错误的授权信息]更新失败，原因是：KeeperErrorCode &#x3D; NoAuth for &#x2F;testAuth</span><br><span class="line">[不使用任何授权信息]删除节点：&#x2F;testAuth&#x2F;delNode</span><br><span class="line">[使用错误的授权信息]删除失败，原因是：KeeperErrorCode &#x3D; NoAuth for &#x2F;testAuth&#x2F;delNode</span><br><span class="line">[使用正确的授权信息]删除节点：&#x2F;testAuth&#x2F;delNode</span><br><span class="line">[不使用任何授权信息]删除失败，原因是：KeeperErrorCode &#x3D; NoAuth for &#x2F;testAuth&#x2F;delNode</span><br><span class="line">[使用正确的授权信息]删除成功</span><br></pre></td></tr></table></figure>

<h2 id="Zookeeper-多客户端操作"><a href="#Zookeeper-多客户端操作" class="headerlink" title="Zookeeper 多客户端操作"></a>Zookeeper 多客户端操作</h2><p>我们有时候需要动态的进行多个机器的配置文件进行更新，我们可以采用Zookeeper对分布式系统的配置文件进行管理，实现方式是多个服务（也就是分布式系统的多台机器进行Watcher），Zookeeper节点发生变化时，我们可以实时的观察数据的变化。</p>
<p>我们下面举一个例子，来模拟这种场景：</p>
<p><img src="http://img.bcoder.top/2018.01.27/1.png" alt="业余学习之Zookeeper深入篇"></p>
<p>如上图所示，我们让Client1和Client2进行对Zookeeper进行Watch，比如监听的节点为<code>/super</code>,我们用Client3进行数据更新。</p>
<p>下面来看具体的代码实现：<br>首先是Watcher接口的实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bcoder.top.Zookeeper.cluster;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.Zookeeper.CreateMode;</span><br><span class="line"><span class="keyword">import</span> org.apache.Zookeeper.KeeperException;</span><br><span class="line"><span class="keyword">import</span> org.apache.Zookeeper.WatchedEvent;</span><br><span class="line"><span class="keyword">import</span> org.apache.Zookeeper.Watcher;</span><br><span class="line"><span class="keyword">import</span> org.apache.Zookeeper.Watcher.Event.EventType;</span><br><span class="line"><span class="keyword">import</span> org.apache.Zookeeper.Watcher.Event.KeeperState;</span><br><span class="line"><span class="keyword">import</span> org.apache.Zookeeper.ZooDefs.Ids;</span><br><span class="line"><span class="keyword">import</span> org.apache.Zookeeper.Zookeeper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> classZookeeperWatcher implements Watcher &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**Zookeeper变量 */</span></span><br><span class="line">	privateZookeeperZookeeper = <span class="keyword">null</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/** 父节点path */</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">final</span> String PARENT_PATH = <span class="string">"/super"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/** 信号量设置，用于等待Zookeeper连接建立之后 通知阻塞程序继续向下执行 */</span></span><br><span class="line">	<span class="keyword">private</span> CountDownLatch connectedSemaphore = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**Zookeeper服务器地址 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String CONNECTION_ADDR = <span class="string">"192.168.1.111:2181,192.168.1.112:2181,192.168.1.113:2181"</span>;</span><br><span class="line">	<span class="comment">/** 定义session失效时间 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SESSION_TIMEOUT = <span class="number">30000</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String clientName;</span><br><span class="line"></span><br><span class="line">	publicZookeeperWatcher(String clientName) <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="keyword">this</span>.clientName = clientName;</span><br><span class="line">		Zookeeper = newZookeeper(CONNECTION_ADDR, SESSION_TIMEOUT, <span class="keyword">this</span>);</span><br><span class="line">		System.out.println(clientName+<span class="string">":开始连接Zookeeper服务器"</span>);</span><br><span class="line">		connectedSemaphore.await();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent event)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 连接状态</span></span><br><span class="line">		KeeperState keeperState = event.getState();</span><br><span class="line">		<span class="comment">// 事件类型</span></span><br><span class="line">		EventType eventType = event.getType();</span><br><span class="line">		<span class="comment">// 受影响的path</span></span><br><span class="line">		String path = event.getPath();</span><br><span class="line">		System.out.println(clientName +<span class="string">":受影响的path : "</span> + path);</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (KeeperState.SyncConnected == keeperState) &#123;</span><br><span class="line">			<span class="comment">// 成功连接上Zookeeper服务器</span></span><br><span class="line">			<span class="keyword">if</span> (EventType.None == eventType) &#123;</span><br><span class="line">				System.out.println(clientName +<span class="string">":成功连接上Zookeeper服务器"</span>);</span><br><span class="line">				connectedSemaphore.countDown();</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					<span class="keyword">if</span>(<span class="keyword">this</span>.Zookeeper.exists(PARENT_PATH, <span class="keyword">false</span>) == <span class="keyword">null</span>)&#123;</span><br><span class="line">						<span class="keyword">this</span>.Zookeeper.create(PARENT_PATH, <span class="string">"root"</span>.getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);		 </span><br><span class="line">					&#125;</span><br><span class="line">					List&lt;String&gt; paths = <span class="keyword">this</span>.Zookeeper.getChildren(PARENT_PATH, <span class="keyword">true</span>);</span><br><span class="line">					<span class="keyword">for</span> (String p : paths) &#123;</span><br><span class="line">						System.out.println(p);</span><br><span class="line">						<span class="keyword">this</span>.Zookeeper.exists(PARENT_PATH + <span class="string">"/"</span> + p, <span class="keyword">true</span>);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125; <span class="keyword">catch</span> (KeeperException | InterruptedException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;		</span><br><span class="line">			&#125; </span><br><span class="line">			<span class="comment">//创建节点</span></span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (EventType.NodeCreated == eventType) &#123;</span><br><span class="line">				System.out.println(clientName +<span class="string">":节点创建"</span>);</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					<span class="keyword">this</span>.Zookeeper.exists(path, <span class="keyword">true</span>);</span><br><span class="line">				&#125; <span class="keyword">catch</span> (KeeperException | InterruptedException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; </span><br><span class="line">			<span class="comment">//更新节点</span></span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (EventType.NodeDataChanged == eventType) &#123;</span><br><span class="line">				System.out.println(clientName +<span class="string">":节点数据更新"</span>);</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					<span class="comment">//update nodes  call function</span></span><br><span class="line">					<span class="keyword">this</span>.Zookeeper.exists(path, <span class="keyword">true</span>);</span><br><span class="line">				&#125; <span class="keyword">catch</span> (KeeperException | InterruptedException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; </span><br><span class="line">			<span class="comment">//更新子节点</span></span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (EventType.NodeChildrenChanged == eventType) &#123;</span><br><span class="line">				System.out.println(clientName +<span class="string">":子节点 ... 变更"</span>);</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					List&lt;String&gt; paths = <span class="keyword">this</span>.Zookeeper.getChildren(path, <span class="keyword">true</span>);</span><br><span class="line">					<span class="keyword">if</span>(paths.size() &gt;= list.size())&#123;</span><br><span class="line">						paths.removeAll(list);</span><br><span class="line">						<span class="keyword">for</span>(String p : paths)&#123;</span><br><span class="line">							<span class="keyword">this</span>.Zookeeper.exists(path + <span class="string">"/"</span> + p, <span class="keyword">true</span>);</span><br><span class="line">							<span class="comment">//this.Zookeeper.getChildren(path + "/" + p, true);</span></span><br><span class="line">							System.out.println(clientName +<span class="string">":这个是新增的子节点 : "</span> + path + <span class="string">"/"</span> + p);</span><br><span class="line">							<span class="comment">//add new nodes  call function</span></span><br><span class="line">						&#125;</span><br><span class="line">						list.addAll(paths);</span><br><span class="line">					&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">						list = paths;</span><br><span class="line">					&#125;</span><br><span class="line">					System.out.println(clientName +<span class="string">":list: "</span> + list.toString());</span><br><span class="line">					System.out.println(clientName +<span class="string">":paths: "</span> + paths.toString());</span><br><span class="line">					</span><br><span class="line">				&#125; <span class="keyword">catch</span> (KeeperException | InterruptedException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; </span><br><span class="line">			<span class="comment">//删除节点</span></span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (EventType.NodeDeleted == eventType) &#123;</span><br><span class="line">				System.out.println(clientName +<span class="string">":节点 "</span> + path + <span class="string">" 被删除"</span>);</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					<span class="comment">//delete nodes  call function</span></span><br><span class="line">					<span class="keyword">this</span>.Zookeeper.exists(path, <span class="keyword">true</span>);</span><br><span class="line">				&#125; <span class="keyword">catch</span> (KeeperException | InterruptedException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> ;</span><br><span class="line">		&#125; </span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (KeeperState.Disconnected == keeperState) &#123;</span><br><span class="line">			System.out.println(clientName +<span class="string">":与Zookeeper服务器断开连接"</span>);</span><br><span class="line">		&#125; </span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (KeeperState.AuthFailed == keeperState) &#123;</span><br><span class="line">			System.out.println(clientName +<span class="string">":权限检查失败"</span>);</span><br><span class="line">		&#125; </span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (KeeperState.Expired == keeperState) &#123;</span><br><span class="line">			System.out.println(clientName +<span class="string">":会话失效"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> ;</span><br><span class="line"></span><br><span class="line">		System.out.println(<span class="string">"--------------------------------------------"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们来看三个客户端的代码：<br>client1:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bcoder.top.Zookeeper.cluster;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client1</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">       ZookeeperWatcher myWatcher = newZookeeperWatcher(<span class="string">"client-1"</span>);</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">100000000</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>client2:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bcoder.top.Zookeeper.cluster;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">       ZookeeperWatcher myWatcher = newZookeeperWatcher(<span class="string">"client-2"</span>);</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">100000000</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>client3:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bcoder.top.Zookeeper.cluster;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.Zookeeper.CreateMode;</span><br><span class="line"><span class="keyword">import</span> org.apache.Zookeeper.WatchedEvent;</span><br><span class="line"><span class="keyword">import</span> org.apache.Zookeeper.Watcher;</span><br><span class="line"><span class="keyword">import</span> org.apache.Zookeeper.Watcher.Event.EventType;</span><br><span class="line"><span class="keyword">import</span> org.apache.Zookeeper.Watcher.Event.KeeperState;</span><br><span class="line"><span class="keyword">import</span> org.apache.Zookeeper.ZooDefs.Ids;</span><br><span class="line"><span class="keyword">import</span> org.apache.Zookeeper.Zookeeper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client3</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *Zookeeper地址</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String CONNECT_ADDR = <span class="string">"192.168.1.111:2181,192.168.1.112:2181,192.168.1.113:2181"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * session超时时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SESSION_OUTTIME = <span class="number">2000</span>;<span class="comment">//ms</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 信号量，阻塞程序执行，用于等待Zookeeper连接成功，发送成功信号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> CountDownLatch connectedSemaphore = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">       ZookeeperZookeeper = newZookeeper(CONNECT_ADDR, SESSION_OUTTIME, <span class="keyword">new</span> Watcher() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent event)</span> </span>&#123;</span><br><span class="line">                <span class="comment">//获取事件的状态</span></span><br><span class="line">                KeeperState keeperState = event.getState();</span><br><span class="line">                EventType eventType = event.getType();</span><br><span class="line">                <span class="comment">//如果是建立连接</span></span><br><span class="line">                <span class="keyword">if</span> (KeeperState.SyncConnected == keeperState) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (EventType.None == eventType) &#123;</span><br><span class="line">                        <span class="comment">//如果建立连接成功，则发送信号量，让后续阻塞程序向下执行</span></span><br><span class="line">                        connectedSemaphore.countDown();</span><br><span class="line">                        System.out.println(<span class="string">"client3:Zookeeper 建立连接"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//进行阻塞</span></span><br><span class="line">        connectedSemaphore.await();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建子节点</span></span><br><span class="line">       Zookeeper.create(<span class="string">"/super/c1"</span>, <span class="string">"c1"</span>.getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span><br><span class="line">        <span class="comment">//创建子节点</span></span><br><span class="line">       Zookeeper.create(<span class="string">"/super/c2"</span>, <span class="string">"c2"</span>.getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span><br><span class="line">        <span class="comment">//创建子节点</span></span><br><span class="line">       Zookeeper.create(<span class="string">"/super/c3"</span>, <span class="string">"c3"</span>.getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span><br><span class="line">        <span class="comment">//创建子节点</span></span><br><span class="line">       Zookeeper.create(<span class="string">"/super/c4"</span>, <span class="string">"c4"</span>.getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span><br><span class="line"></span><br><span class="line">       Zookeeper.create(<span class="string">"/super/c4/c44"</span>, <span class="string">"c44"</span>.getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//修改节点的值</span></span><br><span class="line">       Zookeeper.setData(<span class="string">"/super/c1"</span>, <span class="string">"modify c1"</span>.getBytes(), -<span class="number">1</span>);</span><br><span class="line">       Zookeeper.setData(<span class="string">"/super/c2"</span>, <span class="string">"modify c2"</span>.getBytes(), -<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] data =Zookeeper.getData(<span class="string">"/super/c2"</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(data));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断节点是否存在</span></span><br><span class="line">        <span class="keyword">if</span> (Zookeeper.exists(<span class="string">"/super/c3"</span>, <span class="keyword">false</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//删除节点</span></span><br><span class="line">           Zookeeper.delete(<span class="string">"/super/c3"</span>, -<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">       Zookeeper.close();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行时先启动Client1和Clien2，最后启动Client3</p>
<p>Clinet3 console:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client3:Zookeeper 建立连接</span><br></pre></td></tr></table></figure>

<p>Clinet1 console:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">client-1:开始连接Zookeeper服务器</span><br><span class="line">client-1:受影响的path : null</span><br><span class="line">client-1:成功连接上Zookeeper服务器</span><br><span class="line">--------------------------------------------</span><br><span class="line">client-1:受影响的path : &#x2F;super</span><br><span class="line">client-1:子节点 ... 变更</span><br><span class="line">client-1:这个是新增的子节点 : &#x2F;super&#x2F;c1</span><br><span class="line">client-1:list: [c1]</span><br><span class="line">client-1:paths: [c1]</span><br><span class="line">--------------------------------------------</span><br><span class="line">client-1:受影响的path : &#x2F;super</span><br><span class="line">client-1:子节点 ... 变更</span><br><span class="line">client-1:这个是新增的子节点 : &#x2F;super&#x2F;c3</span><br><span class="line">client-1:这个是新增的子节点 : &#x2F;super&#x2F;c4</span><br><span class="line">client-1:这个是新增的子节点 : &#x2F;super&#x2F;c2</span><br><span class="line">client-1:list: [c1, c3, c4, c2]</span><br><span class="line">client-1:paths: [c3, c4, c2]</span><br><span class="line">--------------------------------------------</span><br><span class="line">client-1:受影响的path : &#x2F;super&#x2F;c1</span><br><span class="line">client-1:节点数据更新</span><br><span class="line">--------------------------------------------</span><br><span class="line">client-1:受影响的path : &#x2F;super&#x2F;c3</span><br><span class="line">client-1:节点 &#x2F;super&#x2F;c3 被删除</span><br><span class="line">--------------------------------------------</span><br><span class="line">client-1:受影响的path : &#x2F;super</span><br><span class="line">client-1:子节点 ... 变更</span><br><span class="line">client-1:list: [c4, c1, c2]</span><br><span class="line">client-1:paths: [c4, c1, c2]</span><br><span class="line">--------------------------------------------</span><br></pre></td></tr></table></figure>

<p>Clinet3 console:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">client-2:开始连接Zookeeper服务器</span><br><span class="line">client-2:受影响的path : null</span><br><span class="line">client-2:成功连接上Zookeeper服务器</span><br><span class="line">--------------------------------------------</span><br><span class="line">client-2:受影响的path : &#x2F;super</span><br><span class="line">client-2:子节点 ... 变更</span><br><span class="line">client-2:这个是新增的子节点 : &#x2F;super&#x2F;c1</span><br><span class="line">client-2:list: [c1]</span><br><span class="line">client-2:paths: [c1]</span><br><span class="line">--------------------------------------------</span><br><span class="line">client-2:受影响的path : &#x2F;super</span><br><span class="line">client-2:子节点 ... 变更</span><br><span class="line">client-2:这个是新增的子节点 : &#x2F;super&#x2F;c2</span><br><span class="line">client-2:list: [c1, c2]</span><br><span class="line">client-2:paths: [c2]</span><br><span class="line">--------------------------------------------</span><br><span class="line">client-2:受影响的path : &#x2F;super</span><br><span class="line">client-2:子节点 ... 变更</span><br><span class="line">client-2:这个是新增的子节点 : &#x2F;super&#x2F;c3</span><br><span class="line">client-2:这个是新增的子节点 : &#x2F;super&#x2F;c4</span><br><span class="line">client-2:list: [c1, c2, c3, c4]</span><br><span class="line">client-2:paths: [c3, c4]</span><br><span class="line">--------------------------------------------</span><br><span class="line">client-2:受影响的path : &#x2F;super&#x2F;c1</span><br><span class="line">client-2:节点数据更新</span><br><span class="line">--------------------------------------------</span><br><span class="line">client-2:受影响的path : &#x2F;super&#x2F;c2</span><br><span class="line">client-2:节点数据更新</span><br><span class="line">--------------------------------------------</span><br><span class="line">client-2:受影响的path : &#x2F;super&#x2F;c3</span><br><span class="line">client-2:节点 &#x2F;super&#x2F;c3 被删除</span><br><span class="line">--------------------------------------------</span><br><span class="line">client-2:受影响的path : &#x2F;super</span><br><span class="line">client-2:子节点 ... 变更</span><br><span class="line">client-2:list: [c4, c1, c2]</span><br><span class="line">client-2:paths: [c4, c1, c2]</span><br><span class="line">--------------------------------------------</span><br></pre></td></tr></table></figure>


<h2 id="ZookeeperClient使用"><a href="#ZookeeperClient使用" class="headerlink" title="ZookeeperClient使用"></a>ZookeeperClient使用</h2><p>ZookeeperClient在原生API的基础上进行了封装，简化了Zookeeper的复杂性。</p>
<h3 id="ZookeeperClient节点操作方法"><a href="#ZookeeperClient节点操作方法" class="headerlink" title="ZookeeperClient节点操作方法"></a>ZookeeperClient节点操作方法</h3><p><strong>1.创建客户端方法</strong>：<code>publicZookeeperClient(IZookeeperConnectionZookeeperConnection, int connectionTimeout,ZookeeperSerializerZookeeperSerializer))</code><br><code>publicZookeeperConnection(StringZookeeperServers, int sessionTimeOut)</code></p>
<p>参数说明如下：<br>参数ZookeeperServers：Zookeeper服务器地址，用“,”分隔<br>参数sessionTimeout：会话超时时间，单位毫秒，默认为30000ms<br>参数connectionTimeout：连接超时时间<br>参数IZookeeperConnection：接口的实现类<br>参数ZookeeperSerializer：自定义序列化实现</p>
<p><strong>2.创建节点</strong><br>create、createEphemeral、createEphemeralSequential、createPersistent、createPersistentSequential</p>
<p>这些方法的主要参数说明如下：<br>参数path：节点路径<br>参数data：数据，可以传入null<br>参数mode：节点类型<br>参数cal：权限策略<br>参数callback：异步回调函数<br>参数context：上下文对象<br>参数createParents：指定是否创建父节点。</p>
<p>在这些参数里，和Zookeeper自带的api都差不多，其中data因为有了自定义的序列化工具，所以可以传入更为复杂的对象。</p>
<p><strong>3.删除节点</strong><br>delete、deleteRecursive(递归删除)</p>
<p>这些方法的主要参数说明如下：<br>参数path：节点路径<br>参数callback：异步回调函数<br>参数context：上下文对象</p>
<p><strong>4.读取节点数据</strong><br>readData<br>参数path：节点路径 </p>
<p><strong>5.读取子节点数据</strong><br>List<String> getChildren(String path)<br>参数returnNullIfPathNotExists：避免为空节点抛出异常。直接返回null<br>参数path：节点路径<br>参数stat:节点状态</p>
<p><strong>6.更新节点数据</strong><br>writeData<br>参数path：节点路径<br>参数data：数据，可以传入null<br>参数version：版本号</p>
<p><strong>7.检测节点是否存在</strong><br>exists<br>参数path：节点路径 </p>
<p>下面来看具体的代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bcoder.top.Zookeeperclient.base;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.I0Itec.Zookeeperclient.ZookeeperClient;</span><br><span class="line"><span class="keyword">import</span> org.I0Itec.Zookeeperclient.ZookeeperConnection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> classZookeeperClientBase &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**Zookeeper地址 */</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">final</span> String CONNECT_ADDR = <span class="string">"192.168.1.111:2181,192.168.1.112:2181,192.168.1.113:2181"</span>;</span><br><span class="line">	<span class="comment">/** session超时时间 */</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SESSION_OUTTIME = <span class="number">5000</span>;<span class="comment">//ms </span></span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		ZookeeperClientZookeeperc = newZookeeperClient(newZookeeperConnection(CONNECT_ADDR), <span class="number">5000</span>);</span><br><span class="line">		<span class="comment">//1. create and delete方法 </span></span><br><span class="line">		Zookeeperc.createEphemeral(<span class="string">"/temp"</span>);</span><br><span class="line">		<span class="comment">//递归创建</span></span><br><span class="line">		Zookeeperc.createPersistent(<span class="string">"/super/c1"</span>, <span class="keyword">true</span>);</span><br><span class="line">		Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">		Zookeeperc.delete(<span class="string">"/temp"</span>);</span><br><span class="line">		<span class="comment">//递归删除</span></span><br><span class="line">		Zookeeperc.deleteRecursive(<span class="string">"/super"</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//2. 设置path和data 并且读取子节点和每个节点的内容</span></span><br><span class="line">		Zookeeperc.createPersistent(<span class="string">"/super"</span>, <span class="string">"1234"</span>);</span><br><span class="line">		Zookeeperc.createPersistent(<span class="string">"/super/c1"</span>, <span class="string">"c1内容"</span>);</span><br><span class="line">		Zookeeperc.createPersistent(<span class="string">"/super/c2"</span>, <span class="string">"c2内容"</span>);</span><br><span class="line">		List&lt;String&gt; list =Zookeeperc.getChildren(<span class="string">"/super"</span>);</span><br><span class="line">		<span class="keyword">for</span>(String p : list)&#123;</span><br><span class="line">			System.out.println(p);</span><br><span class="line">			String rp = <span class="string">"/super/"</span> + p;</span><br><span class="line">			String data =Zookeeperc.readData(rp);</span><br><span class="line">			System.out.println(rp + <span class="string">": "</span> + data);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//3. 更新和判断节点是否存在</span></span><br><span class="line">		Zookeeperc.writeData(<span class="string">"/super/c1"</span>, <span class="string">"新内容"</span>);</span><br><span class="line">		<span class="comment">//System.out.println(Zookeeperc.readData("/super/c1"));</span></span><br><span class="line">		System.out.println(Zookeeperc.exists(<span class="string">"/super/c1"</span>));</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//4.递归删除/super内容</span></span><br><span class="line">		Zookeeperc.deleteRecursive(<span class="string">"/super"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">c1</span><br><span class="line">&#x2F;super&#x2F;c1: c1内容</span><br><span class="line">c2</span><br><span class="line">&#x2F;super&#x2F;c2: c2内容</span><br><span class="line">true</span><br></pre></td></tr></table></figure>
<h3 id="ZookeeperClient对watch的改进"><a href="#ZookeeperClient对watch的改进" class="headerlink" title="ZookeeperClient对watch的改进"></a>ZookeeperClient对watch的改进</h3><p>我们发现，上述ZookeeperClient里面并没有类似的watcher、watch参数，这也就是说我们开发人员无需关心反复注册watcher的问题，Zookeeperclient给我们提供了一套监听方式，我们可以使用监听节点的方式进行操作，剔除了繁琐的反复watcher操作、简化了代码的复杂程度。</p>
<p><strong>subscribeChildChanges方法：订阅子节点变化</strong><br>subscribeChildChanges(String path, IZookeeperChildListener listener)<br>参数1：path路径<br>参数2：实现了IZookeeperChildListener接口的类（如：实例化IZookeeperClientListener类）</p>
<p>只需要重写其handleChildChanges(String parentPath, List currentChild)方法。其中 </p>
<ul>
<li>parentPath 为监听节点全路径 </li>
<li>currentChilds为新的子节点列表 </li>
</ul>
<p>IZookeeperChildListener事件说明针对于下面三个事件触发： </p>
<ul>
<li>新增子节点 </li>
<li>减少子节点 </li>
<li>删除节点 </li>
</ul>
<p><strong>注意： 不监听节点内容的变化</strong> </p>
<p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bcoder.top.Zookeeperclient.watcher;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.I0Itec.Zookeeperclient.IZookeeperChildListener;</span><br><span class="line"><span class="keyword">import</span> org.I0Itec.Zookeeperclient.ZookeeperClient;</span><br><span class="line"><span class="keyword">import</span> org.I0Itec.Zookeeperclient.ZookeeperConnection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> classZookeeperClientWatcher1 &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**Zookeeper地址 */</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">final</span> String CONNECT_ADDR = <span class="string">"192.168.1.111:2181,192.168.1.112:2181,192.168.1.113:2181"</span>;</span><br><span class="line">	<span class="comment">/** session超时时间 */</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SESSION_OUTTIME = <span class="number">5000</span>;<span class="comment">//ms </span></span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		ZookeeperClientZookeeperc = newZookeeperClient(newZookeeperConnection(CONNECT_ADDR), <span class="number">5000</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//对父节点添加监听子节点变化。</span></span><br><span class="line">		Zookeeperc.subscribeChildChanges(<span class="string">"/super"</span>, <span class="keyword">new</span> IZookeeperChildListener() &#123;</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleChildChange</span><span class="params">(String parentPath, List&lt;String&gt; currentChilds)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">				System.out.println(<span class="string">"parentPath: "</span> + parentPath);</span><br><span class="line">				System.out.println(<span class="string">"currentChilds: "</span> + currentChilds);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">		</span><br><span class="line">		Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">		</span><br><span class="line">		Zookeeperc.createPersistent(<span class="string">"/super"</span>);</span><br><span class="line">		Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">		</span><br><span class="line">		Zookeeperc.createPersistent(<span class="string">"/super"</span> + <span class="string">"/"</span> + <span class="string">"c1"</span>, <span class="string">"c1内容"</span>);</span><br><span class="line">		Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">		</span><br><span class="line">		Zookeeperc.createPersistent(<span class="string">"/super"</span> + <span class="string">"/"</span> + <span class="string">"c2"</span>, <span class="string">"c2内容"</span>);</span><br><span class="line">		Thread.sleep(<span class="number">1000</span>);		</span><br><span class="line">		</span><br><span class="line">		Zookeeperc.delete(<span class="string">"/super/c2"</span>);</span><br><span class="line">		Thread.sleep(<span class="number">1000</span>);	</span><br><span class="line">		</span><br><span class="line">		Zookeeperc.deleteRecursive(<span class="string">"/super"</span>);</span><br><span class="line">		Thread.sleep(Integer.MAX_VALUE);</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">parentPath: &#x2F;super</span><br><span class="line">currentChilds: []</span><br><span class="line">parentPath: &#x2F;super</span><br><span class="line">currentChilds: [c1]</span><br><span class="line">parentPath: &#x2F;super</span><br><span class="line">currentChilds: [c1, c2]</span><br><span class="line">parentPath: &#x2F;super</span><br><span class="line">currentChilds: [c1]</span><br><span class="line">parentPath: &#x2F;super</span><br><span class="line">currentChilds: null</span><br><span class="line">parentPath: &#x2F;super</span><br><span class="line">currentChilds: null</span><br></pre></td></tr></table></figure>


<p><strong>subscribeDataChanges 订阅内容变化</strong><br>subscribeDataChanges(String path, IZookeeperDataListener listener)<br>和前面的subscribeChildChanges类似 </p>
<ul>
<li>参数1 路径 </li>
<li>参数2 IZookeeperDataListener对象，重写handleDataDeleted(String path) 方法，可以得到删除节点的path 重写handleDataChange(String path, Object data)可以得到变更的节点和变更的内容</li>
</ul>
<p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bcoder.top.Zookeeperclient.watcher;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.I0Itec.Zookeeperclient.IZookeeperDataListener;</span><br><span class="line"><span class="keyword">import</span> org.I0Itec.Zookeeperclient.ZookeeperClient;</span><br><span class="line"><span class="keyword">import</span> org.I0Itec.Zookeeperclient.ZookeeperConnection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> classZookeeperClientWatcher2 &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**Zookeeper地址 */</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">final</span> String CONNECT_ADDR = <span class="string">"192.168.1.111:2181,192.168.1.112:2181,192.168.1.113:2181"</span>;</span><br><span class="line">	<span class="comment">/** session超时时间 */</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SESSION_OUTTIME = <span class="number">5000</span>;<span class="comment">//ms </span></span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		ZookeeperClientZookeeperc = newZookeeperClient(newZookeeperConnection(CONNECT_ADDR), <span class="number">5000</span>);</span><br><span class="line">		</span><br><span class="line">		Zookeeperc.createPersistent(<span class="string">"/super"</span>, <span class="string">"1234"</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//对父节点添加监听子节点变化。</span></span><br><span class="line">		Zookeeperc.subscribeDataChanges(<span class="string">"/super"</span>, <span class="keyword">new</span> IZookeeperDataListener() &#123;</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDataDeleted</span><span class="params">(String path)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">				System.out.println(<span class="string">"删除的节点为:"</span> + path);</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDataChange</span><span class="params">(String path, Object data)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">				System.out.println(<span class="string">"变更的节点为:"</span> + path + <span class="string">", 变更内容为:"</span> + data);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">		</span><br><span class="line">		Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">		Zookeeperc.writeData(<span class="string">"/super"</span>, <span class="string">"456"</span>, -<span class="number">1</span>);</span><br><span class="line">		Thread.sleep(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">		Zookeeperc.delete(<span class="string">"/super"</span>);</span><br><span class="line">		Thread.sleep(Integer.MAX_VALUE);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">变更的节点为:&#x2F;super, 变更内容为:456</span><br><span class="line">删除的节点为:&#x2F;super</span><br></pre></td></tr></table></figure>

<p>经过测试，得出以下结论：<br>（1）客户端可以对一个不存在的节点进行子节点变更的监听<br>（2）一旦客户端对一个节点注册了子节点列表变更监听之后，那么该节点的字节列表发生变化的时候，服务端都会通知客户端，并将最新的子节点列表发送给客户端。<br>（3）该节点本身的创建或删除会通知到客户端。<br>（4）listener只需要注册一次会一直生效</p>
<h2 id="Curator框架"><a href="#Curator框架" class="headerlink" title="Curator框架"></a>Curator框架</h2><h3 id="Curator框架介绍"><a href="#Curator框架介绍" class="headerlink" title="Curator框架介绍"></a>Curator框架介绍</h3><p>Curator要比ZookeeperClient更有名且功能更加强大，它解决了很多Zookeeper客户端非常底层的细节开发工作，包括链接重连，反复注册watcher和NodeExistsException异常等，还提供了Zookeeper的各种场景例如共享锁服务，主从选举机制以及分布式计数器等抽象封装。下面我们将maven的依赖加入到我们的项目中。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;  </span><br><span class="line">    &lt;groupId&gt;org.apache.curator&lt;/groupId&gt;  </span><br><span class="line">    &lt;artifactId&gt;curator-framework&lt;/artifactId&gt;  </span><br><span class="line">    &lt;version&gt;2.4.2&lt;/version&gt;  </span><br><span class="line">&lt;/dependency&gt;  </span><br><span class="line">&lt;dependency&gt;  </span><br><span class="line">    &lt;groupId&gt;org.apache.curator&lt;/groupId&gt;  </span><br><span class="line">    &lt;artifactId&gt;curator-recipes&lt;/artifactId&gt;  </span><br><span class="line">    &lt;version&gt;2.4.2&lt;/version&gt;  </span><br><span class="line">&lt;/dependency&gt;  </span><br><span class="line">&lt;dependency&gt;  </span><br><span class="line">    &lt;groupId&gt;org.apache.curator&lt;/groupId&gt;  </span><br><span class="line">    &lt;artifactId&gt;curator-client&lt;/artifactId&gt;  </span><br><span class="line">    &lt;version&gt;2.4.2&lt;/version&gt;  </span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h3 id="Curator基本使用"><a href="#Curator基本使用" class="headerlink" title="Curator基本使用"></a>Curator基本使用</h3><p>Curator框架使用链式编程风格，易读性更强，使用工厂方法创建连接对象。</p>
<p><strong>1.连接</strong><br>使用CuratorFrameworkFactory的两个静态工厂方法（参数不同）来实现<br>CuratorFramework newClient(String connectString, int sessionTimeoutMs, int connectionTimeoutMs, RetryPolicy retryPolicy) </p>
<p>参数connectString：Zookeeper服务器列表，英文状态逗号分开<br>参数RetryPolicy：重试连接策略，默认有四种实现：<br>ExponentialBackoffRetry（重试指定的次数,且每一次重试之间停顿的时间逐渐增加）、RetryNtimes（指定最大重试次数的重试策略）、RetryOneTimes（仅重试一次）、RetryUntilElapsed（一直重试直到达到规定的时间）<br>参数sessionTimeoutMs：会话超时时间，默认为60s<br>参数connectionTimeoutMs：连接超时时间，默认为15s</p>
<p>注意：对于retryPolicy策略通过一个接口来让用户自定义实现</p>
<p>其中RetoryPolicy类是重试类，有3个参数：retryCount 重试次数 ；elapsedTimeMs 从第一次重试开始已经花费的时间sleeper用于sleep的时间，首先我们来看一下重试策略ExponentialBackoffRetry，这个类需要指定3个参数：baseSleepTimeMs初始的sleep时间，maxRetries最大重试次数；maxSleepMs 最大睡眠时间.</p>
<p><strong>2.create创建节点</strong><br>可选的链式项：creatingParentsIfNeeded（是否同时创建父节点）、withMode（创建的节点类型）、forPath（创建的节点路径）、withACL（安全项）</p>
<p><strong>3.delete删除节点</strong><br>可选的链式项：deletingChildrenIfNeeded（是否同时删除子节点）、guaranteed（安全删除）、withVersion（版本检查）、forPath（删除的节点路径）</p>
<p><strong>4.inBackground绑定异步回调方法</strong><br>比如在创建节点时绑定一个回调方法，该回调方法可以输出服务器的状态码以及服务器的事件类型等信息，还可以加入一个线程池进行优化操作。</p>
<p>代码示例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bcoder.top.curator.base;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.curator.RetryPolicy;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFramework;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFrameworkFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.api.BackgroundCallback;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.api.CuratorEvent;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.retry.ExponentialBackoffRetry;</span><br><span class="line"><span class="keyword">import</span> org.apache.Zookeeper.CreateMode;</span><br><span class="line"><span class="keyword">import</span> org.apache.Zookeeper.Zookeeper.States;</span><br><span class="line"><span class="keyword">import</span> org.apache.Zookeeper.data.Stat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CuratorBase</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**Zookeeper地址 */</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">final</span> String CONNECT_ADDR = <span class="string">"192.168.1.111:2181,192.112.1.172:2181,192.168.1.113:2181"</span>;</span><br><span class="line">	<span class="comment">/** session超时时间 */</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SESSION_OUTTIME = <span class="number">5000</span>;<span class="comment">//ms </span></span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//1 重试策略：重试时间为1s 重试10次</span></span><br><span class="line">		RetryPolicy retryPolicy = <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">10</span>);</span><br><span class="line">		<span class="comment">//2 通过工厂创建连接</span></span><br><span class="line">		CuratorFramework cf = CuratorFrameworkFactory.builder()</span><br><span class="line">					.connectString(CONNECT_ADDR)</span><br><span class="line">					.sessionTimeoutMs(SESSION_OUTTIME)</span><br><span class="line">					.retryPolicy(retryPolicy)</span><br><span class="line"><span class="comment">//					.namespace("super")</span></span><br><span class="line">					.build();</span><br><span class="line">		<span class="comment">//3 开启连接</span></span><br><span class="line">		cf.start();</span><br><span class="line">		</span><br><span class="line">		System.out.println(States.CONNECTED);</span><br><span class="line">		System.out.println(cf.getState());</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 新加、删除</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">//4 建立节点 指定节点类型（不加withMode默认为持久类型节点）、路径、数据内容</span></span><br><span class="line">		cf.create().creatingParentsIfNeeded().withMode(CreateMode.PERSISTENT).forPath(<span class="string">"/super/c1"</span>,<span class="string">"c1内容"</span>.getBytes());</span><br><span class="line">		<span class="comment">//5 删除节点</span></span><br><span class="line">		cf.delete().guaranteed().deletingChildrenIfNeeded().forPath(<span class="string">"/super"</span>);</span><br><span class="line"></span><br><span class="line">		</span><br><span class="line">		<span class="comment">//6 读取、修改</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">//创建节点</span></span><br><span class="line">		cf.create().creatingParentsIfNeeded().withMode(CreateMode.PERSISTENT).forPath(<span class="string">"/super/c1"</span>,<span class="string">"c1内容"</span>.getBytes());</span><br><span class="line">		cf.create().creatingParentsIfNeeded().withMode(CreateMode.PERSISTENT).forPath(<span class="string">"/super/c2"</span>,<span class="string">"c2内容"</span>.getBytes());</span><br><span class="line">		<span class="comment">//读取节点</span></span><br><span class="line">		String ret1 = <span class="keyword">new</span> String(cf.getData().forPath(<span class="string">"/super/c2"</span>));</span><br><span class="line">		System.out.println(ret1);</span><br><span class="line">		<span class="comment">//修改节点</span></span><br><span class="line">		cf.setData().forPath(<span class="string">"/super/c2"</span>, <span class="string">"修改c2内容"</span>.getBytes());</span><br><span class="line">		String ret2 = <span class="keyword">new</span> String(cf.getData().forPath(<span class="string">"/super/c2"</span>));</span><br><span class="line">		System.out.println(ret2);</span><br><span class="line"></span><br><span class="line">		</span><br><span class="line">		<span class="comment">//7 绑定回调函数</span></span><br><span class="line">		ExecutorService pool = Executors.newCachedThreadPool();</span><br><span class="line">		cf.create().creatingParentsIfNeeded().withMode(CreateMode.PERSISTENT)</span><br><span class="line">		.inBackground(<span class="keyword">new</span> BackgroundCallback() &#123;</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processResult</span><span class="params">(CuratorFramework cf, CuratorEvent ce)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">				System.out.println(<span class="string">"code:"</span> + ce.getResultCode());</span><br><span class="line">				System.out.println(<span class="string">"type:"</span> + ce.getType());</span><br><span class="line">				System.out.println(<span class="string">"线程为:"</span> + Thread.currentThread().getName());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;, pool)</span><br><span class="line">		.forPath(<span class="string">"/super/c3"</span>,<span class="string">"c3内容"</span>.getBytes());</span><br><span class="line">		Thread.sleep(<span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="comment">//8 读取子节点getChildren方法和判断节点是否存在checkExists方法</span></span><br><span class="line">		List&lt;String&gt; list = cf.getChildren().forPath(<span class="string">"/super"</span>);</span><br><span class="line">		<span class="keyword">for</span>(String p : list)&#123;</span><br><span class="line">			System.out.println(p);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		Stat stat = cf.checkExists().forPath(<span class="string">"/super/c3"</span>);</span><br><span class="line">		System.out.println(stat);</span><br><span class="line"></span><br><span class="line">		cf.delete().guaranteed().deletingChildrenIfNeeded().forPath(<span class="string">"/super"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">CONNECTED</span><br><span class="line">STARTED</span><br><span class="line">c2内容</span><br><span class="line">修改c2内容</span><br><span class="line">code:0</span><br><span class="line">type:CREATE</span><br><span class="line">线程为:pool-3-thread-1</span><br><span class="line">c3</span><br><span class="line">c1</span><br><span class="line">c2</span><br><span class="line">30064771161,30064771161,1517052435373,1517052435373,0,0,0,0,8,0,30064771161</span><br></pre></td></tr></table></figure>


<h3 id="Curator监听"><a href="#Curator监听" class="headerlink" title="Curator监听"></a>Curator监听</h3><p>（1）NodeCacheListener：监听节点的新增、修改操作。</p>
<p>代码示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bcoder.top.curator.watcher;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.curator.RetryPolicy;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFramework;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFrameworkFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.api.BackgroundCallback;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.api.CuratorEvent;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.cache.NodeCache;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.cache.NodeCacheListener;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.retry.ExponentialBackoffRetry;</span><br><span class="line"><span class="keyword">import</span> org.apache.Zookeeper.CreateMode;</span><br><span class="line"><span class="keyword">import</span> org.apache.Zookeeper.data.Stat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CuratorWatcher1</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**Zookeeper地址 */</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">final</span> String CONNECT_ADDR = <span class="string">"192.168.1.111:2181,192.168.1.112:2181,192.168.1.113:2181"</span>;</span><br><span class="line">	<span class="comment">/** session超时时间 */</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SESSION_OUTTIME = <span class="number">5000</span>;<span class="comment">//ms </span></span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//1 重试策略：初试时间为1s 重试10次</span></span><br><span class="line">		RetryPolicy retryPolicy = <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">10</span>);</span><br><span class="line">		<span class="comment">//2 通过工厂创建连接</span></span><br><span class="line">		CuratorFramework cf = CuratorFrameworkFactory.builder()</span><br><span class="line">					.connectString(CONNECT_ADDR)</span><br><span class="line">					.sessionTimeoutMs(SESSION_OUTTIME)</span><br><span class="line">					.retryPolicy(retryPolicy)</span><br><span class="line">					.build();</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//3 建立连接</span></span><br><span class="line">		cf.start();</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//4 建立一个cache缓存</span></span><br><span class="line">		<span class="keyword">final</span> NodeCache cache = <span class="keyword">new</span> NodeCache(cf, <span class="string">"/super"</span>, <span class="keyword">false</span>);</span><br><span class="line">		cache.start(<span class="keyword">true</span>);</span><br><span class="line">		cache.getListenable().addListener(<span class="keyword">new</span> NodeCacheListener() &#123;</span><br><span class="line">			<span class="comment">/**</span></span><br><span class="line"><span class="comment">			 * &lt;B&gt;方法名称：&lt;/B&gt;nodeChanged&lt;BR&gt;</span></span><br><span class="line"><span class="comment">			 * &lt;B&gt;概要说明：&lt;/B&gt;触发事件为创建节点和更新节点，在删除节点的时候并不触发此操作。&lt;BR&gt;</span></span><br><span class="line"><span class="comment">			 * <span class="doctag">@see</span> NodeCacheListener#nodeChanged()</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">nodeChanged</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">				System.out.println(<span class="string">"路径为："</span> + cache.getCurrentData().getPath());</span><br><span class="line">				System.out.println(<span class="string">"数据为："</span> + <span class="keyword">new</span> String(cache.getCurrentData().getData()));</span><br><span class="line">				System.out.println(<span class="string">"状态为："</span> + cache.getCurrentData().getStat());</span><br><span class="line">				System.out.println(<span class="string">"---------------------------------------"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">		</span><br><span class="line">		Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">		cf.create().forPath(<span class="string">"/super"</span>, <span class="string">"123"</span>.getBytes());</span><br><span class="line">		</span><br><span class="line">		Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">		cf.setData().forPath(<span class="string">"/super"</span>, <span class="string">"456"</span>.getBytes());</span><br><span class="line">		</span><br><span class="line">		Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">		cf.delete().forPath(<span class="string">"/super"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">路径为：&#x2F;super</span><br><span class="line">数据为：123</span><br><span class="line">状态为：30064771189,30064771189,1517054842930,1517054842930,0,0,0,0,3,0,30064771189</span><br><span class="line"></span><br><span class="line">---------------------------------------</span><br><span class="line">路径为：&#x2F;super</span><br><span class="line">数据为：456</span><br><span class="line">状态为：30064771189,30064771190,1517054842930,1517054843938,1,0,0,0,3,0,30064771189</span><br><span class="line"></span><br><span class="line">---------------------------------------</span><br></pre></td></tr></table></figure>

<p>我们发现我们不能知道数据是新增还是修改，只能知道数据变化了，与此同时，我们在删除监控的节点时，不会触发事件。</p>
<p>（2）PathChildrenCacheListener：监听子节点的新增、修改、删除操作。（只监听一级子节点）</p>
<p>代码示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bcoder.top.curator.watcher;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.curator.RetryPolicy;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFramework;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFrameworkFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.api.BackgroundCallback;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.api.CuratorEvent;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.cache.NodeCache;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.cache.NodeCacheListener;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.retry.ExponentialBackoffRetry;</span><br><span class="line"><span class="keyword">import</span> org.apache.Zookeeper.CreateMode;</span><br><span class="line"><span class="keyword">import</span> org.apache.Zookeeper.data.Stat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CuratorWatcher1</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**Zookeeper地址 */</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">final</span> String CONNECT_ADDR = <span class="string">"192.168.1.111:2181,192.168.1.112:2181,192.168.1.113:2181"</span>;</span><br><span class="line">	<span class="comment">/** session超时时间 */</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SESSION_OUTTIME = <span class="number">5000</span>;<span class="comment">//ms </span></span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//1 重试策略：初试时间为1s 重试10次</span></span><br><span class="line">		RetryPolicy retryPolicy = <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">10</span>);</span><br><span class="line">		<span class="comment">//2 通过工厂创建连接</span></span><br><span class="line">		CuratorFramework cf = CuratorFrameworkFactory.builder()</span><br><span class="line">					.connectString(CONNECT_ADDR)</span><br><span class="line">					.sessionTimeoutMs(SESSION_OUTTIME)</span><br><span class="line">					.retryPolicy(retryPolicy)</span><br><span class="line">					.build();</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//3 建立连接</span></span><br><span class="line">		cf.start();</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//4 建立一个cache缓存</span></span><br><span class="line">		<span class="keyword">final</span> NodeCache cache = <span class="keyword">new</span> NodeCache(cf, <span class="string">"/super"</span>, <span class="keyword">false</span>);</span><br><span class="line">		cache.start(<span class="keyword">true</span>);</span><br><span class="line">		cache.getListenable().addListener(<span class="keyword">new</span> NodeCacheListener() &#123;</span><br><span class="line">			<span class="comment">/**</span></span><br><span class="line"><span class="comment">			 * &lt;B&gt;方法名称：&lt;/B&gt;nodeChanged&lt;BR&gt;</span></span><br><span class="line"><span class="comment">			 * &lt;B&gt;概要说明：&lt;/B&gt;触发事件为创建节点和更新节点，在删除节点的时候并不触发此操作。&lt;BR&gt;</span></span><br><span class="line"><span class="comment">			 * <span class="doctag">@see</span> NodeCacheListener#nodeChanged()</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">nodeChanged</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">				System.out.println(<span class="string">"路径为："</span> + cache.getCurrentData().getPath());</span><br><span class="line">				System.out.println(<span class="string">"数据为："</span> + <span class="keyword">new</span> String(cache.getCurrentData().getData()));</span><br><span class="line">				System.out.println(<span class="string">"状态为："</span> + cache.getCurrentData().getStat());</span><br><span class="line">				System.out.println(<span class="string">"---------------------------------------"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">		</span><br><span class="line">		Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">		cf.create().forPath(<span class="string">"/super"</span>, <span class="string">"123"</span>.getBytes());</span><br><span class="line">		</span><br><span class="line">		Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">		cf.setData().forPath(<span class="string">"/super"</span>, <span class="string">"456"</span>.getBytes());</span><br><span class="line">		</span><br><span class="line">		Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">		cf.delete().forPath(<span class="string">"/super"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">CHILD_ADDED getPath:&#x2F;super&#x2F;c1</span><br><span class="line">CHILD_ADDED getData:c1内容</span><br><span class="line">CHILD_ADDED getPath:&#x2F;super&#x2F;c2</span><br><span class="line">CHILD_ADDED getData:c2内容</span><br><span class="line">CHILD_UPDATED getPath:&#x2F;super&#x2F;c1</span><br><span class="line">CHILD_UPDATED getData:c1更新内容</span><br><span class="line">CHILD_REMOVED getPath:&#x2F;super&#x2F;c1</span><br><span class="line">CHILD_REMOVED getData:c1更新内容</span><br><span class="line">CHILD_REMOVED getPath:&#x2F;super&#x2F;c2</span><br><span class="line">CHILD_REMOVED getData:c2内容</span><br></pre></td></tr></table></figure>

<p>我们发现父节点删除是也不会触发监控事件。</p>
<p>另外还有一种TreeCache：既可以监听节点的状态，又可以监听子节点的状态。类似于上面两种Cache的组合。这里就不在详细叙述了，有兴趣的小伙伴可以Google一下，这里给出网上的down的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CuratorWatcher3</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String CONNECT_ADDR = <span class="string">"192.168.3.58:2181,192.168.3.59:2181,192.168.3.66:2181"</span>;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SESSION_TIMEOUT = <span class="number">5000</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;  </span><br><span class="line">        RetryPolicy policy = <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">10</span>);  </span><br><span class="line">        CuratorFramework curator = CuratorFrameworkFactory.builder().connectString(CONNECT_ADDR).sessionTimeoutMs(SESSION_TIMEOUT)  </span><br><span class="line">                .retryPolicy(policy).build();  </span><br><span class="line">        curator.start();  </span><br><span class="line">        TreeCache treeCache = <span class="keyword">new</span> TreeCache(curator, <span class="string">"/treeCache"</span>);  </span><br><span class="line">        treeCache.start();  </span><br><span class="line">        treeCache.getListenable().addListener((curatorFramework, treeCacheEvent) -&gt; &#123;  </span><br><span class="line">            <span class="keyword">switch</span> (treeCacheEvent.getType()) &#123;  </span><br><span class="line">                <span class="keyword">case</span> NODE_ADDED:  </span><br><span class="line">                    System.out.println(<span class="string">"NODE_ADDED：路径："</span> + treeCacheEvent.getData().getPath() + <span class="string">"，数据："</span> + <span class="keyword">new</span> String(treeCacheEvent.getData().getData())  </span><br><span class="line">                    + <span class="string">"，状态："</span> + treeCacheEvent.getData().getStat());  </span><br><span class="line">                    <span class="keyword">break</span>;  </span><br><span class="line">                <span class="keyword">case</span> NODE_UPDATED:  </span><br><span class="line">                    System.out.println(<span class="string">"NODE_UPDATED：路径："</span> + treeCacheEvent.getData().getPath() + <span class="string">"，数据："</span> + <span class="keyword">new</span> String(treeCacheEvent.getData().getData())  </span><br><span class="line">                            + <span class="string">"，状态："</span> + treeCacheEvent.getData().getStat());  </span><br><span class="line">                    <span class="keyword">break</span>;  </span><br><span class="line">                <span class="keyword">case</span> NODE_REMOVED:  </span><br><span class="line">                    System.out.println(<span class="string">"NODE_REMOVED：路径："</span> + treeCacheEvent.getData().getPath() + <span class="string">"，数据："</span> + <span class="keyword">new</span> String(treeCacheEvent.getData().getData())  </span><br><span class="line">                            + <span class="string">"，状态："</span> + treeCacheEvent.getData().getStat());  </span><br><span class="line">                    <span class="keyword">break</span>;  </span><br><span class="line">                <span class="keyword">default</span>:  </span><br><span class="line">                    <span class="keyword">break</span>;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;);  </span><br><span class="line">  </span><br><span class="line">        curator.create().forPath(<span class="string">"/treeCache"</span>, <span class="string">"123"</span>.getBytes());  </span><br><span class="line">        curator.create().creatingParentsIfNeeded().withMode(CreateMode.PERSISTENT).forPath(<span class="string">"/treeCache/c1"</span>, <span class="string">"456"</span>.getBytes());  </span><br><span class="line">        curator.setData().forPath(<span class="string">"/treeCache"</span>, <span class="string">"789"</span>.getBytes());  </span><br><span class="line">        curator.setData().forPath(<span class="string">"/treeCache/c1"</span>, <span class="string">"910"</span>.getBytes());  </span><br><span class="line">        curator.delete().forPath(<span class="string">"/treeCache/c1"</span>);  </span><br><span class="line">        curator.delete().forPath(<span class="string">"/treeCache"</span>);  </span><br><span class="line">        Thread.sleep(<span class="number">5000</span>);  </span><br><span class="line">        curator.close();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Curator应用场景—分布式锁"><a href="#Curator应用场景—分布式锁" class="headerlink" title="Curator应用场景—分布式锁"></a>Curator应用场景—分布式锁</h3><p>在分布式场景中，为了保证数据的一致性，经常在程序运行的某一个点需要进行同步操作（Java中提供了Synchronized和ReentrantLock实现）。我们使用Curator基于Zookeeper的特性提供的分布式锁来处理分布式场景的数据一致性。</p>
<p><strong>可重入锁：InterProcessMutex(CuratorFramework client, String path)</strong><br>通过acquire()获得锁，并提供超时机制；通过release()释放锁。makeRevocable(RevocationListener<T> listener)定义了可协商的撤销机制，当别的进程或线程想让你释放锁时，listener会被调用。如果请求撤销当前的锁，可以调用attemptRevoke(CuratorFramework client, String path)。</p>
<p>首先创建一个模拟的公共资源，这个资源期望只能单线程的访问，否则会有并发问题。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FakeLimitedResource</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean inUse = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">use</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;  </span><br><span class="line">        <span class="comment">//这个例子在使用锁的情况下不会抛出非法并发异常IllegalStateException  </span></span><br><span class="line">        <span class="comment">//但是在无锁的情况下，由于sleep了一段时间，所以很容易抛出异常  </span></span><br><span class="line">        <span class="keyword">if</span>(!inUse.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Needs to be used by one client at a time"</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            Thread.sleep((<span class="keyword">long</span>) (<span class="number">3</span> * Math.random()));  </span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;  </span><br><span class="line">            inUse.set(<span class="keyword">false</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后创建一个ExampleClientThatLocks类，它负责请求锁、使用资源、释放锁这样一个完整的访问过程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleClientThatLocks</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InterProcessMutex lock;  </span><br><span class="line">    <span class="comment">//private final InterProcessSemaphoreMutex lock;  </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FakeLimitedResource resource;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String clientName;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ExampleClientThatLocks</span><span class="params">(CuratorFramework framework, String path, FakeLimitedResource resource, String clientName)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">this</span>.lock = <span class="keyword">new</span> InterProcessMutex(framework, path);  </span><br><span class="line">        <span class="comment">//this.lock = new InterProcessSemaphoreMutex(framework, path);  </span></span><br><span class="line">        <span class="keyword">this</span>.resource = resource;  </span><br><span class="line">        <span class="keyword">this</span>.clientName = clientName;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doWork</span><span class="params">(<span class="keyword">long</span> time, TimeUnit timeUnit)</span> <span class="keyword">throws</span> Exception </span>&#123;  </span><br><span class="line">        <span class="keyword">if</span>(!lock.acquire(time, timeUnit)) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(clientName + <span class="string">" could not acquire the lock!"</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        System.out.println(clientName + <span class="string">" has the lock"</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">/*if(!lock.acquire(time, timeUnit)) &#123; </span></span><br><span class="line"><span class="comment">            throw new IllegalStateException(clientName + " could not acquire the lock!"); </span></span><br><span class="line"><span class="comment">        &#125; </span></span><br><span class="line"><span class="comment">        System.out.println(clientName + " has the lock");*/</span>  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            resource.use();  </span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;  </span><br><span class="line">            System.out.println(clientName + <span class="string">" releasing the lock"</span>);  </span><br><span class="line">            lock.release();  </span><br><span class="line">            <span class="comment">//lock.release();  </span></span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后创建主程序来测试。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InterProcessMutexExample</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> QTY = <span class="number">5</span>;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REPETITIONS = QTY * <span class="number">10</span>;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PATH = <span class="string">"/examples/locks"</span>;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String CONNECT_ADDR = <span class="string">"192.168.3.58:2181,192.168.3.59:2181,192.168.3.66:2181"</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;  </span><br><span class="line">        <span class="keyword">final</span> FakeLimitedResource resource = <span class="keyword">new</span> FakeLimitedResource();  </span><br><span class="line">        ExecutorService executor = Executors.newFixedThreadPool(QTY);  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;QTY; i++) &#123;  </span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> index = i;  </span><br><span class="line">                Callable&lt;Void&gt; task = () -&gt; &#123;  </span><br><span class="line">                    CuratorFramework curator = CuratorFrameworkFactory.newClient(CONNECT_ADDR, <span class="keyword">new</span> RetryNTimes(<span class="number">3</span>, <span class="number">1000</span>));  </span><br><span class="line">                    curator.start();  </span><br><span class="line">                    <span class="keyword">try</span> &#123;  </span><br><span class="line">                        <span class="keyword">final</span> ExampleClientThatLocks example = <span class="keyword">new</span> ExampleClientThatLocks(curator, PATH, resource, <span class="string">"Client "</span> + index);  </span><br><span class="line">                        <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>; j&lt;REPETITIONS; j++) &#123;  </span><br><span class="line">                            example.doWork(<span class="number">10</span>, TimeUnit.SECONDS);  </span><br><span class="line">                        &#125;  </span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">                        e.printStackTrace();  </span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;  </span><br><span class="line">                        CloseableUtils.closeQuietly(curator);  </span><br><span class="line">                    &#125;  </span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;  </span><br><span class="line">                &#125;;  </span><br><span class="line">                executor.submit(task);  </span><br><span class="line">            &#125;  </span><br><span class="line">            executor.shutdown();  </span><br><span class="line">            executor.awaitTermination(<span class="number">10</span>, TimeUnit.MINUTES);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码也很简单，生成10个client，每个client重复执行10次，请求锁–访问资源–释放锁的过程。每个client都在独立的线程中。结果可以看到，锁是随机的被每个实例排他性的使用。既然是可重用的，你可以在一个线程中多次调用acquire,在线程拥有锁时它总是返回true。你不应该在多个线程中用同一个InterProcessMutex，你可以在每个线程中都生成一个InterProcessMutex实例，它们的path都一样，这样它们可以共享同一个锁。</p>
<p><strong>不可重入锁：InterProcessSemaphoreMutex</strong><br>这个锁和可重入锁相比，就是少了Reentrant功能，也就意味着不能在同一个线程中重入，使用方法和上面的类似。将ExampleClientThatLocks修改成如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleClientThatLocks</span> </span>&#123;  </span><br><span class="line">    <span class="comment">//private final InterProcessMutex lock;  </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InterProcessSemaphoreMutex lock;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FakeLimitedResource resource;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String clientName;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ExampleClientThatLocks</span><span class="params">(CuratorFramework framework, String path, FakeLimitedResource resource, String clientName)</span> </span>&#123;  </span><br><span class="line">        <span class="comment">//this.lock = new InterProcessMutex(framework, path);  </span></span><br><span class="line">        <span class="keyword">this</span>.lock = <span class="keyword">new</span> InterProcessSemaphoreMutex(framework, path);  </span><br><span class="line">        <span class="keyword">this</span>.resource = resource;  </span><br><span class="line">        <span class="keyword">this</span>.clientName = clientName;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doWork</span><span class="params">(<span class="keyword">long</span> time, TimeUnit timeUnit)</span> <span class="keyword">throws</span> Exception </span>&#123;  </span><br><span class="line">        <span class="keyword">if</span>(!lock.acquire(time, timeUnit)) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(clientName + <span class="string">" could not acquire the lock!"</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        System.out.println(clientName + <span class="string">" has the lock"</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span>(!lock.acquire(time, timeUnit)) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(clientName + <span class="string">" could not acquire the lock!"</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        System.out.println(clientName + <span class="string">" has the lock"</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            resource.use();  </span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;  </span><br><span class="line">            System.out.println(clientName + <span class="string">" releasing the lock"</span>);  </span><br><span class="line">            lock.release();  </span><br><span class="line">            lock.release();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意我们也需要调用release两次。这和JDK的ReentrantLock用法一致。如果少调用一次release，则此线程依然拥有锁。 上面的代码没有问题，我们可以多次调用acquire，后续的acquire也不会阻塞。 将上面的InterProcessMutex换成不可重入锁InterProcessSemaphoreMutex,如果再运行上面的代码，结果就会发现线程被阻塞再第二个acquire上。也就是此锁不是可重入的。</p>
<p><strong>可重入读写锁：InterProcessReadWriteLock</strong></p>
<p>类似JDK的ReentrantReadWriteLock. 一个读写锁管理一对相关的锁。 </p>
<p>一个负责读操作，另外一个负责写操作。读操作在写锁没被使用时可同时由多个进程使用，而写锁使用时不允许读(阻塞)。此锁是可重入的。一个拥有写锁的线程可重入读锁，但是读锁却不能进入写锁。 这也意味着写锁可以降级成读锁， 比如请求写锁 —&gt;读锁 —-&gt;释放写锁。 从读锁升级成写锁是不行的。<br>使用时首先创建一个InterProcessReadWriteLock实例，然后再根据你的需求得到读锁或者写锁， 读写锁的类型是InterProcessLock。<br>在可重入锁的代码基础上，使用下面的ExampleClientReadWriteLocks替换ExampleClientThatLocks类即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleClientReadWriteLocks</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InterProcessReadWriteLock readWriteLock;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InterProcessMutex readLock;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InterProcessMutex writeLock;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FakeLimitedResource resource;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String clientName;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ExampleClientReadWriteLocks</span><span class="params">(CuratorFramework client, String path, FakeLimitedResource resource, String clientName)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">this</span>.readWriteLock = <span class="keyword">new</span> InterProcessReadWriteLock(client, path);  </span><br><span class="line">        <span class="keyword">this</span>.readLock = readWriteLock.readLock();  </span><br><span class="line">        <span class="keyword">this</span>.writeLock = readWriteLock.writeLock();  </span><br><span class="line">        <span class="keyword">this</span>.resource = resource;  </span><br><span class="line">        <span class="keyword">this</span>.clientName = clientName;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doWork</span><span class="params">(<span class="keyword">long</span> time, TimeUnit unit)</span> <span class="keyword">throws</span> Exception </span>&#123;  </span><br><span class="line">        <span class="keyword">if</span>(!writeLock.acquire(time, unit)) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(clientName + <span class="string">" could not acquire the writeLock!"</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        System.out.println(clientName + <span class="string">" has the writeLock"</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span>(!readLock.acquire(time, unit)) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(clientName + <span class="string">" could not acquire the readLock!"</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        System.out.println(clientName + <span class="string">" has the readLock"</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            resource.use();  </span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;  </span><br><span class="line">            readLock.release();  </span><br><span class="line">            writeLock.release();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这个类中我们首先请求了一个写锁，然后降级成读锁。执行业务处理，然后释放读写锁。</p>
<p><strong>信号量：InterProcessSemaphoreV2</strong></p>
<p>一个计数的信号量类似JDK的Semaphore。 </p>
<p>JDK中Semaphore维护的一组许可(permits)，而Cubator中称之为租约(Lease)。 有两种方式可以决定semaphore的最大租约数。<br>第一种方式是有用户给定的path决定。<br>第二种方式使用SharedCountReader类。如果不使用SharedCountReader,没有内部代码检查进程是否假定有10个租约而进程B假定有20个租约。所以所有的实例必须使用相同的numberOfLeases值.<br>这次调用acquire会返回一个租约对象。客户端必须在finally中close这些租约对象，否则这些租约会丢失掉。但是，但是，如果客户端session由于某种原因比如crash丢掉， 那么这些客户端持有的租约会自动close，这样其它客户端可以继续使用这些租约。 租约还可以通过下面的方式返还：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">returnAll</span><span class="params">(Collection&lt;Lease&gt; leases)</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">returnLease</span><span class="params">(Lease lease)</span></span></span><br></pre></td></tr></table></figure>
<p>注意一次你可以请求多个租约，如果Semaphore当前的租约不够，则请求线程会被阻塞。 同时还提供了超时的重载方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Lease <span class="title">acquire</span><span class="params">()</span>  </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Collection&lt;Lease&gt; <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> qty)</span>  </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Lease <span class="title">acquire</span><span class="params">(<span class="keyword">long</span> time, TimeUnit unit)</span>  </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Collection&lt;Lease&gt; <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> qty, <span class="keyword">long</span> time, TimeUnit unit)</span></span></span><br></pre></td></tr></table></figure>
<p>下面是例子.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InterProcessSemaphoreExample</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_LEASE = <span class="number">10</span>;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PATH = <span class="string">"/examples/locks"</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;  </span><br><span class="line">        FakeLimitedResource resource = <span class="keyword">new</span> FakeLimitedResource();  </span><br><span class="line">        <span class="keyword">try</span> (TestingServer server = <span class="keyword">new</span> TestingServer()) &#123;  </span><br><span class="line">  </span><br><span class="line">            CuratorFramework client = CuratorFrameworkFactory.newClient(server.getConnectString(), <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">3</span>));  </span><br><span class="line">            client.start();  </span><br><span class="line">  </span><br><span class="line">            InterProcessSemaphoreV2 semaphore = <span class="keyword">new</span> InterProcessSemaphoreV2(client, PATH, MAX_LEASE);  </span><br><span class="line">            Collection&lt;Lease&gt; leases = semaphore.acquire(<span class="number">5</span>);  </span><br><span class="line">            System.out.println(<span class="string">"get "</span> + leases.size() + <span class="string">" leases"</span>);  </span><br><span class="line">            Lease lease = semaphore.acquire();  </span><br><span class="line">            System.out.println(<span class="string">"get another lease"</span>);  </span><br><span class="line">  </span><br><span class="line">            resource.use();  </span><br><span class="line">  </span><br><span class="line">            Collection&lt;Lease&gt; leases2 = semaphore.acquire(<span class="number">5</span>, <span class="number">10</span>, TimeUnit.SECONDS);  </span><br><span class="line">            System.out.println(<span class="string">"Should timeout and acquire return "</span> + leases2);  </span><br><span class="line">  </span><br><span class="line">            System.out.println(<span class="string">"return one lease"</span>);  </span><br><span class="line">            semaphore.returnLease(lease);  </span><br><span class="line">            System.out.println(<span class="string">"return another 5 leases"</span>);  </span><br><span class="line">            semaphore.returnAll(leases);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先我们先获得了5个租约，最后我们把它还给了semaphore。接着请求了一个租约，因为semaphore还有5个租约，所以请求可以满足，返回一个租约，还剩4个租约。 然后再请求一个租约，因为租约不够，阻塞到超时，还是没能满足，返回结果为null。上面说讲的锁都是公平锁(fair)。总Zookeeper的角度看，每个客户端都按照请求的顺序获得锁。 相当公平。</p>
<p><strong>多锁对象：InterProcessMultiLock</strong><br>Multi Shared Lock是一个锁的容器。当调用acquire，所有的锁都会被acquire，如果请求失败，所有的锁都会被release。同样调用release时所有的锁都被release(失败被忽略)。 基本上，它就是组锁的代表，在它上面的请求释放操作都会传递给它包含的所有的锁。</p>
<p>例子如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InterProcessMultiLockExample</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PATH1 = <span class="string">"/examples/locks1"</span>;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PATH2 = <span class="string">"/examples/locks2"</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;  </span><br><span class="line">        FakeLimitedResource resource = <span class="keyword">new</span> FakeLimitedResource();  </span><br><span class="line">        <span class="keyword">try</span> (TestingServer server = <span class="keyword">new</span> TestingServer()) &#123;  </span><br><span class="line">            CuratorFramework client = CuratorFrameworkFactory.newClient(server.getConnectString(), <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">3</span>));  </span><br><span class="line">            client.start();  </span><br><span class="line">  </span><br><span class="line">            InterProcessLock lock1 = <span class="keyword">new</span> InterProcessMutex(client, PATH1);  </span><br><span class="line">            InterProcessLock lock2 = <span class="keyword">new</span> InterProcessSemaphoreMutex(client, PATH2);  </span><br><span class="line">  </span><br><span class="line">            InterProcessMultiLock lock = <span class="keyword">new</span> InterProcessMultiLock(Arrays.asList(lock1, lock2));  </span><br><span class="line">  </span><br><span class="line">            <span class="keyword">if</span> (!lock.acquire(<span class="number">10</span>, TimeUnit.SECONDS)) &#123;  </span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"could not acquire the lock"</span>);  </span><br><span class="line">            &#125;  </span><br><span class="line">            System.out.println(<span class="string">"has the lock"</span>);  </span><br><span class="line">  </span><br><span class="line">            System.out.println(<span class="string">"has the lock1: "</span> + lock1.isAcquiredInThisProcess());  </span><br><span class="line">            System.out.println(<span class="string">"has the lock2: "</span> + lock2.isAcquiredInThisProcess());  </span><br><span class="line">  </span><br><span class="line">            <span class="keyword">try</span> &#123;              </span><br><span class="line">                resource.use(); <span class="comment">//access resource exclusively  </span></span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;  </span><br><span class="line">                System.out.println(<span class="string">"releasing the lock"</span>);  </span><br><span class="line">                lock.release(); <span class="comment">// always release the lock in a finally block  </span></span><br><span class="line">            &#125;  </span><br><span class="line">            System.out.println(<span class="string">"has the lock1: "</span> + lock1.isAcquiredInThisProcess());  </span><br><span class="line">            System.out.println(<span class="string">"has the lock2: "</span> + lock2.isAcquiredInThisProcess());  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>新建一个InterProcessMultiLock，包含一个重入锁和一个非重入锁。调用acquire后可以看到线程同时拥有了这两个锁。 调用release看到这两个锁都被释放了。</p>
<h3 id="Curator应用场景—分布式计数器"><a href="#Curator应用场景—分布式计数器" class="headerlink" title="Curator应用场景—分布式计数器"></a>Curator应用场景—分布式计数器</h3><p>一说到分布式计数器，你可能马上想到AtomicInteger这种经典的方式。如果是在同一个JVM下肯定没有问题，但是在分布式场景下，肯定会存在问题。所以就需要使用Curator框架的DistributedAtomicInteger了。</p>
<p>我们可以用分布式计数器来统计网站的在线人数等。</p>
<p>示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bcoder.top.curator.atomicinteger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.curator.RetryPolicy;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFramework;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFrameworkFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.atomic.AtomicValue;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.atomic.DistributedAtomicInteger;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.retry.ExponentialBackoffRetry;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.retry.RetryNTimes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CuratorAtomicInteger</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**Zookeeper地址 */</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">final</span> String CONNECT_ADDR = <span class="string">"192.168.1.111:2181,192.168.1.112:2181,192.168.1.113:2181"</span>;</span><br><span class="line">	<span class="comment">/** session超时时间 */</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SESSION_OUTTIME = <span class="number">5000</span>;<span class="comment">//ms </span></span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//1 重试策略：初试时间为1s 重试10次</span></span><br><span class="line">		RetryPolicy retryPolicy = <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">10</span>);</span><br><span class="line">		<span class="comment">//2 通过工厂创建连接</span></span><br><span class="line">		CuratorFramework cf = CuratorFrameworkFactory.builder()</span><br><span class="line">					.connectString(CONNECT_ADDR)</span><br><span class="line">					.sessionTimeoutMs(SESSION_OUTTIME)</span><br><span class="line">					.retryPolicy(retryPolicy)</span><br><span class="line">					.build();</span><br><span class="line">		<span class="comment">//3 开启连接</span></span><br><span class="line">		cf.start();</span><br><span class="line">		cf.create().forPath(<span class="string">"/super"</span>);</span><br><span class="line">		</span><br><span class="line"></span><br><span class="line">		<span class="comment">//4 使用DistributedAtomicInteger</span></span><br><span class="line">		DistributedAtomicInteger atomicIntger = </span><br><span class="line">				<span class="keyword">new</span> DistributedAtomicInteger(cf, <span class="string">"/super"</span>, <span class="keyword">new</span> RetryNTimes(<span class="number">3</span>, <span class="number">1000</span>));</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//AtomicValue&lt;Integer&gt; value = atomicIntger.add(10);</span></span><br><span class="line">		<span class="comment">//AtomicValue&lt;Integer&gt; value = atomicIntger.get();</span></span><br><span class="line">		AtomicValue&lt;Integer&gt; value = atomicIntger.increment();</span><br><span class="line">		System.out.println(value.succeeded());</span><br><span class="line">		System.out.println(value.postValue());	<span class="comment">//最新值</span></span><br><span class="line">		System.out.println(value.preValue());	<span class="comment">//原始值</span></span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">true</span><br><span class="line">2</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<h3 id="Curator应用场景—分布式Barrier"><a href="#Curator应用场景—分布式Barrier" class="headerlink" title="Curator应用场景—分布式Barrier"></a>Curator应用场景—分布式Barrier</h3><p>分布式Barrier是这样一个类：它会阻塞所有节点上的等待进程，知道某一个被满足，然后所有的节点继续执行。比如赛马比赛中，等赛马陆续来到起跑线前，一声令下，所有的赛马都飞奔而出。</p>
<p>DistributedBarrier类实现了栏栅的功能，构造方法如下：<br>public DistributedBarrier(CuratorFramework client, String barrierPath) </p>
<p>首先需要调用setBarrier()方法设置栏栅，它将阻塞在它上面等待的线程，然后需要阻塞的线程调用waitOnBarrier()方法等待放行条件。当条件满足时调用removeBarrier()方法移除栏栅，所有等待的线程将继续执行。<br>接下来看例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bcoder.top.curator.barrier;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.curator.RetryPolicy;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFramework;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFrameworkFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.barriers.DistributedDoubleBarrier;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.retry.ExponentialBackoffRetry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CuratorBarrier2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**Zookeeper地址 */</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">final</span> String CONNECT_ADDR = <span class="string">"192.168.1.111:2181,192.168.1.112:2181,192.168.1.113:2181"</span>;</span><br><span class="line">	<span class="comment">/** session超时时间 */</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SESSION_OUTTIME = <span class="number">5000</span>;<span class="comment">//ms </span></span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++)&#123;</span><br><span class="line">			<span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">				<span class="meta">@Override</span></span><br><span class="line">				<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">					<span class="keyword">try</span> &#123;</span><br><span class="line">						RetryPolicy retryPolicy = <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">10</span>);</span><br><span class="line">						CuratorFramework cf = CuratorFrameworkFactory.builder()</span><br><span class="line">									.connectString(CONNECT_ADDR)</span><br><span class="line">									.retryPolicy(retryPolicy)</span><br><span class="line">									.build();</span><br><span class="line">						cf.start();</span><br><span class="line">						</span><br><span class="line">						DistributedDoubleBarrier barrier = <span class="keyword">new</span> DistributedDoubleBarrier(cf, <span class="string">"/super"</span>, <span class="number">5</span>);</span><br><span class="line">						Thread.sleep(<span class="number">1000</span> * (<span class="keyword">new</span> Random()).nextInt(<span class="number">3</span>)); </span><br><span class="line">						System.out.println(Thread.currentThread().getName() + <span class="string">"已经准备"</span>);</span><br><span class="line">						barrier.enter();</span><br><span class="line">						System.out.println(<span class="string">"同时开始运行..."</span>);</span><br><span class="line">						Thread.sleep(<span class="number">1000</span> * (<span class="keyword">new</span> Random()).nextInt(<span class="number">10</span>));</span><br><span class="line">						System.out.println(Thread.currentThread().getName() + <span class="string">"运行完毕"</span>);</span><br><span class="line">						barrier.leave();</span><br><span class="line">						System.out.println(<span class="string">"同时退出运行..."</span>);</span><br><span class="line">						</span><br><span class="line"></span><br><span class="line">					&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">						e.printStackTrace();</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,<span class="string">"t"</span> + i).start();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">t3设置barrier!</span><br><span class="line">t2设置barrier!</span><br><span class="line">t1设置barrier!</span><br><span class="line">t0设置barrier!</span><br><span class="line">t4设置barrier!</span><br><span class="line">---------开始执行程序----------</span><br><span class="line">---------开始执行程序----------</span><br><span class="line">---------开始执行程序----------</span><br><span class="line">---------开始执行程序----------</span><br><span class="line">---------开始执行程序----------</span><br></pre></td></tr></table></figure>



<p><strong>双栏栅：DistributedDoubleBarrier</strong>，双栏栅允许客户端在计算的开始和结束时同步。当足够的进程加入到双栏栅时，进程开始计算，当计算完成时离开栏栅。DistributedDoubleBarrier构造方法如下：<br>public DistributedDoubleBarrier(CuratorFramework client, String barrierPath, int memberQty)  </p>
<p>memberQty是成员数量，当enter()方法被调用时，成员被阻塞，直到所有的成员都调用了enter()方法。当leave()方法被调用时，它也阻塞调用线程，直到所有的成员都调用了leave()方法。就像百米赛跑比赛，发令枪响，所有的运动员开始跑，等所有的运动员跑过终点线，比赛才结束。<br>例子代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bcoder.top.curator.barrier;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.curator.RetryPolicy;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFramework;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFrameworkFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.barriers.DistributedDoubleBarrier;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.retry.ExponentialBackoffRetry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CuratorBarrier2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**Zookeeper地址 */</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">final</span> String CONNECT_ADDR = <span class="string">"192.168.1.111:2181,192.168.1.112:2181,192.168.1.113:2181"</span>;</span><br><span class="line">	<span class="comment">/** session超时时间 */</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SESSION_OUTTIME = <span class="number">5000</span>;<span class="comment">//ms </span></span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++)&#123;</span><br><span class="line">			<span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">				<span class="meta">@Override</span></span><br><span class="line">				<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">					<span class="keyword">try</span> &#123;</span><br><span class="line">						RetryPolicy retryPolicy = <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">10</span>);</span><br><span class="line">						CuratorFramework cf = CuratorFrameworkFactory.builder()</span><br><span class="line">									.connectString(CONNECT_ADDR)</span><br><span class="line">									.retryPolicy(retryPolicy)</span><br><span class="line">									.build();</span><br><span class="line">						cf.start();</span><br><span class="line">						</span><br><span class="line">						DistributedDoubleBarrier barrier = <span class="keyword">new</span> DistributedDoubleBarrier(cf, <span class="string">"/super"</span>, <span class="number">5</span>);</span><br><span class="line">						Thread.sleep(<span class="number">1000</span> * (<span class="keyword">new</span> Random()).nextInt(<span class="number">3</span>)); </span><br><span class="line">						System.out.println(Thread.currentThread().getName() + <span class="string">"已经准备"</span>);</span><br><span class="line">						barrier.enter();</span><br><span class="line">						System.out.println(<span class="string">"同时开始运行..."</span>);</span><br><span class="line">						Thread.sleep(<span class="number">1000</span> * (<span class="keyword">new</span> Random()).nextInt(<span class="number">10</span>));</span><br><span class="line">						System.out.println(Thread.currentThread().getName() + <span class="string">"运行完毕"</span>);</span><br><span class="line">						barrier.leave();</span><br><span class="line">						System.out.println(<span class="string">"同时退出运行..."</span>);</span><br><span class="line">						</span><br><span class="line"></span><br><span class="line">					&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">						e.printStackTrace();</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,<span class="string">"t"</span> + i).start();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">t3已经准备</span><br><span class="line">t4已经准备</span><br><span class="line">t0已经准备</span><br><span class="line">t2已经准备</span><br><span class="line">t1已经准备</span><br><span class="line">同时开始运行...</span><br><span class="line">同时开始运行...</span><br><span class="line">同时开始运行...</span><br><span class="line">同时开始运行...</span><br><span class="line">同时开始运行...</span><br><span class="line">t1运行完毕</span><br><span class="line">t3运行完毕</span><br><span class="line">t4运行完毕</span><br><span class="line">t0运行完毕</span><br><span class="line">t2运行完毕</span><br><span class="line">同时退出运行...</span><br><span class="line">同时退出运行...</span><br><span class="line">同时退出运行...</span><br><span class="line">同时退出运行...</span><br><span class="line">同时退出运行...</span><br></pre></td></tr></table></figure>
<h3 id="Curator应用场景—分布式Queue-队列"><a href="#Curator应用场景—分布式Queue-队列" class="headerlink" title="Curator应用场景—分布式Queue(队列)"></a>Curator应用场景—分布式Queue(队列)</h3><p>Curator也提供Zookeeper Recipe的分布式队列实现。 利用Zookeeper的 PERSISTENTSEQUENTIAL节点， 可以保证放入到队列中的项目是按照顺序排队的。 如果单一的消费者从队列中取数据， 那么它是先入先出的，这也是队列的特点。 如果你严格要求顺序，你就的使用单一的消费者，可以使用leader选举只让leader作为唯一的消费者。</p>
<p>Zookeeper没有实现一个好的Queue，详细内容可以看 Tech Note 4， 原因有五：<br>1.Zookeeper有1MB 的传输限制。实践中ZNode必须相对较小，而队列包含成千上万的消息，非常的大。<br>2.如果有很多节点，Zookeeper启动时相当的慢。 而使用queue会导致好多ZNode. 你需要显著增大 initLimit 和 syncLimit.<br>3.ZNode很大的时候很难清理。因此不得不创建了一个专门的程序做这事。<br>4.当很大量的包含成千上万的子节点的ZNode时，Zookeeper的性能变得不好<br>5.Zookeeper的数据库完全放在内存中。 大量的Queue意味着会占用很多的内存空间。<br>尽管如此， Curator还是创建了各种Queue的实现。 如果Queue的数据量不太多，数据量不太大的情况下，酌情考虑，还是可以使用的。</p>
<p>下面来介绍一下Curator实现的几种队列：</p>
<p><strong>1.DistributedQueue</strong><br>DistributedQueue是最普通的一种队列。</p>
<p>示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFramework;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFrameworkFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.api.CuratorEvent;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.api.CuratorListener;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.queue.DistributedQueue;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.queue.QueueBuilder;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.queue.QueueConsumer;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.queue.QueueSerializer;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.state.ConnectionState;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.retry.ExponentialBackoffRetry;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.test.TestingServer;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.utils.CloseableUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DistributedQueueExample</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PATH = <span class="string">"/example/queue"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        TestingServer server = <span class="keyword">new</span> TestingServer();</span><br><span class="line">        CuratorFramework client = <span class="keyword">null</span>;</span><br><span class="line">        DistributedQueue&lt;String&gt; queue = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            client = CuratorFrameworkFactory.newClient(server.getConnectString(), <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">3</span>));</span><br><span class="line">            client.getCuratorListenable().addListener(<span class="keyword">new</span> CuratorListener() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eventReceived</span><span class="params">(CuratorFramework client, CuratorEvent event)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                    System.out.println(<span class="string">"CuratorEvent: "</span> + event.getType().name());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            client.start();</span><br><span class="line">            QueueConsumer&lt;String&gt; consumer = createQueueConsumer();</span><br><span class="line">            QueueBuilder&lt;String&gt; builder = QueueBuilder.builder(client, consumer, createQueueSerializer(), PATH);</span><br><span class="line">            queue = builder.buildQueue();</span><br><span class="line">            queue.start();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                queue.put(<span class="string">" test-"</span> + i);</span><br><span class="line">                Thread.sleep((<span class="keyword">long</span>)(<span class="number">3</span> * Math.random()));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Thread.sleep(<span class="number">20000</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            CloseableUtils.closeQuietly(queue);</span><br><span class="line">            CloseableUtils.closeQuietly(client);</span><br><span class="line">            CloseableUtils.closeQuietly(server);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> QueueSerializer&lt;String&gt; <span class="title">createQueueSerializer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> QueueSerializer&lt;String&gt;()&#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">byte</span>[] serialize(String item) &#123;</span><br><span class="line">                <span class="keyword">return</span> item.getBytes();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">deserialize</span><span class="params">(<span class="keyword">byte</span>[] bytes)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> String(bytes);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> QueueConsumer&lt;String&gt; <span class="title">createQueueConsumer</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> QueueConsumer&lt;String&gt;()&#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stateChanged</span><span class="params">(CuratorFramework client, ConnectionState newState)</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"connection new state: "</span> + newState.name());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">consumeMessage</span><span class="params">(String message)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"consume one message: "</span> + message);                </span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>2.DistributedIdQueue</strong><br>DistributedIdQueue和上面的队列类似，但是可以为队列中的每一个元素设置一个ID。 可以通过ID把队列中任意的元素移除。</p>
<p>代码示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFramework;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFrameworkFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.api.CuratorEvent;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.api.CuratorListener;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.queue.DistributedIdQueue;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.queue.QueueBuilder;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.queue.QueueConsumer;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.queue.QueueSerializer;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.state.ConnectionState;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.retry.ExponentialBackoffRetry;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.test.TestingServer;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.utils.CloseableUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DistributedIdQueueExample</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PATH = <span class="string">"/example/queue"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        TestingServer server = <span class="keyword">new</span> TestingServer();</span><br><span class="line">        CuratorFramework client = <span class="keyword">null</span>;</span><br><span class="line">        DistributedIdQueue&lt;String&gt; queue = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            client = CuratorFrameworkFactory.newClient(server.getConnectString(), <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">3</span>));</span><br><span class="line">            client.getCuratorListenable().addListener(<span class="keyword">new</span> CuratorListener() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eventReceived</span><span class="params">(CuratorFramework client, CuratorEvent event)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                    System.out.println(<span class="string">"CuratorEvent: "</span> + event.getType().name());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            client.start();</span><br><span class="line">            QueueConsumer&lt;String&gt; consumer = createQueueConsumer();</span><br><span class="line">            QueueBuilder&lt;String&gt; builder = QueueBuilder.builder(client, consumer, createQueueSerializer(), PATH);</span><br><span class="line">            queue = builder.buildIdQueue();</span><br><span class="line">            queue.start();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                queue.put(<span class="string">" test-"</span> + i, <span class="string">"Id"</span> + i);</span><br><span class="line">                Thread.sleep((<span class="keyword">long</span>)(<span class="number">50</span> * Math.random()));</span><br><span class="line">                queue.remove(<span class="string">"Id"</span> + i);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Thread.sleep(<span class="number">20000</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            CloseableUtils.closeQuietly(queue);</span><br><span class="line">            CloseableUtils.closeQuietly(client);</span><br><span class="line">            CloseableUtils.closeQuietly(server);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> QueueSerializer&lt;String&gt; <span class="title">createQueueSerializer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> QueueSerializer&lt;String&gt;()&#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">byte</span>[] serialize(String item) &#123;</span><br><span class="line">                <span class="keyword">return</span> item.getBytes();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">deserialize</span><span class="params">(<span class="keyword">byte</span>[] bytes)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> String(bytes);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> QueueConsumer&lt;String&gt; <span class="title">createQueueConsumer</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> QueueConsumer&lt;String&gt;()&#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stateChanged</span><span class="params">(CuratorFramework client, ConnectionState newState)</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"connection new state: "</span> + newState.name());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">consumeMessage</span><span class="params">(String message)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"consume one message: "</span> + message);                </span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>3.DistributedPriorityQueue</strong><br>优先级队列对队列中的元素按照优先级进行排序。 Priority越小， 元素月靠前， 越先被消费掉。</p>
<p>示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFramework;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFrameworkFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.api.CuratorEvent;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.api.CuratorListener;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.queue.DistributedPriorityQueue;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.queue.QueueBuilder;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.queue.QueueConsumer;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.queue.QueueSerializer;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.state.ConnectionState;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.retry.ExponentialBackoffRetry;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.test.TestingServer;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.utils.CloseableUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DistributedPriorityQueueExample</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PATH = <span class="string">"/example/queue"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        TestingServer server = <span class="keyword">new</span> TestingServer();</span><br><span class="line">        CuratorFramework client = <span class="keyword">null</span>;</span><br><span class="line">        DistributedPriorityQueue&lt;String&gt; queue = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            client = CuratorFrameworkFactory.newClient(server.getConnectString(), <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">3</span>));</span><br><span class="line">            client.getCuratorListenable().addListener(<span class="keyword">new</span> CuratorListener() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eventReceived</span><span class="params">(CuratorFramework client, CuratorEvent event)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                    System.out.println(<span class="string">"CuratorEvent: "</span> + event.getType().name());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            client.start();</span><br><span class="line">            QueueConsumer&lt;String&gt; consumer = createQueueConsumer();</span><br><span class="line">            QueueBuilder&lt;String&gt; builder = QueueBuilder.builder(client, consumer, createQueueSerializer(), PATH);</span><br><span class="line">            queue = builder.buildPriorityQueue(<span class="number">0</span>);</span><br><span class="line">            queue.start();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">int</span> priority = (<span class="keyword">int</span>)(Math.random() * <span class="number">100</span>);</span><br><span class="line">                System.out.println(<span class="string">"test-"</span> + i + <span class="string">" priority:"</span> + priority);</span><br><span class="line">                queue.put(<span class="string">"test-"</span> + i, priority);</span><br><span class="line">                Thread.sleep((<span class="keyword">long</span>)(<span class="number">50</span> * Math.random()));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Thread.sleep(<span class="number">20000</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            CloseableUtils.closeQuietly(queue);</span><br><span class="line">            CloseableUtils.closeQuietly(client);</span><br><span class="line">            CloseableUtils.closeQuietly(server);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> QueueSerializer&lt;String&gt; <span class="title">createQueueSerializer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> QueueSerializer&lt;String&gt;()&#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">byte</span>[] serialize(String item) &#123;</span><br><span class="line">                <span class="keyword">return</span> item.getBytes();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">deserialize</span><span class="params">(<span class="keyword">byte</span>[] bytes)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> String(bytes);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> QueueConsumer&lt;String&gt; <span class="title">createQueueConsumer</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> QueueConsumer&lt;String&gt;()&#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stateChanged</span><span class="params">(CuratorFramework client, ConnectionState newState)</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"connection new state: "</span> + newState.name());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">consumeMessage</span><span class="params">(String message)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"consume one message: "</span> + message);                </span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>4.DistributedDelayQueue</strong></p>
<p>JDK中也有DelayQueue，不知道你是否熟悉。DistributedDelayQueue也提供了类似的功能， 元素有个delay值， 消费者隔一段时间才能收到元素。</p>
<p>示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFramework;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFrameworkFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.api.CuratorEvent;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.api.CuratorListener;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.queue.DistributedDelayQueue;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.queue.QueueBuilder;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.queue.QueueConsumer;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.queue.QueueSerializer;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.state.ConnectionState;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.retry.ExponentialBackoffRetry;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.test.TestingServer;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.utils.CloseableUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DistributedDelayQueueExample</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PATH = <span class="string">"/example/queue"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        TestingServer server = <span class="keyword">new</span> TestingServer();</span><br><span class="line">        CuratorFramework client = <span class="keyword">null</span>;</span><br><span class="line">        DistributedDelayQueue&lt;String&gt; queue = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            client = CuratorFrameworkFactory.newClient(server.getConnectString(), <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">3</span>));</span><br><span class="line">            client.getCuratorListenable().addListener(<span class="keyword">new</span> CuratorListener() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eventReceived</span><span class="params">(CuratorFramework client, CuratorEvent event)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                    System.out.println(<span class="string">"CuratorEvent: "</span> + event.getType().name());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            client.start();</span><br><span class="line">            QueueConsumer&lt;String&gt; consumer = createQueueConsumer();</span><br><span class="line">            QueueBuilder&lt;String&gt; builder = QueueBuilder.builder(client, consumer, createQueueSerializer(), PATH);</span><br><span class="line">            queue = builder.buildDelayQueue();</span><br><span class="line">            queue.start();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                queue.put(<span class="string">"test-"</span> + i, System.currentTimeMillis() + <span class="number">10000</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="keyword">new</span> Date().getTime() + <span class="string">": already put all items"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            Thread.sleep(<span class="number">20000</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            CloseableUtils.closeQuietly(queue);</span><br><span class="line">            CloseableUtils.closeQuietly(client);</span><br><span class="line">            CloseableUtils.closeQuietly(server);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> QueueSerializer&lt;String&gt; <span class="title">createQueueSerializer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> QueueSerializer&lt;String&gt;() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">byte</span>[] serialize(String item) &#123;</span><br><span class="line">                <span class="keyword">return</span> item.getBytes();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">deserialize</span><span class="params">(<span class="keyword">byte</span>[] bytes)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> String(bytes);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> QueueConsumer&lt;String&gt; <span class="title">createQueueConsumer</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> QueueConsumer&lt;String&gt;() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stateChanged</span><span class="params">(CuratorFramework client, ConnectionState newState)</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"connection new state: "</span> + newState.name());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">consumeMessage</span><span class="params">(String message)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                System.out.println(<span class="keyword">new</span> Date().getTime() + <span class="string">": consume one message: "</span> + message);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>5.SimpleDistributedQueue</strong><br>前面虽然实现了各种队列，但是你注意到没有，这些队列并没有实现类似JDK一样的接口。 SimpleDistributedQueue提供了和JDK一致性的接口(但是没有实现Queue接口)。 创建很简单：<br>public SimpleDistributedQueue(CuratorFramework client,String path)</p>
<p>增加元素：<br>public boolean offer(byte[] data) throws Exception</p>
<p>删除元素：<br>public byte[] take() throws Exception</p>
<p>另外还提供了其它方法：<br>public byte[] peek() throws Exception<br>public byte[] poll(long timeout, TimeUnit unit) throws Exception<br>public byte[] poll() throws Exception<br>public byte[] remove() throws Exception<br>public byte[] element() throws Exception<br>没有add方法， 多了take方法。</p>

          
            <br>
            
  
    
    

<section class="widget copyright  desktop mobile">
  <div class='content'>
    
      <blockquote>
        
          
            <p>博客内容遵循 署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</p>

          
        
          
            <p>本文永久链接是：<a href=https://www.bcoder.top/2018/01/27/%E4%B8%9A%E4%BD%99%E5%AD%A6%E4%B9%A0%E4%B9%8BZookeeper%E6%B7%B1%E5%85%A5%E7%AF%87/>https://www.bcoder.top/2018/01/27/%E4%B8%9A%E4%BD%99%E5%AD%A6%E4%B9%A0%E4%B9%8BZookeeper%E6%B7%B1%E5%85%A5%E7%AF%87/</a></p>
          
        
      </blockquote>
    
  </div>
</section>

  

  
    
    

<section class="widget qrcode  desktop mobile">
  

  <div class='content article-entry'>
    
      
        <div class='fancybox'><img src='https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/qrcode/wiki_volantis.png'
        
          height='64px'
        ></div>
      
    
      
        <div class='fancybox'><img src='https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/qrcode/wiki_volantis.png'
        
          height='64px'
        ></div>
      
    
  </div>
</section>

  


          
        </div>
        
          


  <section class='meta' id="footer-meta">
    <div class='new-meta-box'>
      
        
          <div class="new-meta-item date" itemprop="dateUpdated" datetime="2020-01-21T18:44:04+08:00">
  <a class='notlink'>
    <i class="fas fa-edit fa-fw" aria-hidden="true"></i>
    <p>更新于：2020-01-21 18:44:04</p>
  </a>
</div>

        
      
        
          
  
  <div class="new-meta-item meta-tags"><a class="tag" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" rel="nofollow"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i><p>分布式</p></a></div> <div class="new-meta-item meta-tags"><a class="tag" href="/tags/Zookeeper/" rel="nofollow"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i><p>Zookeeper</p></a></div> <div class="new-meta-item meta-tags"><a class="tag" href="/tags/%E9%9B%86%E7%BE%A4/" rel="nofollow"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i><p>集群</p></a></div> <div class="new-meta-item meta-tags"><a class="tag" href="/tags/zkClient/" rel="nofollow"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i><p>zkClient</p></a></div> <div class="new-meta-item meta-tags"><a class="tag" href="/tags/Curator%E6%A1%86%E6%9E%B6/" rel="nofollow"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i><p>Curator框架</p></a></div> <div class="new-meta-item meta-tags"><a class="tag" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" rel="nofollow"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i><p>分布式锁</p></a></div>


        
      
        
          

        
      
        
          
  <div class="new-meta-item share -mob-share-list">
  <div class="-mob-share-list share-body">
    
      
        <a class="-mob-share-qq" title="" rel="external nofollow noopener noreferrer"
          
          href="http://connect.qq.com/widget/shareqq/index.html?url=https://www.bcoder.top/2018/01/27/%E4%B8%9A%E4%BD%99%E5%AD%A6%E4%B9%A0%E4%B9%8BZookeeper%E6%B7%B1%E5%85%A5%E7%AF%87/&title=业余学习之Zookeeper深入篇 - zln's blog&summary=
引言本系列主要是业余知识拓展（java相关方面的知识）的学习笔记，便于以后查看和复习。
"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/qq.png">
          
        </a>
      
    
      
        <a class="-mob-share-qzone" title="" rel="external nofollow noopener noreferrer"
          
          href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://www.bcoder.top/2018/01/27/%E4%B8%9A%E4%BD%99%E5%AD%A6%E4%B9%A0%E4%B9%8BZookeeper%E6%B7%B1%E5%85%A5%E7%AF%87/&title=业余学习之Zookeeper深入篇 - zln's blog&summary=
引言本系列主要是业余知识拓展（java相关方面的知识）的学习笔记，便于以后查看和复习。
"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/qzone.png">
          
        </a>
      
    
      
        <a class="-mob-share-weibo" title="" rel="external nofollow noopener noreferrer"
          
          href="http://service.weibo.com/share/share.php?url=https://www.bcoder.top/2018/01/27/%E4%B8%9A%E4%BD%99%E5%AD%A6%E4%B9%A0%E4%B9%8BZookeeper%E6%B7%B1%E5%85%A5%E7%AF%87/&title=业余学习之Zookeeper深入篇 - zln's blog&summary=
引言本系列主要是业余知识拓展（java相关方面的知识）的学习笔记，便于以后查看和复习。
"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/weibo.png">
          
        </a>
      
    
  </div>
</div>



        
      
    </div>
  </section>


        
        
          <div class="prev-next">
            
              <a class='prev' href='/2018/01/30/%E4%B8%9A%E4%BD%99%E5%AD%A6%E4%B9%A0%E4%B9%8BDubbo%E7%AF%87/'>
                <p class='title'><i class="fas fa-chevron-left" aria-hidden="true"></i>业余学习之Dubbo篇</p>
                <p class='content'>
引言本系列主要是业余知识拓展（java相关方面的知识）的学习笔记，便于以后查看和复习。



Dubbo介绍1.Dubbo是什么？
Dubbo是一个分布式服务框架，致力于提供高性能和透明化的R...</p>
              </a>
            
            
              <a class='next' href='/2018/01/26/%E4%B8%9A%E4%BD%99%E5%AD%A6%E4%B9%A0%E4%B9%8BZookeeper%E5%9F%BA%E7%A1%80%E7%AF%87/'>
                <p class='title'>业余学习之Zookeeper基础篇<i class="fas fa-chevron-right" aria-hidden="true"></i></p>
                <p class='content'>
引言本系列主要是业余知识拓展（java相关方面的知识）的学习笔记，便于以后查看和复习。



Zookeeper简介什么是ZookeeperZooKeeper是一个开放源代码的分布式协调服务，...</p>
              </a>
            
          </div>
        
      </section>
    </article>
  

  
    <!-- 显示推荐文章和评论 -->



  <article class="post white-box comments shadow">
    <section class="article typo">
      <p ct><i class='fas fa-comments'></i> 评论</p>
      
      
      
      
      
        <section id="comments">
          <div id="valine_container" class="valine_thread">
            <i class="fas fa-spinner fa-spin fa-fw"></i>
          </div>
        </section>
      
    </section>
  </article>


  




<!-- 根据页面mathjax变量决定是否加载MathJax数学公式js -->



  <script>
    window.subData = {
      title: '业余学习之Zookeeper深入篇',
      tools: true
    }
  </script>


</div>
<aside class='l_side'>
  
  

  
    
    


  <section class="widget toc-wrapper shadow desktop mobile">
    
  <header>
    
      <i class="fas fa-list fa-fw" aria-hidden="true"></i><span class='name'>本文目录</span>
    
  </header>


    <div class='content'>
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Zookeeper-watcher"><span class="toc-number">1.</span> <span class="toc-text">Zookeeper watcher</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Zookeeper-ACL权限认证"><span class="toc-number">2.</span> <span class="toc-text">Zookeeper ACL权限认证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Zookeeper-多客户端操作"><span class="toc-number">3.</span> <span class="toc-text">Zookeeper 多客户端操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ZookeeperClient使用"><span class="toc-number">4.</span> <span class="toc-text">ZookeeperClient使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ZookeeperClient节点操作方法"><span class="toc-number">4.1.</span> <span class="toc-text">ZookeeperClient节点操作方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ZookeeperClient对watch的改进"><span class="toc-number">4.2.</span> <span class="toc-text">ZookeeperClient对watch的改进</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Curator框架"><span class="toc-number">5.</span> <span class="toc-text">Curator框架</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Curator框架介绍"><span class="toc-number">5.1.</span> <span class="toc-text">Curator框架介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Curator基本使用"><span class="toc-number">5.2.</span> <span class="toc-text">Curator基本使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Curator监听"><span class="toc-number">5.3.</span> <span class="toc-text">Curator监听</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Curator应用场景—分布式锁"><span class="toc-number">5.4.</span> <span class="toc-text">Curator应用场景—分布式锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Curator应用场景—分布式计数器"><span class="toc-number">5.5.</span> <span class="toc-text">Curator应用场景—分布式计数器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Curator应用场景—分布式Barrier"><span class="toc-number">5.6.</span> <span class="toc-text">Curator应用场景—分布式Barrier</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Curator应用场景—分布式Queue-队列"><span class="toc-number">5.7.</span> <span class="toc-text">Curator应用场景—分布式Queue(队列)</span></a></li></ol></li></ol>
    </div>
  </section>


  


</aside>


  
  <footer class="clearfix">
    <br><br>
    
      
        <br>
        <div class="social-wrapper">
          
            
              <a href="https://www.bcoder.top"
                class="social fas fa-rss flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
            
              <a href="mailto:me@xaoxuu.com"
                class="social fas fa-envelope flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
            
              <a href="https://github.com/zlnnjit"
                class="social fab fa-github flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
            
              <a href="https://music.163.com/#/user/home?id=430673592"
                class="social fas fa-headphones-alt flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
        </div>
      
    
      
        Use
        <a href="https://bcoder.top/" target="_blank" class="codename">周陆宁</a>
        as theme
        
          , 
          total visits
          <span id="busuanzi_value_site_pv"><i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span>
          times
        
      
    
      
        <div class='copyright'>
        <p><a href="https://bocder.top" target="_blank" rel="noopener">Copyright © 2016-2020 zlnnjit</a></p>

        </div>
      
    
  </footer>

<script>setLoadingBarProgress(80);</script>


      <script>setLoadingBarProgress(60);</script>
    </div>
    <a class="s-top fas fa-arrow-up fa-fw" href='javascript:void(0)'></a>
  </div>
  
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4/dist/jquery.min.js"></script>


  <script>
    
    var SEARCH_SERVICE = "hexo" || "hexo";
    var ROOT = "/" || "/";
    if (!ROOT.endsWith('/')) ROOT += '/';
  </script>


  <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2/js/instant_page.js" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>



  
<script src="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js"></script>

  <script type="text/javascript">
    $(function() {
      Waves.attach('.flat-btn', ['waves-button']);
      Waves.attach('.float-btn', ['waves-button', 'waves-float']);
      Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);
      Waves.attach('.flat-box', ['waves-block']);
      Waves.attach('.float-box', ['waves-block', 'waves-float']);
      Waves.attach('.waves-image');
      Waves.init();
    });
  </script>


  <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js"></script>



  
  
  
    
<script src="https://cdn.jsdelivr.net/npm/jquery-backstretch@2.1.18/jquery.backstretch.min.js"></script>

    <script type="text/javascript">
      $(function(){
        var imgs=["https://cdn.jsdelivr.net/gh/xaoxuu/cdn-wallpaper/abstract/41F215B9-261F-48B4-80B5-4E86E165259E.jpeg"];
        if ('true' == 'true') {
          function shuffle(arr){
            /*From countercurrent-time*/
            var n = arr.length;
            while(n--) {
              var index = Math.floor(Math.random() * n);
              var temp = arr[index];
              arr[index] = arr[n];
              arr[n] = temp;
            }
          }
          shuffle(imgs);
        }
        if ('.cover') {
          $('.cover').backstretch(
            imgs,
          {
            duration: "20000",
            fade: "1500"
          });
        } else {
          $.backstretch(
            imgs,
          {
            duration: "20000",
            fade: "1500"
          });
        }
      });
    </script>
  



  
    
<script src="https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.js" async></script>

  
    
<script src="https://cdn.jsdelivr.net/npm/meting@2.0/dist/Meting.min.js" async></script>

  








  
    
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2.2.0/js/valine.js"></script>

  
  <script>
  var GUEST_INFO = ['nick','mail','link'];
  var guest_info = 'nick,mail,link'.split(',').filter(function(item){
    return GUEST_INFO.indexOf(item) > -1
  });
  var notify = 'true' == true;
  var verify = 'true' == true;
  var valine = new Valine();
  valine.init({
    el: '#valine_container',
    notify: notify,
    verify: verify,
    guest_info: guest_info,
    
    appId: "M3YhrSNLSJTxyKwa8hGSGbH7-gzGzoHsz",
    appKey: "RwjMsAULtRweeA4GtaqJGPVu",
    placeholder: "快来评论吧~",
    pageSize:'10',
    avatar:'mp',
    lang:'zh-cn',
    visitor: 'false',
    highlight:'true'
  })
  </script>



  
<script src="/js/app.js"></script>



  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2.1/js/search.js"></script>



  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2/js/comment_typing.js"></script>



<!-- 复制 -->

  <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="fas fa-copy"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copyed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('fa-copy');
        $icon.addClass('fa-clipboard-check');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPYED';
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('fa-copy');
        $icon.addClass('fa-exclamation-triangle');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
      });
    }
    initCopyCode();
  }(window, document);
</script>




<!-- fancybox -->

  <script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script>
  let LAZY_LOAD_IMAGE = "";
  $(".article-entry").find("div.fancybox").find("img").each(function () {
      var element = document.createElement("a");
      $(element).attr("data-fancybox", "gallery");
      $(element).attr("href", $(this).attr("src"));
      /* 图片采用懒加载处理时,
       * 一般图片标签内会有个属性名来存放图片的真实地址，比如 data-original,
       * 那么此处将原本的属性名src替换为对应属性名data-original,
       * 修改如下
       */
       if (LAZY_LOAD_IMAGE) {
         $(element).attr("href", $(this).attr("data-original"));
       }
      $(this).wrap(element);
  });
</script>






  <script>setLoadingBarProgress(100);</script>
</body>
</html>

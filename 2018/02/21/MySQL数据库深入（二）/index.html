<!DOCTYPE html>
<html>
<head hexo-theme='https://volantis.js.org/#2020'>
  <meta charset="utf-8">
  <!-- SEO相关 -->
  
    
  
  <!-- 渲染优化 -->
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <!-- 页面元数据 -->
  
    <title>MySQL数据库深入（二） - zln&#39;s blog</title>
  
    <meta name="keywords" content="MySQL,数据库">
  
  
    <meta name="description" content="
引言数据库对于程序员来说至关重要，数据库的学习不能仅仅停留在SQL语句的书写上，应当数据库的底层原理、架构、SQL优化等方面有一个全面的了解。下面对关系型数据库MySQL进行较为深入的学习。
">
  

  <!-- feed -->
  

  <!-- import meta -->
  

  <!-- link -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css">
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">

  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css">

  

  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.css">
  

  <!-- import link -->
  

  
    
<link rel="stylesheet" href="/css/style.css">

  

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>

  
  
</head>

<body>
  
  <div class="cover-wrapper">
    
      <cover class='cover post half'>
        <div class='cover-body'>
  <div class='a'>
    
    
      <p class="title">bcoder.top</p>
    
    
      <p class="subtitle">不忘初心，无畏前行</p>
    
  </div>
  <div class='b'>
    
      <div class="m_search">
        <form name="searchform" class="form u-search-form">
          <input type="text" class="input u-search-input" placeholder="" />
          <i class="icon fas fa-search fa-fw"></i>
        </form>
      </div>
    
    <div class='menu navigation'>
      <ul class='h-list'>
        
          
            <li>
              <a class="nav home"
                href="/"
                
                
                id="home">
                <i class='fas fa-rss fa-fw'></i>&nbsp;博客
              </a>
            </li>
          
            <li>
              <a class="nav home"
                href="/categories/"
                
                
                id="categories">
                <i class='fas fa-folder-open fa-fw'></i>&nbsp;分类
              </a>
            </li>
          
            <li>
              <a class="nav home"
                href="/tags/"
                
                
                id="tags">
                <i class='fas fa-tags fa-fw'></i>&nbsp;标签
              </a>
            </li>
          
            <li>
              <a class="nav home"
                href="/archives/"
                
                
                id="archives">
                <i class='fas fa-archive fa-fw'></i>&nbsp;归档
              </a>
            </li>
          
        
      </ul>
    </div>
  </div>
</div>

      </cover>
    
    <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>
<header class="l_header shadow blur">

  <div class='wrapper'>
    <div class='nav-sub container--flex'>
      <a class="logo flat-box"></a>
      <ul class='switcher h-list'>
        <li><a class="s-comment flat-btn fas fa-comments fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
          <li><a class="s-toc flat-btn fas fa-list fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
      </ul>
    </div>
		<div class="nav-main container container--flex">
      
        
        <a class="logo flat-box" target="_self" href='/'>
          
          
          
          
            周陆宁 <b><sup style='color:#3AA757'>2020</sup></b>
          
        </a>
      

			<div class='menu navigation'>
				<ul class='h-list'>
          
          
          
            
            
              <li>
                <a class="flat-box" href=/
                  
                  
                  
                    id="home"
                  >
                  
                    <i class='fas fa-rss fa-fw'></i>
                  
                  博客
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=/categories/
                  
                  
                  
                    id="categories"
                  >
                  
                    <i class='fas fa-folder-open fa-fw'></i>
                  
                  分类
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=/tags/
                  
                  
                  
                    id="tags"
                  >
                  
                    <i class='fas fa-tags fa-fw'></i>
                  
                  标签
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=/archives/
                  
                  
                  
                    id="archives"
                  >
                  
                    <i class='fas fa-archive fa-fw'></i>
                  
                  归档
                </a>
                
              </li>
            
          
          
				</ul>
			</div>

      
        <div class="m_search">
          <form name="searchform" class="form u-search-form">
            <i class="icon fas fa-search fa-fw"></i>
            <input type="text" class="input u-search-input" placeholder="搜索" />
          </form>
        </div>
      

			<ul class='switcher h-list'>
				
					<li><a class="s-search flat-btn fas fa-search fa-fw" target="_self" href='javascript:void(0)'></a></li>
				
				<li><a class="s-menu flat-btn fas fa-bars fa-fw" target="_self" href='javascript:void(0)'></a></li>
			</ul>
		</div>
	</div>
</header>
<ul class="menu-phone navigation white-box">
  
  
    <li>
      <a class="flat-box" href=/
        
        
        
          id="home"
        >
        
          <i class='fas fa-rss fa-fw'></i>
        
        博客
      </a>
    </li>
  
    <li>
      <a class="flat-box" href=/categories/
        
        
        
          id="categories"
        >
        
          <i class='fas fa-folder-open fa-fw'></i>
        
        分类
      </a>
    </li>
  
    <li>
      <a class="flat-box" href=/tags/
        
        
        
          id="tags"
        >
        
          <i class='fas fa-tags fa-fw'></i>
        
        标签
      </a>
    </li>
  
    <li>
      <a class="flat-box" href=/archives/
        
        
        
          id="archives"
        >
        
          <i class='fas fa-archive fa-fw'></i>
        
        归档
      </a>
    </li>
  
    <li>
      <a class="flat-box" href=/friends/
        
        
        
          id="friends"
        >
        
          <i class='fas fa-link fa-fw'></i>
        
        友链
      </a>
    </li>
  
    <li>
      <a class="flat-box" href=/about/
        
        
        
          id="about"
        >
        
          <i class='fas fa-info-circle fa-fw'></i>
        
        关于
      </a>
    </li>
  
</ul>
<script>setLoadingBarProgress(40);</script>

  </div>


  <div class="l_body">
    <div class='body-wrapper'>
      

<div class='l_main'>
  

  
    <article id="post" class="post white-box shadow article-type-post" itemscope itemprop="blogPost">
      


  <section class='meta'>
    
    
    <div class="meta" id="header-meta">
      
        
  
    <h1 class="title">
      <a href="/2018/02/21/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E6%B7%B1%E5%85%A5%EF%BC%88%E4%BA%8C%EF%BC%89/">
        MySQL数据库深入（二）
      </a>
    </h1>
  


      
      <div class='new-meta-box'>
        
          
        
          
            
<div class='new-meta-item author'>
  <a href="" rel="nofollow">
    <img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/avatar/avatar.png">
    <p>周陆宁</p>
  </a>
</div>

          
        
          
            
  
  <div class='new-meta-item category'>
    <a href='/categories/MySQL/' rel="nofollow">
      <i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>
      <p>MySQL</p>
    </a>
  </div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i>
    <p>发布于：2018-02-21 16:19:06</p>
  </a>
</div>

          
        
          
            
  <div class="new-meta-item wordcount">
    <a class='notlink'>
      <i class="fas fa-keyboard fa-fw" aria-hidden="true"></i>
      <p>字数：6.9k</p>
    </a>
  </div>
  <div class="new-meta-item readtime">
    <a class='notlink'>
      <i class="fas fa-hourglass-half fa-fw" aria-hidden="true"></i>
      <p>时长：31 分钟</p>
    </a>
  </div>


          
        
          
            

          
        
      </div>
      
        <hr>
      
    </div>
  </section>


      <section class="article typo">
        <div class="article-entry" itemprop="articleBody">
          
          <blockquote>
<p>引言<br>数据库对于程序员来说至关重要，数据库的学习不能仅仅停留在SQL语句的书写上，应当数据库的底层原理、架构、SQL优化等方面有一个全面的了解。下面对关系型数据库MySQL进行较为深入的学习。</p>
</blockquote>
<a id="more"></a>

<p>我们接着上文讲，上文对MySQL的索引以及对SQL的性能分析已经做了一个比较全面的讲解，接下来通过实例来讲解索引优化。</p>
<h2 id="索引优化案例"><a href="#索引优化案例" class="headerlink" title="索引优化案例"></a>索引优化案例</h2><h3 id="单表索引优化"><a href="#单表索引优化" class="headerlink" title="单表索引优化"></a>单表索引优化</h3><h4 id="建表"><a href="#建表" class="headerlink" title="建表"></a>建表</h4><p>建立本次优化案例中所需的数据库及数据表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> db02;</span><br><span class="line"><span class="keyword">USE</span> db02;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`db02`</span>.<span class="string">`article`</span>(  </span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`author_id`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`category_id`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`views`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`comments`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`title`</span> <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`content`</span> <span class="built_in">TEXT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">INNODB</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`db02`</span>.<span class="string">`article`</span> (<span class="string">`id`</span>, <span class="string">`author_id`</span>, <span class="string">`category_id`</span>, <span class="string">`views`</span>, <span class="string">`comments`</span>, <span class="string">`title`</span>, <span class="string">`content`</span>) <span class="keyword">VALUES</span> (<span class="literal">NULL</span>, <span class="string">'1'</span>, <span class="string">'1'</span>, <span class="string">'1'</span>, <span class="string">'1'</span>, <span class="string">'1'</span>, <span class="string">'1'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`db02`</span>.<span class="string">`article`</span> (<span class="string">`id`</span>, <span class="string">`author_id`</span>, <span class="string">`category_id`</span>, <span class="string">`views`</span>, <span class="string">`comments`</span>, <span class="string">`title`</span>, <span class="string">`content`</span>) <span class="keyword">VALUES</span> (<span class="literal">NULL</span>, <span class="string">'2'</span>, <span class="string">'2'</span>, <span class="string">'2'</span>, <span class="string">'2'</span>, <span class="string">'2'</span>, <span class="string">'2'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`db02`</span>.<span class="string">`article`</span> (<span class="string">`id`</span>, <span class="string">`author_id`</span>, <span class="string">`category_id`</span>, <span class="string">`views`</span>, <span class="string">`comments`</span>, <span class="string">`title`</span>, <span class="string">`content`</span>) <span class="keyword">VALUES</span> (<span class="literal">NULL</span>, <span class="string">'1'</span>, <span class="string">'1'</span>, <span class="string">'3'</span>, <span class="string">'3'</span>, <span class="string">'3'</span>, <span class="string">'3'</span>);</span><br></pre></td></tr></table></figure>

<h4 id="单表索引分析"><a href="#单表索引分析" class="headerlink" title="单表索引分析"></a>单表索引分析</h4><p>下面我们来执行这条sql：查询category_id为1，且comments大于1的情况下，views最多的article_id</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">id</span>,author_id <span class="keyword">FROM</span> article <span class="keyword">WHERE</span> category_id = <span class="number">1</span> <span class="keyword">AND</span> comments &gt; <span class="number">1</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> views <span class="keyword">DESC</span> <span class="keyword">LIMIT</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p><img src="http://img.bcoder.top/2018.02.21/1.png" alt="MySQL数据库深入（二）"></p>
<p>通过explain命令来查看sql查询优化信息:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> <span class="keyword">id</span>,author_id <span class="keyword">FROM</span> article <span class="keyword">WHERE</span> category_id = <span class="number">1</span> <span class="keyword">AND</span> comments &gt; <span class="number">1</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> views <span class="keyword">DESC</span> <span class="keyword">LIMIT</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>sql查询优化信息:</p>
<p><img src="http://img.bcoder.top/2018.02.21/2.png" alt="MySQL数据库深入（二）"></p>
<p>很显然type是ALL，即最坏情况。Extra里还出现Using filesort（文件内排序），也是最坏情况，所以优化是必须的。</p>
<h4 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h4><p>建立索引的SQL语句:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> idx_article_ccv <span class="keyword">ON</span> article (category_id,comments,views);</span><br></pre></td></tr></table></figure>

<p>再次执行查询分析sql:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> <span class="keyword">id</span>,author_id <span class="keyword">FROM</span> article <span class="keyword">WHERE</span> category_id = <span class="number">1</span> <span class="keyword">AND</span> comments &gt; <span class="number">1</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> views <span class="keyword">DESC</span> <span class="keyword">LIMIT</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p><img src="http://img.bcoder.top/2018.02.21/3.png" alt="MySQL数据库深入（二）"></p>
<p>type变成了range，这是可以忍受的。但是extra里使用了Using filesort 仍然是无法接受的。 </p>
<p>但是我们已经建立的索引，为啥没有用呢？<br>这是因为按照BTree索引的工作原理先排序category_id，如果遇到相同的category_id则再排序comments，如果遇到相同的commetns则再排序views.<br>当comments字段在联合索引中处于中间位置时， 因为comments &gt; 1 条件是一个范围值（所谓的range），Mysql无法利用索引再对后面的views部分进行检索，即range类型查询字段后面索引无效。</p>
<h4 id="第二次优化"><a href="#第二次优化" class="headerlink" title="第二次优化"></a>第二次优化</h4><p>删除不合适的索引:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">INDEX</span> idx_article_ccv <span class="keyword">ON</span> article;</span><br></pre></td></tr></table></figure>

<p>重新建立索引:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> idx_article_cv <span class="keyword">ON</span> article(category_id,views);</span><br></pre></td></tr></table></figure>

<p>重新执行查询分析</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> <span class="keyword">id</span>,author_id <span class="keyword">FROM</span> article <span class="keyword">WHERE</span> category_id = <span class="number">1</span> <span class="keyword">AND</span> comments &gt; <span class="number">1</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> views <span class="keyword">DESC</span> <span class="keyword">LIMIT</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p><img src="http://img.bcoder.top/2018.02.21/4.png" alt="MySQL数据库深入（二）"></p>
<p>根据MySQL的查询分析报告可知，使用当前建立的索引，达到了type=ref,且extra中没有出现Using filesort，因此，我们现在使用的索引结构达到了最优的情况。</p>
<h3 id="两表索引优化"><a href="#两表索引优化" class="headerlink" title="两表索引优化"></a>两表索引优化</h3><h4 id="建表-1"><a href="#建表-1" class="headerlink" title="建表"></a>建表</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">EXISTS</span> <span class="string">`class`</span>(</span><br><span class="line">	<span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">UNSIGNED</span> <span class="keyword">not</span> <span class="literal">null</span> auto_increment,</span><br><span class="line">	<span class="string">`card`</span> <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">UNSIGNED</span> <span class="keyword">not</span> <span class="literal">NULL</span>,</span><br><span class="line">	PRIMARY <span class="keyword">KEY</span>(<span class="string">`id`</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">if</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`book`</span>(</span><br><span class="line">	<span class="string">`bookid`</span> <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">UNSIGNED</span> <span class="keyword">not</span> <span class="literal">null</span> auto_increment,</span><br><span class="line">	<span class="string">`card`</span> <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">UNSIGNED</span> <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">	PRIMARY <span class="keyword">key</span>(<span class="string">`bookid`</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">20</span>)));</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">20</span>)));</span><br></pre></td></tr></table></figure>

<h4 id="两表索引分析"><a href="#两表索引分析" class="headerlink" title="两表索引分析"></a>两表索引分析</h4><p>下面我们来执行这条sql：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">from</span> <span class="keyword">class</span> <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> book <span class="keyword">ON</span> class.card = book.card;</span><br></pre></td></tr></table></figure>

<p><img src="http://img.bcoder.top/2018.02.21/5.png" alt="MySQL数据库深入（二）"></p>
<p>通过explain命令来查看sql查询优化信息:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">from</span> <span class="keyword">class</span> <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> book <span class="keyword">ON</span> class.card = book.card;</span><br></pre></td></tr></table></figure>

<p>sql查询优化信息:</p>
<p><img src="http://img.bcoder.top/2018.02.21/6.png" alt="MySQL数据库深入（二）"></p>
<p>结论：type 有All ，需要优化</p>
<h4 id="优化-1"><a href="#优化-1" class="headerlink" title="优化"></a>优化</h4><p>建立索引的SQL语句:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`book`</span> <span class="keyword">ADD</span> <span class="keyword">INDEX</span> Y(<span class="string">`card`</span>);</span><br></pre></td></tr></table></figure>

<p>再次执行查询分析sql:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">SELECT</span> * <span class="keyword">from</span> <span class="keyword">class</span> <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> book <span class="keyword">ON</span> class.card = book.card;</span><br></pre></td></tr></table></figure>

<p><img src="http://img.bcoder.top/2018.02.21/7.png" alt="MySQL数据库深入（二）"></p>
<p>可以看到第二行的 type 变为了 ref , rows 也变成了 1 优化比较明显。<br>这是由左连接特性决定的。LEFT JOIN条件用于确定从右表搜索行，左边一定都有，<br>所以右边是我们的关键点，一定需要建立索引。</p>
<h4 id="再次分析"><a href="#再次分析" class="headerlink" title="再次分析"></a>再次分析</h4><p>左连接改成右连接：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">SELECT</span> * <span class="keyword">from</span> <span class="keyword">class</span> <span class="keyword">RIGHT</span> <span class="keyword">JOIN</span> book <span class="keyword">ON</span> class.card = book.card</span><br></pre></td></tr></table></figure>
<p><img src="http://img.bcoder.top/2018.02.21/8.png" alt="MySQL数据库深入（二）"></p>
<p>删除索引:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">index</span> Y <span class="keyword">on</span> book;</span><br></pre></td></tr></table></figure>
<p>重建索引</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> X <span class="keyword">on</span> <span class="keyword">class</span>(card);</span><br></pre></td></tr></table></figure>
<p>再次分析</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">SELECT</span> * <span class="keyword">from</span> <span class="keyword">class</span> <span class="keyword">RIGHT</span> <span class="keyword">JOIN</span> book <span class="keyword">ON</span> class.card = book.card</span><br></pre></td></tr></table></figure>
<p><img src="http://img.bcoder.top/2018.02.21/9.png" alt="MySQL数据库深入（二）"></p>
<p>优化比较明显。这是因为RIGHT JOIN 条件用于确定如何从左表搜索行，右边一定都有，所以左边是我们的关键点，一定需要建立索引。</p>
<p>综上所述 ,我们得到以下结论:<br><strong>左连接：索引建在右表上。<br>右连接：索引建在左表上。</strong></p>
<h3 id="三表索引优化"><a href="#三表索引优化" class="headerlink" title="三表索引优化"></a>三表索引优化</h3><h4 id="建表-2"><a href="#建表-2" class="headerlink" title="建表"></a>建表</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`phone`</span> (  </span><br><span class="line"><span class="string">`phoneid`</span> <span class="built_in">INT</span>(<span class="number">10</span>) <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,  </span><br><span class="line"><span class="string">`card`</span> <span class="built_in">INT</span>(<span class="number">10</span>) <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (<span class="string">`phoneid`</span>)  </span><br><span class="line">) <span class="keyword">ENGINE</span> = <span class="keyword">INNODB</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));  </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));  </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));  </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));  </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));  </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));  </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));  </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));  </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));  </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));  </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));  </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));  </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));  </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));  </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));  </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));  </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));  </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));  </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));  </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span> + (<span class="keyword">RAND</span>() * <span class="number">20</span>)));</span><br></pre></td></tr></table></figure>

<h4 id="三表索引分析"><a href="#三表索引分析" class="headerlink" title="三表索引分析"></a>三表索引分析</h4><p>接下来给表建立索引</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`phone`</span> <span class="keyword">ADD</span> <span class="keyword">INDEX</span> Z ( <span class="string">`card`</span>);</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`book`</span> <span class="keyword">ADD</span> <span class="keyword">INDEX</span> Y ( <span class="string">`card`</span>);</span><br></pre></td></tr></table></figure>

<p>下面我们来执行这条sql：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">class</span> <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> book <span class="keyword">ON</span> class.card=book.card <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> phone <span class="keyword">ON</span> book.card = phone.card;</span><br></pre></td></tr></table></figure>
<p><img src="http://img.bcoder.top/2018.02.21/10.png" alt="MySQL数据库深入（二）"></p>
<p>通过explain命令来查看sql查询优化信息:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">class</span> <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> book <span class="keyword">ON</span> class.card=book.card <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> phone <span class="keyword">ON</span> book.card = phone.card;</span><br></pre></td></tr></table></figure>

<p>sql查询优化信息:</p>
<p><img src="http://img.bcoder.top/2018.02.21/11.png" alt="MySQL数据库深入（二）"></p>
<p>后 2 行的 type 都是 ref 且总 rows 优化很好,效果不错。因此索引最好设置在需要经常查询的字段中。</p>
<p>结论：</p>
<p>1.尽可能减少Join语句中的NestedLoop的循环总次数：“永远用小结果集驱动大的结果集”(小表驱动大表)。</p>
<p>2.Join语句的优化，优先优化NestedLoop的内层循环；</p>
<p><strong>3.保证Join语句中被驱动表上Join条件字段已经被索引；</strong></p>
<p>当无法保证被驱动表的Join条件字段被索引且内存资源充足的前提下，不要太吝惜JoinBuffer的设置；此属性在my.cnf中设置。</p>
<h2 id="索引失效"><a href="#索引失效" class="headerlink" title="索引失效"></a>索引失效</h2><p>首先我们先来建表、插入数据以及增加索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> staffs(</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">INT</span> PRIMARY <span class="keyword">KEY</span> AUTO_INCREMENT,</span><br><span class="line">    <span class="keyword">name</span> <span class="built_in">VARCHAR</span>(<span class="number">24</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">""</span> <span class="keyword">COMMENT</span><span class="string">'姓名'</span>,</span><br><span class="line">    age <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span><span class="string">'年龄'</span>,</span><br><span class="line">    pos <span class="built_in">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">""</span> <span class="keyword">COMMENT</span><span class="string">'职位'</span>,</span><br><span class="line">    add_time <span class="built_in">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">COMMENT</span><span class="string">'入职事件'</span></span><br><span class="line">) <span class="keyword">CHARSET</span> utf8 <span class="keyword">COMMENT</span><span class="string">'员工记录表'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`staffs`</span> (<span class="string">`name`</span>, <span class="string">`age`</span>, <span class="string">`pos`</span>, <span class="string">`add_time`</span>) <span class="keyword">VALUES</span> (<span class="string">'z3'</span>, <span class="number">22</span>, <span class="string">'manager'</span>, <span class="keyword">now</span>());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`staffs`</span> (<span class="string">`name`</span>, <span class="string">`age`</span>, <span class="string">`pos`</span>, <span class="string">`add_time`</span>) <span class="keyword">VALUES</span> (<span class="string">'July'</span>, <span class="number">23</span>, <span class="string">'dev'</span>, <span class="keyword">now</span>());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`staffs`</span> (<span class="string">`name`</span>, <span class="string">`age`</span>, <span class="string">`pos`</span>, <span class="string">`add_time`</span>) <span class="keyword">VALUES</span> (<span class="string">'2000'</span>, <span class="number">23</span>, <span class="string">'dev'</span>, <span class="keyword">now</span>());</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> staffs <span class="keyword">ADD</span> <span class="keyword">INDEX</span> idx_staffs_nameAgePos(<span class="keyword">name</span>, age, pos);</span><br></pre></td></tr></table></figure>

<p><strong>避免索引失效：</strong><br>1.最好使用全值匹配（索引都用在where后作为条件）<br>建立几个复合索引字段，最好就用上几个字段。<strong>且按照顺序来用</strong>。</p>
<p>我们下面来看下面三个语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> staffs <span class="keyword">WHERE</span> <span class="keyword">name</span> = <span class="string">'July'</span>;</span><br><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> staffs <span class="keyword">WHERE</span> <span class="keyword">name</span> = <span class="string">'July'</span> <span class="keyword">AND</span> age=<span class="number">25</span>;</span><br><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> staffs <span class="keyword">WHERE</span> <span class="keyword">name</span> = <span class="string">'July'</span> <span class="keyword">AND</span> age=<span class="number">25</span> <span class="keyword">AND</span> pos=<span class="string">'dev'</span>;</span><br></pre></td></tr></table></figure>

<p><img src="http://img.bcoder.top/2018.02.21/12.png" alt="MySQL数据库深入（二）"></p>
<p>2.最佳左前缀法则（指的是从索引的左前列开始并且不跳过索引的列）<br>如果索引了多列，要遵守<strong>最左前缀法则</strong>，指的是查询从索引的最左前列开始，不跳过索引中间的列。（带头大哥不能死，中间兄弟不能丢）</p>
<p>比如下面这个就索引失效了：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> staffs age=<span class="number">25</span> <span class="keyword">AND</span> pos=<span class="string">'dev'</span>;</span><br></pre></td></tr></table></figure>

<p><img src="http://img.bcoder.top/2018.02.21/13.png" alt="MySQL数据库深入（二）"></p>
<p>3.不要在索引上做任何操作（计算、函数、（自动or手动）类型转换），会导致索引失效而转向全表扫描</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> staffs <span class="keyword">WHERE</span> <span class="keyword">name</span> = <span class="string">'July'</span>;</span><br><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> staffs <span class="keyword">WHERE</span> <span class="keyword">LEFT</span>(<span class="keyword">name</span>, <span class="number">4</span>) = <span class="string">'July'</span>;</span><br></pre></td></tr></table></figure>

<p><img src="http://img.bcoder.top/2018.02.21/14.png" alt="MySQL数据库深入（二）"></p>
<p>4.储存引擎不能使用索引中范围条件右边的列（用了&gt;,&lt;,like等右边的索引全部失效）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> staffs <span class="keyword">WHERE</span> <span class="keyword">name</span> = <span class="string">'July'</span> <span class="keyword">AND</span> age = <span class="number">25</span> <span class="keyword">AND</span> pos = <span class="string">'dev'</span>;</span><br><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> staffs <span class="keyword">WHERE</span> <span class="keyword">name</span> = <span class="string">'July'</span> <span class="keyword">AND</span> age &lt; <span class="number">25</span> <span class="keyword">AND</span> pos = <span class="string">'dev'</span>;</span><br></pre></td></tr></table></figure>

<p><img src="http://img.bcoder.top/2018.02.21/15.png" alt="MySQL数据库深入（二）"></p>
<p>将age字段条件从=改成了&lt;，查出的是个范围，所以可发现第三个字段pos索引失效了，因为type类型低了，key_len短了。ref也变成了range。</p>
<p>5.尽量使用覆盖索引（只访问索引的查询），减少select *</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> staffs <span class="keyword">WHERE</span> <span class="keyword">name</span> = <span class="string">'July'</span>;</span><br><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> <span class="keyword">name</span> <span class="keyword">FROM</span> staffs <span class="keyword">WHERE</span> <span class="keyword">name</span> = <span class="string">'July'</span>;</span><br><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> <span class="keyword">name</span>,age <span class="keyword">FROM</span> staffs <span class="keyword">WHERE</span> <span class="keyword">name</span> = <span class="string">'July'</span>;</span><br></pre></td></tr></table></figure>
<p><img src="http://img.bcoder.top/2018.02.21/16.png" alt="MySQL数据库深入（二）"></p>
<p>可以发现，若将替换成索引列的话会用到Using index，直接从索引读，效果更佳，数据量大的时候更明显</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> staffs <span class="keyword">WHERE</span> <span class="keyword">name</span> = <span class="string">'July'</span> <span class="keyword">AND</span> age &lt; <span class="number">25</span> <span class="keyword">AND</span> pos = <span class="string">'dev'</span>;</span><br><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> <span class="keyword">name</span>, age <span class="keyword">FROM</span> staffs <span class="keyword">WHERE</span> <span class="keyword">name</span> = <span class="string">'July'</span> <span class="keyword">AND</span> age &lt; <span class="number">25</span> <span class="keyword">AND</span> pos = <span class="string">'dev'</span>;</span><br></pre></td></tr></table></figure>

<p><img src="http://img.bcoder.top/2018.02.21/17.png" alt="MySQL数据库深入（二）"></p>
<p>Paste_Image.png<br>可以发现，范围查找时，若将替换成索引列的话不仅会用到Using index索引级别还会是ref，key_len也短，效果更佳，数据量大的时候更明显.</p>
<p>6.Mysql在使用不等于(!=、&lt;&gt;)或like的左模糊的时候无法试用索引会导致全表扫描。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> staffs <span class="keyword">WHERE</span> <span class="keyword">name</span> != <span class="string">'July'</span>;</span><br><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> staffs <span class="keyword">WHERE</span> <span class="keyword">name</span> <span class="keyword">LIKE</span> <span class="string">'%July'</span>;</span><br></pre></td></tr></table></figure>

<p><img src="http://img.bcoder.top/2018.02.21/18.png" alt="MySQL数据库深入（二）"></p>
<p>7.is null，is not null也无法使用索引</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> staffs <span class="keyword">WHERE</span> <span class="keyword">name</span> <span class="keyword">IS</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> staffs <span class="keyword">WHERE</span> <span class="keyword">name</span> <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure>

<p><img src="http://img.bcoder.top/2018.02.21/19.png" alt="MySQL数据库深入（二）"></p>
<p>8.like以通配符开头（’%abc….’)mysql索引失效会变成全表扫描的操作（%尽量放在右边，要使用%开头则要使用覆盖索引）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> staffs <span class="keyword">WHERE</span> <span class="keyword">name</span> <span class="keyword">LIKE</span> <span class="string">'%July%'</span>;</span><br><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> staffs <span class="keyword">WHERE</span> <span class="keyword">name</span> <span class="keyword">LIKE</span> <span class="string">'%July'</span>;</span><br><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> staffs <span class="keyword">WHERE</span> <span class="keyword">name</span> <span class="keyword">LIKE</span> <span class="string">'July%'</span>;</span><br></pre></td></tr></table></figure>

<p><img src="http://img.bcoder.top/2018.02.21/20.png" alt="MySQL数据库深入（二）"></p>
<p><strong>解决 like <code>%str%</code> 索引失效的方法？</strong><br>使用覆盖索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> <span class="keyword">name</span>,age <span class="keyword">FROM</span> staffs <span class="keyword">WHERE</span> <span class="keyword">name</span> <span class="keyword">LIKE</span> <span class="string">'%July%'</span>;</span><br><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> <span class="keyword">id</span>,<span class="keyword">name</span>,age <span class="keyword">FROM</span> staffs <span class="keyword">WHERE</span> <span class="keyword">name</span> <span class="keyword">LIKE</span> <span class="string">'%July%'</span>;</span><br><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> <span class="keyword">name</span>,age,add_time <span class="keyword">FROM</span> staffs <span class="keyword">WHERE</span> <span class="keyword">name</span> <span class="keyword">LIKE</span> <span class="string">'%July%'</span>;</span><br></pre></td></tr></table></figure>

<p><img src="http://img.bcoder.top/2018.02.21/21.png" alt="MySQL数据库深入（二）"></p>
<p>需要注意的是，select 后面的字段要和索引沾边，如果不沾边，就变为全表扫描。</p>
<p>9.字符串不加单引号索引失效</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> staffs <span class="keyword">WHERE</span> <span class="keyword">name</span> = <span class="string">'2000'</span>;</span><br><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> staffs <span class="keyword">WHERE</span> <span class="keyword">name</span> = <span class="number">2000</span>;</span><br></pre></td></tr></table></figure>

<p><img src="http://img.bcoder.top/2018.02.21/22.png" alt="MySQL数据库深入（二）"></p>
<p>10.少用or，用它来连接时会索引失效</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> staffs <span class="keyword">WHERE</span> <span class="keyword">name</span> = <span class="string">'2000'</span> <span class="keyword">or</span> <span class="keyword">name</span> = <span class="string">'z3'</span>;</span><br></pre></td></tr></table></figure>

<p><img src="http://img.bcoder.top/2018.02.21/23.png" alt="MySQL数据库深入（二）"></p>
<p>总结：</p>
<p><img src="http://img.bcoder.top/2018.02.21/24.png" alt="MySQL数据库深入（二）"></p>
<p>一道关于索引的小题目：</p>
<p>1.建表：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">create table test03(</span><br><span class="line">id int primary key not null auto_increment,</span><br><span class="line">c1 char(10),</span><br><span class="line">c2 char(10),</span><br><span class="line">c3 char(10),</span><br><span class="line">c4 char(10),</span><br><span class="line">c5 char(10)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">insert into test03(c1,c2,c3,c4,c5) values(&#39;a1&#39;,&#39;a2&#39;,&#39;a3&#39;,&#39;a4&#39;,&#39;a5&#39;);</span><br><span class="line">insert into test03(c1,c2,c3,c4,c5) values(&#39;b1&#39;,&#39;b2&#39;,&#39;b3&#39;,&#39;b4&#39;,&#39;b5&#39;);</span><br><span class="line">insert into test03(c1,c2,c3,c4,c5) values(&#39;c1&#39;,&#39;c2&#39;,&#39;c3&#39;,&#39;c4&#39;,&#39;c5&#39;);</span><br><span class="line">insert into test03(c1,c2,c3,c4,c5) values(&#39;d1&#39;,&#39;d2&#39;,&#39;d3&#39;,&#39;d4&#39;,&#39;d5&#39;);</span><br><span class="line">insert into test03(c1,c2,c3,c4,c5) values(&#39;e1&#39;,&#39;e2&#39;,&#39;e3&#39;,&#39;e4&#39;,&#39;e5&#39;);</span><br></pre></td></tr></table></figure>

<p>2.建索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> idx_test03_c1234 <span class="keyword">on</span> test03(c1,c2,c3,c4);</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">index</span> <span class="keyword">from</span> test03;</span><br></pre></td></tr></table></figure>

<p>3.问题：<br>我们创建了复合索引idx_test03_c1234，根据以下SQL分析下索引使用情况？</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> test03 <span class="keyword">where</span> c1=<span class="string">'a1'</span>; </span><br><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> test03 <span class="keyword">where</span> c1=<span class="string">'a1'</span> <span class="keyword">and</span> c2=<span class="string">'a2'</span>; </span><br><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> test03 <span class="keyword">where</span> c1=<span class="string">'a1'</span> <span class="keyword">and</span> c2=<span class="string">'a2'</span> <span class="keyword">and</span> c3=<span class="string">'a3'</span>; </span><br><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> test03 <span class="keyword">where</span> c1=<span class="string">'a1'</span> <span class="keyword">and</span> c2=<span class="string">'a2'</span> <span class="keyword">and</span> c3=<span class="string">'a3'</span> <span class="keyword">and</span> c4=<span class="string">'a4'</span>;</span><br></pre></td></tr></table></figure>

<p><img src="http://img.bcoder.top/2018.02.21/25.png" alt="MySQL数据库深入（二）"></p>
<p>匹配的精度越来越高。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> test03 <span class="keyword">where</span> c4=<span class="string">'a4'</span> <span class="keyword">and</span> c3=<span class="string">'a3'</span> <span class="keyword">and</span> c2=<span class="string">'a2'</span> <span class="keyword">and</span> c1=<span class="string">'a1'</span>; </span><br><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> test03 <span class="keyword">where</span> c4=<span class="string">'a4'</span> <span class="keyword">and</span> c3=<span class="string">'a3'</span> <span class="keyword">and</span> c2=<span class="string">'a2'</span> <span class="keyword">and</span> c1=<span class="string">'a1'</span>; </span><br><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> test03 <span class="keyword">where</span> c1=<span class="string">'a1'</span> <span class="keyword">and</span> c2=<span class="string">'a2'</span> <span class="keyword">and</span> c3&gt;<span class="string">'a3'</span> <span class="keyword">and</span> c4=<span class="string">'a4'</span>; </span><br><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> test03 <span class="keyword">where</span> c1=<span class="string">'a1'</span> <span class="keyword">and</span> c2=<span class="string">'a2'</span> <span class="keyword">and</span> c4&gt;<span class="string">'a4'</span> <span class="keyword">and</span> c3=<span class="string">'a3'</span>;</span><br></pre></td></tr></table></figure>

<p><img src="http://img.bcoder.top/2018.02.21/26.png" alt="MySQL数据库深入（二）"></p>
<p>第三条c4无法使用。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> test03 <span class="keyword">where</span> c1=<span class="string">'a1'</span> <span class="keyword">and</span> c2=<span class="string">'a2'</span> <span class="keyword">and</span> c4=<span class="string">'a4'</span> <span class="keyword">order</span> <span class="keyword">by</span> c3;</span><br></pre></td></tr></table></figure>
<p><img src="http://img.bcoder.top/2018.02.21/27.png" alt="MySQL数据库深入（二）"></p>
<p>c1,c2用到索引，c3在这里的作用是排序而不是查找。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> test03 <span class="keyword">where</span> c1=<span class="string">'a1'</span> <span class="keyword">and</span> c2=<span class="string">'a2'</span> <span class="keyword">order</span> <span class="keyword">by</span> c3;</span><br></pre></td></tr></table></figure>

<p><img src="http://img.bcoder.top/2018.02.21/28.png" alt="MySQL数据库深入（二）"></p>
<p>同上一条执行计划一样，与c4=’a4’没有关系</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> test03 <span class="keyword">where</span> c1=<span class="string">'a1'</span> <span class="keyword">and</span> c2=<span class="string">'a2'</span> <span class="keyword">order</span> <span class="keyword">by</span> c4;</span><br></pre></td></tr></table></figure>
<p><img src="http://img.bcoder.top/2018.02.21/29.png" alt="MySQL数据库深入（二）"></p>
<p>c1,c2用到索引，Extra中出现了Using filesort。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> test03 <span class="keyword">where</span> c1=<span class="string">'a1'</span> <span class="keyword">and</span> c5=<span class="string">'a5'</span> <span class="keyword">order</span> <span class="keyword">by</span> c2,c3;</span><br></pre></td></tr></table></figure>

<p><img src="http://img.bcoder.top/2018.02.21/30.png" alt="MySQL数据库深入（二）"></p>
<p>只用c1一个字段索引，但是c2、c3用于排序，无Using filesort</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> test03 <span class="keyword">where</span> c1=<span class="string">'a1'</span> <span class="keyword">and</span> c5=<span class="string">'a5'</span> <span class="keyword">order</span> <span class="keyword">by</span> c3,c2;</span><br></pre></td></tr></table></figure>

<p><img src="http://img.bcoder.top/2018.02.21/31.png" alt="MySQL数据库深入（二）"></p>
<p>有Using filesort，我们建的索引是c1,c2,c3,c4，它没有按照顺序来，3和2颠倒了。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> test03 <span class="keyword">where</span> c1=<span class="string">'a1'</span> <span class="keyword">and</span> c2=<span class="string">'a2'</span> <span class="keyword">order</span> <span class="keyword">by</span> c2,c3;</span><br><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> test03 <span class="keyword">where</span> c1=<span class="string">'a1'</span> <span class="keyword">and</span> c2=<span class="string">'a2'</span> <span class="keyword">and</span> c5=<span class="string">'a5'</span> <span class="keyword">order</span> <span class="keyword">by</span> c2,c3;</span><br></pre></td></tr></table></figure>

<p><img src="http://img.bcoder.top/2018.02.21/32.png" alt="MySQL数据库深入（二）"></p>
<p>用c1、c2两个字段索引，但是c2、c3用于排序，无Using filesort</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> test03 <span class="keyword">where</span> c1=<span class="string">'a1'</span> <span class="keyword">and</span> c2=<span class="string">'a2'</span> <span class="keyword">and</span> c5=<span class="string">'a5'</span> <span class="keyword">order</span> <span class="keyword">by</span> c3,c2;</span><br></pre></td></tr></table></figure>

<p><img src="http://img.bcoder.top/2018.02.21/33.png" alt="MySQL数据库深入（二）"></p>
<p>本例有常量c2(排序字段)的情况，所以无Using filesort，与<code>explain select * from test03 where c1=&#39;a1&#39; and c5=&#39;a5&#39; order by c3,c2;</code>例子不同。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> test03 <span class="keyword">where</span> c1=<span class="string">'a1'</span> <span class="keyword">and</span> c4=<span class="string">'a4'</span> <span class="keyword">group</span> <span class="keyword">by</span> c2,c3;</span><br><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> test03 <span class="keyword">where</span> c1=<span class="string">'a1'</span> <span class="keyword">and</span> c4=<span class="string">'a4'</span> <span class="keyword">group</span> <span class="keyword">by</span> c3,c2;</span><br></pre></td></tr></table></figure>

<p><img src="http://img.bcoder.top/2018.02.21/34.png" alt="MySQL数据库深入（二）"></p>
<p>第二条有Using temporary，有Using filesort。</p>
<p>我们对这个题目进行个小结：<br>a. group by 分组之前必排序，所以说它与order by排序法则与索引优化原则几乎是一致的。<br>b. 在索引分析的时候，定值为常量，范围之后是索引失效，最终看排序，一般order by是给个范围。<br>c. group by 基本上都需要进行排序，会有临时表产生。</p>
<p><strong>优化总结口诀</strong>：<br>全值匹配我最爱，最左前缀要遵守；<br>带头大哥不能死，中间兄弟不能断；<br>索引列上少计算，范围之后全失效；<br>Like百分写最右，覆盖索引不写星；<br>不等空值还有or，索引失效要少用；<br>VAR引号不可丢，SQL高级也不难；</p>
<p>那么我们如何进行一步步分析呢？<br>1.观察，至少跑1天，看看生产的慢SQL情况。<br>2.开启慢查询日志，设置阙值，比如超过5秒钟的就是慢SQL，并将它抓取出来。<br>3.explain+慢SQL分析。<br>4.show profile。<br>5.运维经理或者DBA进行SQL数据库服务器的参数调优。</p>
<p>提取一下就是：<br>0.为了避免出现问题，我们需要进行查询优化。<br>1.慢查询日志的开启与捕获。<br>2.explain+慢SQL分析。<br>3.show profile查询SQL在MySQL服务器中的执行细节和生命周期情况。<br>4.SQL数据库服务器的参数调优。</p>
<h2 id="查询优化"><a href="#查询优化" class="headerlink" title="查询优化"></a>查询优化</h2><h3 id="小表驱动大表"><a href="#小表驱动大表" class="headerlink" title="小表驱动大表"></a>小表驱动大表</h3><p>小表驱动大表，即小的数据集驱动大的数据集。</p>
<p>1). 当B表的数据集小于A表的数据集时，用in优于exists.<br>select * from A where id in (select id from B);<br>等价于for循环:<br>for select id from B;<br>for select * from A where A.id = B.id;</p>
<p>2). 当B表的数据集大于A表的数据集时，用exists优于in.<br>select * from A where exists (select 1 from B where B.id=A.id);<br>等价于for循环:<br>for select * from A;<br>for select * from B where B.id = A.id;</p>
<p>in 是把外表和内表作hash 连接；<br>exists 是对外表作loop循环，每次loop循环再对内表进行查询。</p>
<p>总结起来就是：in+小表，exists+大表</p>
<p>注意：A表与B表的ID字段应建立索引。</p>
<h3 id="order-by关键字优化"><a href="#order-by关键字优化" class="headerlink" title="order by关键字优化"></a>order by关键字优化</h3><p>1.建表和索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tblA(</span><br><span class="line">    <span class="comment">#id INT PRIMARY KEY NOT NULL AUTO_INCREMENT,</span></span><br><span class="line">    age <span class="built_in">INT</span>,</span><br><span class="line">    birth <span class="built_in">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> tblA(age, birth) <span class="keyword">VALUES</span>(<span class="number">22</span>, <span class="keyword">NOW</span>());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> tblA(age, birth) <span class="keyword">VALUES</span>(<span class="number">23</span>, <span class="keyword">NOW</span>());</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> tblA(age, birth) <span class="keyword">VALUES</span>(<span class="number">24</span>, <span class="keyword">NOW</span>());</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> indx_A_ageBirth <span class="keyword">ON</span> tblA(age, birth);</span><br></pre></td></tr></table></figure>

<p>2.执行SQL：<br>（1）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> tblA <span class="keyword">WHERE</span> age &gt; <span class="number">20</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> age;</span><br><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> tblA <span class="keyword">WHERE</span> age &gt; <span class="number">20</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> age, birth;</span><br></pre></td></tr></table></figure>

<p><img src="http://img.bcoder.top/2018.02.21/35.png" alt="MySQL数据库深入（二）"></p>
<p>age一直在，所以不会产生Using filesort，因为索引从age开始，而order by正好也是从age开始，age索引可以用上。   </p>
<p>（2）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> tblA <span class="keyword">WHERE</span> age &gt; <span class="number">20</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> birth;</span><br><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> tblA <span class="keyword">WHERE</span> age &gt; <span class="number">20</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> birth, age;</span><br></pre></td></tr></table></figure>

<p><img src="http://img.bcoder.top/2018.02.21/36.png" alt="MySQL数据库深入（二）"></p>
<p>age不再order by范围内了,前面where条件还是大于号（范围值），索引断了，所以排序的时候无法用到索引，产生了Using filesort。</p>
<p>（三）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> tblA <span class="keyword">ORDER</span> <span class="keyword">BY</span> birth;</span><br><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> tblA <span class="keyword">WHERE</span> birth &gt; <span class="string">'2011-11-11 11:11:11'</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> birth;</span><br></pre></td></tr></table></figure>

<p><img src="http://img.bcoder.top/2018.02.21/37.png" alt="MySQL数据库深入（二）"></p>
<p>age完全没用上，产生了Using filesort。</p>
<p>（四）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> tblA <span class="keyword">WHERE</span> birth &gt; <span class="string">'2011-11-11 11:11:11'</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> age;</span><br></pre></td></tr></table></figure>

<p><img src="http://img.bcoder.top/2018.02.21/38.png" alt="MySQL数据库深入（二）"></p>
<p>不难发现，order by开头用到了age，索引不会产生Using filesort</p>
<p>（五）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> tblA <span class="keyword">ORDER</span> <span class="keyword">BY</span> age <span class="keyword">ASC</span>, birth <span class="keyword">DESC</span>;</span><br><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> tblA <span class="keyword">ORDER</span> <span class="keyword">BY</span> age <span class="keyword">DESC</span>, birth <span class="keyword">ASC</span>;</span><br><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> tblA <span class="keyword">ORDER</span> <span class="keyword">BY</span> age <span class="keyword">ASC</span>, birth <span class="keyword">ASC</span>;</span><br><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> tblA <span class="keyword">ORDER</span> <span class="keyword">BY</span> age <span class="keyword">DESC</span>, birth <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<p><img src="http://img.bcoder.top/2018.02.21/39.png" alt="MySQL数据库深入（二）"></p>
<p>排序的话要么都升序，要么都降序，否则mysql内部会不知道怎么排序，排序也是索引的一部分（Btree），所以不一致时会产生Using filesort</p>
<p>（六）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> tblA <span class="keyword">WHERE</span> age = <span class="number">20</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> birth;</span><br></pre></td></tr></table></figure>

<p><img src="http://img.bcoder.top/2018.02.21/40.png" alt="MySQL数据库深入（二）"></p>
<p>没有Using filesort，是因为where 条件是个常量，而不是个范围，所以会自动传递到order by，所以order by 起始排序字段还是age。</p>
<p>order by 支持两种排序方式：Index（索引排序）和FileSort（文件排序），但是index效率高。因此尽量使用Using Index方式排序，避免使用Using FileSort方式排序、<br>尽可能在索引列上完成排序操作，遵照索引建的最佳左前缀的原则</p>
<p>ORDER BY满足两情况，会使用Index方式排序：<br>①ORDER BY 语句使用索引最左前列；<br>②使用Where子句与Order BY子句条件列组合满足索引最左前列。</p>
<p>如果不在索引列上，filesort有两种算法：mysql就要启动<strong>双路排序和单路排序</strong><br>双路排序：MySQL 4.1之前是使用双路排序,字面意思就是两次扫描磁盘，最终得到数据.<br>单路排序 : 从磁盘读取查询需要的所有列，按照order by列在buffer对它们进行排序，然后扫描排序后的列表进行输出，<strong>它的效率更快一些</strong>，避免了第二次读取数据。并且把随机IO变成了顺序IO,但是它会使用更多的空间，因为它把每一行都保存在内存中了。</p>
<p>由于单路是后出的，总体而言好过双路。但是用单路有问题</p>
<p>在sort_buffer中，方法B比方法A要多占用很多空间，因为方法B是把所有字段都取出, 所以有可能取出的数据的总大小超出了sort_buffer的容量，导致每次只能取sort_buffer容量大小的数据，进行排序（创建tmp文件，多路合并），排完再取sort_buffer容量大小，再排…… 从而多次I/O。</p>
<p><strong>解决方案：</strong><br>1.order by 时select * 是一个大忌，只select 需要的字段，而不要用 *，当Query的字段大小总和小于max_length_for_sort_data而且排序字段不是text|bolb类型，会用改进后的算法-单路排序，否则会用老算法-双路排序。两种算法的数据都有可能超出sort_buffer的容量，超出之后，会创建temp文件进行合并排序，导致多次I/O，使用单路排序算法的风险会大一些，所以要提高sort_buffer_size。</p>
<ol start="2">
<li>提高sort_buffer_size，不管用哪种算法，提高这个参数，都会提高效率，当然要根据系统的能力去提高，因为这个参数是针对每个进程的</li>
</ol>
<p>3.提高max_length_for_sort_data，会增加用改进算法的概率，但是如果设置太高，数据总量超过sort_buffer_size的概率就会增大，明显症状是，高的磁盘I/O活动和低的cup使用率。</p>
<h3 id="group-by关键字优化"><a href="#group-by关键字优化" class="headerlink" title="group by关键字优化"></a>group by关键字优化</h3><p>1.group by 是先排序后分组，用到索引跟order by 一样，遵从索引最佳左前缀原则<br>2.当无法使用索引列时，要加大sort_buffer_size和max_length_for_sort_data的值<br>3.where高于having，能写到where限定条件里的，就不要去having中限定。</p>
<h2 id="慢查询日志"><a href="#慢查询日志" class="headerlink" title="慢查询日志"></a>慢查询日志</h2><h3 id="慢查询日志介绍"><a href="#慢查询日志介绍" class="headerlink" title="慢查询日志介绍"></a>慢查询日志介绍</h3><p>MySQL的慢查询日志是MySQL提供的一种日志记录，它用来记录在MySQL中响应时间超过阀值的语句，具体指运行时间超过<strong>long_query_time</strong>值的SQL，则会被记录到慢查询日志中。</p>
<p>具体指运行时间超过long_query_time值的SQL，则会被记录到慢查询日志中。long_query_time的默认值为10，意思是运行10秒以上的语句。</p>
<h3 id="慢查询日志使用"><a href="#慢查询日志使用" class="headerlink" title="慢查询日志使用"></a>慢查询日志使用</h3><p><strong>mysql数据库中开启慢查询：</strong></p>
<p>默认slow_query_log的值为off,表示慢查询日志是禁用的：<br><code>show variables like &#39;%slow_query_log%&#39;;</code></p>
<p>开启:(只对当前开启的数据库当时生效，如果mysql重启后就失效了)<br><code>set global slow_query_log=1;</code></p>
<p>查看慢查询阙值时间:<br><code>show variables like &#39;long_query_time%&#39;;</code></p>
<p>设置阙值时间:<br><code>set global long_query_time=3;</code></p>
<p><img src="http://img.bcoder.top/2018.02.21/41.png" alt="MySQL数据库深入（二）"></p>
<p>为什么设置阙值时间后，还是默认的10秒？<br>需要重新连接或者新开一个会话才能看到修改值。</p>
<p><img src="http://img.bcoder.top/2018.02.21/42.png" alt="MySQL数据库深入（二）"></p>
<p>查看当前系统有多少条慢查询记录:<br><code>show global status like &#39;%slow_queries%&#39;;</code></p>
<p>如果要以上参数永久生效，需要修改my.cnf配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">slow_query_log&#x3D;1</span><br><span class="line">slow_query_log_file&#x3D;&#x2F;var&#x2F;lib&#x2F;mysql&#x2F;zln117-slow.log</span><br><span class="line">long_query_time&#x3D;3;</span><br><span class="line">log_output&#x3D;FILE</span><br></pre></td></tr></table></figure>
<p>slow_query_log_file表示慢查询日志存放的位置。</p>
<p>我们使用select sleep(4);</p>
<p><img src="http://img.bcoder.top/2018.02.21/43.png" alt="MySQL数据库深入（二）"></p>
<h3 id="日志分析工具mysqldumpslow"><a href="#日志分析工具mysqldumpslow" class="headerlink" title="日志分析工具mysqldumpslow"></a>日志分析工具mysqldumpslow</h3><p>使用mysqldumpslow命令可以非常明确的得到各种我们需要的查询语句，对MySQL查询语句的监控、分析、优化是MySQL优化的第一步，也是非常重要的一步。</p>
<p>mysqldumpslow的帮助信息：<br>-s 表示按照何种方式排序<br>-c 访问次数<br>-l 锁定时间<br>-r 返回记录<br>-t 查询时间<br>-al 平均锁定时间<br>-ar 平均返回记录数<br>-at 平均查询时间<br>-t 即为返回前面多少条的数据<br>-g 后边搭配一个正则匹配模式，大小写不敏感的</p>
<p>示例参考：<br>1.得到返回记录集最多的10个SQL:<br><code>mysqldumpslow -s r -t 10 /var/lib/mysql/zln117-slow.log</code></p>
<p>2.得到访问次数最多的10个SQL:<br><code>mysqldumpslow -s c -t 10 /var/lib/mysql/zln117-slow.log</code></p>
<p>3.得到按照时间排序的前10条里面含有左连接的查询语句:<br><code>mysqldumpslow -s t -t 10 -g &quot;left join&quot; /var/lib/mysql/zln117-slow.log</code></p>
<p>4.另外建议在使用这些命令时结合|和more使用，否则有可能出现爆爆的情况:<br><code>mysqldumpslow -s r -t 10 /var/lib/mysql/zln117-slow.log | more</code></p>
<h2 id="批量数据脚本"><a href="#批量数据脚本" class="headerlink" title="批量数据脚本"></a>批量数据脚本</h2><p>1.建库建表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#建库</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> bigdata;</span><br><span class="line"><span class="keyword">use</span> bigdata;</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建部门表dept</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> dept(</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">int</span> <span class="keyword">unsigned</span> primary <span class="keyword">key</span> auto_increment,</span><br><span class="line">deptno mediumint <span class="keyword">unsigned</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">default</span> <span class="number">0</span>,</span><br><span class="line">deptname <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">default</span> <span class="string">''</span>,</span><br><span class="line">loc <span class="built_in">varchar</span>(<span class="number">13</span>) <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">default</span> <span class="string">''</span></span><br><span class="line">)<span class="keyword">engine</span>=<span class="keyword">innodb</span> <span class="keyword">default</span> <span class="keyword">charset</span>=gbk;</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建员工表emp</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> emp(</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">int</span> <span class="keyword">unsigned</span> primary <span class="keyword">key</span> auto_increment,</span><br><span class="line">empno mediumint <span class="keyword">unsigned</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">default</span> <span class="number">0</span>, <span class="comment">/*编号*/</span></span><br><span class="line">empname <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">default</span> <span class="string">''</span>, <span class="comment">/*名字*/</span></span><br><span class="line">job <span class="built_in">varchar</span>(<span class="number">9</span>) <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">default</span> <span class="string">''</span>, <span class="comment">/*工作*/</span></span><br><span class="line">mgr mediumint <span class="keyword">unsigned</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">default</span> <span class="number">0</span>, <span class="comment">/*上级编号*/</span></span><br><span class="line">hiredate <span class="built_in">date</span> <span class="keyword">not</span> <span class="literal">null</span>, <span class="comment">/*入职时间*/</span></span><br><span class="line">sal <span class="built_in">decimal</span>(<span class="number">7</span>,<span class="number">2</span>) <span class="keyword">not</span> <span class="literal">null</span>, <span class="comment">/*薪水*/</span></span><br><span class="line">comm <span class="built_in">decimal</span>(<span class="number">7</span>,<span class="number">2</span>) <span class="keyword">not</span> <span class="literal">null</span>, <span class="comment">/*红利*/</span></span><br><span class="line">deptno mediumint <span class="keyword">unsigned</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">default</span> <span class="number">0</span> <span class="comment">/*部门编号*/</span></span><br><span class="line">) <span class="keyword">engine</span>=<span class="keyword">innodb</span> <span class="keyword">default</span> <span class="keyword">charset</span>=gbk;</span><br></pre></td></tr></table></figure>

<p>2.设置参数log_bin_trust_function_creators<br>创建函数时，如果报错：<code>ERROR 1418 (HY000): This function has none of DETERMINISTIC, NO SQL, or READS SQL DATA in its declaration  and binary logging is enabled (you *might* want to use the less safe log_bin_trust_function_creators variable)</code></p>
<p>由于开启过慢查询日志，因为我们开启了bin-log，我们就必须为我们的function指定一个参数。:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">show variables like &#39;log_bin_trust_function_creators&#39;;</span><br><span class="line">set global log_bin_trust_function_creators&#x3D;1;</span><br></pre></td></tr></table></figure>
<p>这样添加了参数以后，如果mysqld重启，上述参数又会消失，使其永久有效的做法是：</p>
<p>在windows下配置my.ini或者在linux下配置my.cnf：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">log_bin_trust_function_creators&#x3D;1</span><br></pre></td></tr></table></figure>

<p>3.创建函数，保证每条数据都不同</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#随机产生字符串</span></span><br><span class="line">delimiter $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">function</span> rand_string(n <span class="built_in">int</span>) <span class="keyword">returns</span> <span class="built_in">varchar</span>(<span class="number">255</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> init_str <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">default</span> <span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'</span>;</span><br><span class="line"><span class="keyword">declare</span> return_str <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">default</span> <span class="string">''</span>;</span><br><span class="line"><span class="keyword">declare</span> i <span class="built_in">int</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">while i &lt; n do</span><br><span class="line"><span class="keyword">set</span> return_str = <span class="keyword">concat</span>(return_str, </span><br><span class="line"><span class="keyword">substring</span>(init_str,<span class="keyword">floor</span>(<span class="number">1</span>+<span class="keyword">rand</span>()*<span class="number">52</span>),<span class="number">1</span>));</span><br><span class="line"><span class="keyword">set</span> i=i+<span class="number">1</span>;</span><br><span class="line"><span class="keyword">end</span> <span class="keyword">while</span>;</span><br><span class="line">return return_str;</span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span> $$</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#假如要删除</span></span><br><span class="line"><span class="comment">#drop function rand_string;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#随机产生部门编号</span></span><br><span class="line">delimiter $$</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">function</span> rand_num()</span><br><span class="line"><span class="keyword">returns</span> <span class="built_in">int</span>(<span class="number">5</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">declare</span> i <span class="built_in">int</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">set</span> i = <span class="keyword">floor</span>(<span class="number">100</span>+<span class="keyword">rand</span>()*<span class="number">10</span>);</span><br><span class="line">return i;</span><br><span class="line"><span class="keyword">end</span> $$</span><br><span class="line"></span><br><span class="line"><span class="comment">#假如要删除</span></span><br><span class="line"><span class="comment">#drop function rand_num;</span></span><br></pre></td></tr></table></figure>


<p>4.创建存储过程</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">delimiter $$</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> insert_emp(<span class="keyword">in</span> start_num <span class="built_in">int</span>(<span class="number">10</span>),<span class="keyword">in</span> max_num <span class="built_in">int</span>(<span class="number">10</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">declare</span> i <span class="built_in">int</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line"><span class="comment">## 把自动提交写为0，commit提交</span></span><br><span class="line"><span class="keyword">set</span> autocommit=<span class="number">0</span>;</span><br><span class="line">repeat</span><br><span class="line"><span class="keyword">set</span> i = i+<span class="number">1</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> emp(empno,empname,job,mgr,hiredate,sal,comm,deptno) <span class="keyword">values</span>((start_num+i),rand_string(<span class="number">6</span>),<span class="string">'salesman'</span>,<span class="number">0001</span>,<span class="keyword">curdate</span>(),<span class="number">2000</span>,<span class="number">400</span>,rand_num());</span><br><span class="line">until i = max_num</span><br><span class="line"><span class="keyword">end</span> <span class="keyword">repeat</span>;</span><br><span class="line"><span class="keyword">commit</span>;</span><br><span class="line"><span class="keyword">end</span> $$</span><br><span class="line"></span><br><span class="line">delimiter $$</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> insert_dept(<span class="keyword">in</span> start_num <span class="built_in">int</span>(<span class="number">10</span>),<span class="keyword">in</span> max_num <span class="built_in">int</span>(<span class="number">10</span>))</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">declare</span> i <span class="built_in">int</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">set</span> autocommit=<span class="number">0</span>;</span><br><span class="line">repeat</span><br><span class="line"><span class="keyword">set</span> i = i+<span class="number">1</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> dept(deptno,deptname,loc) <span class="keyword">values</span>((start_num+i),rand_string(<span class="number">10</span>),rand_string(<span class="number">8</span>));</span><br><span class="line">until i = max_num</span><br><span class="line"><span class="keyword">end</span> <span class="keyword">repeat</span>;</span><br><span class="line"><span class="keyword">commit</span>;</span><br><span class="line"><span class="keyword">end</span> $$</span><br></pre></td></tr></table></figure>

<p>5.调用存储过程</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">delimiter ;</span><br><span class="line"><span class="keyword">call</span> insert_dept(<span class="number">100</span>,<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">#执行存储过程，往emp表添加50万条数据</span></span><br><span class="line">delimiter ;</span><br><span class="line"><span class="keyword">call</span> insert_emp(<span class="number">100001</span>,<span class="number">500000</span>);</span><br></pre></td></tr></table></figure>

<p>至此50万条数据插入完毕。</p>
<h2 id="Show-Profile分析SQL"><a href="#Show-Profile分析SQL" class="headerlink" title="Show Profile分析SQL"></a>Show Profile分析SQL</h2><p>mysql提供用来分析当前会话中语句执行的资源消耗情况，可以用于SQL的调优测量。</p>
<p>分析步骤：<br>1.是否支持，看看当前的mysql版本是否支持：<br><code>show variables like &#39;profiling%&#39;;</code></p>
<p>2.开启功能，默认是关闭的，使用前需要开启<br><code>set profiling=on;</code></p>
<p><img src="http://img.bcoder.top/2018.02.21/44.png" alt="MySQL数据库深入（二）"></p>
<p>3.运行sql:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select * from emp group by id%10 limit 150000;</span><br><span class="line">select * from emp group by id%20 order by 5;</span><br></pre></td></tr></table></figure>

<p>4.查看结果:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show profiles;</span><br></pre></td></tr></table></figure>

<p><img src="http://img.bcoder.top/2018.02.21/45.png" alt="MySQL数据库深入（二）"></p>
<p>5.诊断SQL:<br><code>show profile cpu,block io for query id;</code><br>(id是上一步通过show profiles查询的Query_ID数值)；</p>
<p><img src="http://img.bcoder.top/2018.02.21/46.png" alt="MySQL数据库深入（二）"></p>
<p>show profile 后面还可以有很多参数，来查看执行的详细情况，其中我们主要用的是cpu，block io。详细参数介绍：<br>all ：显示所有的开销信息<br>block io ： 显示io相关开销<br>context switches ： 上下文切换相关开销<br>cpu ： 显示cpu相关开销<br>ipc ： 显示发送和接收相关开销信息<br>memory ： 显示内存相关开销信息<br>page faults ： 显示页面错误相关开销信息<br>source ：显示source_function,source_file,source_line相关的开销信息<br>swaps ： 显示交换次数相关的开销信息</p>
<p>6.日常开发需要注意到结论:<br>1). status 出现converting HEAP to MyISAM 查询结果太大，内存都不够用了只能往磁盘上搬了。<br>2). status 出现creating tmp table 创建临时表<br>拷贝数据到临时表；用完再删除。<br>3). status 出现copying to tmp table on disk 把内存中临时表复制到磁盘，危险！！！<br>4). status 出现locked 锁表</p>
<p><strong>全局查询日志：</strong></p>
<p>开启全局查询日志以后，所有的sql都会被记录下来（<strong>生产环境不要开启这个</strong>）</p>
<p>可以在my.cnf中配置开启，设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">general_log&#x3D;1，</span><br><span class="line">general_log_file&#x3D;&#x2F;路径，</span><br><span class="line">log_output&#x3D;FILE或者log_output&#x3D;TABLE，</span><br></pre></td></tr></table></figure>

<p>设置了输出到文件中，那么所有的sql都被记录到了general_log_file中配置的路径里面，如果设置了输出到table，那么所有的记录都被记录到了mysql库中的general_log表中。</p>
<p>可以使用命令开启，命令开启的mysql重启以后将失效；<br>执行命令:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> general_log = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> log_output=<span class="string">'TABLE'</span>;</span><br></pre></td></tr></table></figure>

<p>之后所有的sql都将被记录到general_log中。使用select * from mysql.general_log 将查处所有的sql。</p>

          
            <br>
            
  
    
    

<section class="widget copyright  desktop mobile">
  <div class='content'>
    
      <blockquote>
        
          
            <p>博客内容遵循 署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</p>

          
        
          
            <p>本文永久链接是：<a href=https://www.bcoder.top/2018/02/21/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E6%B7%B1%E5%85%A5%EF%BC%88%E4%BA%8C%EF%BC%89/>https://www.bcoder.top/2018/02/21/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E6%B7%B1%E5%85%A5%EF%BC%88%E4%BA%8C%EF%BC%89/</a></p>
          
        
      </blockquote>
    
  </div>
</section>

  

  
    
    

<section class="widget qrcode  desktop mobile">
  

  <div class='content article-entry'>
    
      
        <div class='fancybox'><img src='https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/qrcode/wiki_volantis.png'
        
          height='64px'
        ></div>
      
    
      
        <div class='fancybox'><img src='https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/qrcode/wiki_volantis.png'
        
          height='64px'
        ></div>
      
    
  </div>
</section>

  


          
        </div>
        
          


  <section class='meta' id="footer-meta">
    <div class='new-meta-box'>
      
        
          <div class="new-meta-item date" itemprop="dateUpdated" datetime="2020-01-21T18:44:03+08:00">
  <a class='notlink'>
    <i class="fas fa-edit fa-fw" aria-hidden="true"></i>
    <p>更新于：2020-01-21 18:44:03</p>
  </a>
</div>

        
      
        
          
  
  <div class="new-meta-item meta-tags"><a class="tag" href="/tags/MySQL/" rel="nofollow"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i><p>MySQL</p></a></div> <div class="new-meta-item meta-tags"><a class="tag" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="nofollow"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i><p>数据库</p></a></div>


        
      
        
          

        
      
        
          
  <div class="new-meta-item share -mob-share-list">
  <div class="-mob-share-list share-body">
    
      
        <a class="-mob-share-qq" title="" rel="external nofollow noopener noreferrer"
          
          href="http://connect.qq.com/widget/shareqq/index.html?url=https://www.bcoder.top/2018/02/21/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E6%B7%B1%E5%85%A5%EF%BC%88%E4%BA%8C%EF%BC%89/&title=MySQL数据库深入（二） - zln's blog&summary=
引言数据库对于程序员来说至关重要，数据库的学习不能仅仅停留在SQL语句的书写上，应当数据库的底层原理、架构、SQL优化等方面有一个全面的了解。下面对关系型数据库MySQL进行较为深入的学习。
"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/qq.png">
          
        </a>
      
    
      
        <a class="-mob-share-qzone" title="" rel="external nofollow noopener noreferrer"
          
          href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://www.bcoder.top/2018/02/21/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E6%B7%B1%E5%85%A5%EF%BC%88%E4%BA%8C%EF%BC%89/&title=MySQL数据库深入（二） - zln's blog&summary=
引言数据库对于程序员来说至关重要，数据库的学习不能仅仅停留在SQL语句的书写上，应当数据库的底层原理、架构、SQL优化等方面有一个全面的了解。下面对关系型数据库MySQL进行较为深入的学习。
"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/qzone.png">
          
        </a>
      
    
      
        <a class="-mob-share-weibo" title="" rel="external nofollow noopener noreferrer"
          
          href="http://service.weibo.com/share/share.php?url=https://www.bcoder.top/2018/02/21/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E6%B7%B1%E5%85%A5%EF%BC%88%E4%BA%8C%EF%BC%89/&title=MySQL数据库深入（二） - zln's blog&summary=
引言数据库对于程序员来说至关重要，数据库的学习不能仅仅停留在SQL语句的书写上，应当数据库的底层原理、架构、SQL优化等方面有一个全面的了解。下面对关系型数据库MySQL进行较为深入的学习。
"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/weibo.png">
          
        </a>
      
    
  </div>
</div>



        
      
    </div>
  </section>


        
        
          <div class="prev-next">
            
              <a class='prev' href='/2018/02/22/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E6%B7%B1%E5%85%A5%EF%BC%88%E4%B8%89%EF%BC%89/'>
                <p class='title'><i class="fas fa-chevron-left" aria-hidden="true"></i>MySQL数据库深入（三）</p>
                <p class='content'>
引言数据库对于程序员来说至关重要，数据库的学习不能仅仅停留在SQL语句的书写上，应当数据库的底层原理、架构、SQL优化等方面有一个全面的了解。下面对关系型数据库MySQL进行较为深入的学习。
...</p>
              </a>
            
            
              <a class='next' href='/2018/02/20/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E6%B7%B1%E5%85%A5%EF%BC%88%E4%B8%80%EF%BC%89/'>
                <p class='title'>MySQL数据库深入（一）<i class="fas fa-chevron-right" aria-hidden="true"></i></p>
                <p class='content'>
引言数据库对于程序员来说至关重要，数据库的学习不能仅仅停留在SQL语句的书写上，应当数据库的底层原理、架构、SQL优化等方面有一个全面的了解。下面对关系型数据库MySQL进行较为深入的学习。
...</p>
              </a>
            
          </div>
        
      </section>
    </article>
  

  
    <!-- 显示推荐文章和评论 -->



  <article class="post white-box comments shadow">
    <section class="article typo">
      <p ct><i class='fas fa-comments'></i> 评论</p>
      
      
      
      
      
        <section id="comments">
          <div id="valine_container" class="valine_thread">
            <i class="fas fa-spinner fa-spin fa-fw"></i>
          </div>
        </section>
      
    </section>
  </article>


  




<!-- 根据页面mathjax变量决定是否加载MathJax数学公式js -->



  <script>
    window.subData = {
      title: 'MySQL数据库深入（二）',
      tools: true
    }
  </script>


</div>
<aside class='l_side'>
  
  

  
    
    


  <section class="widget toc-wrapper shadow desktop mobile">
    
  <header>
    
      <i class="fas fa-list fa-fw" aria-hidden="true"></i><span class='name'>本文目录</span>
    
  </header>


    <div class='content'>
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#索引优化案例"><span class="toc-number">1.</span> <span class="toc-text">索引优化案例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#单表索引优化"><span class="toc-number">1.1.</span> <span class="toc-text">单表索引优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#建表"><span class="toc-number">1.1.1.</span> <span class="toc-text">建表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#单表索引分析"><span class="toc-number">1.1.2.</span> <span class="toc-text">单表索引分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#优化"><span class="toc-number">1.1.3.</span> <span class="toc-text">优化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#第二次优化"><span class="toc-number">1.1.4.</span> <span class="toc-text">第二次优化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#两表索引优化"><span class="toc-number">1.2.</span> <span class="toc-text">两表索引优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#建表-1"><span class="toc-number">1.2.1.</span> <span class="toc-text">建表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#两表索引分析"><span class="toc-number">1.2.2.</span> <span class="toc-text">两表索引分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#优化-1"><span class="toc-number">1.2.3.</span> <span class="toc-text">优化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#再次分析"><span class="toc-number">1.2.4.</span> <span class="toc-text">再次分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#三表索引优化"><span class="toc-number">1.3.</span> <span class="toc-text">三表索引优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#建表-2"><span class="toc-number">1.3.1.</span> <span class="toc-text">建表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#三表索引分析"><span class="toc-number">1.3.2.</span> <span class="toc-text">三表索引分析</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#索引失效"><span class="toc-number">2.</span> <span class="toc-text">索引失效</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查询优化"><span class="toc-number">3.</span> <span class="toc-text">查询优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#小表驱动大表"><span class="toc-number">3.1.</span> <span class="toc-text">小表驱动大表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#order-by关键字优化"><span class="toc-number">3.2.</span> <span class="toc-text">order by关键字优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#group-by关键字优化"><span class="toc-number">3.3.</span> <span class="toc-text">group by关键字优化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#慢查询日志"><span class="toc-number">4.</span> <span class="toc-text">慢查询日志</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#慢查询日志介绍"><span class="toc-number">4.1.</span> <span class="toc-text">慢查询日志介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#慢查询日志使用"><span class="toc-number">4.2.</span> <span class="toc-text">慢查询日志使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#日志分析工具mysqldumpslow"><span class="toc-number">4.3.</span> <span class="toc-text">日志分析工具mysqldumpslow</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#批量数据脚本"><span class="toc-number">5.</span> <span class="toc-text">批量数据脚本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Show-Profile分析SQL"><span class="toc-number">6.</span> <span class="toc-text">Show Profile分析SQL</span></a></li></ol>
    </div>
  </section>


  


</aside>


  
  <footer class="clearfix">
    <br><br>
    
      
        <br>
        <div class="social-wrapper">
          
            
              <a href="https://www.bcoder.top"
                class="social fas fa-rss flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
            
              <a href="mailto:me@xaoxuu.com"
                class="social fas fa-envelope flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
            
              <a href="https://github.com/zlnnjit"
                class="social fab fa-github flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
            
              <a href="https://music.163.com/#/user/home?id=430673592"
                class="social fas fa-headphones-alt flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
        </div>
      
    
      
        Use
        <a href="https://bcoder.top/" target="_blank" class="codename">周陆宁</a>
        as theme
        
          , 
          total visits
          <span id="busuanzi_value_site_pv"><i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span>
          times
        
      
    
      
        <div class='copyright'>
        <p><a href="https://bocder.top" target="_blank" rel="noopener">Copyright © 2016-2020 zlnnjit</a></p>

        </div>
      
    
  </footer>

<script>setLoadingBarProgress(80);</script>


      <script>setLoadingBarProgress(60);</script>
    </div>
    <a class="s-top fas fa-arrow-up fa-fw" href='javascript:void(0)'></a>
  </div>
  
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4/dist/jquery.min.js"></script>


  <script>
    
    var SEARCH_SERVICE = "hexo" || "hexo";
    var ROOT = "/" || "/";
    if (!ROOT.endsWith('/')) ROOT += '/';
  </script>


  <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2/js/instant_page.js" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>



  
<script src="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js"></script>

  <script type="text/javascript">
    $(function() {
      Waves.attach('.flat-btn', ['waves-button']);
      Waves.attach('.float-btn', ['waves-button', 'waves-float']);
      Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);
      Waves.attach('.flat-box', ['waves-block']);
      Waves.attach('.float-box', ['waves-block', 'waves-float']);
      Waves.attach('.waves-image');
      Waves.init();
    });
  </script>


  <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js"></script>



  
  
  
    
<script src="https://cdn.jsdelivr.net/npm/jquery-backstretch@2.1.18/jquery.backstretch.min.js"></script>

    <script type="text/javascript">
      $(function(){
        var imgs=["https://cdn.jsdelivr.net/gh/xaoxuu/cdn-wallpaper/abstract/41F215B9-261F-48B4-80B5-4E86E165259E.jpeg"];
        if ('true' == 'true') {
          function shuffle(arr){
            /*From countercurrent-time*/
            var n = arr.length;
            while(n--) {
              var index = Math.floor(Math.random() * n);
              var temp = arr[index];
              arr[index] = arr[n];
              arr[n] = temp;
            }
          }
          shuffle(imgs);
        }
        if ('.cover') {
          $('.cover').backstretch(
            imgs,
          {
            duration: "20000",
            fade: "1500"
          });
        } else {
          $.backstretch(
            imgs,
          {
            duration: "20000",
            fade: "1500"
          });
        }
      });
    </script>
  



  
    
<script src="https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.js" async></script>

  
    
<script src="https://cdn.jsdelivr.net/npm/meting@2.0/dist/Meting.min.js" async></script>

  








  
    
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2.2.0/js/valine.js"></script>

  
  <script>
  var GUEST_INFO = ['nick','mail','link'];
  var guest_info = 'nick,mail,link'.split(',').filter(function(item){
    return GUEST_INFO.indexOf(item) > -1
  });
  var notify = 'true' == true;
  var verify = 'true' == true;
  var valine = new Valine();
  valine.init({
    el: '#valine_container',
    notify: notify,
    verify: verify,
    guest_info: guest_info,
    
    appId: "M3YhrSNLSJTxyKwa8hGSGbH7-gzGzoHsz",
    appKey: "RwjMsAULtRweeA4GtaqJGPVu",
    placeholder: "快来评论吧~",
    pageSize:'10',
    avatar:'mp',
    lang:'zh-cn',
    visitor: 'false',
    highlight:'true'
  })
  </script>



  
<script src="/js/app.js"></script>



  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2.1/js/search.js"></script>



  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2/js/comment_typing.js"></script>



<!-- 复制 -->

  <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="fas fa-copy"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copyed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('fa-copy');
        $icon.addClass('fa-clipboard-check');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPYED';
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('fa-copy');
        $icon.addClass('fa-exclamation-triangle');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
      });
    }
    initCopyCode();
  }(window, document);
</script>




<!-- fancybox -->

  <script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script>
  let LAZY_LOAD_IMAGE = "";
  $(".article-entry").find("div.fancybox").find("img").each(function () {
      var element = document.createElement("a");
      $(element).attr("data-fancybox", "gallery");
      $(element).attr("href", $(this).attr("src"));
      /* 图片采用懒加载处理时,
       * 一般图片标签内会有个属性名来存放图片的真实地址，比如 data-original,
       * 那么此处将原本的属性名src替换为对应属性名data-original,
       * 修改如下
       */
       if (LAZY_LOAD_IMAGE) {
         $(element).attr("href", $(this).attr("data-original"));
       }
      $(this).wrap(element);
  });
</script>






  <script>setLoadingBarProgress(100);</script>
</body>
</html>

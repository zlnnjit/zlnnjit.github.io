<!DOCTYPE html>
<html>
<head hexo-theme='https://volantis.js.org/#2020'>
  <meta charset="utf-8">
  <!-- SEO相关 -->
  
    
  
  <!-- 渲染优化 -->
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <!-- 页面元数据 -->
  
    <title>Google Guava:java扩展类库（下） - zln&#39;s blog</title>
  
    <meta name="keywords" content="java,Guava">
  
  
    <meta name="description" content="
引言Guava 是一个 Google 的基于java1.6的类库集合的扩展项目。Guava工程包含了若干被Google的Java项目广泛依赖的核心库，例如：集合（collections）、缓存（caching） 、原生类型支持（primitives support）、并发库（concurrency librar...">
  

  <!-- feed -->
  

  <!-- import meta -->
  

  <!-- link -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css">
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">

  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css">

  

  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.css">
  

  <!-- import link -->
  

  
    
<link rel="stylesheet" href="/css/style.css">

  

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>

  
  
</head>

<body>
  
  <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>
<header class="l_header shadow blur">

  <div class='wrapper'>
    <div class='nav-sub container--flex'>
      <a class="logo flat-box"></a>
      <ul class='switcher h-list'>
        <li><a class="s-comment flat-btn fas fa-comments fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
          <li><a class="s-toc flat-btn fas fa-list fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
      </ul>
    </div>
		<div class="nav-main container container--flex">
      
        
        <a class="logo flat-box" target="_self" href='/'>
          
          
          
          
            周陆宁 <b><sup style='color:#3AA757'>2020</sup></b>
          
        </a>
      

			<div class='menu navigation'>
				<ul class='h-list'>
          
          
          
            
            
              <li>
                <a class="flat-box" href=/
                  
                  
                  
                    id="home"
                  >
                  
                    <i class='fas fa-rss fa-fw'></i>
                  
                  博客
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=/categories/
                  
                  
                  
                    id="categories"
                  >
                  
                    <i class='fas fa-folder-open fa-fw'></i>
                  
                  分类
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=/tags/
                  
                  
                  
                    id="tags"
                  >
                  
                    <i class='fas fa-tags fa-fw'></i>
                  
                  标签
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=/archives/
                  
                  
                  
                    id="archives"
                  >
                  
                    <i class='fas fa-archive fa-fw'></i>
                  
                  归档
                </a>
                
              </li>
            
          
          
				</ul>
			</div>

      
        <div class="m_search">
          <form name="searchform" class="form u-search-form">
            <i class="icon fas fa-search fa-fw"></i>
            <input type="text" class="input u-search-input" placeholder="搜索" />
          </form>
        </div>
      

			<ul class='switcher h-list'>
				
					<li><a class="s-search flat-btn fas fa-search fa-fw" target="_self" href='javascript:void(0)'></a></li>
				
				<li><a class="s-menu flat-btn fas fa-bars fa-fw" target="_self" href='javascript:void(0)'></a></li>
			</ul>
		</div>
	</div>
</header>
<ul class="menu-phone navigation white-box">
  
  
    <li>
      <a class="flat-box" href=/
        
        
        
          id="home"
        >
        
          <i class='fas fa-rss fa-fw'></i>
        
        博客
      </a>
    </li>
  
    <li>
      <a class="flat-box" href=/categories/
        
        
        
          id="categories"
        >
        
          <i class='fas fa-folder-open fa-fw'></i>
        
        分类
      </a>
    </li>
  
    <li>
      <a class="flat-box" href=/tags/
        
        
        
          id="tags"
        >
        
          <i class='fas fa-tags fa-fw'></i>
        
        标签
      </a>
    </li>
  
    <li>
      <a class="flat-box" href=/archives/
        
        
        
          id="archives"
        >
        
          <i class='fas fa-archive fa-fw'></i>
        
        归档
      </a>
    </li>
  
    <li>
      <a class="flat-box" href=/friends/
        
        
        
          id="friends"
        >
        
          <i class='fas fa-link fa-fw'></i>
        
        友链
      </a>
    </li>
  
    <li>
      <a class="flat-box" href=/about/
        
        
        
          id="about"
        >
        
          <i class='fas fa-info-circle fa-fw'></i>
        
        关于
      </a>
    </li>
  
</ul>
<script>setLoadingBarProgress(40);</script>



  <div class="l_body nocover">
    <div class='body-wrapper'>
      

<div class='l_main'>
  

  
    <article id="post" class="post white-box shadow article-type-post" itemscope itemprop="blogPost">
      


  <section class='meta'>
    
    
    <div class="meta" id="header-meta">
      
        
  
    <h1 class="title">
      <a href="/2018/03/10/Google-Guava-java%E6%89%A9%E5%B1%95%E7%B1%BB%E5%BA%93%EF%BC%88%E4%B8%8B%EF%BC%89/">
        Google Guava:java扩展类库（下）
      </a>
    </h1>
  


      
      <div class='new-meta-box'>
        
          
        
          
            
<div class='new-meta-item author'>
  <a href="" rel="nofollow">
    <img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/avatar/avatar.png">
    <p>周陆宁</p>
  </a>
</div>

          
        
          
            
  
  <div class='new-meta-item category'>
    <a href='/categories/Guava/' rel="nofollow">
      <i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>
      <p>Guava</p>
    </a>
  </div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i>
    <p>发布于：2018-03-10 13:42:51</p>
  </a>
</div>

          
        
          
            

          
        
      </div>
      
        <hr>
      
    </div>
  </section>


      <section class="article typo">
        <div class="article-entry" itemprop="articleBody">
          
          <blockquote>
<p>引言<br>Guava 是一个 Google 的基于java1.6的类库集合的扩展项目。Guava工程包含了若干被Google的Java项目广泛依赖的核心库，例如：集合（collections）、缓存（caching） 、原生类型支持（primitives support）、并发库（concurrency libraries）、通用注解（common annotations）、字符串处理（string processing）、I/O 等等。 所有这些工具每天都在被Google的工程师应用在产品服务中。</p>
</blockquote>
<a id="more"></a>



<h2 id="Guava新增集合类型"><a href="#Guava新增集合类型" class="headerlink" title="Guava新增集合类型"></a>Guava新增集合类型</h2><p>Guava引进了JDK里没有的，但是非常有用的一些新的集合类型。所有这些新集合类型都能和JDK里的集合平滑集成。Guava集合非常精准地实现了JDK定义的接口。Guava中定义的新集合有：</p>
<ul>
<li>Multiset</li>
<li>SortedMultiset</li>
<li>Multimap</li>
<li>ListMultimap</li>
<li>SetMultimap</li>
<li>BiMap</li>
<li>ClassToInstanceMap</li>
<li>Table</li>
</ul>
<p>下面对几个比较常用的进行介绍。</p>
<h3 id="Multiset"><a href="#Multiset" class="headerlink" title="Multiset"></a>Multiset</h3><p>Multiset是什么？顾名思义，Multiset和Set的区别就是可以保存多个相同的对象。在JDK中，List和Set有一个基本的区别，就是List可以包含多个相同对象，且是有顺序的，而Set不能有重复，且不保证顺序（有些实现有顺序，例如LinkedHashSet和SortedSet等）所以Multiset占据了List和Set之间的一个灰色地带：允许重复，但是不保证顺序。 </p>
<p>常见使用场景：Multiset有一个有用的功能，就是跟踪每种对象的数量，所以你可以用来进行数字统计。 常见的普通实现方式如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testWordCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String strWorld = <span class="string">"wer|dffd|ddsa|dfd|dreg|de|dr|ce|ghrt|cf|gt|ser|tg|ghrt|cf|gt|"</span> +</span><br><span class="line">            <span class="string">"ser|tg|gt|kldf|dfg|vcd|fg|gt|ls|lser|dfr|wer|dffd|ddsa|dfd|dreg|de|dr|"</span> +</span><br><span class="line">            <span class="string">"ce|ghrt|cf|gt|ser|tg|gt|kldf|dfg|vcd|fg|gt|ls|lser|dfr"</span>;</span><br><span class="line">    String[] words = strWorld.split(<span class="string">"\\|"</span>);</span><br><span class="line">    Map&lt;String, Integer&gt; countMap = <span class="keyword">new</span> HashMap&lt;String, Integer&gt;();</span><br><span class="line">    <span class="keyword">for</span> (String word : words) &#123;</span><br><span class="line">        Integer count = countMap.get(word);</span><br><span class="line">        <span class="keyword">if</span> (count == <span class="keyword">null</span>) &#123;</span><br><span class="line">            countMap.put(word, <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            countMap.put(word, count + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">"countMap："</span>);</span><br><span class="line">    <span class="keyword">for</span> (String key : countMap.keySet()) &#123;</span><br><span class="line">        System.out.println(key + <span class="string">" count："</span> + countMap.get(key));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">countMap：</span><br><span class="line">ddsa count：2</span><br><span class="line">de count：2</span><br><span class="line">ser count：3</span><br><span class="line">fg count：2</span><br><span class="line">ce count：2</span><br><span class="line">dfd count：2</span><br><span class="line">cf count：3</span><br><span class="line">dfg count：2</span><br><span class="line">wer count：2</span><br><span class="line">lser count：2</span><br><span class="line">ls count：2</span><br><span class="line">gt count：7</span><br><span class="line">dr count：2</span><br><span class="line">dffd count：2</span><br><span class="line">kldf count：2</span><br><span class="line">dfr count：2</span><br><span class="line">ghrt count：3</span><br><span class="line">tg count：3</span><br><span class="line">vcd count：2</span><br><span class="line">dreg count：2</span><br></pre></td></tr></table></figure>

<p>上面的代码实现的功能非常简单，用于记录字符串在数组中出现的次数。这种场景在实际的开发过程还是容易经常出现的，如果使用实现Multiset接口的具体类就可以很容易实现以上的功能需求：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMultsetWordCount</span><span class="params">()</span></span>&#123;</span><br><span class="line">    String strWorld = <span class="string">"wer|dffd|ddsa|dfd|dreg|de|dr|ce|ghrt|cf|gt|ser|tg|ghrt|cf|gt|"</span> +</span><br><span class="line">            <span class="string">"ser|tg|gt|kldf|dfg|vcd|fg|gt|ls|lser|dfr|wer|dffd|ddsa|dfd|dreg|de|dr|"</span> +</span><br><span class="line">            <span class="string">"ce|ghrt|cf|gt|ser|tg|gt|kldf|dfg|vcd|fg|gt|ls|lser|dfr"</span>;</span><br><span class="line">    String[] words=strWorld.split(<span class="string">"\\|"</span>);</span><br><span class="line">    List&lt;String&gt; wordList=<span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">    <span class="keyword">for</span> (String word : words) &#123;</span><br><span class="line">        wordList.add(word);</span><br><span class="line">    &#125;</span><br><span class="line">    Multiset&lt;String&gt; wordsMultiset = HashMultiset.create();</span><br><span class="line">    wordsMultiset.addAll(wordList);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(String key:wordsMultiset.elementSet())&#123;</span><br><span class="line">        System.out.println(key+<span class="string">" count："</span>+wordsMultiset.count(key));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Multiset主要方法：</strong></p>
<ul>
<li>add(E element) :向其中添加单个元素</li>
<li>add(E element,int occurrences) : 向其中添加指定个数的元素</li>
<li>count(Object element) : 返回给定参数元素的个数</li>
<li>remove(E element) : 移除一个元素，其count值 会响应减少</li>
<li>remove(E element,int occurrences): 移除相应个数的元素</li>
<li>elementSet() : 将不同的元素放入一个Set中</li>
<li>entrySet(): 类似与Map.entrySet 返回Set&lt;Multiset.Entry&gt;。包含的Entry支持使用getElement()和getCount()</li>
<li>setCount(E element ,int count): 设定某一个元素的重复次数</li>
<li>setCount(E element,int oldCount,int newCount): 将符合原有重复个数的元素修改为新的重复次数</li>
<li>retainAll(Collection c) : 保留出现在给定集合参数的所有的元素</li>
<li>removeAll(Collection c) : 去除出现给给定集合参数的所有的元素</li>
</ul>
<p>常用方法实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMultsetWordCount2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String strWorld = <span class="string">"wer|dfd|dd|dfd|dda|de|dr"</span>;</span><br><span class="line">    String[] words = strWorld.split(<span class="string">"\\|"</span>);</span><br><span class="line">    List&lt;String&gt; wordList = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">    <span class="keyword">for</span> (String word : words) &#123;</span><br><span class="line">        wordList.add(word);</span><br><span class="line">    &#125;</span><br><span class="line">    Multiset&lt;String&gt; wordsMultiset = HashMultiset.create();</span><br><span class="line">    wordsMultiset.addAll(wordList);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//System.out.println("wordsMultiset："+wordsMultiset);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (String key : wordsMultiset.elementSet()) &#123;</span><br><span class="line">        System.out.println(key + <span class="string">" count："</span> + wordsMultiset.count(key));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!wordsMultiset.contains(<span class="string">"peida"</span>)) &#123;</span><br><span class="line">        wordsMultiset.add(<span class="string">"peida"</span>, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">"============================================"</span>);</span><br><span class="line">    <span class="keyword">for</span> (String key : wordsMultiset.elementSet()) &#123;</span><br><span class="line">        System.out.println(key + <span class="string">" count："</span> + wordsMultiset.count(key));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (wordsMultiset.contains(<span class="string">"peida"</span>)) &#123;</span><br><span class="line">        wordsMultiset.setCount(<span class="string">"peida"</span>, <span class="number">23</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">"============================================"</span>);</span><br><span class="line">    <span class="keyword">for</span> (String key : wordsMultiset.elementSet()) &#123;</span><br><span class="line">        System.out.println(key + <span class="string">" count："</span> + wordsMultiset.count(key));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (wordsMultiset.contains(<span class="string">"peida"</span>)) &#123;</span><br><span class="line">        wordsMultiset.setCount(<span class="string">"peida"</span>, <span class="number">23</span>, <span class="number">45</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">"============================================"</span>);</span><br><span class="line">    <span class="keyword">for</span> (String key : wordsMultiset.elementSet()) &#123;</span><br><span class="line">        System.out.println(key + <span class="string">" count："</span> + wordsMultiset.count(key));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (wordsMultiset.contains(<span class="string">"peida"</span>)) &#123;</span><br><span class="line">        wordsMultiset.setCount(<span class="string">"peida"</span>, <span class="number">44</span>, <span class="number">67</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">"============================================"</span>);</span><br><span class="line">    <span class="keyword">for</span> (String key : wordsMultiset.elementSet()) &#123;</span><br><span class="line">        System.out.println(key + <span class="string">" count："</span> + wordsMultiset.count(key));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">dd count：1</span><br><span class="line">dda count：1</span><br><span class="line">de count：1</span><br><span class="line">dfd count：2</span><br><span class="line">wer count：1</span><br><span class="line">dr count：1</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">dd count：1</span><br><span class="line">dda count：1</span><br><span class="line">de count：1</span><br><span class="line">dfd count：2</span><br><span class="line">wer count：1</span><br><span class="line">peida count：2</span><br><span class="line">dr count：1</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">dd count：1</span><br><span class="line">dda count：1</span><br><span class="line">de count：1</span><br><span class="line">dfd count：2</span><br><span class="line">wer count：1</span><br><span class="line">peida count：23</span><br><span class="line">dr count：1</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">dd count：1</span><br><span class="line">dda count：1</span><br><span class="line">de count：1</span><br><span class="line">dfd count：2</span><br><span class="line">wer count：1</span><br><span class="line">peida count：45</span><br><span class="line">dr count：1</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">dd count：1</span><br><span class="line">dda count：1</span><br><span class="line">de count：1</span><br><span class="line">dfd count：2</span><br><span class="line">wer count：1</span><br><span class="line">peida count：45</span><br><span class="line">dr count：1</span><br></pre></td></tr></table></figure>

<p>说明：setCount(E element,int oldCount,int newCount): 方法，如果传入的oldCount和element的不一致的时候，是不能讲element的count设置成newCount的。需要注意。</p>
<p><strong>Multiset不是Map</strong></p>
<p>需要注意的是Multiset不是一个Map<code>&lt;E,Integer&gt;</code>,尽管Multiset提供一部分类似的功能实现。其它值得关注的差别有:</p>
<p>Multiset中的元素的重复个数只会是正数，且最大不会超过Integer.MAX_VALUE。设定计数为0的元素将不会出现multiset中，也不会出现elementSet()和entrySet()的返回结果中。</p>
<p>multiset.size() 方法返回的是所有的元素的总和，相当于是将所有重复的个数相加。如果需要知道每个元素的个数可以使用elementSet().size()得到.(因而调用add(E)方法会是multiset.size()增加1).</p>
<p>multiset.iterator()会循环迭代每一个出现的元素，迭代的次数与multiset.size()相同。 iterates over each occurrence of each element, so the length of the iteration is equal to multiset.size().</p>
<p>Multiset 支持添加、移除多个元素以及重新设定元素的个数。执行setCount(element,0)相当于移除multiset中所有的相同元素。</p>
<p>调用multiset.count(elem)方法时，如果该元素不在该集中，那么返回的结果只会是0。</p>
<p>Guava提供了Multiset的多种实现，这些实现基本对应了JDK中Map的实现：</p>
<p><img src="http://img.bcoder.top/2018.03.10/1.png" alt="Google Guava:java扩展类库(下)"></p>
<h3 id="Multimap"><a href="#Multimap" class="headerlink" title="Multimap"></a>Multimap</h3><p>在日常的开发工作中，我们有的时候需要构造像<code>Map&lt;K, List&lt;V&gt;&gt;</code>或者<code>Map&lt;K, Set&lt;V&gt;&gt;</code>这样比较复杂的集合类型的数据结构，以便做相应的业务逻辑处理。例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MultimapTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    Map&lt;String, List&lt;StudentScore&gt;&gt; StudentScoreMap = <span class="keyword">new</span> HashMap&lt;String, List&lt;StudentScore&gt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testStudentScore</span><span class="params">()</span></span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">10</span>;i&lt;<span class="number">20</span>;i++)&#123;</span><br><span class="line">            StudentScore studentScore=<span class="keyword">new</span> StudentScore();</span><br><span class="line">            studentScore.CourseId=<span class="number">1001</span>+i;</span><br><span class="line">            studentScore.score=<span class="number">100</span>-i;</span><br><span class="line">            addStudentScore(<span class="string">"peida"</span>,studentScore);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">"StudentScoreMap:"</span>+StudentScoreMap.size());</span><br><span class="line">        System.out.println(<span class="string">"StudentScoreMap:"</span>+StudentScoreMap.containsKey(<span class="string">"peida"</span>));</span><br><span class="line">            </span><br><span class="line">        System.out.println(<span class="string">"StudentScoreMap:"</span>+StudentScoreMap.containsKey(<span class="string">"jerry"</span>));</span><br><span class="line">        System.out.println(<span class="string">"StudentScoreMap:"</span>+StudentScoreMap.size());</span><br><span class="line">        System.out.println(<span class="string">"StudentScoreMap:"</span>+StudentScoreMap.get(<span class="string">"peida"</span>).size());</span><br><span class="line"></span><br><span class="line">        List&lt;StudentScore&gt; StudentScoreList=StudentScoreMap.get(<span class="string">"peida"</span>);</span><br><span class="line">        <span class="keyword">if</span>(StudentScoreList!=<span class="keyword">null</span>&amp;&amp;StudentScoreList.size()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span>(StudentScore stuScore:StudentScoreList)&#123;</span><br><span class="line">                System.out.println(<span class="string">"stuScore one:"</span>+stuScore.CourseId+<span class="string">" score:"</span>+stuScore.score);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addStudentScore</span><span class="params">(<span class="keyword">final</span> String stuName,<span class="keyword">final</span> StudentScore studentScore)</span> </span>&#123;</span><br><span class="line">        List&lt;StudentScore&gt; stuScore = StudentScoreMap.get(stuName);</span><br><span class="line">        <span class="keyword">if</span> (stuScore == <span class="keyword">null</span>) &#123;</span><br><span class="line">            stuScore = <span class="keyword">new</span> ArrayList&lt;StudentScore&gt;();</span><br><span class="line">            StudentScoreMap.put(stuName, stuScore);</span><br><span class="line">        &#125;</span><br><span class="line">        stuScore.add(studentScore);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StudentScore</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> CourseId;</span><br><span class="line">    <span class="keyword">int</span> score;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">StudentScoreMap:1</span><br><span class="line">StudentScoreMap:true</span><br><span class="line">StudentScoreMap:false</span><br><span class="line">StudentScoreMap:1</span><br><span class="line">StudentScoreMap:10</span><br><span class="line">stuScore one:1011 score:90</span><br><span class="line">stuScore one:1012 score:89</span><br><span class="line">stuScore one:1013 score:88</span><br><span class="line">stuScore one:1014 score:87</span><br><span class="line">stuScore one:1015 score:86</span><br><span class="line">stuScore one:1016 score:85</span><br><span class="line">stuScore one:1017 score:84</span><br><span class="line">stuScore one:1018 score:83</span><br><span class="line">stuScore one:1019 score:82</span><br><span class="line">stuScore one:1020 score:81</span><br></pre></td></tr></table></figure>

<p>像<code>Map&lt;String, List&lt;StudentScore&gt;&gt; StudentScoreMap = new HashMap&lt;String, List&lt;StudentScore&gt;&gt;()</code>这样的数据结构，自己实现起来太麻烦，你需要检查key是否存在，不存在时则创建一个，存在时在List后面添加上一个。这个过程是比较痛苦的，如果你希望检查List中的对象是否存在，删除一个对象，或者遍历整个数据结构，那么则需要更多的代码来实现。</p>
<p>Guava的Multimap就提供了一个方便地把一个键对应到多个值的数据结构。让我们可以简单优雅的实现上面复杂的数据结构，让我们的精力和时间放在实现业务逻辑上，而不是在数据结构上，下面我们具体来看看Multimap的相关知识点。</p>
<p>上面的代码和数据结构用Multimap来实现，代码结构清晰简单了很多吧，具体代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void teststuScoreMultimap()&#123;</span><br><span class="line">    Multimap&lt;String,StudentScore&gt; scoreMultimap &#x3D; ArrayListMultimap.create(); </span><br><span class="line">    for(int i&#x3D;10;i&lt;20;i++)&#123;</span><br><span class="line">        StudentScore studentScore&#x3D;new StudentScore();</span><br><span class="line">        studentScore.CourseId&#x3D;1001+i;</span><br><span class="line">        studentScore.score&#x3D;100-i;</span><br><span class="line">        scoreMultimap.put(&quot;peida&quot;,studentScore);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(&quot;scoreMultimap:&quot;+scoreMultimap.size());</span><br><span class="line">    System.out.println(&quot;scoreMultimap:&quot;+scoreMultimap.keys());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scoreMultimap:10</span><br><span class="line">scoreMultimap:[peida x 10]</span><br></pre></td></tr></table></figure>
<p>调用Multimap.get(key)会返回这个键对应的值的集合的视图（view），没有对应集合就返回空集合。对于ListMultimap来说，这个方法会返回一个List，对于SetMultimap来说，这个方法就返回一个Set。修改数据是通过修改底层Multimap来实现的。例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">teststuScoreMultimap</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Multimap&lt;String,StudentScore&gt; scoreMultimap = ArrayListMultimap.create(); </span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">10</span>;i&lt;<span class="number">20</span>;i++)&#123;</span><br><span class="line">        StudentScore studentScore=<span class="keyword">new</span> StudentScore();</span><br><span class="line">        studentScore.CourseId=<span class="number">1001</span>+i;</span><br><span class="line">        studentScore.score=<span class="number">100</span>-i;</span><br><span class="line">        scoreMultimap.put(<span class="string">"peida"</span>,studentScore);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">"scoreMultimap:"</span>+scoreMultimap.size());</span><br><span class="line">    System.out.println(<span class="string">"scoreMultimap:"</span>+scoreMultimap.keys());</span><br><span class="line">    </span><br><span class="line">    Collection&lt;StudentScore&gt; studentScore = scoreMultimap.get(<span class="string">"peida"</span>);</span><br><span class="line">    studentScore.clear();</span><br><span class="line">    StudentScore studentScoreNew=<span class="keyword">new</span> StudentScore();</span><br><span class="line">    studentScoreNew.CourseId=<span class="number">1034</span>;</span><br><span class="line">    studentScoreNew.score=<span class="number">67</span>;</span><br><span class="line">    studentScore.add(studentScoreNew);</span><br><span class="line">    </span><br><span class="line">    System.out.println(<span class="string">"scoreMultimap:"</span>+scoreMultimap.size());</span><br><span class="line">    System.out.println(<span class="string">"scoreMultimap:"</span>+scoreMultimap.keys());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">scoreMultimap:10</span><br><span class="line">scoreMultimap:[peida x 10]</span><br><span class="line">scoreMultimap:1</span><br><span class="line">scoreMultimap:[peida]</span><br></pre></td></tr></table></figure>


<p><strong>Multimap支持一系列强大的视图功能：</strong><br>1.asMap把自身<code>Multimap&lt;K, V&gt;</code>映射成<code>Map&lt;K, Collection&lt;V&gt;&gt;</code>视图。这个Map视图支持remove和修改操作，但是不支持put和putAll。严格地来讲，当你希望传入参数是不存在的key，而且你希望返回的是null而不是一个空的可修改的集合的时候就可以调用asMap().get(key)。（你可以强制转型asMap().get(key)的结果类型－对SetMultimap的结果转成Set，对ListMultimap的结果转成List型－但是直接把ListMultimap转成<code>Map&lt;K, List&lt;V&gt;&gt;</code>是不行的。）</p>
<p>2.entries视图是把Multimap里所有的键值对以<code>Collection&lt;Map.Entry&lt;K, V&gt;&gt;</code>的形式展现。</p>
<p>3.keySet视图是把Multimap的键集合作为视图</p>
<p>4.keys视图返回的是个Multiset，这个Multiset是以不重复的键对应的个数作为视图。这个Multiset可以通过支持移除操作而不是添加操作来修改Multimap。</p>
<p>5.values()视图能把Multimap里的所有值“平展”成一个Collection<V>。这个操作和Iterables.concat(multimap.asMap().values())很相似，只是它返回的是一个完整的Collection。</p>
<p>尽管Multimap的实现用到了Map，但<code>Multimap&lt;K, V&gt;</code>不是<code>Map&lt;K, Collection&lt;V&gt;&gt;</code>。因为两者有明显区别：<br>1.Multimap.get(key)一定返回一个非null的集合。但这不表示Multimap使用了内存来关联这些键，相反，返回的集合只是个允许添加元素的视图。</p>
<p>2.如果你喜欢像Map那样当不存在键的时候要返回null，而不是Multimap那样返回空集合的话，可以用asMap()返回的视图来得到<code>Map&lt;K, Collection&lt;V&gt;&gt;</code>。（这种情况下，你得把返回的<code>Collection&lt;V&gt;</code>强转型为List或Set）。</p>
<p>3.Multimap.containsKey(key)只有在这个键存在的时候才返回true。</p>
<p>4.Multimap.entries()返回的是Multimap所有的键值对。但是如果需要key-collection的键值对，那就得用asMap().entries()。</p>
<p>5.Multimap.size()返回的是entries的数量，而不是不重复键的数量。如果要得到不重复键的数目就得用Multimap.keySet().size()。</p>
<p>我们来看一个实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">teststuScoreMultimap3</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Multimap&lt;String,StudentScore&gt; scoreMultimap = ArrayListMultimap.create(); </span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">10</span>;i&lt;<span class="number">20</span>;i++)&#123;</span><br><span class="line">        StudentScore studentScore=<span class="keyword">new</span> StudentScore();</span><br><span class="line">        studentScore.CourseId=<span class="number">1001</span>+i;</span><br><span class="line">        studentScore.score=<span class="number">100</span>-i;</span><br><span class="line">        scoreMultimap.put(<span class="string">"peida"</span>,studentScore);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">"scoreMultimap:"</span>+scoreMultimap.size());</span><br><span class="line">    System.out.println(<span class="string">"scoreMultimap:"</span>+scoreMultimap.keys());</span><br><span class="line">    </span><br><span class="line">    Collection&lt;StudentScore&gt; studentScore = scoreMultimap.get(<span class="string">"peida"</span>);</span><br><span class="line">    StudentScore studentScore1=<span class="keyword">new</span> StudentScore();</span><br><span class="line">    studentScore1.CourseId=<span class="number">1034</span>;</span><br><span class="line">    studentScore1.score=<span class="number">67</span>;</span><br><span class="line">    studentScore.add(studentScore1);</span><br><span class="line">    </span><br><span class="line">    StudentScore studentScore2=<span class="keyword">new</span> StudentScore();</span><br><span class="line">    studentScore2.CourseId=<span class="number">1045</span>;</span><br><span class="line">    studentScore2.score=<span class="number">56</span>;</span><br><span class="line">    scoreMultimap.put(<span class="string">"jerry"</span>,studentScore2);</span><br><span class="line">    </span><br><span class="line">    System.out.println(<span class="string">"scoreMultimap:"</span>+scoreMultimap.size());</span><br><span class="line">    System.out.println(<span class="string">"scoreMultimap:"</span>+scoreMultimap.keys());</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(StudentScore stuScore : scoreMultimap.values()) &#123;</span><br><span class="line">        System.out.println(<span class="string">"stuScore one:"</span>+stuScore.CourseId+<span class="string">" score:"</span>+stuScore.score);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    scoreMultimap.remove(<span class="string">"jerry"</span>,studentScore2); </span><br><span class="line">    System.out.println(<span class="string">"scoreMultimap:"</span>+scoreMultimap.size());</span><br><span class="line">    System.out.println(<span class="string">"scoreMultimap:"</span>+scoreMultimap.get(<span class="string">"jerry"</span>));</span><br><span class="line">    </span><br><span class="line">    scoreMultimap.put(<span class="string">"harry"</span>,studentScore2);</span><br><span class="line">    scoreMultimap.removeAll(<span class="string">"harry"</span>);</span><br><span class="line">    System.out.println(<span class="string">"scoreMultimap:"</span>+scoreMultimap.size());</span><br><span class="line">    System.out.println(<span class="string">"scoreMultimap:"</span>+scoreMultimap.get(<span class="string">"harry"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">scoreMultimap:10</span><br><span class="line">scoreMultimap:[peida x 10]</span><br><span class="line">scoreMultimap:12</span><br><span class="line">scoreMultimap:[peida x 11, jerry]</span><br><span class="line">stuScore one:1011 score:90</span><br><span class="line">stuScore one:1012 score:89</span><br><span class="line">stuScore one:1013 score:88</span><br><span class="line">stuScore one:1014 score:87</span><br><span class="line">stuScore one:1015 score:86</span><br><span class="line">stuScore one:1016 score:85</span><br><span class="line">stuScore one:1017 score:84</span><br><span class="line">stuScore one:1018 score:83</span><br><span class="line">stuScore one:1019 score:82</span><br><span class="line">stuScore one:1020 score:81</span><br><span class="line">stuScore one:1034 score:67</span><br><span class="line">stuScore one:1045 score:56</span><br><span class="line">scoreMultimap:11</span><br><span class="line">scoreMultimap:[]</span><br><span class="line">scoreMultimap:11</span><br><span class="line">scoreMultimap:[]</span><br></pre></td></tr></table></figure>

<p>Multimap提供了丰富的实现，所以你可以用它来替代程序里的<code>Map&lt;K, Collection&lt;V&gt;&gt;</code>，具体的实现如下：</p>
<p><img src="http://img.bcoder.top/2018.03.10/2.png" alt="Google Guava:java扩展类库(下)"></p>
<p>以上这些实现，除了immutable的实现都支持null的键和值。<br>1.LinkedListMultimap.entries()能维持迭代时的顺序。</p>
<p>2.LinkedHashMultimap维持插入的顺序，以及键的插入顺序。</p>
<p>要注意并不是所有的实现都正真实现了<code>Map&lt;K, Collection&lt;V&gt;&gt;</code>！（尤其是有些Multimap的实现为了最小化开销，使用了自定义的hash table）</p>
<h3 id="Bimap"><a href="#Bimap" class="headerlink" title="Bimap"></a>Bimap</h3><p>BiMap提供了一种新的集合类型，它提供了key和value的双向关联的数据结构。</p>
<p>通常情况下，我们在使用Java的Map时，往往是通过key来查找value的，但是如果出现下面一种场景的情况，我们就需要额外编写一些代码了。首先来看下面一种表示标识序号和文件名的map结构。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">logMapTest</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Map&lt;Integer,String&gt; logfileMap = Maps.newHashMap();</span><br><span class="line">    logfileMap.put(<span class="number">1</span>,<span class="string">"a.log"</span>);</span><br><span class="line">    logfileMap.put(<span class="number">2</span>,<span class="string">"b.log"</span>);</span><br><span class="line">    logfileMap.put(<span class="number">3</span>,<span class="string">"c.log"</span>);</span><br><span class="line">    System.out.println(<span class="string">"logfileMap:"</span>+logfileMap);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logfileMap:&#123;1&#x3D;a.log, 2&#x3D;b.log, 3&#x3D;c.log&#125;</span><br></pre></td></tr></table></figure>

<p>当我们需要通过序号查找文件名，很简单。但是如果我们需要通过文件名查找其序号时，我们就不得不遍历map了。当然我们还可以编写一段Map倒转的方法来帮助实现倒置的映射关系。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;S,T&gt; <span class="function">Map&lt;T,S&gt; <span class="title">getInverseMap</span><span class="params">(Map&lt;S,T&gt; map)</span> </span>&#123;</span><br><span class="line">    Map&lt;T,S&gt; inverseMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">    <span class="keyword">for</span>(Map.Entry&lt;S,T&gt; entry: map.entrySet()) &#123;</span><br><span class="line">        inverseMap.put(entry.getValue(), entry.getKey());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> inverseMap;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">logMapTest2</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Map&lt;Integer,String&gt; logfileMap = Maps.newHashMap();</span><br><span class="line">    logfileMap.put(<span class="number">1</span>,<span class="string">"a.log"</span>);</span><br><span class="line">    logfileMap.put(<span class="number">2</span>,<span class="string">"b.log"</span>);</span><br><span class="line">    logfileMap.put(<span class="number">3</span>,<span class="string">"c.log"</span>);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">"logfileMap:"</span>+logfileMap);</span><br><span class="line"></span><br><span class="line">    Map&lt;String,Integer&gt; logfileInverseMap = Maps.newHashMap();</span><br><span class="line"></span><br><span class="line">    logfileInverseMap=getInverseMap(logfileMap);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">"logfileInverseMap:"</span>+logfileInverseMap);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">logfileMap:&#123;1&#x3D;a.log, 2&#x3D;b.log, 3&#x3D;c.log&#125;</span><br><span class="line">logfileInverseMap:&#123;c.log&#x3D;3, b.log&#x3D;2, a.log&#x3D;1&#125;</span><br></pre></td></tr></table></figure>


<p>上面的代码可以帮助我们实现map倒转的要求，但是还有一些我们需要考虑的问题:</p>
<ol>
<li>如何处理重复的value的情况。不考虑的话，反转的时候就会出现覆盖的情况.</li>
<li>如果在反转的map中增加一个新的key，倒转前的map是否需要更新一个值呢?<br>在这种情况下需要考虑的业务以外的内容就增加了，编写的代码也变得不那么易读了。这时我们就可以考虑使用Guava中的BiMap了。</li>
</ol>
<p>Bimap使用非常的简单，对于上面的这种使用场景，我们可以用很简单的代码就实现了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">BimapTest</span><span class="params">()</span></span>&#123;</span><br><span class="line">    BiMap&lt;Integer,String&gt; logfileMap = HashBiMap.create(); </span><br><span class="line">    logfileMap.put(<span class="number">1</span>,<span class="string">"a.log"</span>);</span><br><span class="line">    logfileMap.put(<span class="number">2</span>,<span class="string">"b.log"</span>);</span><br><span class="line">    logfileMap.put(<span class="number">3</span>,<span class="string">"c.log"</span>); </span><br><span class="line">    System.out.println(<span class="string">"logfileMap:"</span>+logfileMap); </span><br><span class="line">    BiMap&lt;String,Integer&gt; filelogMap = logfileMap.inverse();</span><br><span class="line">    System.out.println(<span class="string">"filelogMap:"</span>+filelogMap);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">logfileMap:&#123;1&#x3D;a.log, 2&#x3D;b.log, 3&#x3D;c.log&#125;</span><br><span class="line">filelogMap:&#123;a.log&#x3D;1, b.log&#x3D;2, c.log&#x3D;3&#125;</span><br></pre></td></tr></table></figure>

<p>Bimap数据的强制唯一性<br>在使用BiMap时，会要求Value的唯一性。如果value重复了则会抛出错误：java.lang.IllegalArgumentException，例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">BimapTest2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    BiMap&lt;Integer, String&gt; logfileMap = HashBiMap.create();</span><br><span class="line">    logfileMap.put(<span class="number">1</span>, <span class="string">"a.log"</span>);</span><br><span class="line">    logfileMap.put(<span class="number">2</span>, <span class="string">"b.log"</span>);</span><br><span class="line">    logfileMap.put(<span class="number">3</span>, <span class="string">"c.log"</span>);</span><br><span class="line">    logfileMap.put(<span class="number">4</span>, <span class="string">"d.log"</span>);</span><br><span class="line">    logfileMap.put(<span class="number">5</span>, <span class="string">"d.log"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<p><img src="http://img.bcoder.top/2018.03.10/3.png" alt="Google Guava:java扩展类库(下)"></p>
<p>logfileMap.put(5,”d.log”) 会抛出java.lang.IllegalArgumentException: value already present: d.log的错误。如果我们确实需要插入重复的value值，那可以选择forcePut方法。但是我们需要注意的是前面的key也会被覆盖了。例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">BimapTest3</span><span class="params">()</span></span>&#123;</span><br><span class="line">    BiMap&lt;Integer,String&gt; logfileMap = HashBiMap.create();</span><br><span class="line">    logfileMap.put(<span class="number">1</span>,<span class="string">"a.log"</span>);</span><br><span class="line">    logfileMap.put(<span class="number">2</span>,<span class="string">"b.log"</span>);</span><br><span class="line">    logfileMap.put(<span class="number">3</span>,<span class="string">"c.log"</span>);</span><br><span class="line"></span><br><span class="line">    logfileMap.put(<span class="number">4</span>,<span class="string">"d.log"</span>);</span><br><span class="line">    logfileMap.forcePut(<span class="number">5</span>,<span class="string">"d.log"</span>);</span><br><span class="line">    System.out.println(<span class="string">"logfileMap:"</span>+logfileMap);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logfileMap:&#123;1&#x3D;a.log, 2&#x3D;b.log, 3&#x3D;c.log, 5&#x3D;d.log&#125;</span><br></pre></td></tr></table></figure>


<p>inverse方法会返回一个反转的BiMap，但是注意这个反转的map不是新的map对象，它实现了一种视图关联，这样你对于反转后的map的所有操作都会影响原先的map对象。例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">BimapTest4</span><span class="params">()</span></span>&#123;</span><br><span class="line">    BiMap&lt;Integer,String&gt; logfileMap = HashBiMap.create();</span><br><span class="line">    logfileMap.put(<span class="number">1</span>,<span class="string">"a.log"</span>);</span><br><span class="line">    logfileMap.put(<span class="number">2</span>,<span class="string">"b.log"</span>);</span><br><span class="line">    logfileMap.put(<span class="number">3</span>,<span class="string">"c.log"</span>);</span><br><span class="line">    BiMap&lt;String,Integer&gt; filelogMap = logfileMap.inverse();</span><br><span class="line">    System.out.println(<span class="string">"logfileMap:"</span>+logfileMap);</span><br><span class="line">    System.out.println(<span class="string">"filelogMap:"</span>+filelogMap);</span><br><span class="line"></span><br><span class="line">    logfileMap.put(<span class="number">4</span>,<span class="string">"d.log"</span>);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">"logfileMap:"</span>+logfileMap);</span><br><span class="line">    System.out.println(<span class="string">"filelogMap:"</span>+filelogMap);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">logfileMap:&#123;1&#x3D;a.log, 2&#x3D;b.log, 3&#x3D;c.log&#125;</span><br><span class="line">filelogMap:&#123;a.log&#x3D;1, b.log&#x3D;2, c.log&#x3D;3&#125;</span><br><span class="line">logfileMap:&#123;1&#x3D;a.log, 2&#x3D;b.log, 3&#x3D;c.log, 4&#x3D;d.log&#125;</span><br><span class="line">filelogMap:&#123;a.log&#x3D;1, b.log&#x3D;2, c.log&#x3D;3, d.log&#x3D;4&#125;</span><br></pre></td></tr></table></figure>


<p>BiMap的实现类:</p>
<p><img src="http://img.bcoder.top/2018.03.10/4.png" alt="Google Guava:java扩展类库(下)"></p>
<h3 id="Table"><a href="#Table" class="headerlink" title="Table"></a>Table</h3><p>当我们需要多个索引的数据结构的时候，通常情况下，我们只能用这种丑陋的<code>Map&lt;FirstName, Map&lt;LastName, Person&gt;&gt;</code>来实现。为此Guava提供了一个新的集合类型－Table集合类型，来支持这种数据结构的使用场景。Table支持“row”和“column”，而且提供多种视图。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">TableTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Table&lt;String, Integer, String&gt; aTable = HashBasedTable.create();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">char</span> a = <span class="string">'A'</span>; a &lt;= <span class="string">'C'</span>; ++a) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Integer b = <span class="number">1</span>; b &lt;= <span class="number">3</span>; ++b) &#123;</span><br><span class="line">            aTable.put(Character.toString(a), b, String.format(<span class="string">"%c%d"</span>, a, b));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    System.out.println(aTable.column(<span class="number">2</span>));</span><br><span class="line">    System.out.println(aTable.row(<span class="string">"B"</span>));</span><br><span class="line">    System.out.println(aTable.get(<span class="string">"B"</span>, <span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">    System.out.println(aTable.contains(<span class="string">"D"</span>, <span class="number">1</span>));</span><br><span class="line">    System.out.println(aTable.containsColumn(<span class="number">3</span>));</span><br><span class="line">    System.out.println(aTable.containsRow(<span class="string">"C"</span>));</span><br><span class="line">    System.out.println(aTable.columnMap());</span><br><span class="line">    System.out.println(aTable.rowMap());</span><br><span class="line"></span><br><span class="line">    System.out.println(aTable.remove(<span class="string">"B"</span>, <span class="number">3</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;A&#x3D;A2, B&#x3D;B2, C&#x3D;C2&#125;</span><br><span class="line">&#123;1&#x3D;B1, 2&#x3D;B2, 3&#x3D;B3&#125;</span><br><span class="line">B2</span><br><span class="line">false</span><br><span class="line">true</span><br><span class="line">true</span><br><span class="line">&#123;1&#x3D;&#123;A&#x3D;A1, B&#x3D;B1, C&#x3D;C1&#125;, 2&#x3D;&#123;A&#x3D;A2, B&#x3D;B2, C&#x3D;C2&#125;, 3&#x3D;&#123;A&#x3D;A3, B&#x3D;B3, C&#x3D;C3&#125;&#125;</span><br><span class="line">&#123;A&#x3D;&#123;1&#x3D;A1, 2&#x3D;A2, 3&#x3D;A3&#125;, B&#x3D;&#123;1&#x3D;B1, 2&#x3D;B2, 3&#x3D;B3&#125;, C&#x3D;&#123;1&#x3D;C1, 2&#x3D;C2, 3&#x3D;C3&#125;&#125;</span><br><span class="line">B3</span><br></pre></td></tr></table></figure>



<p><strong>Table视图：</strong> </p>
<ul>
<li>rowMap()返回一个<code>Map&lt;R, Map&lt;C, V&gt;&gt;</code>的视图。rowKeySet()类似地返回一个<code>Set&lt;R&gt;</code>。</li>
<li>row(r)返回一个非null的<code>Map&lt;C, V&gt;</code>。修改这个视图Map也会导致原表格的修改。和列相关的方法有columnMap(),columnKeySet()和column(c)。（基于列的操作会比基于行的操作效率差些）</li>
<li>cellSet()返回的是以<code>Table.Cell&lt;R, C, V&gt;</code>为元素的Set。这里的Cell就类似Map.Entry，但是它是通过行和列来区分的。</li>
</ul>
<p><strong>Table有以下实现：</strong> </p>
<ul>
<li><p>HashBasedTable：基于<code>HashMap&lt;R, HashMap&lt;C, V&gt;&gt;</code>的实现。</p>
</li>
<li><p>TreeBasedTable：基于<code>TreeMap&lt;R, TreeMap&lt;C, V&gt;&gt;</code>的实现。</p>
</li>
<li><p>ImmutableTable：基于<code>ImmutableMap&lt;R, ImmutableMap&lt;C, V&gt;&gt;</code>的实现。（注意，ImmutableTable已对稀疏和密集集合做了优化）</p>
</li>
<li><p>ArrayTable：ArrayTable是一个需要在构建的时候就需要定下行列的表格。这种表格由二维数组实现，这样可以在密集数据的表格的场合，提高时间和空间的效率。</p>
</li>
<li><p>ClassToInstanceMap</p>
</li>
</ul>
<p>有的时候，你的map的key并不是一种类型，他们是很多类型，你想通过映射他们得到这种类型，guava提供了ClassToInstanceMap满足了这个目的。</p>
<p>除了继承自Map接口，ClassToInstaceMap提供了方法 T getInstance(Class<code>&lt;T&gt;</code>) 和 T putInstance(Class<code>&lt;T&gt;</code>, T),消除了强制类型转换。 </p>
<p>该类有一个简单类型的参数，通常称为B，代表了map控制的上层绑定，例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ClassToInstanceMap&lt;Number&gt; numberDefaults = MutableClassToInstanceMap.create();</span><br><span class="line">numberDefaults.putInstance(Integer<span class="class">.<span class="keyword">class</span>, <span class="title">Integer</span>.<span class="title">valueOf</span>(0))</span>;</span><br></pre></td></tr></table></figure>

<p>从技术上来说，ClassToInstanceMap<code>&lt;B&gt;</code> 实现了<code>Map&lt;Class&lt;? extends B&gt;, B&gt;</code>，或者说，这是一个从B的子类到B对象的映射，这可能使得ClassToInstanceMap的泛型轻度混乱，但是只要记住B总是Map的上层绑定类型，通常来说B只是一个对象。</p>
<p>guava提供了有用的实现， MutableClassToInstanceMap 和 ImmutableClassToInstanceMap.</p>
<p>重点：像其他的<code>Map&lt;Class,Object&gt;</code>,ClassToInstanceMap含有的原生类型的项目，一个原生类型和他的相应的包装类可以映射到不同的值；</p>
<p>我们来看一个小的例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ClassToInstanceMapTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ClassToInstanceMap&lt;String&gt; classToInstanceMapString = MutableClassToInstanceMap.create();</span><br><span class="line">    ClassToInstanceMap&lt;Person&gt; classToInstanceMap = MutableClassToInstanceMap.create();</span><br><span class="line">    Person person = <span class="keyword">new</span> Person(<span class="string">"peida"</span>, <span class="number">20</span>);</span><br><span class="line">    System.out.println(<span class="string">"person name :"</span> + person.name + <span class="string">" age:"</span> + person.age);</span><br><span class="line">    classToInstanceMapString.put(String.class, "peida");</span><br><span class="line">    System.out.println(<span class="string">"string:"</span> + classToInstanceMapString.getInstance(String<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line"></span><br><span class="line">    classToInstanceMap.putInstance(Person<span class="class">.<span class="keyword">class</span>, <span class="title">person</span>)</span>;</span><br><span class="line">    Person person1 = classToInstanceMap.getInstance(Person<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    System.out.println(<span class="string">"person1 name :"</span> + person1.name + <span class="string">" age:"</span> + person1.age);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">person name :peida age:20</span><br><span class="line">string:peida</span><br><span class="line">person1 name :peida age:20</span><br></pre></td></tr></table></figure>

<h3 id="RangeSet"><a href="#RangeSet" class="headerlink" title="RangeSet"></a>RangeSet</h3><p>RangeSet用来处理一系列不连续，非空的range。当添加一个range到一个RangeSet之后，任何有连续的range将被自动合并，而空的range将被自动去除。例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RangeSetTest</span><span class="params">()</span></span>&#123;</span><br><span class="line">    RangeSet&lt;Integer&gt; rangeSet = TreeRangeSet.create();</span><br><span class="line">    rangeSet.add(Range.closed(<span class="number">1</span>, <span class="number">10</span>));</span><br><span class="line">    System.out.println(<span class="string">"rangeSet:"</span>+rangeSet);</span><br><span class="line">    rangeSet.add(Range.closedOpen(<span class="number">11</span>, <span class="number">15</span>));</span><br><span class="line">    System.out.println(<span class="string">"rangeSet:"</span>+rangeSet);</span><br><span class="line">    rangeSet.add(Range.open(<span class="number">15</span>, <span class="number">20</span>));</span><br><span class="line">    System.out.println(<span class="string">"rangeSet:"</span>+rangeSet);</span><br><span class="line">    rangeSet.add(Range.openClosed(<span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line">    System.out.println(<span class="string">"rangeSet:"</span>+rangeSet);</span><br><span class="line">    rangeSet.remove(Range.open(<span class="number">5</span>, <span class="number">10</span>));</span><br><span class="line">    System.out.println(<span class="string">"rangeSet:"</span>+rangeSet);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rangeSet:[[1..10]]</span><br><span class="line">rangeSet:[[1..10], [11..15)]</span><br><span class="line">rangeSet:[[1..10], [11..15), (15..20)]</span><br><span class="line">rangeSet:[[1..10], [11..15), (15..20)]</span><br><span class="line">rangeSet:[[1..5], [10..10], [11..15), (15..20)]</span><br></pre></td></tr></table></figure>

<p>注意，像合并Range.closed(1, 10)和Range.closedOpen(11, 15)这样的情况，我们必须先用调用Range.canonical(DiscreteDomain)传入DiscreteDomain.integers()处理一下。</p>
<p>RangeSet的实现支持了十分丰富的视图，包括：</p>
<ul>
<li>complement():是个辅助的RangeSet，它本身就是一个RangeSet，因为它包含了非连续，非空的range。</li>
<li>subRangeSet(Range<code>&lt;C&gt;</code>): 返回的是一个交集的视图。</li>
<li>asRanges():返回可以被迭代的Set&lt;Range<code>&lt;C&gt;</code>&gt;的视图。</li>
<li>asSet(DiscreteDomain<code>&lt;C&gt;</code>) (ImmutableRangeSet only):返回一个ImmutableSortedSet<code>&lt;C&gt;</code>类型的视图,里面的元素是range里面的元素，而不是range本身。（如果DiscreteDomain和RangeSet的上限或下限是无限的话，这个操作就不能支持）</li>
</ul>
<p>除了支持各种视图，RangeSet还支持各种直接的查询操作，其中最重要的是：</p>
<ul>
<li>contains(C):这是RangeSet最基本的操作，它能查询给定的元素是否在RangeSet里。</li>
<li>rangeContaining(C): 返回包含给定的元素的Range，如果不存在就返回null。</li>
<li>encloses(Range<code>&lt;C&gt;</code>): 用来判断给定的Range是否包含在RangeSet里面。</li>
<li>span():返回一个包含在这个RangeSet的所有Range的并集。</li>
</ul>
<h3 id="RangeMap"><a href="#RangeMap" class="headerlink" title="RangeMap"></a>RangeMap</h3><p>RangeMap代表了非连续非空的range对应的集合。不像RangeSet，RangeMap不会合并相邻的映射，甚至相邻的range对应的是相同的值。例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RangeMapTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    RangeMap&lt;Integer, String&gt; rangeMap = TreeRangeMap.create();</span><br><span class="line">    rangeMap.put(Range.closed(<span class="number">1</span>, <span class="number">10</span>), <span class="string">"foo"</span>);</span><br><span class="line">    System.out.println(<span class="string">"rangeMap:"</span> + rangeMap);</span><br><span class="line">    rangeMap.put(Range.open(<span class="number">3</span>, <span class="number">6</span>), <span class="string">"bar"</span>);</span><br><span class="line">    System.out.println(<span class="string">"rangeMap:"</span> + rangeMap);</span><br><span class="line">    rangeMap.put(Range.open(<span class="number">10</span>, <span class="number">20</span>), <span class="string">"foo"</span>);</span><br><span class="line">    System.out.println(<span class="string">"rangeMap:"</span> + rangeMap);</span><br><span class="line">    rangeMap.remove(Range.closed(<span class="number">5</span>, <span class="number">11</span>));</span><br><span class="line">    System.out.println(<span class="string">"rangeMap:"</span> + rangeMap);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rangeMap:[[1..10]&#x3D;foo]</span><br><span class="line">rangeMap:[[1..3]&#x3D;foo, (3..6)&#x3D;bar, [6..10]&#x3D;foo]</span><br><span class="line">rangeMap:[[1..3]&#x3D;foo, (3..6)&#x3D;bar, [6..10]&#x3D;foo, (10..20)&#x3D;foo]</span><br><span class="line">rangeMap:[[1..3]&#x3D;foo, (3..5)&#x3D;bar, (11..20)&#x3D;foo]</span><br></pre></td></tr></table></figure>

<p>RangeMap提供了两种视图：<br>1.asMapOfRanges():返回Map&lt;Range<code>&lt;K&gt;</code>, V&gt;类型的视图。这个操作可以被用作迭代操作。<br>2.subRangeMap(Range<code>&lt;K&gt;</code>)提供给定Range的交集。这个操作可以推广到传统的headMap, subMap, 和tailMap。</p>
<h2 id="Guava-cache"><a href="#Guava-cache" class="headerlink" title="Guava cache"></a>Guava cache</h2><p>缓存，在我们日常开发中是必不可少的一种解决性能问题的方法。简单的说，cache就是为了提升系统性能而开辟的一块内存空间。</p>
<p>缓存的主要作用是<strong>暂时在内存中保存业务系统的数据处理结果，并且等待下次访问使用。</strong>在日常开发的很多场合，由于受限于硬盘IO的性能或者我们自身业务系统的数据处理和获取可能非常费时，当我们发现我们的系统这个数据请求量很大的时候，频繁的IO和频繁的逻辑处理会导致硬盘和CPU资源的瓶颈出现。缓存的作用就是将这些来自不易的数据保存在内存中，当有其他线程或者客户端需要查询相同的数据资源时，直接从缓存的内存块中返回数据，这样不但可以提高系统的响应时间，同时也可以节省对这些数据的处理流程的资源消耗，整体上来说，系统性能会有大大的提升。</p>
<p>缓存在很多系统和架构中都用广泛的应用,例如：<br>1.CPU缓存<br>2.操作系统缓存<br>3.本地缓存<br>4.分布式缓存<br>5.HTTP缓存<br>6.数据库缓存<br>等等，可以说在计算机和网络领域，缓存无处不在。可以这么说，只要有硬件性能不对等，涉及到网络传输的地方都会有缓存的身影。</p>
<p>Guava Cache是一个全内存的本地缓存实现，它提供了线程安全的实现机制。整体上来说Guava cache 是本地缓存的不二之选，简单易用，性能好。</p>
<p><strong>Guava Cache有两种创建方式：</strong></p>
<ol>
<li>cacheLoader</li>
<li>callable</li>
</ol>
<p>通过这两种方法创建的cache，和通常用map来缓存的做法比，不同在于，这两种方法都实现了一种逻辑——从缓存中取key X的值，如果该值已经缓存过了，则返回缓存中的值，如果没有缓存过，可以通过某个方法来获取这个值。但不同的在于cacheloader的定义比较宽泛，是针对整个cache定义的，可以认为是统一的根据key值load value的方法。而callable的方式较为灵活，允许你在get的时候指定。</p>
<p>cacheLoader方式实现实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">TestLoadingCache</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    LoadingCache&lt;String,String&gt; cahceBuilder= CacheBuilder</span><br><span class="line">            .newBuilder()</span><br><span class="line">            .build(<span class="keyword">new</span> CacheLoader&lt;String, String&gt;()&#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> String <span class="title">load</span><span class="params">(String key)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                    String strProValue=<span class="string">"hello "</span>+key+<span class="string">"!"</span>;</span><br><span class="line">                    <span class="keyword">return</span> strProValue;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">"jerry value:"</span>+cahceBuilder.apply(<span class="string">"jerry"</span>));</span><br><span class="line">    System.out.println(<span class="string">"jerry value:"</span>+cahceBuilder.get(<span class="string">"jerry"</span>));</span><br><span class="line">    System.out.println(<span class="string">"peida value:"</span>+cahceBuilder.get(<span class="string">"peida"</span>));</span><br><span class="line">    System.out.println(<span class="string">"peida value:"</span>+cahceBuilder.apply(<span class="string">"peida"</span>));</span><br><span class="line">    System.out.println(<span class="string">"lisa value:"</span>+cahceBuilder.apply(<span class="string">"lisa"</span>));</span><br><span class="line">    cahceBuilder.put(<span class="string">"harry"</span>, <span class="string">"ssdded"</span>);</span><br><span class="line">    System.out.println(<span class="string">"harry value:"</span>+cahceBuilder.get(<span class="string">"harry"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">jerry value:hello jerry!</span><br><span class="line">jerry value:hello jerry!</span><br><span class="line">peida value:hello peida!</span><br><span class="line">peida value:hello peida!</span><br><span class="line">lisa value:hello lisa!</span><br><span class="line">harry value:ssdded</span><br></pre></td></tr></table></figure>


<p>callback的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testcallableCache</span><span class="params">()</span><span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    Cache&lt;String, String&gt; cache = CacheBuilder.newBuilder().maximumSize(<span class="number">1000</span>).build();  </span><br><span class="line">    String resultVal = cache.get(<span class="string">"jerry"</span>, <span class="keyword">new</span> Callable&lt;String&gt;() &#123;  </span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">            String strProValue=<span class="string">"hello "</span>+<span class="string">"jerry"</span>+<span class="string">"!"</span>;                </span><br><span class="line">            <span class="keyword">return</span> strProValue;</span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;);  </span><br><span class="line">    System.out.println(<span class="string">"jerry value : "</span> + resultVal);</span><br><span class="line">    </span><br><span class="line">    resultVal = cache.get(<span class="string">"peida"</span>, <span class="keyword">new</span> Callable&lt;String&gt;() &#123;  </span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">            String strProValue=<span class="string">"hello "</span>+<span class="string">"peida"</span>+<span class="string">"!"</span>;                </span><br><span class="line">            <span class="keyword">return</span> strProValue;</span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;);  </span><br><span class="line">    System.out.println(<span class="string">"peida value : "</span> + resultVal);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jerry value : hello jerry!</span><br><span class="line">peida value : hello peida!</span><br></pre></td></tr></table></figure>

<p>cache的参数说明：</p>
<p><strong>回收的参数：</strong></p>
<ol>
<li>大小的设置：CacheBuilder.maximumSize(long)  CacheBuilder.weigher(Weigher)  CacheBuilder.maxumumWeigher(long)</li>
<li>时间：expireAfterAccess(long, TimeUnit) expireAfterWrite(long, TimeUnit)</li>
<li>引用：CacheBuilder.weakKeys() CacheBuilder.weakValues()  CacheBuilder.softValues()</li>
<li>明确的删除：invalidate(key)  invalidateAll(keys)  invalidateAll()</li>
<li>删除监听器：CacheBuilder.removalListener(RemovalListener)
　　</li>
</ol>
<p><strong>refresh机制：</strong></p>
<ol>
<li>LoadingCache.refresh(K)  在生成新的value的时候，旧的value依然会被使用。</li>
<li>CacheLoader.reload(K, V) 生成新的value过程中允许使用旧的value</li>
<li>CacheBuilder.refreshAfterWrite(long, TimeUnit) 自动刷新cache</li>
</ol>
<p>基于泛型的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 通过key获取value</span></span><br><span class="line"><span class="comment"> * 调用方式 commonCache.get(key) ; return String</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span>  LoadingCache&lt;String , String&gt; <span class="title">commonCache</span><span class="params">(<span class="keyword">final</span> String key)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    LoadingCache&lt;String , String&gt; commonCache= cached(<span class="keyword">new</span> CacheLoader&lt;String , String&gt;()&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">load</span><span class="params">(String key)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"hello "</span>+key+<span class="string">"!"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> commonCache;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCache</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    LoadingCache&lt;String , String&gt; commonCache=commonCache(<span class="string">"peida"</span>);</span><br><span class="line">    System.out.println(<span class="string">"peida:"</span>+commonCache.get(<span class="string">"peida"</span>));</span><br><span class="line">    commonCache.apply(<span class="string">"harry"</span>);</span><br><span class="line">    System.out.println(<span class="string">"harry:"</span>+commonCache.get(<span class="string">"harry"</span>));</span><br><span class="line">    commonCache.apply(<span class="string">"lisa"</span>);</span><br><span class="line">    System.out.println(<span class="string">"lisa:"</span>+commonCache.get(<span class="string">"lisa"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">peida:hello peida!</span><br><span class="line">harry:hello harry!</span><br><span class="line">peida被移除</span><br><span class="line">lisa:hello lisa!</span><br></pre></td></tr></table></figure>

<p>基于泛型的Callable Cache实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Cache&lt;String, String&gt; cacheFormCallable = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 对需要延迟处理的可以采用这个机制；(泛型的方式封装)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;K,V&gt; <span class="function">Cache&lt;K , V&gt; <span class="title">callableCached</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Cache&lt;K, V&gt; cache = CacheBuilder</span><br><span class="line">            .newBuilder()</span><br><span class="line">            .maximumSize(<span class="number">10000</span>)</span><br><span class="line">            .expireAfterWrite(<span class="number">10</span>, TimeUnit.MINUTES)</span><br><span class="line">            .build();</span><br><span class="line">    <span class="keyword">return</span> cache;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getCallableCache</span><span class="params">(<span class="keyword">final</span> String userName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//Callable只有在缓存值不存在时，才会调用</span></span><br><span class="line">        <span class="keyword">return</span> cacheFormCallable.get(userName, <span class="keyword">new</span> Callable&lt;String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                System.out.println(userName+<span class="string">" from db"</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"hello "</span>+userName+<span class="string">"!"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCallableCache</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String u1name = <span class="string">"peida"</span>;</span><br><span class="line">    <span class="keyword">final</span> String u2name = <span class="string">"jerry"</span>;</span><br><span class="line">    <span class="keyword">final</span> String u3name = <span class="string">"lisa"</span>;</span><br><span class="line">    cacheFormCallable=callableCached();</span><br><span class="line">    System.out.println(<span class="string">"peida:"</span>+getCallableCache(u1name));</span><br><span class="line">    System.out.println(<span class="string">"jerry:"</span>+getCallableCache(u2name));</span><br><span class="line">    System.out.println(<span class="string">"lisa:"</span>+getCallableCache(u3name));</span><br><span class="line">    System.out.println(<span class="string">"peida:"</span>+getCallableCache(u1name));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">peida from db</span><br><span class="line">peida:hello peida!</span><br><span class="line">jerry from db</span><br><span class="line">jerry:hello jerry!</span><br><span class="line">lisa from db</span><br><span class="line">lisa:hello lisa!</span><br><span class="line">peida:hello peida!</span><br></pre></td></tr></table></figure>
<p>说明：Callable只有在缓存值不存在时，才会调用，比如第二次调用getCallableCache(u1name)直接返回缓存中的值</p>
<p>guava Cache数据移除：<br>guava做cache时候数据的移除方式，在guava中数据的移除分为<strong>被动移除和主动移除</strong>两种。</p>
<p>被动移除数据的方式，guava默认提供了三种方式：<br><strong>1.基于大小的移除</strong>:看字面意思就知道就是按照缓存的大小来移除，如果即将到达指定的大小，那就会把不常用的键值对从cache中移除。<br>定义的方式一般为 CacheBuilder.maximumSize(long)，还有一种一种可以算权重的方法，个人认为实际使用中不太用到。就这个常用的来看有几个注意点:<br>其一，这个size指的是cache中的条目数，不是内存大小或是其他；<br>其二，并不是完全到了指定的size系统才开始移除不常用的数据的，而是接近这个size的时候系统就会开始做移除的动作；<br>其三，如果一个键值对已经从缓存中被移除了，你再次请求访问的时候，如果cachebuild是使用cacheloader方式的，那依然还是会从cacheloader中再取一次值，如果这样还没有，就会抛出异常<br>　　　　<br><strong>2.基于时间的移除</strong>：guava提供了两个基于时间移除的方法<br>expireAfterAccess(long, TimeUnit):这个方法是根据某个键值对最后一次访问之后多少时间后移除<br>expireAfterWrite(long, TimeUnit):这个方法是根据某个键值对被创建或值被替换后多少时间移除</p>
<p>3.基于引用的移除：<br>这种移除方式主要是基于java的垃圾回收机制，根据键或者值的引用关系决定移除<br>主动移除数据方式，主动移除有三种方法：</p>
<ul>
<li>单独移除用 Cache.invalidate(key)</li>
<li>批量移除用 Cache.invalidateAll(keys)</li>
<li>移除所有用 Cache.invalidateAll()</li>
</ul>
<p>如果需要在移除数据的时候有所动作还可以定义Removal Listener，但是有点需要注意的是默认Removal Listener中的行为是和移除动作同步执行的，如果需要改成异步形式，可以考虑使用RemovalListeners.asynchronous(RemovalListener, Executor)</p>
<h2 id="EventBus-观察者模式实现"><a href="#EventBus-观察者模式实现" class="headerlink" title="EventBus:观察者模式实现"></a>EventBus:观察者模式实现</h2><h3 id="EventBus介绍"><a href="#EventBus介绍" class="headerlink" title="EventBus介绍"></a>EventBus介绍</h3><p>EventBus是Guava的事件处理机制，是设计模式中的观察者模式（生产/消费者编程模型）的优雅实现。对于事件监听和发布订阅模式，EventBus是一个非常优雅和简单解决方案，我们不用创建复杂的类和接口层次结构。</p>
<p>Observer模式是比较常用的设计模式之一，虽然有时候在具体代码里，它不一定叫这个名字，比如改头换面叫个Listener，但模式就是这个模式。手工实现一个Observer也不是多复杂的一件事，只是因为这个设计模式实在太常用了，Java就把它放到了JDK里面：Observable和Observer，从JDK 1.0里，它们就一直在那里。从某种程度上说，它简化了Observer模式的开发，至少我们不用再手工维护自己的Observer列表了。不过，如前所述，JDK里的Observer从1.0就在那里了，直到Java 7，它都没有什么改变，就连通知的参数还是Object类型。要知道，Java 5就已经泛型了。Java 5是一次大规模的语法调整，许多程序库从那开始重新设计了API，使其更简洁易用。当然，那些不做应对的程序库，多半也就过时了。这也就是这里要讨论知识更新的原因所在。今天，对于普通的应用，如果要使用Observer模式该如何做呢？答案是Guava的EventBus。</p>
<h3 id="EventBus基本用法"><a href="#EventBus基本用法" class="headerlink" title="EventBus基本用法"></a>EventBus基本用法</h3><p>使用Guava之后, 如果要订阅消息, 就不用再继承指定的接口, 只需要在指定的方法上加上@Subscribe注解即可。代码如下：</p>
<p>消息封装类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestEvent</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> message;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TestEvent</span><span class="params">(<span class="keyword">int</span> message)</span> </span>&#123;        </span><br><span class="line">        <span class="keyword">this</span>.message = message;</span><br><span class="line">        System.out.println(<span class="string">"event message:"</span>+message);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>消息接受类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EventListener</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> lastMessage = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Subscribe</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">(TestEvent event)</span> </span>&#123;</span><br><span class="line">        lastMessage = event.getMessage();</span><br><span class="line">        System.out.println(<span class="string">"Message:"</span>+lastMessage);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getLastMessage</span><span class="params">()</span> </span>&#123;      </span><br><span class="line">        <span class="keyword">return</span> lastMessage;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestEventBus</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testReceiveEvent</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        EventBus eventBus = <span class="keyword">new</span> EventBus(<span class="string">"test"</span>);</span><br><span class="line">        EventListener listener = <span class="keyword">new</span> EventListener();</span><br><span class="line"></span><br><span class="line">        eventBus.register(listener);</span><br><span class="line"></span><br><span class="line">        eventBus.post(<span class="keyword">new</span> TestEvent(<span class="number">200</span>));</span><br><span class="line">        eventBus.post(<span class="keyword">new</span> TestEvent(<span class="number">300</span>));</span><br><span class="line">        eventBus.post(<span class="keyword">new</span> TestEvent(<span class="number">400</span>));</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"LastMessage:"</span>+listener.getLastMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">event message:200</span><br><span class="line">Message:200</span><br><span class="line">event message:300</span><br><span class="line">Message:300</span><br><span class="line">event message:400</span><br><span class="line">Message:400</span><br><span class="line">LastMessage:400</span><br></pre></td></tr></table></figure>

<h3 id="MultiListener的使用："><a href="#MultiListener的使用：" class="headerlink" title="MultiListener的使用："></a>MultiListener的使用：</h3><p>只需要在要订阅消息的方法上加上@Subscribe注解即可实现对多个消息的订阅，代码如下：</p>
<p>消息接受类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MultipleListener</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> Integer lastInteger;  </span><br><span class="line">    <span class="keyword">public</span> Long lastLong;  </span><br><span class="line">   </span><br><span class="line">    <span class="meta">@Subscribe</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listenInteger</span><span class="params">(Integer event)</span> </span>&#123;  </span><br><span class="line">        lastInteger = event; </span><br><span class="line">        System.out.println(<span class="string">"event Integer:"</span>+lastInteger);</span><br><span class="line">    &#125;  </span><br><span class="line">   </span><br><span class="line">    <span class="meta">@Subscribe</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listenLong</span><span class="params">(Long event)</span> </span>&#123;  </span><br><span class="line">        lastLong = event; </span><br><span class="line">        System.out.println(<span class="string">"event Long:"</span>+lastLong);</span><br><span class="line">    &#125;  </span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getLastInteger</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> lastInteger;  </span><br><span class="line">    &#125;  </span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getLastLong</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> lastLong;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MultipleListener</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> Integer lastInteger;  </span><br><span class="line">    <span class="keyword">public</span> Long lastLong;  </span><br><span class="line">   </span><br><span class="line">    <span class="meta">@Subscribe</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listenInteger</span><span class="params">(Integer event)</span> </span>&#123;  </span><br><span class="line">        lastInteger = event; </span><br><span class="line">        System.out.println(<span class="string">"event Integer:"</span>+lastInteger);</span><br><span class="line">    &#125;  </span><br><span class="line">   </span><br><span class="line">    <span class="meta">@Subscribe</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listenLong</span><span class="params">(Long event)</span> </span>&#123;  </span><br><span class="line">        lastLong = event; </span><br><span class="line">        System.out.println(<span class="string">"event Long:"</span>+lastLong);</span><br><span class="line">    &#125;  </span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getLastInteger</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> lastInteger;  </span><br><span class="line">    &#125;  </span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getLastLong</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> lastLong;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">event Integer:100</span><br><span class="line">event Integer:200</span><br><span class="line">event Integer:300</span><br><span class="line">event Long:800</span><br><span class="line">event Long:800990</span><br><span class="line">event Long:800882934</span><br><span class="line">LastInteger:300</span><br><span class="line">LastLong:800882934</span><br></pre></td></tr></table></figure>
<h3 id="Dead-Event"><a href="#Dead-Event" class="headerlink" title="Dead Event"></a>Dead Event</h3><p>如果EventBus发送的消息都不是订阅者关心的称之为Dead Event。实例如下：</p>
<p>消息接受类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeadEventListener</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> notDelivered = <span class="keyword">false</span>;  </span><br><span class="line">       </span><br><span class="line">    <span class="meta">@Subscribe</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">(DeadEvent event)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"DeadEventListener ..."</span>);</span><br><span class="line">        notDelivered = <span class="keyword">true</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isNotDelivered</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> notDelivered;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestDeadEventListeners</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDeadEventListeners</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;  </span><br><span class="line">       </span><br><span class="line">        EventBus eventBus = <span class="keyword">new</span> EventBus(<span class="string">"test"</span>);</span><br><span class="line">        DeadEventListener deadEventListener = <span class="keyword">new</span> DeadEventListener();  </span><br><span class="line">        eventBus.register(deadEventListener);  </span><br><span class="line"></span><br><span class="line">        eventBus.post(<span class="keyword">new</span> TestEvent(<span class="number">200</span>));         </span><br><span class="line">        eventBus.post(<span class="keyword">new</span> TestEvent(<span class="number">300</span>));        </span><br><span class="line">       </span><br><span class="line">        System.out.println(<span class="string">"deadEvent:"</span>+deadEventListener.isNotDelivered());</span><br><span class="line"></span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">event message:200</span><br><span class="line">DeadEventListener ...</span><br><span class="line">event message:300</span><br><span class="line">DeadEventListener ...</span><br><span class="line">deadEvent:true</span><br></pre></td></tr></table></figure>


<p>说明：如果没有消息订阅者监听消息， EventBus将发送DeadEvent消息，这时我们可以通过log的方式来记录这种状态。</p>
<h3 id="Event的继承"><a href="#Event的继承" class="headerlink" title="Event的继承"></a>Event的继承</h3><p>如果Listener A监听Event A, 而Event A有一个子类Event B, 此时Listener A将同时接收Event A和B消息，实例如下：</p>
<p>Listener类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NumberListener</span> </span>&#123;</span><br><span class="line">       </span><br><span class="line">    <span class="keyword">private</span> Number lastMessage;  </span><br><span class="line">   </span><br><span class="line">    <span class="meta">@Subscribe</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">(Number integer)</span> </span>&#123;  </span><br><span class="line">        lastMessage = integer; </span><br><span class="line">        System.out.println(<span class="string">"Message:"</span>+lastMessage);</span><br><span class="line">    &#125;  </span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Number <span class="title">getLastMessage</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> lastMessage;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IntegerListener</span> </span>&#123;</span><br><span class="line">       </span><br><span class="line">    <span class="keyword">private</span> Integer lastMessage;  </span><br><span class="line">   </span><br><span class="line">    <span class="meta">@Subscribe</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">(Integer integer)</span> </span>&#123;  </span><br><span class="line">        lastMessage = integer; </span><br><span class="line">        System.out.println(<span class="string">"Message:"</span>+lastMessage);</span><br><span class="line">    &#125;  </span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getLastMessage</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> lastMessage;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>测试类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestEventsFromSubclass</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testEventsFromSubclass</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;  </span><br><span class="line">       </span><br><span class="line">        EventBus eventBus = <span class="keyword">new</span> EventBus(<span class="string">"test"</span>);  </span><br><span class="line">        IntegerListener integerListener = <span class="keyword">new</span> IntegerListener();  </span><br><span class="line">        NumberListener numberListener = <span class="keyword">new</span> NumberListener();  </span><br><span class="line">        eventBus.register(integerListener);  </span><br><span class="line">        eventBus.register(numberListener);  </span><br><span class="line">       </span><br><span class="line">        eventBus.post(<span class="keyword">new</span> Integer(<span class="number">100</span>));  </span><br><span class="line">       </span><br><span class="line">        System.out.println(<span class="string">"integerListener message:"</span>+integerListener.getLastMessage());</span><br><span class="line">        System.out.println(<span class="string">"numberListener message:"</span>+numberListener.getLastMessage());</span><br><span class="line">              </span><br><span class="line">        eventBus.post(<span class="keyword">new</span> Long(<span class="number">200L</span>));  </span><br><span class="line">       </span><br><span class="line">        System.out.println(<span class="string">"integerListener message:"</span>+integerListener.getLastMessage());</span><br><span class="line">        System.out.println(<span class="string">"numberListener message:"</span>+numberListener.getLastMessage());        </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Message:100</span><br><span class="line">Message:100</span><br><span class="line">integerListener message:100</span><br><span class="line">numberListener message:100</span><br><span class="line">Message:200</span><br><span class="line">integerListener message:100</span><br><span class="line">numberListener message:200</span><br></pre></td></tr></table></figure>

<p>说明：在这个方法中,我们看到第一个事件(新的整数(100))是收到两个听众,但第二个(新长(200 l))只能到达NumberListener作为整数一不是创建这种类型的事件。可以使用此功能来创建更通用的监听器监听一个广泛的事件和更详细的具体的特殊的事件。</p>
<p>综合实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Socket connection;</span><br><span class="line">    <span class="keyword">private</span> EventBus channel;</span><br><span class="line">    <span class="keyword">private</span> BufferedReader in;</span><br><span class="line">    <span class="keyword">private</span> PrintWriter out;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserThread</span><span class="params">(Socket connection, EventBus channel)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.connection = connection;</span><br><span class="line">        <span class="keyword">this</span>.channel = channel;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            in = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(connection.getInputStream()));</span><br><span class="line">            out = <span class="keyword">new</span> PrintWriter(connection.getOutputStream(), <span class="keyword">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            System.exit(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Subscribe</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recieveMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (out != <span class="keyword">null</span>) &#123;</span><br><span class="line">            out.println(message);</span><br><span class="line">            System.out.println(<span class="string">"recieveMessage:"</span>+message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String input;</span><br><span class="line">            <span class="keyword">while</span> ((input = in.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                channel.post(input);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//reached eof</span></span><br><span class="line">        channel.unregister(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        in = <span class="keyword">null</span>;</span><br><span class="line">        out = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EventBusChat</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        EventBus channel = <span class="keyword">new</span> EventBus();</span><br><span class="line">        ServerSocket socket;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            socket = <span class="keyword">new</span> ServerSocket(<span class="number">4444</span>);</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                Socket connection = socket.accept();</span><br><span class="line">                UserThread newUser = <span class="keyword">new</span> UserThread(connection, channel);</span><br><span class="line">                channel.register(newUser);</span><br><span class="line">                newUser.start();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Range"><a href="#Range" class="headerlink" title="Range"></a>Range</h2><p>在Guava中新增了一个新的类型Range，从名字就可以了解到，这个是和区间有关的数据结构。从Google官方文档可以得到定义：Range定义了连续跨度的范围边界，这个连续跨度是一个可以比较的类型(Comparable type)。比如1到100之间的整型数据。</p>
<p>在数学里面的范围是有边界和无边界之分的；同样，在Guava中也有这个说法。如果这个范围是有边界的，那么这个范围又可以分为包括开集（不包括端点）和闭集（包括端点）；如果是无解的可以用+∞表示。如果枚举的话，一共有九种范围表示：</p>
<p><img src="http://img.bcoder.top/2018.03.10/5.png" alt="Google Guava:java扩展类库(下)"></p>
<p>上表中的guava对应功能方法那一栏表示Range类提供的方法，分别来表示九种可能出现的范围区间。如果区间两边都存在范围，在这种情况下，区间右边的数不可能比区间左边的数小。在极端情况下，区间两边的数是相等的，但前提条件是最少有一个边界是闭集的，否则是不成立的。比如：</p>
<p>[a..a] : 里面只有一个数a；<br>[a..a); (a..a] : 空的区间范围，但是是有效的；<br>(a..a) : 这种情况是无效的，构造这样的Range将会抛出异常。</p>
<p>在使用Range时需要注意：在构造区间时，尽量使用不可改变的类型。如果你需要使用可变的类型，在区间类型构造完成的情况下，请不要改变区间两边的数。</p>
<p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testRange</span><span class="params">()</span></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"open:"</span>+ Range.open(<span class="number">1</span>, <span class="number">10</span>));</span><br><span class="line">    System.out.println(<span class="string">"closed:"</span>+ Range.closed(<span class="number">1</span>, <span class="number">10</span>));</span><br><span class="line">    System.out.println(<span class="string">"closedOpen:"</span>+ Range.closedOpen(<span class="number">1</span>, <span class="number">10</span>));</span><br><span class="line">    System.out.println(<span class="string">"openClosed:"</span>+ Range.openClosed(<span class="number">1</span>, <span class="number">10</span>));    </span><br><span class="line">    System.out.println(<span class="string">"greaterThan:"</span>+ Range.greaterThan(<span class="number">10</span>));</span><br><span class="line">    System.out.println(<span class="string">"atLeast:"</span>+ Range.atLeast(<span class="number">10</span>));</span><br><span class="line">    System.out.println(<span class="string">"lessThan:"</span>+ Range.lessThan(<span class="number">10</span>));</span><br><span class="line">    System.out.println(<span class="string">"atMost:"</span>+ Range.atMost(<span class="number">10</span>));</span><br><span class="line">    System.out.println(<span class="string">"all:"</span>+ Range.all());</span><br><span class="line">    System.out.println(<span class="string">"closed:"</span>+Range.closed(<span class="number">10</span>, <span class="number">10</span>));</span><br><span class="line">    System.out.println(<span class="string">"closedOpen:"</span>+Range.closedOpen(<span class="number">10</span>, <span class="number">10</span>));</span><br><span class="line">    <span class="comment">//会抛出异常</span></span><br><span class="line">    System.out.println(<span class="string">"open:"</span>+Range.open(<span class="number">10</span>, <span class="number">10</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">open:(1..10)</span><br><span class="line">closed:[1..10]</span><br><span class="line">closedOpen:[1..10)</span><br><span class="line">openClosed:(1..10]</span><br><span class="line">greaterThan:(10..+∞)</span><br><span class="line">atLeast:[10..+∞)</span><br><span class="line">lessThan:(-∞..10)</span><br><span class="line">atMost:(-∞..10]</span><br><span class="line">all:(-∞..+∞)</span><br><span class="line">closed:[10..10]</span><br><span class="line">closedOpen:[10..10)</span><br><span class="line"></span><br><span class="line">java.lang.IllegalArgumentException: Invalid range:</span><br><span class="line">	at com.google.common.collect.Range.&lt;init&gt;(Range.java:363)</span><br><span class="line">	at com.google.common.collect.Range.create(Range.java:153)</span><br><span class="line">	at com.google.common.collect.Range.open(Range.java:165)</span><br><span class="line">	at guava.TestBaseRange.testRange(TestBaseRange.java:22)</span><br></pre></td></tr></table></figure>

<p>此外,范围可以构造实例通过绑定类型显式,例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testRange</span><span class="params">()</span></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"downTo:"</span>+Range.downTo(<span class="number">4</span>, BoundType.OPEN));</span><br><span class="line">    System.out.println(<span class="string">"upTo:"</span>+Range.upTo(<span class="number">4</span>, BoundType.CLOSED));</span><br><span class="line">    System.out.println(<span class="string">"range:"</span>+Range.range(<span class="number">1</span>, BoundType.CLOSED, <span class="number">4</span>, BoundType.OPEN)); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">downTo:(4..+∞)</span><br><span class="line">upTo:(-∞..4]</span><br><span class="line">range:[1..4)</span><br></pre></td></tr></table></figure>

<h3 id="Range主要方法"><a href="#Range主要方法" class="headerlink" title="Range主要方法"></a>Range主要方法</h3><p>1.contains：判断值是否在当前Range内</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testContains</span><span class="params">()</span></span>&#123;</span><br><span class="line">    System.out.println(Range.closed(<span class="number">1</span>, <span class="number">3</span>).contains(<span class="number">2</span>)); </span><br><span class="line">    System.out.println(Range.closed(<span class="number">1</span>, <span class="number">3</span>).contains(<span class="number">4</span>)); </span><br><span class="line">    System.out.println(Range.lessThan(<span class="number">5</span>).contains(<span class="number">5</span>)); </span><br><span class="line">    System.out.println(Range.closed(<span class="number">1</span>, <span class="number">4</span>).containsAll(Ints.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>))); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">true</span><br><span class="line">false</span><br><span class="line">false</span><br><span class="line">true</span><br></pre></td></tr></table></figure>

<p>2.Endpoint相关查询方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQuery</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"hasLowerBound:"</span> + Range.closedOpen(<span class="number">4</span>, <span class="number">4</span>).hasLowerBound());</span><br><span class="line">    System.out.println(<span class="string">"hasUpperBound:"</span> + Range.closedOpen(<span class="number">4</span>, <span class="number">4</span>).hasUpperBound());</span><br><span class="line">    System.out.println(Range.closedOpen(<span class="number">4</span>, <span class="number">4</span>).isEmpty());</span><br><span class="line">    System.out.println(Range.openClosed(<span class="number">4</span>, <span class="number">4</span>).isEmpty());</span><br><span class="line">    System.out.println(Range.closed(<span class="number">4</span>, <span class="number">4</span>).isEmpty());</span><br><span class="line">    <span class="comment">// Range.open throws IllegalArgumentException</span></span><br><span class="line">    <span class="comment">//System.out.println(Range.open(4, 4).isEmpty());</span></span><br><span class="line"></span><br><span class="line">    System.out.println(Range.closed(<span class="number">3</span>, <span class="number">10</span>).lowerEndpoint());</span><br><span class="line">    System.out.println(Range.open(<span class="number">3</span>, <span class="number">10</span>).lowerEndpoint());</span><br><span class="line">    System.out.println(Range.closed(<span class="number">3</span>, <span class="number">10</span>).upperEndpoint());</span><br><span class="line">    System.out.println(Range.open(<span class="number">3</span>, <span class="number">10</span>).upperEndpoint());</span><br><span class="line">    System.out.println(Range.closed(<span class="number">3</span>, <span class="number">10</span>).lowerBoundType());</span><br><span class="line">    System.out.println(Range.open(<span class="number">3</span>, <span class="number">10</span>).upperBoundType());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">hasLowerBound:true</span><br><span class="line">hasUpperBound:true</span><br><span class="line">true</span><br><span class="line">true</span><br><span class="line">false</span><br><span class="line">3</span><br><span class="line">3</span><br><span class="line">10</span><br><span class="line">10</span><br><span class="line">CLOSED</span><br><span class="line">OPEN</span><br></pre></td></tr></table></figure>

<p>3.encloses方法：encloses(Range range)中的range是否包含在需要比较的range中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testEncloses</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Range&lt;Integer&gt; rangeBase=Range.open(<span class="number">1</span>, <span class="number">4</span>);</span><br><span class="line">    Range&lt;Integer&gt; rangeClose=Range.closed(<span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line">    Range&lt;Integer&gt; rangeCloseOpen=Range.closedOpen(<span class="number">2</span>, <span class="number">4</span>);</span><br><span class="line">    Range&lt;Integer&gt; rangeCloseOther=Range.closedOpen(<span class="number">2</span>, <span class="number">5</span>);</span><br><span class="line">    System.out.println(<span class="string">"rangeBase: "</span>+rangeBase+<span class="string">" Enclose:"</span>+rangeBase.encloses(rangeClose)+<span class="string">" rangeClose:"</span>+rangeClose);</span><br><span class="line">    System.out.println(<span class="string">"rangeBase: "</span>+rangeBase+<span class="string">" Enclose:"</span>+rangeBase.encloses(rangeCloseOpen)+<span class="string">" rangeClose:"</span>+rangeCloseOpen);</span><br><span class="line">    System.out.println(<span class="string">"rangeBase: "</span>+rangeBase+<span class="string">" Enclose:"</span>+rangeBase.encloses(rangeCloseOther)+<span class="string">" rangeClose:"</span>+rangeCloseOther);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rangeBase: (1..4) Enclose:true rangeClose:[2..3]</span><br><span class="line">rangeBase: (1..4) Enclose:true rangeClose:[2..4)</span><br><span class="line">rangeBase: (1..4) Enclose:false rangeClose:[2..5)</span><br></pre></td></tr></table></figure>

<p>4.isConnected：range是否可连接上</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testConnected</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    System.out.println(Range.closed(<span class="number">3</span>, <span class="number">5</span>).isConnected(Range.open(<span class="number">5</span>, <span class="number">10</span>)));</span><br><span class="line">    System.out.println(Range.closed(<span class="number">0</span>, <span class="number">9</span>).isConnected(Range.closed(<span class="number">3</span>, <span class="number">4</span>)));</span><br><span class="line">    System.out.println(Range.closed(<span class="number">0</span>, <span class="number">5</span>).isConnected(Range.closed(<span class="number">3</span>, <span class="number">9</span>)));</span><br><span class="line">    System.out.println(Range.open(<span class="number">3</span>, <span class="number">5</span>).isConnected(Range.open(<span class="number">5</span>, <span class="number">10</span>)));</span><br><span class="line">    System.out.println(Range.closed(<span class="number">1</span>, <span class="number">5</span>).isConnected(Range.closed(<span class="number">6</span>, <span class="number">10</span>)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">true</span><br><span class="line">true</span><br><span class="line">true</span><br><span class="line">false</span><br><span class="line">false</span><br></pre></td></tr></table></figure>

<p>4.intersection：如果两个range相连时，返回最大交集，如果不相连时，直接抛出异常</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testIntersection</span><span class="params">()</span></span>&#123;</span><br><span class="line">    System.out.println(Range.closed(<span class="number">3</span>, <span class="number">5</span>).intersection(Range.open(<span class="number">5</span>, <span class="number">10</span>))); </span><br><span class="line">    System.out.println(Range.closed(<span class="number">0</span>, <span class="number">9</span>).intersection(Range.closed(<span class="number">3</span>, <span class="number">4</span>))); </span><br><span class="line">    System.out.println(Range.closed(<span class="number">0</span>, <span class="number">5</span>).intersection(Range.closed(<span class="number">3</span>, <span class="number">9</span>))); </span><br><span class="line">    System.out.println(Range.open(<span class="number">3</span>, <span class="number">5</span>).intersection(Range.open(<span class="number">5</span>, <span class="number">10</span>)));</span><br><span class="line">    System.out.println(Range.closed(<span class="number">1</span>, <span class="number">5</span>).intersection(Range.closed(<span class="number">6</span>, <span class="number">10</span>)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(5..5]</span><br><span class="line">[3..4]</span><br><span class="line">[3..5]</span><br><span class="line"></span><br><span class="line">java.lang.IllegalArgumentException: Invalid range: (5..5)</span><br><span class="line">	at com.google.common.collect.Range.&lt;init&gt;(Range.java:363)</span><br><span class="line">	at com.google.common.collect.Range.create(Range.java:153)</span><br><span class="line">	at com.google.common.collect.Range.intersection(Range.java:567)</span><br></pre></td></tr></table></figure>

<p>5.span：获取两个range的并集，如果两个range是两连的，则是其最大range</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSpan</span><span class="params">()</span></span>&#123;</span><br><span class="line">    System.out.println(Range.closed(<span class="number">3</span>, <span class="number">5</span>).span(Range.open(<span class="number">5</span>, <span class="number">10</span>))); </span><br><span class="line">    System.out.println(Range.closed(<span class="number">0</span>, <span class="number">9</span>).span(Range.closed(<span class="number">3</span>, <span class="number">4</span>))); </span><br><span class="line">    System.out.println(Range.closed(<span class="number">0</span>, <span class="number">5</span>).span(Range.closed(<span class="number">3</span>, <span class="number">9</span>))); </span><br><span class="line">    System.out.println(Range.open(<span class="number">3</span>, <span class="number">5</span>).span(Range.open(<span class="number">5</span>, <span class="number">10</span>))); </span><br><span class="line">    System.out.println(Range.closed(<span class="number">1</span>, <span class="number">5</span>).span(Range.closed(<span class="number">6</span>, <span class="number">10</span>)));</span><br><span class="line">    System.out.println(Range.closed(<span class="number">1</span>, <span class="number">5</span>).span(Range.closed(<span class="number">7</span>, <span class="number">10</span>)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[3..10)</span><br><span class="line">[0..9]</span><br><span class="line">[0..9]</span><br><span class="line">(3..10)</span><br><span class="line">[1..10]</span><br><span class="line">[1..10]</span><br></pre></td></tr></table></figure>
          
            <br>
            
  
    
    

<section class="widget copyright  desktop mobile">
  <div class='content'>
    
      <blockquote>
        
          
            <p>博客内容遵循 署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</p>

          
        
          
            <p>本文永久链接是：<a href=https://www.bcoder.top/2018/03/10/Google-Guava-java%E6%89%A9%E5%B1%95%E7%B1%BB%E5%BA%93%EF%BC%88%E4%B8%8B%EF%BC%89/>https://www.bcoder.top/2018/03/10/Google-Guava-java%E6%89%A9%E5%B1%95%E7%B1%BB%E5%BA%93%EF%BC%88%E4%B8%8B%EF%BC%89/</a></p>
          
        
      </blockquote>
    
  </div>
</section>

  

  
    
    

<section class="widget qrcode  desktop mobile">
  

  <div class='content article-entry'>
    
      
        <div class='fancybox'><img src='https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/qrcode/wiki_volantis.png'
        
          height='64px'
        ></div>
      
    
      
        <div class='fancybox'><img src='https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/qrcode/wiki_volantis.png'
        
          height='64px'
        ></div>
      
    
  </div>
</section>

  


          
        </div>
        
          


  <section class='meta' id="footer-meta">
    <div class='new-meta-box'>
      
        
          <div class="new-meta-item date" itemprop="dateUpdated" datetime="2020-01-21T18:44:03+08:00">
  <a class='notlink'>
    <i class="fas fa-edit fa-fw" aria-hidden="true"></i>
    <p>更新于：2020-01-21 18:44:03</p>
  </a>
</div>

        
      
        
          
  
  <div class="new-meta-item meta-tags"><a class="tag" href="/tags/java/" rel="nofollow"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i><p>java</p></a></div> <div class="new-meta-item meta-tags"><a class="tag" href="/tags/Guava/" rel="nofollow"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i><p>Guava</p></a></div>


        
      
        
          

        
      
        
          
  <div class="new-meta-item share -mob-share-list">
  <div class="-mob-share-list share-body">
    
      
        <a class="-mob-share-qq" title="" rel="external nofollow noopener noreferrer"
          
          href="http://connect.qq.com/widget/shareqq/index.html?url=https://www.bcoder.top/2018/03/10/Google-Guava-java%E6%89%A9%E5%B1%95%E7%B1%BB%E5%BA%93%EF%BC%88%E4%B8%8B%EF%BC%89/&title=Google Guava:java扩展类库（下） - zln's blog&summary=
引言Guava 是一个 Google 的基于java1.6的类库集合的扩展项目。Guava工程包含了若干被Google的Java项目广泛依赖的核心库，例如：集合（collections）、缓存（caching） 、原生类型支持（primitives support）、并发库（concurrency libraries）、通用注解（common annotations）、字符串处理（string processing）、I/O 等等。 所有这些工具每天都在被Google的工程师应用在产品服务中。
"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/qq.png">
          
        </a>
      
    
      
        <a class="-mob-share-qzone" title="" rel="external nofollow noopener noreferrer"
          
          href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://www.bcoder.top/2018/03/10/Google-Guava-java%E6%89%A9%E5%B1%95%E7%B1%BB%E5%BA%93%EF%BC%88%E4%B8%8B%EF%BC%89/&title=Google Guava:java扩展类库（下） - zln's blog&summary=
引言Guava 是一个 Google 的基于java1.6的类库集合的扩展项目。Guava工程包含了若干被Google的Java项目广泛依赖的核心库，例如：集合（collections）、缓存（caching） 、原生类型支持（primitives support）、并发库（concurrency libraries）、通用注解（common annotations）、字符串处理（string processing）、I/O 等等。 所有这些工具每天都在被Google的工程师应用在产品服务中。
"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/qzone.png">
          
        </a>
      
    
      
        <a class="-mob-share-weibo" title="" rel="external nofollow noopener noreferrer"
          
          href="http://service.weibo.com/share/share.php?url=https://www.bcoder.top/2018/03/10/Google-Guava-java%E6%89%A9%E5%B1%95%E7%B1%BB%E5%BA%93%EF%BC%88%E4%B8%8B%EF%BC%89/&title=Google Guava:java扩展类库（下） - zln's blog&summary=
引言Guava 是一个 Google 的基于java1.6的类库集合的扩展项目。Guava工程包含了若干被Google的Java项目广泛依赖的核心库，例如：集合（collections）、缓存（caching） 、原生类型支持（primitives support）、并发库（concurrency libraries）、通用注解（common annotations）、字符串处理（string processing）、I/O 等等。 所有这些工具每天都在被Google的工程师应用在产品服务中。
"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/weibo.png">
          
        </a>
      
    
  </div>
</div>



        
      
    </div>
  </section>


        
        
          <div class="prev-next">
            
              <a class='prev' href='/2018/03/12/OpenDaylight%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0%EF%BC%9A%E5%BC%80%E5%8F%91RPC%E8%8E%B7%E5%8F%96%E5%85%A8%E7%BD%91%E6%8B%93%E6%89%91%E5%92%8C%E7%BD%91%E5%8D%A1%E4%BF%A1%E6%81%AF/'>
                <p class='title'><i class="fas fa-chevron-left" aria-hidden="true"></i>OpenDaylight开发笔记：开发RPC获取全网拓扑和网卡信息</p>
                <p class='content'>
引言SDN作为近些年比较新型的网络技术，已经被各大设备厂商运用到自己的产品中，其中OpenDaylight作为SDN主流的控制器，也受到了广泛的关注。本人从事OpenDaylight控制器相关...</p>
              </a>
            
            
              <a class='next' href='/2018/03/07/Google-Guava-java%E6%89%A9%E5%B1%95%E7%B1%BB%E5%BA%93%EF%BC%88%E4%B8%8A%EF%BC%89/'>
                <p class='title'>Google Guava:java扩展类库（上）<i class="fas fa-chevron-right" aria-hidden="true"></i></p>
                <p class='content'>
引言Guava 是一个 Google 的基于java1.6的类库集合的扩展项目。Guava工程包含了若干被Google的Java项目广泛依赖的核心库，例如：集合（collections）、缓存...</p>
              </a>
            
          </div>
        
      </section>
    </article>
  

  
    <!-- 显示推荐文章和评论 -->



  


  




<!-- 根据页面mathjax变量决定是否加载MathJax数学公式js -->



  <script>
    window.subData = {
      title: 'Google Guava:java扩展类库（下）',
      tools: true
    }
  </script>


</div>
<aside class='l_side'>
  
  

  
    
    


  <section class="widget toc-wrapper shadow desktop mobile">
    
  <header>
    
      <i class="fas fa-list fa-fw" aria-hidden="true"></i><span class='name'>本文目录</span>
    
  </header>


    <div class='content'>
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Guava新增集合类型"><span class="toc-text">Guava新增集合类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Multiset"><span class="toc-text">Multiset</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Multimap"><span class="toc-text">Multimap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Bimap"><span class="toc-text">Bimap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Table"><span class="toc-text">Table</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RangeSet"><span class="toc-text">RangeSet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RangeMap"><span class="toc-text">RangeMap</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Guava-cache"><span class="toc-text">Guava cache</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EventBus-观察者模式实现"><span class="toc-text">EventBus:观察者模式实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#EventBus介绍"><span class="toc-text">EventBus介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EventBus基本用法"><span class="toc-text">EventBus基本用法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MultiListener的使用："><span class="toc-text">MultiListener的使用：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Dead-Event"><span class="toc-text">Dead Event</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Event的继承"><span class="toc-text">Event的继承</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Range"><span class="toc-text">Range</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Range主要方法"><span class="toc-text">Range主要方法</span></a></li></ol></li></ol>
    </div>
  </section>


  


</aside>


  
  <footer class="clearfix">
    <br><br>
    
      
        <div class="aplayer-container">
          

  
    <meting-js
      theme='#1BCDFC'
      autoplay='false'
      volume='0.7'
      loop='all'
      order='list'
      fixed='false'
      list-max-height='340px'
      server='netease'
      type='playlist'
      id='3175833810'
      list-folded='true'>
    </meting-js>
  


        </div>
      
    
      
        <br>
        <div class="social-wrapper">
          
            
              <a href="/atom.xml"
                class="social fas fa-rss flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
            
              <a href="mailto:me@xaoxuu.com"
                class="social fas fa-envelope flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
            
              <a href="https://github.com/xaoxuu"
                class="social fab fa-github flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
            
              <a href="https://music.163.com/#/user/home?id=63035382"
                class="social fas fa-headphones-alt flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
        </div>
      
    
      
        <div><p>Blog content follows the <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener">Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0) License</a></p>
</div>
      
    
      
        Use
        <a href="https://bcoder,top/" target="_blank" class="codename">周陆宁</a>
        as theme
        
          , 
          total visits
          <span id="busuanzi_value_site_pv"><i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span>
          times
        
      
    
      
        <div class='copyright'>
        <p><a href="https://xaoxuu.com" target="_blank" rel="noopener">Copyright © 2017-2020 Mr. X</a></p>

        </div>
      
    
  </footer>

<script>setLoadingBarProgress(80);</script>


      <script>setLoadingBarProgress(60);</script>
    </div>
    <a class="s-top fas fa-arrow-up fa-fw" href='javascript:void(0)'></a>
  </div>
  
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4/dist/jquery.min.js"></script>


  <script>
    
    var SEARCH_SERVICE = "hexo" || "hexo";
    var ROOT = "/" || "/";
    if (!ROOT.endsWith('/')) ROOT += '/';
  </script>


  <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2/js/instant_page.js" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>



  
<script src="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js"></script>

  <script type="text/javascript">
    $(function() {
      Waves.attach('.flat-btn', ['waves-button']);
      Waves.attach('.float-btn', ['waves-button', 'waves-float']);
      Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);
      Waves.attach('.flat-box', ['waves-block']);
      Waves.attach('.float-box', ['waves-block', 'waves-float']);
      Waves.attach('.waves-image');
      Waves.init();
    });
  </script>


  <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js"></script>



  
  
  
    
<script src="https://cdn.jsdelivr.net/npm/jquery-backstretch@2.1.18/jquery.backstretch.min.js"></script>

    <script type="text/javascript">
      $(function(){
        var imgs=["https://cdn.jsdelivr.net/gh/xaoxuu/cdn-wallpaper/abstract/41F215B9-261F-48B4-80B5-4E86E165259E.jpeg"];
        if ('true' == 'true') {
          function shuffle(arr){
            /*From countercurrent-time*/
            var n = arr.length;
            while(n--) {
              var index = Math.floor(Math.random() * n);
              var temp = arr[index];
              arr[index] = arr[n];
              arr[n] = temp;
            }
          }
          shuffle(imgs);
        }
        if ('.cover') {
          $('.cover').backstretch(
            imgs,
          {
            duration: "20000",
            fade: "1500"
          });
        } else {
          $.backstretch(
            imgs,
          {
            duration: "20000",
            fade: "1500"
          });
        }
      });
    </script>
  



  
    
<script src="https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.js" async></script>

  
    
<script src="https://cdn.jsdelivr.net/npm/meting@2.0/dist/Meting.min.js" async></script>

  










  
<script src="/js/app.js"></script>



  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2.1/js/search.js"></script>



  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2/js/comment_typing.js"></script>



<!-- 复制 -->

  <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="fas fa-copy"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copyed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('fa-copy');
        $icon.addClass('fa-clipboard-check');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPYED';
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('fa-copy');
        $icon.addClass('fa-exclamation-triangle');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
      });
    }
    initCopyCode();
  }(window, document);
</script>




<!-- fancybox -->

  <script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script>
  let LAZY_LOAD_IMAGE = "";
  $(".article-entry").find("div.fancybox").find("img").each(function () {
      var element = document.createElement("a");
      $(element).attr("data-fancybox", "gallery");
      $(element).attr("href", $(this).attr("src"));
      /* 图片采用懒加载处理时,
       * 一般图片标签内会有个属性名来存放图片的真实地址，比如 data-original,
       * 那么此处将原本的属性名src替换为对应属性名data-original,
       * 修改如下
       */
       if (LAZY_LOAD_IMAGE) {
         $(element).attr("href", $(this).attr("data-original"));
       }
      $(this).wrap(element);
  });
</script>






  <script>setLoadingBarProgress(100);</script>
</body>
</html>

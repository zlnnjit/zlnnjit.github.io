<!DOCTYPE html>
<html>
<head hexo-theme='https://volantis.js.org/#2020'>
  <meta charset="utf-8">
  <!-- SEO相关 -->
  
    
  
  <!-- 渲染优化 -->
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <!-- 页面元数据 -->
  
    <title>Spring Boot高级特性 - zln&#39;s blog</title>
  
    <meta name="keywords" content="Spring Boot">
  
  
    <meta name="description" content="
引言

在我们进行开发应用时，除了要整合像MyBatis、Durid、logback等基础组件，还会去整合诸如缓存、消息队列、各种任务（异步任务、定时任务、邮件任务）等等。">
  

  <!-- feed -->
  

  <!-- import meta -->
  

  <!-- link -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css">
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">

  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css">

  

  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.css">
  

  <!-- import link -->
  

  
    
<link rel="stylesheet" href="/css/style.css">

  

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>

  
  
</head>

<body>
  
  <div class="cover-wrapper">
    
      <cover class='cover post half'>
        <div class='cover-body'>
  <div class='a'>
    
    
      <p class="title">bcoder.top</p>
    
    
      <p class="subtitle">不忘初心，无畏前行</p>
    
  </div>
  <div class='b'>
    
      <div class="m_search">
        <form name="searchform" class="form u-search-form">
          <input type="text" class="input u-search-input" placeholder="" />
          <i class="icon fas fa-search fa-fw"></i>
        </form>
      </div>
    
    <div class='menu navigation'>
      <ul class='h-list'>
        
          
            <li>
              <a class="nav home"
                href="/"
                
                
                id="home">
                <i class='fas fa-rss fa-fw'></i>&nbsp;博客
              </a>
            </li>
          
            <li>
              <a class="nav home"
                href="/categories/"
                
                
                id="categories">
                <i class='fas fa-folder-open fa-fw'></i>&nbsp;分类
              </a>
            </li>
          
            <li>
              <a class="nav home"
                href="/tags/"
                
                
                id="tags">
                <i class='fas fa-tags fa-fw'></i>&nbsp;标签
              </a>
            </li>
          
            <li>
              <a class="nav home"
                href="/archives/"
                
                
                id="archives">
                <i class='fas fa-archive fa-fw'></i>&nbsp;归档
              </a>
            </li>
          
        
      </ul>
    </div>
  </div>
</div>

      </cover>
    
    <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>
<header class="l_header shadow blur">

  <div class='wrapper'>
    <div class='nav-sub container--flex'>
      <a class="logo flat-box"></a>
      <ul class='switcher h-list'>
        <li><a class="s-comment flat-btn fas fa-comments fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
          <li><a class="s-toc flat-btn fas fa-list fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
      </ul>
    </div>
		<div class="nav-main container container--flex">
      
        
        <a class="logo flat-box" target="_self" href='/'>
          
          
          
          
            周陆宁 <b><sup style='color:#3AA757'>2020</sup></b>
          
        </a>
      

			<div class='menu navigation'>
				<ul class='h-list'>
          
          
          
            
            
              <li>
                <a class="flat-box" href=/
                  
                  
                  
                    id="home"
                  >
                  
                    <i class='fas fa-rss fa-fw'></i>
                  
                  博客
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=/categories/
                  
                  
                  
                    id="categories"
                  >
                  
                    <i class='fas fa-folder-open fa-fw'></i>
                  
                  分类
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=/tags/
                  
                  
                  
                    id="tags"
                  >
                  
                    <i class='fas fa-tags fa-fw'></i>
                  
                  标签
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=/archives/
                  
                  
                  
                    id="archives"
                  >
                  
                    <i class='fas fa-archive fa-fw'></i>
                  
                  归档
                </a>
                
              </li>
            
          
          
				</ul>
			</div>

      
        <div class="m_search">
          <form name="searchform" class="form u-search-form">
            <i class="icon fas fa-search fa-fw"></i>
            <input type="text" class="input u-search-input" placeholder="搜索" />
          </form>
        </div>
      

			<ul class='switcher h-list'>
				
					<li><a class="s-search flat-btn fas fa-search fa-fw" target="_self" href='javascript:void(0)'></a></li>
				
				<li><a class="s-menu flat-btn fas fa-bars fa-fw" target="_self" href='javascript:void(0)'></a></li>
			</ul>
		</div>
	</div>
</header>
<ul class="menu-phone navigation white-box">
  
  
    <li>
      <a class="flat-box" href=/
        
        
        
          id="home"
        >
        
          <i class='fas fa-rss fa-fw'></i>
        
        博客
      </a>
    </li>
  
    <li>
      <a class="flat-box" href=/categories/
        
        
        
          id="categories"
        >
        
          <i class='fas fa-folder-open fa-fw'></i>
        
        分类
      </a>
    </li>
  
    <li>
      <a class="flat-box" href=/tags/
        
        
        
          id="tags"
        >
        
          <i class='fas fa-tags fa-fw'></i>
        
        标签
      </a>
    </li>
  
    <li>
      <a class="flat-box" href=/archives/
        
        
        
          id="archives"
        >
        
          <i class='fas fa-archive fa-fw'></i>
        
        归档
      </a>
    </li>
  
    <li>
      <a class="flat-box" href=/friends/
        
        
        
          id="friends"
        >
        
          <i class='fas fa-link fa-fw'></i>
        
        友链
      </a>
    </li>
  
    <li>
      <a class="flat-box" href=/about/
        
        
        
          id="about"
        >
        
          <i class='fas fa-info-circle fa-fw'></i>
        
        关于
      </a>
    </li>
  
</ul>
<script>setLoadingBarProgress(40);</script>

  </div>


  <div class="l_body">
    <div class='body-wrapper'>
      

<div class='l_main'>
  

  
    <article id="post" class="post white-box shadow article-type-post" itemscope itemprop="blogPost">
      


  <section class='meta'>
    
    
    <div class="meta" id="header-meta">
      
        
  
    <h1 class="title">
      <a href="/2019/01/01/SpringBoot%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/">
        Spring Boot高级特性
      </a>
    </h1>
  


      
      <div class='new-meta-box'>
        
          
        
          
            
<div class='new-meta-item author'>
  <a href="" rel="nofollow">
    <img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/avatar/avatar.png">
    <p>周陆宁</p>
  </a>
</div>

          
        
          
            
  
  <div class='new-meta-item category'>
    <a href='/categories/Spring-Boot/' rel="nofollow">
      <i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>
      <p>Spring Boot</p>
    </a>
  </div>


          
        
          
            
  
  <div class="new-meta-item meta-tags"><a class="tag" href="/tags/Spring-Boot/" rel="nofollow"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i><p>Spring Boot</p></a></div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i>
    <p>发布于：2019-01-01 21:37:52</p>
  </a>
</div>

          
        
          
            
  <div class="new-meta-item wordcount">
    <a class='notlink'>
      <i class="fas fa-keyboard fa-fw" aria-hidden="true"></i>
      <p>字数：8k</p>
    </a>
  </div>
  <div class="new-meta-item readtime">
    <a class='notlink'>
      <i class="fas fa-hourglass-half fa-fw" aria-hidden="true"></i>
      <p>时长：35 分钟</p>
    </a>
  </div>


          
        
          
            

          
        
      </div>
      
        <hr>
      
    </div>
  </section>


      <section class="article typo">
        <div class="article-entry" itemprop="articleBody">
          
          <blockquote>
<p>引言</p>
</blockquote>
<p>在我们进行开发应用时，除了要整合像MyBatis、Durid、logback等基础组件，还会去整合诸如缓存、消息队列、各种任务（异步任务、定时任务、邮件任务）等等。</p>
<a id="more"></a>

<h2 id="Spring-Boot之缓存"><a href="#Spring-Boot之缓存" class="headerlink" title="Spring Boot之缓存"></a>Spring Boot之缓存</h2><h3 id="JSR107"><a href="#JSR107" class="headerlink" title="JSR107"></a>JSR107</h3><p>JSR107定义了缓存的标准，主要有以下内容：</p>
<p>Java Caching定义了5个核心接口，分别是<strong>CachingProvider</strong>, <strong>CacheManager</strong>, <strong>Cache</strong>, <strong>Entry</strong> 和 <strong>Expiry</strong>。</p>
<ul>
<li>CachingProvider定义了创建、配置、获取、管理和控制多个CacheManager。一个应用可以在运行期访问多个CachingProvider。</li>
<li>CacheManager定义了创建、配置、获取、管理和控制多个唯一命名的Cache，这些Cache存在于CacheManager的上下文中。一个CacheManager仅被一个CachingProvider所拥有。</li>
<li>Cache是一个类似Map的数据结构并临时存储以Key为索引的值。一个Cache仅被一个CacheManager所拥有。</li>
<li>Entry是一个存储在Cache中的key-value对。</li>
<li>Expiry 每一个存储在Cache中的条目有一个定义的有效期。一旦超过这个时间，条目为过期的状态。一旦过期，条目将不可访问、更新和删除。缓存有效期可以通过ExpiryPolicy设置。</li>
</ul>
<p>我们可以用一个图来表示：</p>
<p><img src="http://img.bcoder.top/2019.01.01/1.png" alt="SpringBoot高级特性"></p>
<h3 id="Spring缓存抽象"><a href="#Spring缓存抽象" class="headerlink" title="Spring缓存抽象"></a>Spring缓存抽象</h3><p>Spring从3.1开始定义了org.springframework.cache.Cache和org.springframework.cache.CacheManager接口来统一不同的缓存技术；</p>
<p>并支持使用JCache（JSR-107）注解简化我们开发；</p>
<ul>
<li>Cache接口为缓存的组件规范定义，包含缓存的各种操作集合；</li>
<li>Cache接口下Spring提供了各种xxxCache的实现；如RedisCache，EhCacheCache , ConcurrentMapCache等；</li>
<li>每次调用需要缓存功能的方法时，Spring会检查检查指定参数的指定的目标方法是否已经被调用过；如果有就直接从缓存中获取方法调用后的结果，如果没有就调用方法并缓存结果后返回给用户。下次调用直接从缓存中获取。</li>
<li>使用Spring缓存抽象时我们需要关注以下两点：<ul>
<li>确定方法需要被缓存以及他们的缓存策略</li>
<li>从缓存中读取之前缓存存储的数据</li>
</ul>
</li>
</ul>
<p>我们可以用一个图来表示：</p>
<p><img src="http://img.bcoder.top/2019.01.01/2.png" alt="SpringBoot高级特性"></p>
<h3 id="Spring缓存概念"><a href="#Spring缓存概念" class="headerlink" title="Spring缓存概念"></a>Spring缓存概念</h3><table>
<thead>
<tr>
<th align="left">Cache</th>
<th>缓存接口，定义缓存操作。实现有：RedisCache、EhCacheCache、ConcurrentMapCache等</th>
</tr>
</thead>
<tbody><tr>
<td align="left">CacheManager</td>
<td>缓存管理器，管理各种缓存（Cache）组件</td>
</tr>
<tr>
<td align="left">@Cacheable</td>
<td>主要针对方法配置，能够根据方法的请求参数对其结果进行缓存</td>
</tr>
<tr>
<td align="left">@CacheEvict</td>
<td>清空缓存</td>
</tr>
<tr>
<td align="left">@CachePut</td>
<td>保证方法被调用，又希望结果被缓存。</td>
</tr>
<tr>
<td align="left">@EnableCaching</td>
<td>开启基于注解的缓存</td>
</tr>
<tr>
<td align="left">keyGenerator</td>
<td>缓存数据时key生成策略</td>
</tr>
<tr>
<td align="left">serialize</td>
<td>缓存数据时value序列化策略</td>
</tr>
</tbody></table>
<p><strong>@Cacheable/@CachePut/@CacheEvict主要的参数</strong></p>
<table>
<thead>
<tr>
<th>value</th>
<th align="left">缓存的名称，在 spring   配置文件中定义，必须指定至少一个</th>
<th>例如：@Cacheable(value=”mycache”) 或者       @Cacheable(value={”cache1”,”cache2”}</th>
</tr>
</thead>
<tbody><tr>
<td>key</td>
<td align="left">缓存的   key，可以为空，如果指定要按照   SpEL 表达式编写，如果不指定，则缺省按照方法的所有参数进行组合</td>
<td>例如：<code>@Cacheable(value=”testcache”,key=”#userName”)</code></td>
</tr>
<tr>
<td>condition</td>
<td align="left">缓存的条件，可以为空，使用   SpEL 编写，返回   true 或者 false，只有为   true 才进行缓存/清除缓存，在调用方法之前之后都能判断</td>
<td>例如：<code>@Cacheable(value=”testcache”,condition=”#userName.length()&gt;2”)</code></td>
</tr>
<tr>
<td>allEntries   (@CacheEvict   )</td>
<td align="left">是否清空所有缓存内容，缺省为   false，如果指定为 true，则方法调用后将立即清空所有缓存</td>
<td>例如：<code>@CachEvict(value=”testcache”,allEntries=true)</code></td>
</tr>
<tr>
<td>beforeInvocation   (@CacheEvict)</td>
<td align="left">是否在方法执行前就清空，缺省为   false，如果指定为 true，则在方法还没有执行的时候就清空缓存，缺省情况下，如果方法执行抛出异常，则不会清空缓存</td>
<td>例如：<code>@CachEvict(value=”testcache”，beforeInvocation=true)</code></td>
</tr>
<tr>
<td>unless   (@CachePut)   (@Cacheable)</td>
<td align="left">用于否决缓存的，不像condition，该表达式只在方法执行之后判断，此时可以拿到返回值result进行判断。条件为true不会缓存，fasle才缓存</td>
<td>例如：<code>@Cacheable(value=”testcache”,unless=”#result== null”)</code></td>
</tr>
</tbody></table>
<p><strong>Cache SpEL available</strong> </p>
<table>
<thead>
<tr>
<th>名字</th>
<th>位置</th>
<th>描述</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>methodName</td>
<td>root object</td>
<td>当前被调用的方法名</td>
<td><code>#root.methodName</code></td>
</tr>
<tr>
<td>method</td>
<td>root object</td>
<td>当前被调用的方法</td>
<td><code>#root.method.name</code></td>
</tr>
<tr>
<td>target</td>
<td>root object</td>
<td>当前被调用的目标对象</td>
<td><code>#root.target</code></td>
</tr>
<tr>
<td>targetClass</td>
<td>root object</td>
<td>当前被调用的目标对象类</td>
<td><code>#root.targetClass</code></td>
</tr>
<tr>
<td>args</td>
<td>root object</td>
<td>当前被调用的方法的参数列表</td>
<td><code>#root.args[0]</code></td>
</tr>
<tr>
<td>caches</td>
<td>root object</td>
<td>当前方法调用使用的缓存列表（如@Cacheable(value={“cache1”,   “cache2”})），则有两个cache</td>
<td><code>#root.caches[0].name</code></td>
</tr>
<tr>
<td>argument name</td>
<td>evaluation context</td>
<td>方法参数的名字. 可以直接 #参数名 ，也可以使用 #p0或#a0 的形式，0代表参数的索引；</td>
<td><code>#iban 、 #a0 、  #p0</code></td>
</tr>
<tr>
<td>result</td>
<td>evaluation context</td>
<td>方法执行后的返回值（仅当方法执行之后的判断有效，如‘unless’，’cache put’的表达式 ’cache evict’的表达式beforeInvocation=false）</td>
<td><code>#result</code></td>
</tr>
</tbody></table>
<h3 id="缓存实战"><a href="#缓存实战" class="headerlink" title="缓存实战"></a>缓存实战</h3><p>1.引入pom</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2.开启缓存</p>
<p>在XXXApplication.java中加上注解：@EnableCaching</p>
<p>3.创建数据表及其对应的实体bean：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`department`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`departmentName`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for employee</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`employee`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`employee`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`lastName`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`email`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`gender`</span> <span class="built_in">int</span>(<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`d_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br></pre></td></tr></table></figure>



<p>4.创建Mapper</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Component</span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EmployeeMapper</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Select</span>(<span class="string">"select * from employee where id=#&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Employee <span class="title">getEmpById</span><span class="params">(Integer id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Update</span>(<span class="string">"update employee set lastName=#&#123;lastName&#125;,email=#&#123;email&#125;,gender=#&#123;gender&#125;,d_id=#&#123;d_id&#125; where id=#&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateEmp</span><span class="params">(Employee employee)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Delete</span>(<span class="string">"Delete from employee where id=#&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteEmpById</span><span class="params">(Integer id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Insert</span>(<span class="string">"insert employee(lastName,email,gender,d_id) values(#&#123;lastName&#125;,#&#123;email&#125;,#&#123;gender&#125;,#&#123;dId&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertEmployee</span><span class="params">(Employee employee)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>5.创建Service(主要内容在注释)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.zln.cache.bean.Employee;</span><br><span class="line"><span class="keyword">import</span> com.zln.cache.mapper.EmployeeMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@CacheConfig</span>(cacheNames=<span class="string">"emp"</span><span class="comment">/*,cacheManager = "employeeCacheManager"*/</span>) <span class="comment">//抽取缓存的公共配置</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmployeeService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    EmployeeMapper employeeMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将方法的运行结果进行缓存；以后再要相同的数据，直接从缓存中获取，不用调用方法；</span></span><br><span class="line"><span class="comment">     * CacheManager管理多个Cache组件的，对缓存的真正CRUD操作在Cache组件中，每一个缓存组件有自己唯一一个名字；</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 原理：</span></span><br><span class="line"><span class="comment">     *   1、自动配置类；CacheAutoConfiguration</span></span><br><span class="line"><span class="comment">     *   2、缓存的配置类</span></span><br><span class="line"><span class="comment">     *   org.springframework.boot.autoconfigure.cache.GenericCacheConfiguration</span></span><br><span class="line"><span class="comment">     *   org.springframework.boot.autoconfigure.cache.JCacheCacheConfiguration</span></span><br><span class="line"><span class="comment">     *   org.springframework.boot.autoconfigure.cache.EhCacheCacheConfiguration</span></span><br><span class="line"><span class="comment">     *   org.springframework.boot.autoconfigure.cache.HazelcastCacheConfiguration</span></span><br><span class="line"><span class="comment">     *   org.springframework.boot.autoconfigure.cache.InfinispanCacheConfiguration</span></span><br><span class="line"><span class="comment">     *   org.springframework.boot.autoconfigure.cache.CouchbaseCacheConfiguration</span></span><br><span class="line"><span class="comment">     *   org.springframework.boot.autoconfigure.cache.RedisCacheConfiguration</span></span><br><span class="line"><span class="comment">     *   org.springframework.boot.autoconfigure.cache.CaffeineCacheConfiguration</span></span><br><span class="line"><span class="comment">     *   org.springframework.boot.autoconfigure.cache.GuavaCacheConfiguration</span></span><br><span class="line"><span class="comment">     *   org.springframework.boot.autoconfigure.cache.SimpleCacheConfiguration【默认】</span></span><br><span class="line"><span class="comment">     *   org.springframework.boot.autoconfigure.cache.NoOpCacheConfiguration</span></span><br><span class="line"><span class="comment">     *   3、哪个配置类默认生效：SimpleCacheConfiguration；</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *   4、给容器中注册了一个CacheManager：ConcurrentMapCacheManager</span></span><br><span class="line"><span class="comment">     *   5、可以获取和创建ConcurrentMapCache类型的缓存组件；他的作用将数据保存在ConcurrentMap中；</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *   运行流程：</span></span><br><span class="line"><span class="comment">     *   <span class="doctag">@Cacheable</span>：</span></span><br><span class="line"><span class="comment">     *   1、方法运行之前，先去查询Cache（缓存组件），按照cacheNames指定的名字获取；</span></span><br><span class="line"><span class="comment">     *      （CacheManager先获取相应的缓存），第一次获取缓存如果没有Cache组件会自动创建。</span></span><br><span class="line"><span class="comment">     *   2、去Cache中查找缓存的内容，使用一个key，默认就是方法的参数；</span></span><br><span class="line"><span class="comment">     *      key是按照某种策略生成的；默认是使用keyGenerator生成的，默认使用SimpleKeyGenerator生成key；</span></span><br><span class="line"><span class="comment">     *          SimpleKeyGenerator生成key的默认策略；</span></span><br><span class="line"><span class="comment">     *                  如果没有参数；key=new SimpleKey()；</span></span><br><span class="line"><span class="comment">     *                  如果有一个参数：key=参数的值</span></span><br><span class="line"><span class="comment">     *                  如果有多个参数：key=new SimpleKey(params)；</span></span><br><span class="line"><span class="comment">     *   3、没有查到缓存就调用目标方法；</span></span><br><span class="line"><span class="comment">     *   4、将目标方法返回的结果，放进缓存中</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *   <span class="doctag">@Cacheable</span>标注的方法执行之前先来检查缓存中有没有这个数据，默认按照参数的值作为key去查询缓存，</span></span><br><span class="line"><span class="comment">     *   如果没有就运行方法并将结果放入缓存；以后再来调用就可以直接使用缓存中的数据；</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *   核心：</span></span><br><span class="line"><span class="comment">     *      1）、使用CacheManager【ConcurrentMapCacheManager】按照名字得到Cache【ConcurrentMapCache】组件</span></span><br><span class="line"><span class="comment">     *      2）、key使用keyGenerator生成的，默认是SimpleKeyGenerator</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *   几个属性：</span></span><br><span class="line"><span class="comment">     *      cacheNames/value：指定缓存组件的名字;将方法的返回结果放在哪个缓存中，是数组的方式，可以指定多个缓存；</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *      key：缓存数据使用的key；可以用它来指定。默认是使用方法参数的值  1-方法的返回值</span></span><br><span class="line"><span class="comment">     *              编写SpEL； #i d;参数id的值   #a0  #p0  #root.args[0]</span></span><br><span class="line"><span class="comment">     *              getEmp[2]</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *      keyGenerator：key的生成器；可以自己指定key的生成器的组件id</span></span><br><span class="line"><span class="comment">     *              key/keyGenerator：二选一使用;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *      cacheManager：指定缓存管理器；或者cacheResolver指定获取解析器</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *      condition：指定符合条件的情况下才缓存；</span></span><br><span class="line"><span class="comment">     *              ,condition = "#id&gt;0"</span></span><br><span class="line"><span class="comment">     *          condition = "#a0&gt;1"：第一个参数的值》1的时候才进行缓存</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *      unless:否定缓存；当unless指定的条件为true，方法的返回值就不会被缓存；可以获取到结果进行判断</span></span><br><span class="line"><span class="comment">     *              unless = "#result == null"</span></span><br><span class="line"><span class="comment">     *              unless = "#a0==2":如果第一个参数的值是2，结果不缓存；</span></span><br><span class="line"><span class="comment">     *      sync：是否使用异步模式</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Cacheable</span>(value = &#123;<span class="string">"emp"</span>&#125;<span class="comment">/*,keyGenerator = "myKeyGenerator",condition = "#a0&gt;1",unless = "#a0==2"*/</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Employee <span class="title">getEmp</span><span class="params">(Integer id)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"查询"</span>+id+<span class="string">"号员工"</span>);</span><br><span class="line">        Employee emp = employeeMapper.getEmpById(id);</span><br><span class="line">        <span class="keyword">return</span> emp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@CachePut</span>：既调用方法，又更新缓存数据；同步更新缓存</span></span><br><span class="line"><span class="comment">     * 修改了数据库的某个数据，同时更新缓存；</span></span><br><span class="line"><span class="comment">     * 运行时机：</span></span><br><span class="line"><span class="comment">     *  1、先调用目标方法</span></span><br><span class="line"><span class="comment">     *  2、将目标方法的结果缓存起来</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 测试步骤：</span></span><br><span class="line"><span class="comment">     *  1、查询1号员工；查到的结果会放在缓存中；</span></span><br><span class="line"><span class="comment">     *          key：1  value：lastName：张三</span></span><br><span class="line"><span class="comment">     *  2、以后查询还是之前的结果</span></span><br><span class="line"><span class="comment">     *  3、更新1号员工；【lastName:zhangsan；gender:0】</span></span><br><span class="line"><span class="comment">     *          将方法的返回值也放进缓存了；</span></span><br><span class="line"><span class="comment">     *          key：传入的employee对象  值：返回的employee对象；</span></span><br><span class="line"><span class="comment">     *  4、查询1号员工？</span></span><br><span class="line"><span class="comment">     *      应该是更新后的员工；</span></span><br><span class="line"><span class="comment">     *          key = "#employee.id":使用传入的参数的员工id；</span></span><br><span class="line"><span class="comment">     *          key = "#result.id"：使用返回后的id</span></span><br><span class="line"><span class="comment">     *             <span class="doctag">@Cacheable</span>的key是不能用#result</span></span><br><span class="line"><span class="comment">     *      为什么是没更新前的？【1号员工没有在缓存中更新】</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@CachePut</span>(<span class="comment">/*value = "emp",*/</span>key = <span class="string">"#result.id"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Employee <span class="title">updateEmp</span><span class="params">(Employee employee)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"updateEmp:"</span>+employee);</span><br><span class="line">        employeeMapper.updateEmp(employee);</span><br><span class="line">        <span class="keyword">return</span> employee;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@CacheEvict</span>：缓存清除</span></span><br><span class="line"><span class="comment">     *  key：指定要清除的数据</span></span><br><span class="line"><span class="comment">     *  allEntries = true：指定清除这个缓存中所有的数据</span></span><br><span class="line"><span class="comment">     *  beforeInvocation = false：缓存的清除是否在方法之前执行</span></span><br><span class="line"><span class="comment">     *      默认代表缓存清除操作是在方法执行之后执行;如果出现异常缓存就不会清除</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *  beforeInvocation = true：</span></span><br><span class="line"><span class="comment">     *      代表清除缓存操作是在方法运行之前执行，无论方法是否出现异常，缓存都清除</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@CacheEvict</span>(value=<span class="string">"emp"</span>,beforeInvocation = <span class="keyword">true</span><span class="comment">/*key = "#id",*/</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteEmp</span><span class="params">(Integer id)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"deleteEmp:"</span>+id);</span><br><span class="line">        <span class="comment">//employeeMapper.deleteEmpById(id);</span></span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">10</span>/<span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @Caching 定义复杂的缓存规则</span></span><br><span class="line">    <span class="meta">@Caching</span>(</span><br><span class="line">         cacheable = &#123;</span><br><span class="line">             <span class="meta">@Cacheable</span>(<span class="comment">/*value="emp",*/</span>key = <span class="string">"#lastName"</span>)</span><br><span class="line">         &#125;,</span><br><span class="line">         put = &#123;</span><br><span class="line">             <span class="meta">@CachePut</span>(<span class="comment">/*value="emp",*/</span>key = <span class="string">"#result.id"</span>),</span><br><span class="line">             <span class="meta">@CachePut</span>(<span class="comment">/*value="emp",*/</span>key = <span class="string">"#result.email"</span>)</span><br><span class="line">         &#125;</span><br><span class="line">    )</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Employee <span class="title">getEmpByLastName</span><span class="params">(String lastName)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> employeeMapper.getEmpByLastName(lastName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="整合Redis作为缓存"><a href="#整合Redis作为缓存" class="headerlink" title="整合Redis作为缓存"></a>整合Redis作为缓存</h3><p>1.引入pom</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2.yml配置Redis相关配置</p>
<p>3.创建RedisCacheManager的实现（已上面的例子为基础）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRedisConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisTemplate&lt;Object, Employee&gt; <span class="title">empredisTemplate</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            RedisConnectionFactory redisConnectionFactory)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        RedisTemplate&lt;Object,Employee&gt; template=<span class="keyword">new</span> RedisTemplate&lt;Object, Employee&gt;();</span><br><span class="line">        template.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">        Jackson2JsonRedisSerializer&lt;Employee&gt; ser=<span class="keyword">new</span> Jackson2JsonRedisSerializer&lt;Employee&gt;(Employee<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        template.setDefaultSerializer(ser);</span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisTemplate&lt;Object, Department&gt; <span class="title">deptredisTemplate</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            RedisConnectionFactory redisConnectionFactory)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        RedisTemplate&lt;Object,Department&gt; template=<span class="keyword">new</span> RedisTemplate&lt;Object, Department&gt;();</span><br><span class="line">        template.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">        Jackson2JsonRedisSerializer&lt;Department&gt; ser=<span class="keyword">new</span> Jackson2JsonRedisSerializer&lt;Department&gt;(Department<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        template.setDefaultSerializer(ser);</span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Primary</span><span class="comment">//必须设置一个默认的</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisCacheManager <span class="title">empoyeeCacheManager</span><span class="params">(RedisTemplate&lt;Object,Employee&gt; employeeRedisTemplate)</span></span>&#123;</span><br><span class="line">        RedisCacheManager redisCacheManager=<span class="keyword">new</span> RedisCacheManager(employeeRedisTemplate);</span><br><span class="line">        redisCacheManager.setUsePrefix(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> redisCacheManager;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisCacheManager <span class="title">deptCacheManager</span><span class="params">(RedisTemplate&lt;Object,Department&gt; deptloyeeRedisTemplate)</span></span>&#123;</span><br><span class="line">        RedisCacheManager redisCacheManager=<span class="keyword">new</span> RedisCacheManager(deptloyeeRedisTemplate);</span><br><span class="line">        redisCacheManager.setUsePrefix(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> redisCacheManager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>4.在使用缓存注解时，指定cacheManager即可，当然也可以直接代码调用cacheManager，示例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeptController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier</span>(<span class="string">"deptCacheManager"</span>)</span><br><span class="line">    <span class="keyword">private</span> RedisCacheManager deptCacheManager;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DeptService deptService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/dept/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Department <span class="title">getDeptById</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> Integer id)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> deptService.getDeptById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/depts/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Department <span class="title">getDeptByIds</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> Integer id)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"查询部门"</span>);</span><br><span class="line">        Department department=deptService.getDeptById(<span class="number">1</span>);</span><br><span class="line">        Cache dept = deptCacheManager.getCache(<span class="string">"dept"</span>);</span><br><span class="line">        dept.put(<span class="string">"dept:1"</span>,department);</span><br><span class="line">        <span class="keyword">return</span> department;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="缓存原理"><a href="#缓存原理" class="headerlink" title="缓存原理"></a>缓存原理</h3><p><strong>1.自动配置类：CacheAutoConfiguration.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(&#123;CacheManager<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class">@<span class="title">ConditionalOnBean</span>(</span>&#123;CacheAspectSupport<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class">@<span class="title">ConditionalOnMissingBean</span>(</span></span><br><span class="line"><span class="class">    <span class="title">value</span> </span>= &#123;CacheManager<span class="class">.<span class="keyword">class</span>&#125;,</span></span><br><span class="line"><span class="class">    <span class="title">name</span> </span>= &#123;<span class="string">"cacheResolver"</span>&#125;</span><br><span class="line">)</span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span>(&#123;CacheProperties<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class">@<span class="title">AutoConfigureAfter</span>(</span>&#123;CouchbaseAutoConfiguration<span class="class">.<span class="keyword">class</span>, <span class="title">HazelcastAutoConfiguration</span>.<span class="title">class</span>, <span class="title">HibernateJpaAutoConfiguration</span>.<span class="title">class</span>, <span class="title">RedisAutoConfiguration</span>.<span class="title">class</span>&#125;)</span></span><br><span class="line"><span class="class">//给容器中导入缓存要用的一些组件</span></span><br><span class="line"><span class="class">@<span class="title">Import</span>(</span>&#123;CacheAutoConfiguration.CacheConfigurationImportSelector<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">CacheAutoConfiguration</span> </span>&#123;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheConfigurationImportSelector</span> <span class="keyword">implements</span> <span class="title">ImportSelector</span> </span>&#123;</span><br><span class="line">    CacheConfigurationImportSelector() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;</span><br><span class="line">        CacheType[] types = CacheType.values();</span><br><span class="line">        <span class="comment">//给容器中导入缓存要用的一些组件</span></span><br><span class="line">        String[] imports = <span class="keyword">new</span> String[types.length];</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; types.length; ++i) &#123;</span><br><span class="line">            imports[i] = CacheConfigurations.getConfigurationClass(types[i]);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> imports;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p><strong>2.导入缓存自动配置类组件</strong></p>
<p><img src="http://img.bcoder.top/2019.01.01/3.png" alt="SpringBoot高级特性"></p>
<p><strong>3.默认生效配置类SimpleCacheConfiguration</strong></p>
<p>yml中 debug: true进行查看</p>
<p><img src="http://img.bcoder.top/2019.01.01/4.png" alt="SpringBoot高级特性"></p>
<p><strong>4.SimpleCacheConfiguration给容器中注册一个CacheManager：ConcurrentMapCacheManager</strong></p>
<p>ConcurrentMapCacheManager.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Cache <span class="title">getCache</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    Cache cache = (Cache)<span class="keyword">this</span>.cacheMap.get(name);</span><br><span class="line">    <span class="keyword">if</span> (cache == <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.dynamic) &#123;</span><br><span class="line">        ConcurrentMap var3 = <span class="keyword">this</span>.cacheMap;</span><br><span class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>.cacheMap) &#123;</span><br><span class="line">            cache = (Cache)<span class="keyword">this</span>.cacheMap.get(name);</span><br><span class="line">            <span class="keyword">if</span> (cache == <span class="keyword">null</span>) &#123;</span><br><span class="line">                cache = <span class="keyword">this</span>.createConcurrentMapCache(name);</span><br><span class="line">                <span class="keyword">this</span>.cacheMap.put(name, cache);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> cache;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ConcurrentMapCache.java    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;Object, Object&gt; store;</span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">lookup</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.store.get(key);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(Object key, @Nullable Object value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.store.put(key, <span class="keyword">this</span>.toStoreValue(value));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="缓存运行流程"><a href="#缓存运行流程" class="headerlink" title="缓存运行流程"></a>缓存运行流程</h3><p>标注的方法执行之前先来检查缓存中有没有这个数据，默认按照参数的值作为key去查询缓存，如果没有就运行方法并将结果放入缓存，以后再来调用就可以直接使用缓存中的数据。</p>
<p><strong>一.核心</strong></p>
<ul>
<li>使用CacheManager（ConcurrentMapCacheManager）按照名字得到Cache（ConcurrentMapCache）组件</li>
<li>key使用KeyGenerator生成的，默认是使用SimpleKeyGenerator生成key</li>
</ul>
<p><strong>二.流程</strong></p>
<p>方法运行之前，先去查询Cache（缓存组件），按照cacheName指定的名字获取CacheManager先获取相应的缓存，第一次获取缓存如果没有cache组件会自动创建</p>
<p><strong>ConcurrentMapCacheManager.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Cache <span class="title">getCache</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    Cache cache = (Cache)<span class="keyword">this</span>.cacheMap.get(name);</span><br><span class="line">    <span class="keyword">if</span> (cache == <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.dynamic) &#123;</span><br><span class="line">        ConcurrentMap var3 = <span class="keyword">this</span>.cacheMap;</span><br><span class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>.cacheMap) &#123;</span><br><span class="line">            cache = (Cache)<span class="keyword">this</span>.cacheMap.get(name);</span><br><span class="line">            <span class="keyword">if</span> (cache == <span class="keyword">null</span>) &#123;</span><br><span class="line">                cache = <span class="keyword">this</span>.createConcurrentMapCache(name);</span><br><span class="line">                <span class="keyword">this</span>.cacheMap.put(name, cache);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cache;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.使用一个key去cache中查找缓存的内容,key默认就是方法的参数key是按照某种策略生成的，使用KeyGenerator生成的，默认是使用SimpleKeyGenerator生成key</p>
<p>SimpleKeyGenerator生成key的默认策略：</p>
<ul>
<li><p>如果没有参数 key = new SimpleKey();</p>
</li>
<li><p>如果有一个参数 key = 参数的值;</p>
</li>
<li><p>如果有多个参数 key = new SimpleKey(params);</p>
</li>
</ul>
<p>ConcurrentMapCache.java </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">lookup</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.store.get(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>CacheAspectSupport.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> ValueWrapper <span class="title">findCachedItem</span><span class="params">(Collection&lt;CacheAspectSupport.CacheOperationContext&gt; contexts)</span> </span>&#123;</span><br><span class="line">    Object result = CacheOperationExpressionEvaluator.NO_RESULT;</span><br><span class="line">    Iterator var3 = contexts.iterator();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(var3.hasNext()) &#123;</span><br><span class="line">        CacheAspectSupport.CacheOperationContext context = (CacheAspectSupport.CacheOperationContext)var3.next();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.isConditionPassing(context, result)) &#123;</span><br><span class="line">            Object key = <span class="keyword">this</span>.generateKey(context, result);</span><br><span class="line">            ValueWrapper cached = <span class="keyword">this</span>.findInCaches(context, key);</span><br><span class="line">            <span class="keyword">if</span> (cached != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> cached;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.logger.isTraceEnabled()) &#123;</span><br><span class="line">                <span class="keyword">this</span>.logger.trace(<span class="string">"No cache entry for key '"</span> + key + <span class="string">"' in cache(s) "</span> + context.getCacheNames());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>SimpleKeyGenerator.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">generateKey</span><span class="params">(Object... params)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (params.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> SimpleKey.EMPTY;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (params.length == <span class="number">1</span>) &#123;</span><br><span class="line">            Object param = params[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">if</span> (param != <span class="keyword">null</span> &amp;&amp; !param.getClass().isArray()) &#123;</span><br><span class="line">                <span class="keyword">return</span> param;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SimpleKey(params);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.没有查到缓存就调用目标方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Cacheable</span>(cacheNames = <span class="string">"emp"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Employee <span class="title">getEmp</span><span class="params">(Integer id)</span></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"查询"</span>+id+<span class="string">"号员工"</span>);</span><br><span class="line">    Employee emp = employeeMapper.getEmpById(id);</span><br><span class="line">    <span class="keyword">return</span> emp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>4.将目标方法返回到结果放进缓存中</p>
<p>ConcurrentMapCache.java   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(Object key, @Nullable Object value)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">this</span>.store.put(key, <span class="keyword">this</span>.toStoreValue(value));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Spring-Boot之消息队列"><a href="#Spring-Boot之消息队列" class="headerlink" title="Spring Boot之消息队列"></a>Spring Boot之消息队列</h2><h3 id="消息队列概述"><a href="#消息队列概述" class="headerlink" title="消息队列概述"></a>消息队列概述</h3><p><strong>1.消息队列简介</strong></p>
<ul>
<li><p>大多应用中，可通过消息服务中间件来提升系统异步通信、扩展解耦能力</p>
</li>
<li><p>消息服务中两个重要概念：消息代理（message broker）和目的地（destination）</p>
<ul>
<li>当消息发送者发送消息以后，将由消息代理接管，消息代理保证消息传递到指定目的地。</li>
</ul>
</li>
<li><p>消息队列主要有两种形式的目的地</p>
<ul>
<li><strong>队列</strong>（queue）：点对点消息通信（point-to-point）</li>
<li><strong>主题</strong>（topic）：发布（publish）/订阅（subscribe）消息通信</li>
</ul>
</li>
<li><p><strong>点对点式</strong>：</p>
<ul>
<li>消息发送者发送消息，消息代理将其放入一个队列中，消息接收者从队列中获取消息内容，消息读取后被移出队列</li>
<li>消息只有唯一的发送者和接受者，但并不是说只能有一个接收者</li>
</ul>
</li>
<li><p><strong>发布订阅式</strong>：发送者（发布者）发送消息到主题，多个接收者（订阅者）监听（订阅）这个主题，那么就会在消息到达时同时收到消息</p>
</li>
<li><p><strong>JMS</strong>（Java Message Service）JAVA消息服务：基于JVM消息代理的规范。</p>
<ul>
<li>ActiveMQ、HornetMQ是JMS实现</li>
</ul>
</li>
<li><p><strong>AMQP</strong>（Advanced Message Queuing Protocol）：高级消息队列协议，也是一个消息代理的规范，兼容JMS</p>
<ul>
<li>RabbitMQ是AMQP的实现</li>
</ul>
</li>
<li><p><strong>Spring支持</strong></p>
<ul>
<li>spring-jms提供了对JMS的支持</li>
<li>spring-rabbit提供了对AMQP的支持</li>
<li>需要ConnectionFactory的实现来连接消息代理</li>
<li>提供JmsTemplate、RabbitTemplate来发送消息</li>
<li>@JmsListener（JMS）、@RabbitListener（AMQP）注解在方法上监听消息代理发布的消息</li>
<li>@EnableJms、@EnableRabbit开启支持</li>
</ul>
</li>
<li><p>Spring Boot自动配置</p>
<ul>
<li>JmsAutoConfiguration</li>
<li>RabbitAutoConfiguration</li>
</ul>
</li>
</ul>
<p><strong>JMS  VS  AMQP</strong>   </p>
<table>
<thead>
<tr>
<th></th>
<th>JMS</th>
<th align="left">AMQP</th>
</tr>
</thead>
<tbody><tr>
<td>定义</td>
<td>Java   api</td>
<td align="left">网络线级协议</td>
</tr>
<tr>
<td>跨语言</td>
<td>否</td>
<td align="left">是</td>
</tr>
<tr>
<td>跨平台</td>
<td>否</td>
<td align="left">是</td>
</tr>
<tr>
<td>Model</td>
<td>提供两种消息模型：   （1）、Peer-2-Peer   （2）、Pub/sub</td>
<td align="left">提供了五种消息模型：   （1）、direct   exchange   （2）、fanout   exchange   （3）、topic   change   （4）、headers   exchange   （5）、system   exchange   本质来讲，后四种和JMS的pub/sub模型没有太大差别，仅是在路由机制上做了更详细的划分；</td>
</tr>
<tr>
<td>支持消息类型</td>
<td>多种消息类型：   TextMessage   MapMessage   BytesMessage   StreamMessage   ObjectMessage   Message   （只有消息头和属性）</td>
<td align="left">byte[]   当实际应用时，有复杂的消息，可以将消息序列化后发送。</td>
</tr>
<tr>
<td>综合评价</td>
<td>JMS   定义了JAVA   API层面的标准；在java体系中，多个client均可以通过JMS进行交互，不需要应用修改代码，但是其对跨平台的支持较差；</td>
<td align="left">AMQP定义了wire-level层的协议标准；天然具有跨平台、跨语言特性。</td>
</tr>
</tbody></table>
<p><strong>2.消息队列的好处</strong></p>
<p>①异步处理</p>
<p><img src="http://img.bcoder.top/2019.01.01/5.png" alt="SpringBoot高级特性"></p>
<p><img src="http://img.bcoder.top/2019.01.01/6.png" alt="SpringBoot高级特性"></p>
<p><img src="http://img.bcoder.top/2019.01.01/7.png" alt="SpringBoot高级特性"></p>
<p>②应用解耦</p>
<p><img src="http://img.bcoder.top/2019.01.01/8.png" alt="SpringBoot高级特性"></p>
<p><img src="http://img.bcoder.top/2019.01.01/9.png" alt="SpringBoot高级特性"></p>
<p>③流量削峰</p>
<p><img src="http://img.bcoder.top/2019.01.01/10.png" alt="SpringBoot高级特性"></p>
<h3 id="RabbitMQ简介"><a href="#RabbitMQ简介" class="headerlink" title="RabbitMQ简介"></a>RabbitMQ简介</h3><p>RabbitMQ是一个由erlang开发的AMQP(Advanved Message Queue Protocol)的开源实现。</p>
<p>核心概念如下：</p>
<ul>
<li><p><strong>Message</strong></p>
<p>消息，消息是不具名的，它由消息头和消息体组成。消息体是不透明的，而消息头则由一系列的可选属性组成，这些属性包括routing-key（路由键）、priority（相对于其他消息的优先权）、delivery-mode（指出该消息可能需要持久性存储）等。</p>
</li>
<li><p><strong>Publisher</strong></p>
<p>消息的生产者，也是一个向交换器发布消息的客户端应用程序。</p>
</li>
<li><p><strong>Exchange</strong></p>
<p>交换器，用来接收生产者发送的消息并将这些消息路由给服务器中的队列。</p>
<p>Exchange有4种类型：direct(默认)，fanout, topic, 和headers，不同类型的Exchange转发消息的策略有所区别</p>
</li>
<li><p><strong>Queue</strong></p>
<p>消息队列，用来保存消息直到发送给消费者。它是消息的容器，也是消息的终点。一个消息可投入一个或多个队列。消息一直在队列里面，等待消费者连接到这个队列将其取走。</p>
</li>
<li><p><strong>Binding</strong></p>
<p>绑定，用于消息队列和交换器之间的关联。一个绑定就是基于路由键将交换器和消息队列连接起来的路由规则，所以可以将交换器理解成一个由绑定构成的路由表。</p>
<p>Exchange 和Queue的绑定可以是多对多的关系。</p>
</li>
<li><p><strong>Connection</strong></p>
<p>网络连接，比如一个TCP连接。</p>
</li>
<li><p><strong>Channel</strong></p>
<p>信道，多路复用连接中的一条独立的双向数据流通道。信道是建立在真实的TCP连接内的虚拟连接，AMQP 命令都是通过信道发出去的，不管是发布消息、订阅队列还是接收消息，这些动作都是通过信道完成。因为对于操作系统来说建立和销毁 TCP 都是非常昂贵的开销，所以引入了信道的概念，以复用一条 TCP 连接。</p>
</li>
<li><p><strong>Consumer</strong></p>
<p>消息的消费者，表示一个从消息队列中取得消息的客户端应用程序。</p>
</li>
<li><p><strong>Virtual Host</strong></p>
<p>虚拟主机，表示一批交换器、消息队列和相关对象。虚拟主机是共享相同的身份认证和加密环境的独立服务器域。每个 vhost 本质上就是一个 mini 版的 RabbitMQ 服务器，拥有自己的队列、交换器、绑定和权限机制。vhost 是 AMQP 概念的基础，必须在连接时指定，RabbitMQ 默认的 vhost 是 / 。</p>
</li>
<li><p><strong>Broker</strong></p>
<p>表示消息队列服务器实体</p>
</li>
</ul>
<p>总结起来如下图所示：</p>
<p><img src="http://img.bcoder.top/2019.01.01/11.png" alt="SpringBoot高级特性"></p>
<h3 id="RabbitMQ运行机制"><a href="#RabbitMQ运行机制" class="headerlink" title="RabbitMQ运行机制"></a>RabbitMQ运行机制</h3><p><strong>1.AMQP 中的消息路由</strong></p>
<p>AMQP 中消息的路由过程和 Java 开发者熟悉的 JMS 存在一些差别，AMQP 中增加了 <strong>Exchange</strong> 和 <strong>Binding</strong> 的角色。生产者把消息发布到 Exchange 上，消息最终到达队列并被消费者接收，而 Binding 决定交换器的消息应该发送到那个队列。</p>
<p><img src="http://img.bcoder.top/2019.01.01/12.png" alt="SpringBoot高级特性"></p>
<p><strong>2.Exchange类型</strong></p>
<p>Exchange分发消息时根据类型的不同分发策略有区别，目前共四种类型：<strong>direct</strong>、<strong>fanout</strong>、<strong>topic</strong>、<strong>headers</strong> 。headers 匹配 AMQP 消息的 header 而不是路由键， <strong>headers 交换器和 direct 交换器完全一致，但性能差很多，目前几乎用不到</strong>了，所以直接看另外三种类型：</p>
<p><strong>①direct</strong></p>
<p><img src="http://img.bcoder.top/2019.01.01/13.png" alt="SpringBoot高级特性"></p>
<p>消息中的路由键（routing key）如果和 Binding 中的 binding key 一致，交换器就将消息发到对应的队列中。路由键与队列名完全匹配，如果一个队列绑定到交换机要求路由键为“dog”，则只转发 routing key 标记为“dog”的消息，不会转发“dog.puppy”，也不会转发“dog.guard”等等。它是完全匹配、单播的模式。</p>
<p><strong>②fanout</strong></p>
<p><img src="http://img.bcoder.top/2019.01.01/14.png" alt="SpringBoot高级特性"></p>
<p>每个发到 fanout 类型交换器的消息都会分到所有绑定的队列上去。fanout交换器不处理路由键，只是简单的将队列绑定到交换器上，每个发送到交换器的消息都会被转发到与该交换器绑定的所有队列上。很像子网广播，每台子网内的主机都获得了一份复制的消息。fanout类型转发消息是最快的。</p>
<p><strong>③topic</strong></p>
<p><img src="http://img.bcoder.top/2019.01.01/15.png" alt="SpringBoot高级特性"></p>
<p>topic 交换器通过模式匹配分配消息的路由键属性，将路由键和某个模式进行匹配，此时队列需要绑定到一个模式上。它将路由键和绑定键的字符串切分成单词，这些单词之间用点隔开。它同样也会识别两个通配符：符号“<code>#</code>”和符号“<code>*</code>”。<code>#</code>匹配0个或多个单词，<code>*</code>匹配一个单词。</p>
<h3 id="整合RabbitMQ作为缓存"><a href="#整合RabbitMQ作为缓存" class="headerlink" title="整合RabbitMQ作为缓存"></a>整合RabbitMQ作为缓存</h3><ol>
<li><strong>引入 spring-boot-starter-amqp</strong></li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li><strong>application.yml配置</strong></li>
</ol>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#主机地址</span></span><br><span class="line"><span class="meta">spring.rabbitmq.host</span>=<span class="string">192.168.3.224</span></span><br><span class="line"><span class="meta">spring.rabbitmq.username</span>=<span class="string">guest</span></span><br><span class="line"><span class="meta">spring.rabbitmq.password</span>=<span class="string">guest</span></span><br><span class="line"><span class="meta">spring.rabbitmq.port</span>=<span class="string">5672</span></span><br></pre></td></tr></table></figure>



<p>3.配置消息转换器（默认jdk实现）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//自定义MessageConverter：将数据自动转为josn发送出去</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAMQPConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MessageConverter <span class="title">messageConverter</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Jackson2JsonMessageConverter();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>4.测试</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">Springboot02AmqpApplicationTests</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RabbitTemplate rabbitTemplate;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送消息</span></span><br><span class="line"><span class="comment">     * 如何将数据自动转为josn发送出去:自定义messageConverter</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextLoads</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//Message需要自己构造一个；定义消息体内容和消息头</span></span><br><span class="line">        <span class="comment">//rabbitTemplate.send(exchange,routeKey,message);</span></span><br><span class="line">        <span class="comment">//1、单播（点对点）</span></span><br><span class="line">        <span class="comment">//object默认当成消息体，只需要传入要发送的对象，自动序列化发送给rabbitmq;</span></span><br><span class="line">        <span class="comment">//rabbitTemplate.convertAndSend(exchange,routeKey,object);</span></span><br><span class="line">        Map&lt;String,Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">"msg"</span>,<span class="string">"这是第一个消息"</span>);</span><br><span class="line">        map.put(<span class="string">"data"</span>,Arrays.asList(<span class="string">"helloworld"</span>,<span class="number">123</span>,<span class="keyword">true</span>));</span><br><span class="line">        <span class="comment">//对象被默认序列化以后发送出去</span></span><br><span class="line">        <span class="comment">//rabbitTemplate.convertAndSend("exchange.direct","zln.news",map);</span></span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">"exchange.direct"</span>,<span class="string">"zln.news"</span>,<span class="keyword">new</span> Book(<span class="string">"西游记"</span>,<span class="string">"吴承恩"</span>));</span><br><span class="line">        <span class="comment">//2、广播</span></span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">"exchange.fanout"</span>,<span class="string">""</span>,<span class="keyword">new</span> Book(<span class="string">"三国演义"</span>,<span class="string">"罗贯中"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 接收消息</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Object o = rabbitTemplate.receiveAndConvert(<span class="string">"zln.news"</span>);</span><br><span class="line">        System.out.println(o.getClass());</span><br><span class="line">        System.out.println(o);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p><strong>5.注解使用:@EnableRabbit+@RabbitListener</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableRabbit</span> <span class="comment">//开启基于注解的RabbitMQ</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Springboot02AmqpApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(Springboot02AmqpApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookService</span> </span>&#123;</span><br><span class="line">    <span class="comment">//监听队列消息</span></span><br><span class="line">    <span class="meta">@RabbitListener</span>(queues = <span class="string">"zln.news"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span>  <span class="keyword">void</span>  <span class="title">receive</span><span class="params">(Book book)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"收到消息："</span>+book);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//监听消息相关信息</span></span><br><span class="line">    <span class="meta">@RabbitListener</span>(queues = <span class="string">"zln.news"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span>  <span class="keyword">void</span>  <span class="title">receive02</span><span class="params">(Message message)</span></span>&#123;</span><br><span class="line">        System.out.println(message.getBody());</span><br><span class="line">        System.out.println(message.getMessageProperties());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>6.AmqpAdmin：创建和删除Queue、Exchange、Binding</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">AmqpAdmin amqpAdmin;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createExchange</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">//创建exchange</span></span><br><span class="line">    <span class="comment">//amqpAdmin.declareExchange(new DirectExchange("amqpadmin.exchange"));</span></span><br><span class="line">    <span class="comment">//创建queue</span></span><br><span class="line">    <span class="comment">//amqpAdmin.declareQueue(new Queue("amqpadmin.queue",true));</span></span><br><span class="line">    <span class="comment">//创建Binding</span></span><br><span class="line">    amqpAdmin.declareBinding(<span class="keyword">new</span> Binding(<span class="string">"amqpadmin.queue"</span>,Binding.DestinationType.QUEUE,<span class="string">"amqpadmin.exchange"</span>,<span class="string">"amqpa.haha"</span>,<span class="keyword">null</span>));</span><br><span class="line">    System.out.println(<span class="string">"创建完成"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="整合原理"><a href="#整合原理" class="headerlink" title="整合原理"></a>整合原理</h3><p>1.自动配置类RabbitAutoConfiguration.java</p>
<p><strong>①自动配置类连接工厂CachingConnectionFactory</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(&#123; RabbitTemplate<span class="class">.<span class="keyword">class</span>, <span class="title">Channel</span>.<span class="title">class</span> &#125;)</span></span><br><span class="line"><span class="class">@<span class="title">EnableConfigurationProperties</span>(<span class="title">RabbitProperties</span>.<span class="title">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">Import</span>(<span class="title">RabbitAnnotationDrivenConfiguration</span>.<span class="title">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">RabbitAutoConfiguration</span> </span>&#123;</span><br><span class="line">                <span class="comment">//有自动配置类连接工厂</span></span><br><span class="line">		<span class="meta">@Bean</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> CachingConnectionFactory <span class="title">rabbitConnectionFactory</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">				RabbitProperties properties,</span></span></span><br><span class="line"><span class="function"><span class="params">				ObjectProvider&lt;ConnectionNameStrategy&gt; connectionNameStrategy)</span></span></span><br><span class="line"><span class="function">				<span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">			PropertyMapper map = PropertyMapper.get();</span><br><span class="line">                        <span class="comment">//配置连接工厂属性</span></span><br><span class="line">			CachingConnectionFactory factory = <span class="keyword">new</span> CachingConnectionFactory(</span><br><span class="line">					getRabbitConnectionFactoryBean(properties).getObject());</span><br><span class="line">			map.from(properties::determineAddresses).to(factory::setAddresses);</span><br><span class="line">			map.from(properties::isPublisherConfirms).to(factory::setPublisherConfirms);</span><br><span class="line">			map.from(properties::isPublisherReturns).to(factory::setPublisherReturns);</span><br><span class="line">			RabbitProperties.Cache.Channel channel = properties.getCache().getChannel();</span><br><span class="line">			map.from(channel::getSize).whenNonNull().to(factory::setChannelCacheSize);</span><br><span class="line">			map.from(channel::getCheckoutTimeout).whenNonNull().as(Duration::toMillis)</span><br><span class="line">					.to(factory::setChannelCheckoutTimeout);</span><br><span class="line">			RabbitProperties.Cache.Connection connection = properties.getCache()</span><br><span class="line">					.getConnection();</span><br><span class="line">			map.from(connection::getMode).whenNonNull().to(factory::setCacheMode);</span><br><span class="line">			map.from(connection::getSize).whenNonNull()</span><br><span class="line">					.to(factory::setConnectionCacheSize);</span><br><span class="line">			map.from(connectionNameStrategy::getIfUnique).whenNonNull()</span><br><span class="line">					.to(factory::setConnectionNameStrategy);</span><br><span class="line">			<span class="keyword">return</span> factory;</span><br><span class="line">		&#125;</span><br><span class="line">    </span><br><span class="line"> 		<span class="comment">//配置自动配置的连接   配置RabbitProperties里的属性</span></span><br><span class="line">		<span class="function"><span class="keyword">private</span> RabbitConnectionFactoryBean <span class="title">getRabbitConnectionFactoryBean</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">				RabbitProperties properties)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">			PropertyMapper map = PropertyMapper.get();</span><br><span class="line">			RabbitConnectionFactoryBean factory = <span class="keyword">new</span> RabbitConnectionFactoryBean();</span><br><span class="line">			map.from(properties::determineHost).whenNonNull().to(factory::setHost);</span><br><span class="line">			map.from(properties::determinePort).to(factory::setPort);</span><br><span class="line">			map.from(properties::determineUsername).whenNonNull()</span><br><span class="line">					.to(factory::setUsername);</span><br><span class="line">			map.from(properties::determinePassword).whenNonNull()</span><br><span class="line">					.to(factory::setPassword);</span><br><span class="line">			map.from(properties::determineVirtualHost).whenNonNull()</span><br><span class="line">					.to(factory::setVirtualHost);</span><br><span class="line">			map.from(properties::getRequestedHeartbeat).whenNonNull()</span><br><span class="line">					.asInt(Duration::getSeconds).to(factory::setRequestedHeartbeat);</span><br><span class="line">			RabbitProperties.Ssl ssl = properties.getSsl();</span><br><span class="line">			<span class="keyword">if</span> (ssl.isEnabled()) &#123;</span><br><span class="line">				factory.setUseSSL(<span class="keyword">true</span>);</span><br><span class="line">				map.from(ssl::getAlgorithm).whenNonNull().to(factory::setSslAlgorithm);</span><br><span class="line">				map.from(ssl::getKeyStoreType).to(factory::setKeyStoreType);</span><br><span class="line">				map.from(ssl::getKeyStore).to(factory::setKeyStore);</span><br><span class="line">				map.from(ssl::getKeyStorePassword).to(factory::setKeyStorePassphrase);</span><br><span class="line">				map.from(ssl::getTrustStoreType).to(factory::setTrustStoreType);</span><br><span class="line">				map.from(ssl::getTrustStore).to(factory::setTrustStore);</span><br><span class="line">				map.from(ssl::getTrustStorePassword).to(factory::setTrustStorePassphrase);</span><br><span class="line">				map.from(ssl::isValidateServerCertificate).to((validate) -&gt; factory</span><br><span class="line">						.setSkipServerCertificateValidation(!validate));</span><br><span class="line">				map.from(ssl::getVerifyHostname).when(Objects::nonNull)</span><br><span class="line">						.to(factory::setEnableHostnameVerification);</span><br><span class="line">				<span class="keyword">if</span> (ssl.getVerifyHostname() == <span class="keyword">null</span> &amp;&amp; CAN_ENABLE_HOSTNAME_VERIFICATION) &#123;</span><br><span class="line">					factory.setEnableHostnameVerification(<span class="keyword">true</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			map.from(properties::getConnectionTimeout).whenNonNull()</span><br><span class="line">					.asInt(Duration::toMillis).to(factory::setConnectionTimeout);</span><br><span class="line">			factory.afterPropertiesSet();</span><br><span class="line">			<span class="keyword">return</span> factory;</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<p><strong>②RabbitProperties：封装了RabbitMQ的所有配置</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//RabbitProperties封装了RabbitMQ的所有配置</span></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.rabbitmq"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RabbitProperties</span> </span>&#123;</span><br></pre></td></tr></table></figure>



<p><strong>③rabbitTemplate：给RabbitMQ发送和接受消息的</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnSingleCandidate</span>(ConnectionFactory<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">ConditionalOnMissingBean</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">RabbitTemplate</span> <span class="title">rabbitTemplate</span>(<span class="title">ConnectionFactory</span> <span class="title">connectionFactory</span>) </span>&#123;</span><br><span class="line">    PropertyMapper map = PropertyMapper.get();</span><br><span class="line">    RabbitTemplate template = <span class="keyword">new</span> RabbitTemplate(connectionFactory);</span><br><span class="line">    MessageConverter messageConverter = <span class="keyword">this</span>.messageConverter.getIfUnique();</span><br><span class="line">    <span class="keyword">if</span> (messageConverter != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//如果有自己设置的messageConverter消息转换器，也会在这设置进来</span></span><br><span class="line">        template.setMessageConverter(messageConverter);</span><br><span class="line">    &#125;</span><br><span class="line">    template.setMandatory(determineMandatoryFlag());</span><br><span class="line">    RabbitProperties.Template properties = <span class="keyword">this</span>.properties.getTemplate();</span><br><span class="line">    <span class="keyword">if</span> (properties.getRetry().isEnabled()) &#123;</span><br><span class="line">        template.setRetryTemplate(createRetryTemplate(properties.getRetry()));</span><br><span class="line">    &#125;</span><br><span class="line">    map.from(properties::getReceiveTimeout).whenNonNull().as(Duration::toMillis)</span><br><span class="line">        .to(template::setReceiveTimeout);</span><br><span class="line">    map.from(properties::getReplyTimeout).whenNonNull().as(Duration::toMillis)</span><br><span class="line">        .to(template::setReplyTimeout);</span><br><span class="line">    map.from(properties::getExchange).to(template::setExchange);</span><br><span class="line">    map.from(properties::getRoutingKey).to(template::setRoutingKey);</span><br><span class="line">    <span class="keyword">return</span> template;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p><strong>④消息转换器</strong></p>
<p>RabbitTemplate.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//默认使用的是SimpleMessageConverter消息转换器</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> MessageConverter messageConverter = <span class="keyword">new</span> SimpleMessageConverter();</span><br></pre></td></tr></table></figure>



<p>SimpleMessageConverter.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//默认序列化数据的时候，按照jdk序列化规则来序列化</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> Message <span class="title">createMessage</span><span class="params">(Object object, MessageProperties messageProperties)</span> <span class="keyword">throws</span> MessageConversionException </span>&#123;</span><br><span class="line">       <span class="keyword">byte</span>[] bytes = <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">if</span> (object <span class="keyword">instanceof</span> <span class="keyword">byte</span>[]) &#123;</span><br><span class="line">           bytes = (<span class="keyword">byte</span>[])((<span class="keyword">byte</span>[])object);</span><br><span class="line">           messageProperties.setContentType(<span class="string">"application/octet-stream"</span>);</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               bytes = ((String)object).getBytes(<span class="keyword">this</span>.defaultCharset);</span><br><span class="line">           &#125; <span class="keyword">catch</span> (UnsupportedEncodingException var6) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> MessageConversionException(<span class="string">"failed to convert to Message content"</span>, var6);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           messageProperties.setContentType(<span class="string">"text/plain"</span>);</span><br><span class="line">           messageProperties.setContentEncoding(<span class="keyword">this</span>.defaultCharset);</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> Serializable) &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               bytes = SerializationUtils.serialize(object);</span><br><span class="line">           &#125; <span class="keyword">catch</span> (IllegalArgumentException var5) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> MessageConversionException(<span class="string">"failed to convert to serialized Message content"</span>, var5);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           messageProperties.setContentType(<span class="string">"application/x-java-serialized-object"</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (bytes != <span class="keyword">null</span>) &#123;</span><br><span class="line">           messageProperties.setContentLength((<span class="keyword">long</span>)bytes.length);</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">new</span> Message(bytes, messageProperties);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="keyword">this</span>.getClass().getSimpleName() + <span class="string">" only supports String, byte[] and Serializable payloads, received: "</span> + object.getClass().getName());</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h2 id="Spring-Boot之任务"><a href="#Spring-Boot之任务" class="headerlink" title="Spring Boot之任务"></a>Spring Boot之任务</h2><h3 id="异步任务"><a href="#异步任务" class="headerlink" title="异步任务"></a>异步任务</h3><p>在Java应用中，绝大多数情况下都是通过同步的方式来实现交互处理的;但是在处理与第三方系统交互的时候，容易造成响应迟缓的情况，之前大部分都是使用多线程来完成此类任务，其实，在Spring 3.x之后，就已经内置了@Async来完美解决这个问题。</p>
<p>两个注解:<strong>@EnableAysnc、@Aysnc</strong></p>
<p><strong>1.Service</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncService</span> </span>&#123;</span><br><span class="line">    <span class="comment">//告诉Spring这是一个异步方法</span></span><br><span class="line">    <span class="meta">@Async</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">30000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"数据处理中。。。。"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>2.Controller</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    AsyncService asyncService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/hello"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        asyncService.hello();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>3.Application</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableAsync</span>  <span class="comment">//开启异步注解功能</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringBootTaskApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(SpringBootTaskApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="定时任务"><a href="#定时任务" class="headerlink" title="定时任务"></a>定时任务</h3><p>项目开发中经常需要执行一些定时任务，比如需要在每天凌晨时候，分析一次前一天的日志信息。Spring为我们提供了异步执行任务调度的方式，提供 TaskExecutor 、TaskScheduler 接口。</p>
<p><strong>两个注解:@EnableScheduling、@Scheduled</strong></p>
<p><strong>cron表达式</strong></p>
<table>
<thead>
<tr>
<th>字段</th>
<th>允许值</th>
<th>允许的特殊字符</th>
</tr>
</thead>
<tbody><tr>
<td>秒</td>
<td>0-59</td>
<td>, -   * /</td>
</tr>
<tr>
<td>分</td>
<td>0-59</td>
<td>, -   * /</td>
</tr>
<tr>
<td>小时</td>
<td>0-23</td>
<td>, -   * /</td>
</tr>
<tr>
<td>日期</td>
<td>1-31</td>
<td>, -   * ? / L W C</td>
</tr>
<tr>
<td>月份</td>
<td>1-12</td>
<td>, -   * /</td>
</tr>
<tr>
<td>星期</td>
<td>0-7或SUN-SAT   0,7是SUN</td>
<td>, -   * ? / L C #</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>字段</th>
<th>允许值</th>
<th>允许的特殊字符</th>
</tr>
</thead>
<tbody><tr>
<td>秒</td>
<td>0-59</td>
<td>, -   * /</td>
</tr>
<tr>
<td>分</td>
<td>0-59</td>
<td>, -   * /</td>
</tr>
<tr>
<td>小时</td>
<td>0-23</td>
<td>, -   * /</td>
</tr>
<tr>
<td>日期</td>
<td>1-31</td>
<td>, -   * ? / L W C</td>
</tr>
<tr>
<td>月份</td>
<td>1-12</td>
<td>, -   * /</td>
</tr>
<tr>
<td>星期</td>
<td>0-7或SUN-SAT   0,7是SUN</td>
<td>, -   * ? / L C #</td>
</tr>
</tbody></table>
<p><strong>1.service</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ScheduledService</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定时任务</span></span><br><span class="line"><span class="comment">     * cron 指定定时任务的cron表达式</span></span><br><span class="line"><span class="comment">     * second(秒),minute（分）,hour（时）,day of month（日）,month（月）,day of week（周几）</span></span><br><span class="line"><span class="comment">     * 0 * * * * MON-FRI (周一到周五每一分钟整分钟的时候运行一次)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//@Scheduled(cron = "0 * * * * MON-FRI")</span></span><br><span class="line">    <span class="comment">//@Scheduled(cron = "0,1,2,3,4 * * * * MON-FRI")  //0,1,2,3,4枚举</span></span><br><span class="line">    <span class="comment">//@Scheduled(cron = "0-4 * * * * MON-FRI")    //0-4秒区间</span></span><br><span class="line">    <span class="comment">//@Scheduled(cron = "0/4 * * * * MON-FRI")    //每4秒一次</span></span><br><span class="line">    <span class="comment">//@Scheduled(cron = "0 0/5 14,18 * * ?")    //每天14点整和18点整，每隔5分钟执行一次</span></span><br><span class="line">    <span class="comment">//@Scheduled(cron = "0 15 10 ？ * 1-6")  //每个月点周一至周六10：15分执行一次</span></span><br><span class="line">    <span class="comment">//@Scheduled(cron = "0 0 2 ？ * 6L")  //每个月的最后一个周六凌晨2点执行一次</span></span><br><span class="line">    <span class="comment">//@Scheduled(cron = "0 0 2 LW * ？")  //每个月的最后一个工作日凌晨两点执行一次</span></span><br><span class="line">    <span class="meta">@Scheduled</span>(cron = <span class="string">"0 0 2-4 ？ * 1#1"</span>)  <span class="comment">//每个月的第一个周一凌晨2点到4点期间每个整点都执行一次</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"hello..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>2.Application</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableScheduling</span>  <span class="comment">//开启基于注解的定时任务</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringBootTaskApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(SpringBootTaskApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="邮件任务"><a href="#邮件任务" class="headerlink" title="邮件任务"></a>邮件任务</h3><p><strong>1.引入pom</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-mail<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p><strong>2.配置application.yml</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.mail.username</span>=<span class="string">1269995677@qq.com</span></span><br><span class="line"><span class="meta">spring.mail.password</span>=<span class="string">mpduxmuivewdigjf</span></span><br><span class="line"><span class="meta">spring.mail.host</span>=<span class="string">smtp.qq.com</span></span><br></pre></td></tr></table></figure>



<p><strong>3.测试</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">SpringBootTaskApplicationTests</span> </span>&#123;</span><br><span class="line">    <span class="comment">//注入邮件发送器</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    JavaMailSenderImpl javaMailSender;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//测试简单邮件</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextLoads</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SimpleMailMessage message = <span class="keyword">new</span> SimpleMailMessage();</span><br><span class="line">        <span class="comment">//邮件设置</span></span><br><span class="line">        message.setSubject(<span class="string">"通知：今晚开会"</span>);</span><br><span class="line">        message.setText(<span class="string">"今晚7：30开会"</span>);</span><br><span class="line">        message.setTo(<span class="string">"1269995677@qq.com"</span>);</span><br><span class="line">        message.setFrom(<span class="string">"1269995677@qq.com"</span>);</span><br><span class="line">        javaMailSender.send(message);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="comment">//测试复杂邮件</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> <span class="keyword">throws</span> MessagingException </span>&#123;</span><br><span class="line">        <span class="comment">//1、创建一个复杂消息邮件</span></span><br><span class="line">        MimeMessage message = javaMailSender.createMimeMessage();</span><br><span class="line">        MimeMessageHelper helper = <span class="keyword">new</span> MimeMessageHelper(message, <span class="keyword">true</span>);<span class="comment">//multipart 是否上传文件</span></span><br><span class="line">        <span class="comment">//邮件设置</span></span><br><span class="line">        helper.setSubject(<span class="string">"通知：今晚开会"</span>);</span><br><span class="line">        helper.setText(<span class="string">"&lt;b style='color:red'&gt;今晚7：30开会&lt;/b&gt;"</span>, <span class="keyword">true</span>);</span><br><span class="line">        helper.setTo(<span class="string">"1269995677@qq.com"</span>);</span><br><span class="line">        helper.setFrom(<span class="string">"1269995677@qq.com"</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//上传附件</span></span><br><span class="line">        helper.addAttachment(<span class="string">"1.jpg"</span>, <span class="keyword">new</span> File(<span class="string">"/Users/Amy/Downloads/1.jpg"</span>));</span><br><span class="line">        helper.addAttachment(<span class="string">"2.jpg"</span>, <span class="keyword">new</span> File(<span class="string">"/Users/Amy/Downloads/2.jpg"</span>));</span><br><span class="line">        javaMailSender.send(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="邮件发送原理"><a href="#邮件发送原理" class="headerlink" title="邮件发送原理"></a>邮件发送原理</h4><p><strong>1.SpringBoot 自动配置MailSenderAutoConfiguration</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//邮件自动配置类</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(&#123; MimeMessage<span class="class">.<span class="keyword">class</span>, <span class="title">MimeType</span>.<span class="title">class</span>, <span class="title">MailSender</span>.<span class="title">class</span> &#125;)</span></span><br><span class="line"><span class="class">@<span class="title">ConditionalOnMissingBean</span>(<span class="title">MailSender</span>.<span class="title">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">Conditional</span>(<span class="title">MailSenderCondition</span>.<span class="title">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">EnableConfigurationProperties</span>(<span class="title">MailProperties</span>.<span class="title">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">Import</span>(</span>&#123; MailSenderJndiConfiguration<span class="class">.<span class="keyword">class</span>, <span class="title">MailSenderPropertiesConfiguration</span>.<span class="title">class</span> &#125;)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">MailSenderAutoConfiguration</span> </span>&#123;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//邮件发送属性</span></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.mail"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MailProperties</span> </span>&#123;</span><br></pre></td></tr></table></figure>



<p><strong>2.自动装配JavaMailSender</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(Session<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">ConditionalOnProperty</span>(<span class="title">prefix</span> </span>= <span class="string">"spring.mail"</span>, name = <span class="string">"jndi-name"</span>)</span><br><span class="line"><span class="meta">@ConditionalOnJndi</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MailSenderJndiConfiguration</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> MailProperties properties;</span><br><span class="line"> </span><br><span class="line">	MailSenderJndiConfiguration(MailProperties properties) &#123;</span><br><span class="line">		<span class="keyword">this</span>.properties = properties;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="meta">@Bean</span> <span class="comment">//发送邮件的组件</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> JavaMailSenderImpl <span class="title">mailSender</span><span class="params">(Session session)</span> </span>&#123;</span><br><span class="line">		JavaMailSenderImpl sender = <span class="keyword">new</span> JavaMailSenderImpl();</span><br><span class="line">		sender.setDefaultEncoding(<span class="keyword">this</span>.properties.getDefaultEncoding().name());</span><br><span class="line">		sender.setSession(session);</span><br><span class="line">		<span class="keyword">return</span> sender;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<p>暂时先介绍这三个我们常用的高级特性，后面根据实际应用会介绍其他的高级技术，例如：检索、安全等。</p>

          
            <br>
            
  
    
    

<section class="widget copyright  desktop mobile">
  <div class='content'>
    
      <blockquote>
        
          
            <p>博客内容遵循 署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</p>

          
        
          
            <p>本文永久链接是：<a href=https://www.bcoder.top/2019/01/01/SpringBoot%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/>https://www.bcoder.top/2019/01/01/SpringBoot%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/</a></p>
          
        
      </blockquote>
    
  </div>
</section>

  

  
    
    

<section class="widget qrcode  desktop mobile">
  

  <div class='content article-entry'>
    
      
        <div class='fancybox'><img src='https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/qrcode/wiki_volantis.png'
        
          height='64px'
        ></div>
      
    
      
        <div class='fancybox'><img src='https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/qrcode/wiki_volantis.png'
        
          height='64px'
        ></div>
      
    
  </div>
</section>

  


          
        </div>
        
          


  <section class='meta' id="footer-meta">
    <div class='new-meta-box'>
      
        
          <div class="new-meta-item date" itemprop="dateUpdated" datetime="2020-01-21T18:44:04+08:00">
  <a class='notlink'>
    <i class="fas fa-edit fa-fw" aria-hidden="true"></i>
    <p>更新于：2020-01-21 18:44:04</p>
  </a>
</div>

        
      
        
          
  
  <div class="new-meta-item meta-tags"><a class="tag" href="/tags/Spring-Boot/" rel="nofollow"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i><p>Spring Boot</p></a></div>


        
      
        
          

        
      
        
          
  <div class="new-meta-item share -mob-share-list">
  <div class="-mob-share-list share-body">
    
      
        <a class="-mob-share-qq" title="" rel="external nofollow noopener noreferrer"
          
          href="http://connect.qq.com/widget/shareqq/index.html?url=https://www.bcoder.top/2019/01/01/SpringBoot%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/&title=Spring Boot高级特性 - zln's blog&summary=
引言

在我们进行开发应用时，除了要整合像MyBatis、Durid、logback等基础组件，还会去整合诸如缓存、消息队列、各种任务（异步任务、定时任务、邮件任务）等等。"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/qq.png">
          
        </a>
      
    
      
        <a class="-mob-share-qzone" title="" rel="external nofollow noopener noreferrer"
          
          href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://www.bcoder.top/2019/01/01/SpringBoot%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/&title=Spring Boot高级特性 - zln's blog&summary=
引言

在我们进行开发应用时，除了要整合像MyBatis、Durid、logback等基础组件，还会去整合诸如缓存、消息队列、各种任务（异步任务、定时任务、邮件任务）等等。"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/qzone.png">
          
        </a>
      
    
      
        <a class="-mob-share-weibo" title="" rel="external nofollow noopener noreferrer"
          
          href="http://service.weibo.com/share/share.php?url=https://www.bcoder.top/2019/01/01/SpringBoot%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/&title=Spring Boot高级特性 - zln's blog&summary=
引言

在我们进行开发应用时，除了要整合像MyBatis、Durid、logback等基础组件，还会去整合诸如缓存、消息队列、各种任务（异步任务、定时任务、邮件任务）等等。"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/weibo.png">
          
        </a>
      
    
  </div>
</div>



        
      
    </div>
  </section>


        
        
          <div class="prev-next">
            
              <a class='prev' href='/2019/01/12/%E7%BC%93%E5%AD%98%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E5%8F%8A%E5%85%B6%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95/'>
                <p class='title'><i class="fas fa-chevron-left" aria-hidden="true"></i>缓存常见问题及其解决办法</p>
                <p class='content'>为什么出现缓存？随着互联网系统发展的逐步完善，提高系统的qps，目前的绝大部分系统都增加了缓存机制从而避免请求过多的直接与数据库操作从而造成系统瓶颈，极大的提升了用户体验和系统稳定性。



缓...</p>
              </a>
            
            
              <a class='next' href='/2018/12/31/JsonPath%E5%AD%A6%E4%B9%A0/'>
                <p class='title'>JsonPath学习<i class="fas fa-chevron-right" aria-hidden="true"></i></p>
                <p class='content'>
引用

最近项目中需要进行单元测试，主要是对Controller类的方法进行单元测试，测试的结果是返回json体，因此需要对返回的json进行解析（而非反序列化）。这时发现了JsonPath，...</p>
              </a>
            
          </div>
        
      </section>
    </article>
  

  
    <!-- 显示推荐文章和评论 -->



  <article class="post white-box comments shadow">
    <section class="article typo">
      <p ct><i class='fas fa-comments'></i> 评论</p>
      
      
      
      
      
        <section id="comments">
          <div id="valine_container" class="valine_thread">
            <i class="fas fa-spinner fa-spin fa-fw"></i>
          </div>
        </section>
      
    </section>
  </article>


  




<!-- 根据页面mathjax变量决定是否加载MathJax数学公式js -->



  <script>
    window.subData = {
      title: 'Spring Boot高级特性',
      tools: true
    }
  </script>


</div>
<aside class='l_side'>
  
  

  
    
    


  <section class="widget toc-wrapper shadow desktop mobile">
    
  <header>
    
      <i class="fas fa-list fa-fw" aria-hidden="true"></i><span class='name'>本文目录</span>
    
  </header>


    <div class='content'>
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-Boot之缓存"><span class="toc-number">1.</span> <span class="toc-text">Spring Boot之缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#JSR107"><span class="toc-number">1.1.</span> <span class="toc-text">JSR107</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring缓存抽象"><span class="toc-number">1.2.</span> <span class="toc-text">Spring缓存抽象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring缓存概念"><span class="toc-number">1.3.</span> <span class="toc-text">Spring缓存概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#缓存实战"><span class="toc-number">1.4.</span> <span class="toc-text">缓存实战</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#整合Redis作为缓存"><span class="toc-number">1.5.</span> <span class="toc-text">整合Redis作为缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#缓存原理"><span class="toc-number">1.6.</span> <span class="toc-text">缓存原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#缓存运行流程"><span class="toc-number">1.7.</span> <span class="toc-text">缓存运行流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-Boot之消息队列"><span class="toc-number">2.</span> <span class="toc-text">Spring Boot之消息队列</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#消息队列概述"><span class="toc-number">2.1.</span> <span class="toc-text">消息队列概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RabbitMQ简介"><span class="toc-number">2.2.</span> <span class="toc-text">RabbitMQ简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RabbitMQ运行机制"><span class="toc-number">2.3.</span> <span class="toc-text">RabbitMQ运行机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#整合RabbitMQ作为缓存"><span class="toc-number">2.4.</span> <span class="toc-text">整合RabbitMQ作为缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#整合原理"><span class="toc-number">2.5.</span> <span class="toc-text">整合原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-Boot之任务"><span class="toc-number">3.</span> <span class="toc-text">Spring Boot之任务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#异步任务"><span class="toc-number">3.1.</span> <span class="toc-text">异步任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#定时任务"><span class="toc-number">3.2.</span> <span class="toc-text">定时任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#邮件任务"><span class="toc-number">3.3.</span> <span class="toc-text">邮件任务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#邮件发送原理"><span class="toc-number">3.3.1.</span> <span class="toc-text">邮件发送原理</span></a></li></ol></li></ol></li></ol>
    </div>
  </section>


  


</aside>


  
  <footer class="clearfix">
    <br><br>
    
      
        <br>
        <div class="social-wrapper">
          
            
              <a href="https://www.bcoder.top"
                class="social fas fa-rss flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
            
              <a href="mailto:me@xaoxuu.com"
                class="social fas fa-envelope flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
            
              <a href="https://github.com/zlnnjit"
                class="social fab fa-github flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
            
              <a href="https://music.163.com/#/user/home?id=430673592"
                class="social fas fa-headphones-alt flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
        </div>
      
    
      
        Use
        <a href="https://bcoder.top/" target="_blank" class="codename">周陆宁</a>
        as theme
        
          , 
          total visits
          <span id="busuanzi_value_site_pv"><i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span>
          times
        
      
    
      
        <div class='copyright'>
        <p><a href="https://bocder.top" target="_blank" rel="noopener">Copyright © 2016-2020 zlnnjit</a></p>

        </div>
      
    
  </footer>

<script>setLoadingBarProgress(80);</script>


      <script>setLoadingBarProgress(60);</script>
    </div>
    <a class="s-top fas fa-arrow-up fa-fw" href='javascript:void(0)'></a>
  </div>
  
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4/dist/jquery.min.js"></script>


  <script>
    
    var SEARCH_SERVICE = "hexo" || "hexo";
    var ROOT = "/" || "/";
    if (!ROOT.endsWith('/')) ROOT += '/';
  </script>


  <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2/js/instant_page.js" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>



  
<script src="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js"></script>

  <script type="text/javascript">
    $(function() {
      Waves.attach('.flat-btn', ['waves-button']);
      Waves.attach('.float-btn', ['waves-button', 'waves-float']);
      Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);
      Waves.attach('.flat-box', ['waves-block']);
      Waves.attach('.float-box', ['waves-block', 'waves-float']);
      Waves.attach('.waves-image');
      Waves.init();
    });
  </script>


  <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js"></script>



  
  
  
    
<script src="https://cdn.jsdelivr.net/npm/jquery-backstretch@2.1.18/jquery.backstretch.min.js"></script>

    <script type="text/javascript">
      $(function(){
        var imgs=["https://cdn.jsdelivr.net/gh/xaoxuu/cdn-wallpaper/abstract/41F215B9-261F-48B4-80B5-4E86E165259E.jpeg"];
        if ('true' == 'true') {
          function shuffle(arr){
            /*From countercurrent-time*/
            var n = arr.length;
            while(n--) {
              var index = Math.floor(Math.random() * n);
              var temp = arr[index];
              arr[index] = arr[n];
              arr[n] = temp;
            }
          }
          shuffle(imgs);
        }
        if ('.cover') {
          $('.cover').backstretch(
            imgs,
          {
            duration: "20000",
            fade: "1500"
          });
        } else {
          $.backstretch(
            imgs,
          {
            duration: "20000",
            fade: "1500"
          });
        }
      });
    </script>
  



  
    
<script src="https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.js" async></script>

  
    
<script src="https://cdn.jsdelivr.net/npm/meting@2.0/dist/Meting.min.js" async></script>

  








  
    
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2.2.0/js/valine.js"></script>

  
  <script>
  var GUEST_INFO = ['nick','mail','link'];
  var guest_info = 'nick,mail,link'.split(',').filter(function(item){
    return GUEST_INFO.indexOf(item) > -1
  });
  var notify = 'true' == true;
  var verify = 'true' == true;
  var valine = new Valine();
  valine.init({
    el: '#valine_container',
    notify: notify,
    verify: verify,
    guest_info: guest_info,
    
    appId: "M3YhrSNLSJTxyKwa8hGSGbH7-gzGzoHsz",
    appKey: "RwjMsAULtRweeA4GtaqJGPVu",
    placeholder: "快来评论吧~",
    pageSize:'10',
    avatar:'mp',
    lang:'zh-cn',
    visitor: 'false',
    highlight:'true'
  })
  </script>



  
<script src="/js/app.js"></script>



  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2.1/js/search.js"></script>



  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2/js/comment_typing.js"></script>



<!-- 复制 -->

  <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="fas fa-copy"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copyed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('fa-copy');
        $icon.addClass('fa-clipboard-check');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPYED';
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('fa-copy');
        $icon.addClass('fa-exclamation-triangle');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
      });
    }
    initCopyCode();
  }(window, document);
</script>




<!-- fancybox -->

  <script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script>
  let LAZY_LOAD_IMAGE = "";
  $(".article-entry").find("div.fancybox").find("img").each(function () {
      var element = document.createElement("a");
      $(element).attr("data-fancybox", "gallery");
      $(element).attr("href", $(this).attr("src"));
      /* 图片采用懒加载处理时,
       * 一般图片标签内会有个属性名来存放图片的真实地址，比如 data-original,
       * 那么此处将原本的属性名src替换为对应属性名data-original,
       * 修改如下
       */
       if (LAZY_LOAD_IMAGE) {
         $(element).attr("href", $(this).attr("data-original"));
       }
      $(this).wrap(element);
  });
</script>






  <script>setLoadingBarProgress(100);</script>
</body>
</html>
